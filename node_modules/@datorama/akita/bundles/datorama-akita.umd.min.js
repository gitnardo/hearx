!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("rxjs"),require("rxjs/operators")):"function"==typeof define&&define.amd?define("@datorama/akita",["exports","rxjs","rxjs/operators"],e):e((t.datorama=t.datorama||{},t.datorama.akita={}),t.rxjs,t.rxjs.operators)}(this,function(i,s,A){"use strict";var n=function(t,e){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(t,e)};function t(t,e){function r(){this.constructor=t}n(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}var j=function(){return(j=Object.assign||function(t){for(var e,r=1,i=arguments.length;r<i;r++)for(var n in e=arguments[r])Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t}).apply(this,arguments)};function e(t,e,r,i){var n,o=arguments.length,s=o<3?e:null===i?i=Object.getOwnPropertyDescriptor(e,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(t,e,r,i);else for(var a=t.length-1;0<=a;a--)(n=t[a])&&(s=(o<3?n(s):3<o?n(e,r,s):n(e,r))||s);return 3<o&&s&&Object.defineProperty(e,r,s),s}function r(t,e){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(t,e)}function x(t){var e="function"==typeof Symbol&&t[Symbol.iterator],r=0;return e?e.call(t):{next:function(){return t&&r>=t.length&&(t=void 0),{value:t&&t[r++],done:!t}}}}function I(t,e){var r="function"==typeof Symbol&&t[Symbol.iterator];if(!r)return t;var i,n,o=r.call(t),s=[];try{for(;(void 0===e||0<e--)&&!(i=o.next()).done;)s.push(i.value)}catch(a){n={error:a}}finally{try{i&&!i.done&&(r=o["return"])&&r.call(o)}finally{if(n)throw n.error}}return s}function m(){for(var t=[],e=0;e<arguments.length;e++)t=t.concat(I(arguments[e]));return t}function p(t){return Array.isArray(t)}function h(t){return!!p(t)&&0===t.length}function f(t,e,r){var i,n,o={entities:{},ids:[]};try{for(var s=x(t),a=s.next();!a.done;a=s.next()){var u=r(a.value);o.entities[u[e]]=u,o.ids.push(u[e])}}catch(c){i={error:c}}finally{try{a&&!a.done&&(n=s["return"])&&n.call(s)}finally{if(i)throw i.error}}return o}function C(t,e){return t.hasOwnProperty(e)}function l(t){return t.hasOwnProperty("active")}function o(t){return p(t)}function y(t){var e=t.active,r=t.ids,i=t.entities;return o(e)?a(e,r):!1===C(i,e)?null:e}function a(t,e){var r=t.filter(function(t){return-1<e.indexOf(t)});return r.length===t.length?t:r}function d(t){return t.entities&&t.ids}function v(t,e){var r,i,n={};try{for(var o=x(Object.keys(t)),s=o.next();!s.done;s=o.next()){var a=s.value;n[a]=e(t[a])}}catch(u){r={error:u}}finally{try{s&&!s.done&&(i=o["return"])&&i.call(o)}finally{if(r)throw r.error}}return n}function u(t){var e,r,i=t.state,n=t.entities,o=t.idKey,s=t.preAddEntity,a=t.isNativePreAdd;if(p(n)){var u=f(n,o,s);e=u.entities,r=u.ids}else r=d(n)?(e=a?n.entities:v(n.entities,s),n.ids):(e=a?n:v(n,s),Object.keys(e).map(function(t){return isNaN(t)?t:Number(t)}));var c=j({},i,{entities:e,ids:r,loading:!1});return l(i)&&(c.active=y(c)),c}var g={type:null,entityIds:null,skip:!1},c=!1;function b(){c=!1}function S(t,e){w(t,e),c=!0}function w(t,e){!1===c&&(g.type=t,g.entityIds=e)}function P(t){void 0===t&&(t=!0),g.skip=t}function E(n,o){return function(t,e,r){var i=r.value;return r.value=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return S(n,o),i.apply(this,t)},r}}var _={resettable:!1,ttl:null,producerFn:undefined};function O(){return _}function k(e){Object.freeze(e);var r="function"==typeof e,i=Object.prototype.hasOwnProperty;return Object.getOwnPropertyNames(e).forEach(function(t){!i.call(e,t)||r&&("caller"===t||"callee"===t||"arguments"===t)||null===e[t]||"object"!=typeof e[t]&&"function"!=typeof e[t]||Object.isFrozen(e[t])||k(e[t])}),e}var U=new s.Subject,F=new s.ReplaySubject(50,5e3),N=new s.Subject;function V(t){U.next(t)}function D(t){F.next(t)}function K(t){N.next(t)}function R(){return i.__DEV__}i.__DEV__=!0;var B,H=(t(M,B=Error),M);function M(t){return B.call(this,t)||this}function $(t){return null===t||t===undefined}function L(t){return!1===$(t)}function Q(t){return"function"==typeof t}function q(t){return null!=t&&""+t!="false"}function z(t){return q(t)&&"Object"===t.constructor.name}function J(){try{return"undefined"!=typeof localStorage}catch(t){return!1}}var W="undefined"!=typeof window,X=!W,Y=("undefined"!=typeof global&&global.__runtimeVersion,"akitaConfig");var G={},Z={};W&&R()&&(window.$$stores=G,window.$$queries=Z);var tt=new s.Subject,et=new s.BehaviorSubject(!1),rt={activeTransactions:0,batchTransaction:null};function it(){ot()||(rt.batchTransaction=new s.Subject),rt.activeTransactions++,et.next(!0)}function nt(){0==--rt.activeTransactions&&(rt.batchTransaction.next(!0),rt.batchTransaction.complete(),et.next(!1),tt.next(!0))}function ot(){return 0<rt.activeTransactions}function st(){return rt.batchTransaction?rt.batchTransaction.asObservable():s.of(!0)}function at(t,e){void 0===e&&(e=undefined),it();try{return t.apply(e)}finally{S("@Transaction"),nt()}}function ut(){return function(t,e,r){var i=r.value;return r.value=function(){for(var t=this,e=[],r=0;r<arguments.length;r++)e[r]=arguments[r];return at(function(){return i.apply(t,e)},this)},r}}var ct=(pt.prototype.setLoading=function(e){void 0===e&&(e=!1),e!==this._value().loading&&(R()&&w("Set Loading"),this._setState(function(t){return j({},t,{loading:e})}))},pt.prototype.setHasCache=function(t,e){var r=this;if(void 0===e&&(e={restartTTL:!1}),t!==this.cache.active.value&&this.cache.active.next(t),e.restartTTL){var i=this.getCacheTTL();i&&(null!==this.cache.ttl&&clearTimeout(this.cache.ttl),this.cache.ttl=setTimeout(function(){return r.setHasCache(!1)},i))}},pt.prototype.getValue=function(){return this.storeValue},pt.prototype.setError=function(e){e!==this._value().error&&(R()&&w("Set Error"),this._setState(function(t){return j({},t,{error:e})}))},pt.prototype._select=function(t){return this.store.asObservable().pipe(A.map(t),A.distinctUntilChanged())},pt.prototype._value=function(){return this.storeValue},pt.prototype._cache=function(){return this.cache.active},Object.defineProperty(pt.prototype,"config",{get:function(){return this.constructor[Y]||{}},enumerable:!0,configurable:!0}),Object.defineProperty(pt.prototype,"storeName",{get:function(){return this.config.storeName||this.options.storeName||this.options.name},enumerable:!0,configurable:!0}),Object.defineProperty(pt.prototype,"deepFreeze",{get:function(){return this.config.deepFreezeFn||this.options.deepFreezeFn||k},enumerable:!0,configurable:!0}),Object.defineProperty(pt.prototype,"cacheConfig",{get:function(){return this.config.cache||this.options.cache},enumerable:!0,configurable:!0}),Object.defineProperty(pt.prototype,"_producerFn",{get:function(){return this.config.producerFn||this.options.producerFn||function t(){return _.producerFn}()},enumerable:!0,configurable:!0}),Object.defineProperty(pt.prototype,"resettable",{get:function(){return L(this.config.resettable)?this.config.resettable:this.options.resettable},enumerable:!0,configurable:!0}),pt.prototype._setState=function(t,e){if(void 0===e&&(e=!0),Q(t)){var r=t(this._value());this.storeValue=i.__DEV__?this.deepFreeze(r):r}else this.storeValue=t;this.store?ot()?this.handleTransaction():this.dispatch(this.storeValue,e):this.store=new s.BehaviorSubject(this.storeValue)},pt.prototype.reset=function(){var t=this;this.isResettable()?(R()&&w("Reset"),this._setState(function(){return Object.assign({},t._initialState)}),this.setHasCache(!1)):R()&&console.warn("You need to enable the reset functionality")},pt.prototype.update=function(t){var e;R()&&w("Update");var r=this._value();e=Q(t)?Q(this._producerFn)?this._producerFn(r,t):t(r):t;var i=this.akitaPreUpdate(r,j({},r,e)),n=z(r)?i:new r.constructor(i);this._setState(n)},pt.prototype.updateStoreConfig=function(t){this.options=j({},this.options,t)},pt.prototype.akitaPreUpdate=function(t,e){return e},pt.prototype.ngOnDestroy=function(){this.destroy()},pt.prototype.destroy=function(){W&&window.hmrEnabled||this!==G[this.storeName]||(delete G[this.storeName],V(this.storeName),this.setHasCache(!1),this.cache.active.complete())},pt.prototype.onInit=function(t){(G[this.storeName]=this)._setState(function(){return t}),D(this.storeName),this.isResettable()&&(this._initialState=t),R()&&function r(t,e){t||console.error("@StoreConfig({ name }) is missing in "+e)}(this.storeName,this.constructor.name)},pt.prototype.dispatch=function(t,e){void 0===e&&(e=!0),this.store.next(t),e&&(K(this.storeName),b())},pt.prototype.watchTransaction=function(){var t=this;st().subscribe(function(){t.inTransaction=!1,t.dispatch(t._value())})},pt.prototype.isResettable=function(){return!1!==this.resettable&&(this.resettable||O().resettable)},pt.prototype.handleTransaction=function(){this.inTransaction||(this.watchTransaction(),this.inTransaction=!0)},pt.prototype.getCacheTTL=function(){return this.cacheConfig&&this.cacheConfig.ttl||O().ttl},pt);function pt(t,e){void 0===e&&(e={}),this.options=e,this.inTransaction=!1,this.cache={active:new s.BehaviorSubject(!1),ttl:null},this.onInit(t)}function ht(t){var e=typeof t;return null!=t&&("object"==e||"function"==e)}function ft(t,e,r){var i;if(p(t))i=t;else if(ht(t)){if($(r))return;t=Object.assign({wrap:!0},t);var n=e.indexOf(r);if(t.prev){var o=0===n;if(o&&!t.wrap)return;i=o?e[e.length-1]:e[n-1]}else if(t.next){var s=e.length===n+1;if(s&&!t.wrap)return;i=s?e[0]:e[n+1]}}else{if(t===r)return;i=t}return i}function lt(t){var e,r,i=t.state,n=t.entities,o=t.idKey,s=t.options,a=void 0===s?{}:s,u=t.preAddEntity,c={},p=[],h=!1;try{for(var f=x(n),l=f.next();!l.done;l=f.next()){var y=l.value;if(!1===C(i.entities,y[o])){var d=u(y),v=d[o];c[v]=d,a.prepend?p.unshift(v):p.push(v),h=!0}}}catch(g){e={error:g}}finally{try{l&&!l.done&&(r=f["return"])&&r.call(f)}finally{if(e)throw e.error}}return h?{newState:j({},i,{entities:j({},i.entities,c),ids:a.prepend?m(p,i.ids):m(i.ids,p)}),newIds:p}:null}function yt(t){return $(t)?[]:Array.isArray(t)?t:[t]}function dt(t){var e,r,i=t.state,n=t.ids;if($(n))return vt(i);var o=i.entities,s={};try{for(var a=x(i.ids),u=a.next();!u.done;u=a.next()){var c=u.value;!1===n.includes(c)&&(s[c]=o[c])}}catch(h){e={error:h}}finally{try{u&&!u.done&&(r=a["return"])&&r.call(a)}finally{if(e)throw e.error}}var p=j({},i,{entities:s,ids:i.ids.filter(function(t){return!1===n.includes(t)})});return l(i)&&(p.active=y(p)),p}function vt(t){return j({},t,{entities:{},ids:[],active:o(t.active)?[]:null})}function gt(){return{entities:{},ids:[],loading:!0,error:null}}function bt(t){var e,r,i,n=t.state,o=t.ids,s=t.idKey,a=t.newStateOrFn,u=t.preUpdateEntity,c=t.producerFn,p={},h=!1;try{for(var f=x(o),l=f.next();!l.done;l=f.next()){var y=l.value;if(!1!==C(n.entities,y)){var d=n.entities[y],v=void 0,g=(v=Q(a)?Q(c)?c(d,a):a(d):a).hasOwnProperty(s)&&v[s]!==d[s],b=void 0;i=y,g&&(h=!0,i=v[s]);var m=j({},d,v);b=z(d)?m:z(v)?new d.constructor(m):new v.constructor(m),p[i]=u(d,b)}}}catch(A){e={error:A}}finally{try{l&&!l.done&&(r=f["return"])&&r.call(f)}finally{if(e)throw e.error}}var S=n.ids,P=n.entities;if(h){var E=I(o,1)[0],_=n.entities,O=E;_[O];P=function w(t,e){var r={};for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&e.indexOf(i)<0&&(r[i]=t[i]);if(null!=t&&"function"==typeof Object.getOwnPropertySymbols){var n=0;for(i=Object.getOwnPropertySymbols(t);n<i.length;n++)e.indexOf(i[n])<0&&(r[i[n]]=t[i[n]])}return r}(_,["symbol"==typeof O?O:O+""]),S=n.ids.map(function(t){return t===E?i:t})}return j({},n,{entities:j({},P,p),ids:S})}function mt(t){return t===undefined}var St={Set:0,Add:1,Update:2,Remove:3};St[St.Set]="Set",St[St.Add]="Add",St[St.Update]="Update",St[St.Remove]="Remove";var Pt,Et,_t="id",Ot=(t(At,Pt=ct),Object.defineProperty(At.prototype,"selectEntityAction$",{get:function(){return this.entityActions.asObservable()},enumerable:!0,configurable:!0}),Object.defineProperty(At.prototype,"idKey",{get:function(){return this.config.idKey||this.options.idKey||_t},enumerable:!0,configurable:!0}),At.prototype.set=function(r,i){var n=this;if(void 0===i&&(i={}),!$(r)){R()&&w("Set Entity");var o=this.akitaPreAddEntity===At.prototype.akitaPreAddEntity;this._setState(function(t){var e=u({state:t,entities:r,idKey:n.idKey,preAddEntity:n.akitaPreAddEntity,isNativePreAdd:o});return!1===mt(i.activeId)&&(e.active=i.activeId),e}),this.setHasCache(!0,{restartTTL:!0}),this.hasInitialUIState()&&this.handleUICreation(),this.entityActions.next({type:St.Set,ids:this.ids})}},At.prototype.add=function(t,e){void 0===e&&(e={loading:!1});var r=yt(t);if(!h(r)){var i=lt({state:this._value(),preAddEntity:this.akitaPreAddEntity,entities:r,idKey:this.idKey,options:e});i&&(R()&&w("Add Entity"),i.newState.loading=e.loading,this._setState(function(){return i.newState}),this.hasInitialUIState()&&this.handleUICreation(!0),this.entityActions.next({type:St.Add,ids:i.newIds}))}},At.prototype.update=function(e,r){var i=this;if(mt(r))Pt.prototype.update.call(this,e);else{var n=[];h(n=Q(e)?this.ids.filter(function(t){return e(i.entities[t])}):$(e)?this.ids:yt(e))||(R()&&w("Update Entity",n),this._setState(function(t){return bt({idKey:i.idKey,ids:n,preUpdateEntity:i.akitaPreUpdateEntity,state:t,newStateOrFn:r,producerFn:i._producerFn})}),this.entityActions.next({type:St.Update,ids:n}))}},At.prototype.upsert=function(t,n,o){var s=this;function e(e){return function(t){return C(s.entities,t)===e}}void 0===o&&(o={});var r=yt(t),a=Q(o.baseClass),i=r.filter(e(!0)),u=r.filter(e(!1)).map(function(t){var e,r=Q(n)?n({}):n,i=j({},r,((e={})[s.idKey]=t,e));return a?new o.baseClass(i):i});this.update(i,n),this.add(u),R()&&S("Upsert Entity")},At.prototype.upsertMany=function(t,e){var r,i;void 0===e&&(e={});var n=[],o=[],s={};try{for(var a=x(t),u=a.next();!u.done;u=a.next()){var c=u.value,p=this.akitaPreCheckEntity(c),h=p[this.idKey];if(C(this.entities,h)){var f=this._value().entities[h],l=j({},this._value().entities[h],p),y=e.baseClass?new e.baseClass(l):l,d=(v=this.akitaPreUpdateEntity(f,y))[this.idKey];s[d]=v,o.push(d)}else{var v,g=e.baseClass?new e.baseClass(p):p;d=(v=this.akitaPreAddEntity(g))[this.idKey],n.push(d),s[d]=v}}}catch(b){r={error:b}}finally{try{u&&!u.done&&(i=a["return"])&&i.call(a)}finally{if(r)throw r.error}}R()&&S("Upsert Many"),this._setState(function(t){return j({},t,{ids:n.length?m(t.ids,n):t.ids,entities:j({},t.entities,s),loading:!!e.loading})}),o.length&&this.entityActions.next({type:St.Update,ids:o}),n.length&&this.entityActions.next({type:St.Add,ids:n}),n.length&&this.hasUIStore()&&this.handleUICreation(!0)},At.prototype.replace=function(t,e){var r,i,n=yt(t);if(!h(n)){var o={};try{for(var s=x(n),a=s.next();!a.done;a=s.next()){var u=a.value;e[this.idKey]=u,o[u]=e}}catch(c){r={error:c}}finally{try{a&&!a.done&&(i=s["return"])&&i.call(s)}finally{if(r)throw r.error}}R()&&w("Replace Entity",t),this._setState(function(t){return j({},t,{entities:j({},t.entities,o)})})}},At.prototype.move=function(t,e){var r=this.ids.slice();r.splice(e<0?r.length+e:e,0,r.splice(t,1)[0]),R()&&w("Move Entity"),this._setState(function(t){return j({},t,{entities:j({},t.entities),ids:r})})},At.prototype.remove=function(e){var r=this;if(!h(this.ids)){var t=L(e),i=[];h(i=Q(e)?this.ids.filter(function(t){return e(r.entities[t])}):t?yt(e):null)||(R()&&w("Remove Entity",i),this._setState(function(t){return dt({state:t,ids:i})}),null===i&&this.setHasCache(!1),this.handleUIRemove(i),this.entityActions.next({type:St.Remove,ids:i}))}},At.prototype.updateActive=function(t){var e=yt(this.active);R()&&w("Update Active",e),this.update(e,t)},At.prototype.setActive=function(t){var e=ft(t,this.ids,this.active);e!==undefined&&(R()&&w("Set Active",e),this._setActive(e))},At.prototype.addActive=function(t){var e=this,r=yt(t);h(r)||r.every(function(t){return-1<e.active.indexOf(t)})||(R()&&w("Add Active",t),this._setState(function(t){var e=Array.from(new Set(m(t.active,r)));return j({},t,{active:e})}))},At.prototype.removeActive=function(t){var e=this,r=yt(t);h(r)||r.some(function(t){return-1<e.active.indexOf(t)})&&(R()&&w("Remove Active",t),this._setState(function(t){return j({},t,{active:Array.isArray(t.active)?t.active.filter(function(t){return-1===r.indexOf(t)}):null})}))},At.prototype.toggleActive=function(t){function e(e){return function(t){return r.active.includes(t)===e}}var r=this,i=yt(t),n=i.filter(e(!0)),o=i.filter(e(!1));this.removeActive(n),this.addActive(o),R()&&S("Toggle Active")},At.prototype.createUIStore=function(t,e){void 0===t&&(t={}),void 0===e&&(e={});var r={name:"UI/"+this.storeName,idKey:this.idKey};return this.ui=new jt(t,j({},r,e)),this.ui},At.prototype.destroy=function(){Pt.prototype.destroy.call(this),this.ui instanceof At&&this.ui.destroy(),this.entityActions.complete()},At.prototype.akitaPreUpdateEntity=function(t,e){return e},At.prototype.akitaPreAddEntity=function(t){return t},At.prototype.akitaPreCheckEntity=function(t){return t},Object.defineProperty(At.prototype,"ids",{get:function(){return this._value().ids},enumerable:!0,configurable:!0}),Object.defineProperty(At.prototype,"entities",{get:function(){return this._value().entities},enumerable:!0,configurable:!0}),Object.defineProperty(At.prototype,"active",{get:function(){return this._value().active},enumerable:!0,configurable:!0}),At.prototype._setActive=function(e){this._setState(function(t){return j({},t,{active:e})})},At.prototype.handleUICreation=function(t){var n=this;function e(t){var e,r=n.entities[t],i=o?n.ui._akitaCreateEntityFn(r):n.ui._akitaCreateEntityFn;return j(((e={})[n.idKey]=r[n.idKey],e),i)}void 0===t&&(t=!1);var r,i=this.ids,o=Q(this.ui._akitaCreateEntityFn);r=t?this.ids.filter(function(t){return mt(n.ui.entities[t])}).map(e):i.map(e),t?this.ui.add(r):this.ui.set(r)},At.prototype.hasInitialUIState=function(){return this.hasUIStore()&&!1===mt(this.ui._akitaCreateEntityFn)},At.prototype.handleUIRemove=function(t){this.hasUIStore()&&this.ui.remove(t)},At.prototype.hasUIStore=function(){return this.ui instanceof jt},e([ut(),r("design:type",Function),r("design:paramtypes",[Object,Object,Object]),r("design:returntype",void 0)],At.prototype,"upsert",null),e([ut(),r("design:type",Function),r("design:paramtypes",["function"==typeof(Et="undefined"!=typeof T&&T)?Et:Object]),r("design:returntype",void 0)],At.prototype,"toggleActive",null),At);function At(t,e){void 0===t&&(t={}),void 0===e&&(e={});var r=Pt.call(this,j({},{entities:{},ids:[],loading:!0,error:null},t),e)||this;return r.options=e,r.entityActions=new s.Subject,r}var wt,jt=(t(xt,wt=Ot),xt.prototype.setInitialEntityState=function(t){this._akitaCreateEntityFn=t},xt);function xt(t,e){return void 0===t&&(t={}),void 0===e&&(e={}),wt.call(this,t,e)||this}function It(t,e,r){var i,n,o,s,a=[];if(Q(e))try{for(var u=x(t),c=u.next();!c.done;c=u.next()){!0===e(l=c.value)&&a.push(l)}}catch(y){i={error:y}}finally{try{c&&!c.done&&(n=u["return"])&&n.call(u)}finally{if(i)throw i.error}}else{var p=yt(e).reduce(function(t,e){return t.add(e)},new Set);try{for(var h=x(t),f=h.next();!f.done;f=h.next()){var l=f.value;p.has(l[r])&&a.push(l)}}catch(d){o={error:d}}finally{try{f&&!f.done&&(s=h["return"])&&s.call(h)}finally{if(o)throw o.error}}}return a}function Ct(){return A.distinctUntilChanged(function(t,e){return t===e||!1!==p(t)&&!1!==p(e)&&(!(!h(t)||!h(e))||!kt(e,t)&&!1===kt(t,e))})}function kt(t,e){return e.some(function(e){return t.find(function(t){return t===e})===undefined})}var Ut={ASC:"asc",DESC:"desc"};function Tt(o,s){return void 0===s&&(s=Ut.ASC),function(t,e){if(!t.hasOwnProperty(o)||!e.hasOwnProperty(o))return 0;var r="string"==typeof t[o]?t[o].toUpperCase():t[o],i="string"==typeof e[o]?e[o].toUpperCase():e[o],n=0;return i<r?n=1:r<i&&(n=-1),s==Ut.DESC?-1*n:n}}function Ft(r,t){for(var i=[],n=r.ids,o=r.entities,s=t.filterBy,e=t.limitTo,a=t.sortBy,u=t.sortByOrder,c=function(e){var r=o[n[e]];if(!s)return i.push(r),"continue";yt(s).every(function(t){return t(r,e)})&&i.push(r)},p=0;p<n.length;p++)c(p);if(a){var h=Q(a)?a:Tt(a,u);i=i.sort(function(t,e){return h(t,e,r)})}var f=Math.min(e||i.length,i.length);return f===i.length?i:i.slice(0,f)}function Nt(t,e){var n={},o=e.filterBy,s=e.limitTo,a=t.ids,u=t.entities;if(!o&&!s)return u;var r=!1===$(s);if(o&&r)for(var c=0,i=function(e,t){if(c===s)return"break";var r=a[e],i=u[r];yt(o).every(function(t){return t(i,e)})&&(n[r]=i,c++)},p=0,h=a.length;p<h;p++){if("break"===i(p))break}else{var f=Math.min(s||a.length,a.length),l=function(e){var t=a[e],r=u[t];if(!o)return n[t]=r,"continue";yt(o).every(function(t){return t(r,e)})&&(n[t]=r)};for(p=0;p<f;p++)l(p)}return n}function Vt(t){return"string"==typeof t}function Dt(r,i){return function(t){var e=t[r];return mt(e)?undefined:i?Vt(i)?e[i]:i(e):e}}var Kt="akitaQueryConfig";var Rt=(Bt.prototype.select=function(e){var t;if(Q(e))t=e;else if(Vt(e))t=function(t){return t[e]};else{if(Array.isArray(e))return this.store._select(function(t){return t}).pipe(A.distinctUntilChanged(function r(t){return function(e,r){var i=Q(t[0]);return!1===t.some(function(t){return i?t(e)!==t(r):e[t]!==r[t]})}}(e)),A.map(function(r){return Q(e[0])?e.map(function(t){return t(r)}):e.reduce(function(t,e){return t[e]=r[e],t},{})}));t=function(t){return t}}return this.store._select(t)},Bt.prototype.selectLoading=function(){return this.select(function(t){return t.loading})},Bt.prototype.selectError=function(){return this.select(function(t){return t.error})},Bt.prototype.getValue=function(){return this.store._value()},Bt.prototype.selectHasCache=function(){return this.store._cache().asObservable()},Bt.prototype.getHasCache=function(){return this.store._cache().value},Object.defineProperty(Bt.prototype,"config",{get:function(){return this.constructor[Kt]},enumerable:!0,configurable:!0}),Bt);function Bt(t){this.store=t,this.__store__=t,R()&&(Z[t.storeName]=this)}function Ht(t,e){t.sortBy=t.sortBy||e&&e.sortBy,t.sortByOrder=t.sortByOrder||e&&e.sortByOrder}var Mt,$t=(t(Lt,Mt=Rt),Lt.prototype.selectAll=function(t){var e=this;return void 0===t&&(t={asObject:!1}),this.select(function(t){return t.entities}).pipe(A.map(function(){return e.getAll(t)}))},Lt.prototype.getAll=function(t){return void 0===t&&(t={asObject:!1,filterBy:undefined,limitTo:undefined}),t.asObject?Nt(this.getValue(),t):(Ht(t,this.config||this.options),Ft(this.getValue(),t))},Lt.prototype.selectMany=function(t,i){return t&&t.length?this.select(function(t){return t.entities}).pipe(A.map(function(e){return function r(t,o){return t.reduce(function(t,e,r,i){var n=o(e,r,i);return n!==undefined&&t.push(n),t},[])}(t,function(t){return Dt(t,i)(e)})}),Ct()):s.of([])},Lt.prototype.selectEntity=function(t,e){var r=t;return Q(t)&&(r=function u(t,e){var r,i;try{for(var n=x(Object.keys(e)),o=n.next();!o.done;o=n.next()){var s=o.value;if(!0===t(e[s]))return s}}catch(a){r={error:a}}finally{try{o&&!o.done&&(i=n["return"])&&i.call(n)}finally{if(r)throw r.error}}return undefined}(t,this.getValue().entities)),this.select(function(t){return t.entities}).pipe(A.map(Dt(r,e)),A.distinctUntilChanged())},Lt.prototype.getEntity=function(t){return this.getValue().entities[t]},Lt.prototype.selectActiveId=function(){return this.select(function(t){return t.active})},Lt.prototype.getActiveId=function(){return this.getValue().active},Lt.prototype.selectActive=function(e){var r=this;return p(this.getActive())?this.selectActiveId().pipe(A.switchMap(function(t){return r.selectMany(t,e)})):this.selectActiveId().pipe(A.switchMap(function(t){return r.selectEntity(t,e)}))},Lt.prototype.getActive=function(){var e=this,t=this.getActiveId();return p(t)?t.map(function(t){return e.getValue().entities[t]}):q(t)?this.getEntity(t):undefined},Lt.prototype.selectCount=function(t){var e=this;return this.select(function(t){return t.entities}).pipe(A.map(function(){return e.getCount(t)}))},Lt.prototype.getCount=function(t){return Q(t)?this.getAll().filter(t).length:this.getValue().ids.length},Lt.prototype.selectLast=function(t){return this.selectAt(function(t){return t[t.length-1]},t)},Lt.prototype.selectFirst=function(t){return this.selectAt(function(t){return t[0]},t)},Lt.prototype.selectEntityAction=function(e){return mt(e)?this.store.selectEntityAction$:this.store.selectEntityAction$.pipe(A.filter(function(t){return t.type===e}),A.map(function(t){return t.ids}))},Lt.prototype.hasEntity=function(t){var e=this;return $(t)?0<this.getValue().ids.length:Q(t)?this.getAll().some(t):p(t)?t.every(function(t){return t in e.getValue().entities}):t in this.getValue().entities},Lt.prototype.hasActive=function(t){var e=this.getValue().active,r=L(t);return Array.isArray(e)?r?e.includes(t):0<e.length:r?e===t:L(e)},Lt.prototype.createUIQuery=function(){this.ui=new qt(this.__store__.ui)},Lt.prototype.selectAt=function(t,e){var r=this;return this.select(function(t){return t.ids}).pipe(A.map(t),A.distinctUntilChanged(),A.switchMap(function(t){return r.selectEntity(t,e)}))},Lt);function Lt(t,e){void 0===e&&(e={});var r=Mt.call(this,t)||this;return r.options=e,r.__store__=t,r}var Qt,qt=(t(zt,Qt=$t),zt);function zt(t){return Qt.call(this,t)||this}function Jt(t){return t.pipe(A.filter(function(t){return null!=t}))}function Wt(t,e){return 1===e.split(".").length?t:e.split(".").slice(1).join(".").split(".").reduce(function(t,e){return t&&t[e]},t)}function Xt(t,e,i){var r=e.split(".");if(1===r.length)return j({},t,i);t=j({},t);var n=r.length-2;return e.split(".").slice(1).reduce(function(t,e,r){return r===n?ht(t[e])?t[e]=j({},t[e],i):t[e]=i:t[e]=j({},t[e]),t&&t[e]},t),t}var Yt=!1,Gt=new s.ReplaySubject(1);function Zt(t){Yt=t}function te(){return Yt}function ee(t){return function e(t){return t&&Q(t.then)}(t)||s.isObservable(t)?s.from(t):s.of(t)}var re=(ie.prototype.getStoresSnapshot=function(t){void 0===t&&(t=[]);for(var e={},r=0<t.length?t:Object.keys(G),i=0;i<r.length;i++){var n=r[i];"router"!==n&&(e[n]=G[n]._value())}return e},ie.prototype.setStoresSnapshot=function(t,e){var r=j({skipStorageUpdate:!1,lazy:!1},e);r.skipStorageUpdate&&Zt(!0);var i=t;Vt(t)&&(i=JSON.parse(i));var n=Object.keys(i).length;if(r.lazy)F.pipe(A.filter(function(t){return i.hasOwnProperty(t)}),A.take(n)).subscribe(function(t){return G[t]._setState(function(){return i[t]})});else for(var o=function(t,e){var r=e[t];G[r]&&G[r]._setState(function(){return i[r]})},s=0,a=Object.keys(i);s<a.length;s++)o(s,a);r.skipStorageUpdate&&Zt(!1)},ie);function ie(){}var ne=new re,oe=(se.prototype.getQuery=function(){return this.query},se.prototype.getStore=function(){return this.getQuery().__store__},se.prototype.isEntityBased=function(t){return q(t)},se.prototype.selectSource=function(t,e){var r=this;return this.isEntityBased(t)?this.getQuery().selectEntity(t).pipe(Jt):e?this.getQuery().select(function(t){return Wt(t,r.withStoreName(e))}):this.getQuery().select()},se.prototype.getSource=function(t,e){if(this.isEntityBased(t))return this.getQuery().getEntity(t);var r=this.getQuery().getValue();return e?Wt(r,this.withStoreName(e)):r},se.prototype.withStoreName=function(t){return this.storeName+"."+t},Object.defineProperty(se.prototype,"storeName",{get:function(){return this.getStore().storeName},enumerable:!0,configurable:!0}),se.prototype.updateStore=function(e,t,r){var i=this;if(this.isEntityBased(t))this.getStore().update(t,e);else{if(r)return void this.getStore()._setState(function(t){return Xt(t,i.withStoreName(r),e)});this.getStore()._setState(function(t){return j({},t,e)})}},se.prototype.onReset=function(r){var i=this,n=this.getStore().reset;this.getStore().reset=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];setTimeout(function(){n.apply(i.getStore(),t),r()})}},se);function se(t,e){this.query=t,e&&e.resetFn&&O().resettable&&this.onReset(e.resetFn)}var ae,ue={pagesControls:!1,range:!1,startWith:1,cacheTimeout:undefined,clearStoreWithCache:!0},ce=(t(pe,ae=oe),Object.defineProperty(pe.prototype,"pageChanges",{get:function(){return this.page.asObservable()},enumerable:!0,configurable:!0}),Object.defineProperty(pe.prototype,"currentPage",{get:function(){return this.pagination.currentPage},enumerable:!0,configurable:!0}),Object.defineProperty(pe.prototype,"isFirst",{get:function(){return 1===this.currentPage},enumerable:!0,configurable:!0}),Object.defineProperty(pe.prototype,"isLast",{get:function(){return this.currentPage===this.pagination.lastPage},enumerable:!0,configurable:!0}),pe.prototype.withControls=function(){return this.config.pagesControls=!0,this},pe.prototype.withRange=function(){return this.config.range=!0,this},pe.prototype.setLoading=function(t){void 0===t&&(t=!0),this.getStore().setLoading(t)},pe.prototype.update=function(t){this.pagination=t,this.addPage(t.data)},pe.prototype.addPage=function(t){var e=this;this.pages.set(this.currentPage,{ids:t.map(function(t){return t[e.getStore().idKey]})}),this.getStore().add(t)},pe.prototype.clearCache=function(t){void 0===t&&(t={}),this.initial||(S("@Pagination - Clear Cache"),!1!==t.clearStore&&(this.config.clearStoreWithCache||t.clearStore)&&this.getStore().remove(),this.pages=new Map,this.metadata=new Map),this.initial=!1},pe.prototype.clearPage=function(t){this.pages["delete"](t)},pe.prototype.destroy=function(t){var e=void 0===t?{}:t,r=e.clearCache,i=e.currentPage;this.clearCacheSubscription&&this.clearCacheSubscription.unsubscribe(),r&&this.clearCache(),mt(i)||this.setPage(i),this.initial=!0},pe.prototype.isPageActive=function(t){return this.currentPage===t},pe.prototype.setPage=function(t){t===this.currentPage&&this.hasPage(t)||this.page.next(this.pagination.currentPage=t)},pe.prototype.nextPage=function(){this.currentPage!==this.pagination.lastPage&&this.setPage(this.pagination.currentPage+1)},pe.prototype.prevPage=function(){1<this.pagination.currentPage&&this.setPage(this.pagination.currentPage-1)},pe.prototype.setLastPage=function(){this.setPage(this.pagination.lastPage)},pe.prototype.setFirstPage=function(){this.setPage(1)},pe.prototype.hasPage=function(t){return this.pages.has(t)},pe.prototype.getPage=function(t){var e=this,r=this.pagination.currentPage;return this.hasPage(r)?this.selectPage(r):(this.setLoading(!0),s.from(t()).pipe(A.switchMap(function(t){return r=t.currentPage,at(function(){e.setLoading(!1),e.update(t)}),e.selectPage(r)})))},pe.prototype.getQuery=function(){return this.query},pe.prototype.refreshCurrentPage=function(){!1===$(this.currentPage)&&(this.clearPage(this.currentPage),this.setPage(this.currentPage))},pe.prototype.getFrom=function(){return this.isFirst?1:(this.currentPage-1)*this.pagination.perPage+1},pe.prototype.getTo=function(){return this.isLast?this.pagination.total:this.currentPage*this.pagination.perPage},pe.prototype.selectPage=function(s){var a=this;return this.query.selectAll({asObject:!0}).pipe(A.take(1),A.map(function(e){var t=j({},a.pagination,{data:a.pages.get(s).ids.map(function(t){return e[t]})}),r=a.config,i=r.range,n=r.pagesControls;return isNaN(a.pagination.total)&&(1===t.lastPage?t.total=t.data?t.data.length:0:t.total=t.perPage*t.lastPage,a.pagination.total=t.total),i&&(t.from=a.getFrom(),t.to=a.getTo()),n&&(t.pageControls=function o(t,e){for(var r=Math.ceil(t/e),i=[],n=0;n<r;n++)i.push(n+1);return i}(a.pagination.total,a.pagination.perPage)),t}))},e([E("@Pagination - New Page"),r("design:type",Function),r("design:paramtypes",[Object]),r("design:returntype",void 0)],pe.prototype,"update",null),pe);function pe(t,e){void 0===e&&(e={});var r=ae.call(this,t,{resetFn:function(){r.initial=!1,r.destroy({clearCache:!0,currentPage:1})}})||this;r.query=t,r.config=e,r.metadata=new Map,r.pages=new Map,r.pagination={currentPage:1,perPage:0,total:0,lastPage:0,data:[]},r.initial=!0,r.isLoading$=r.query.selectLoading().pipe(A.delay(0)),r.config=Object.assign(ue,e);var i=r.config,n=i.startWith,o=i.cacheTimeout;return r.page=new s.BehaviorSubject(n),s.isObservable(o)&&(r.clearCacheSubscription=o.subscribe(function(){return r.clearCache()})),r}var he,fe=ce,le=(t(ye,he=oe),ye.prototype.setForm=function(t,e){return this.form=t,this.builder=e,this.activate(),this},ye.prototype.reset=function(t){var e,r,i=this;r=t||(this.isKeyBased?this.initialValue:this.factoryFnOrPath()),this.isKeyBased&&Object.keys(this.initialValue).forEach(function(r){var t=i.initialValue[r];if(Array.isArray(t)&&i.builder){var e=i.form.controls[r];i.cleanArray(e),t.forEach(function(t,e){i.form.get(r).insert(e,i.params.arrControlFactory(t))})}}),this.form.patchValue(r,{emitEvent:this.params.emitEvent});var n=this.isKeyBased?Xt(this.getQuery().getValue(),this.getStore().storeName+"."+this.factoryFnOrPath,r):((e={})[this.params.formKey]=r,e);this.updateStore(n)},ye.prototype.cleanArray=function(t){for(;0!==t.length;)t.removeAt(0)},ye.prototype.resolveInitialValue=function(t,n){var o=this;if(t)return Object.keys(t).reduce(function(t,r){var e=n[r];if(Array.isArray(e)&&o.builder){var i=o.params.arrControlFactory;o.cleanArray(o.form.get(r)),e.forEach(function(t,e){o.form.get(r).insert(e,i(t))})}return t[r]=n[r],t},{})},ye.prototype.activate=function(){var t,r,i=this;if(this.isKeyBased)if(this.isRootKeys)this.initialValue=this.resolveInitialValue(this.form.value,this.getQuery().getValue()),this.form.patchValue(this.initialValue,{emitEvent:this.params.emitEvent});else{r=this.getStore().storeName+"."+this.factoryFnOrPath;var e=Wt(this.getQuery().getValue(),r);this.initialValue=this.resolveInitialValue(e,e),this.form.patchValue(this.initialValue,{emitEvent:this.params.emitEvent})}else{this.getQuery().getValue()[this.params.formKey]||(S("@PersistNgFormPlugin activate"),this.updateStore(((t={})[this.params.formKey]=this.factoryFnOrPath(),t)));var n=this.getQuery().getValue()[this.params.formKey];this.form.patchValue(n)}this.formChanges=this.form.valueChanges.pipe(A.debounceTime(this.params.debounceTime)).subscribe(function(e){var t;S("@PersistForm - Update"),t=i.isKeyBased?i.isRootKeys?function(t){return j({},t,e)}:function(t){return Xt(t,r,e)}:function(){var t;return(t={})[i.params.formKey]=e,t},i.updateStore(t(i.getQuery().getValue()))})},ye.prototype.destroy=function(){this.formChanges&&this.formChanges.unsubscribe(),this.form=null,this.builder=null},ye);function ye(t,e,r){void 0===r&&(r={});var i=he.call(this,t)||this;return i.query=t,i.factoryFnOrPath=e,i.params=r,i.params=j({debounceTime:300,formKey:"akitaForm",emitEvent:!1,arrControlFactory:function(t){return i.builder.control(t)}},r),i.isRootKeys=!1===q(e),i.isKeyBased=Vt(e)||i.isRootKeys,i}function de(t){return t&&t.charAt(0).toUpperCase()+t.slice(1)}var ve=[];var ge=(be.prototype.getEntity=function(t){return this.entities.get(t)},be.prototype.hasEntity=function(t){return this.entities.has(t)},be.prototype.removeEntity=function(t){return this.destroy(t),this.entities["delete"](t)},be.prototype.createEntity=function(t,e){return this.entities.set(t,e)},be.prototype.getIds=function(){return mt(this.entityIds)?this.query.getValue().ids:yt(this.entityIds)},be.prototype.resolvedIds=function(t){return mt(t)?this.getIds():yt(t)},be.prototype.rebase=function(r,i){var n=this;if(void 0===i&&(i={}),q(r))if(mt(this.entityIds)){for(var t=0,e=r.length;t<e;t++){var o=r[t];if(!1===this.hasEntity(o)){Q(i.beforeAdd)&&i.beforeAdd(o);var s=this.instantiatePlugin(o);this.entities.set(o,s),Q(i.afterAdd)&&i.afterAdd(s)}}this.entities.forEach(function(t,e){-1===r.indexOf(e)&&(Q(i.beforeRemove)&&i.beforeRemove(t),n.removeEntity(e))})}else{var a=yt(this.entityIds);for(t=0,e=a.length;t<e;t++)o=a[t],-1<r.indexOf(o)&&!1===this.hasEntity(o)?(Q(i.beforeAdd)&&i.beforeAdd(o),s=this.instantiatePlugin(o),this.entities.set(o,s),Q(i.afterAdd)&&i.afterAdd(s)):this.entities.forEach(function(t,e){-1===r.indexOf(e)&&!0===n.hasEntity(e)&&(Q(i.beforeRemove)&&i.beforeRemove(t),n.removeEntity(e))})}else this.getIds().forEach(function(t){n.hasEntity(t)||n.createEntity(t,n.instantiatePlugin(t))})},be.prototype.selectIds=function(){return this.query.select(function(t){return t.ids})},be.prototype.activate=function(t){this.rebase(t)},be.prototype.forEachId=function(t,e){for(var r=this.resolvedIds(t),i=0,n=r.length;i<n;i++){var o=r[i];this.hasEntity(o)&&e(this.getEntity(o))}},be);function be(t,e){this.query=t,this.entityIds=e,this.entities=new Map}var me,Se=(t(Pe,me=oe),Object.defineProperty(Pe.prototype,"hasPast$",{get:function(){return this._hasPast$},enumerable:!0,configurable:!0}),Object.defineProperty(Pe.prototype,"hasFuture$",{get:function(){return this._hasFuture$},enumerable:!0,configurable:!0}),Object.defineProperty(Pe.prototype,"hasPast",{get:function(){return 0<this.history.past.length},enumerable:!0,configurable:!0}),Object.defineProperty(Pe.prototype,"hasFuture",{get:function(){return 0<this.history.future.length},enumerable:!0,configurable:!0}),Object.defineProperty(Pe.prototype,"property",{get:function(){return this.params.watchProperty},enumerable:!0,configurable:!0}),Pe.prototype.updateHasHistory=function(){this.hasFutureSubject.next(this.hasFuture),this.hasPastSubject.next(this.hasPast)},Pe.prototype.activate=function(){var o=this;this.hasPastSubject=new s.BehaviorSubject(!1),this._hasPast$=this.hasPastSubject.asObservable().pipe(A.distinctUntilChanged()),this.hasFutureSubject=new s.BehaviorSubject(!1),this._hasFuture$=this.hasFutureSubject.asObservable().pipe(A.distinctUntilChanged()),this.history.present=this.getSource(this._entityId,this.property),this.subscription=this.selectSource(this._entityId,this.property).pipe(A.pairwise()).subscribe(function(t){var e=I(t,2),r=e[0],i=e[1];if(o.skip)o.skip=!1;else{var n=o.params.comparator(r,i);!o.skipUpdate&&n&&(o.history.past.length===o.params.maxAge&&(o.history.past=o.history.past.slice(1)),o.history.past=m(o.history.past,[r]),o.history.present=i,o.updateHasHistory())}})},Pe.prototype.undo=function(){if(0<this.history.past.length){var t=this.history,e=t.past,r=t.present,i=e[e.length-1];this.history.past=e.slice(0,e.length-1),this.history.present=i,this.history.future=m([r],this.history.future),this.update()}},Pe.prototype.redo=function(){if(0<this.history.future.length){var t=this.history,e=t.past,r=t.present,i=this.history.future[0],n=this.history.future.slice(1);this.history.past=m(e,[r]),this.history.present=i,this.history.future=n,this.update("Redo")}},Pe.prototype.jumpToPast=function(t){if(!(t<0||t>=this.history.past.length)){var e=this.history,r=e.past,i=e.future,n=e.present,o=r.slice(0,t),s=m(r.slice(t+1),[n],i),a=r[t];this.history.past=o,this.history.present=a,this.history.future=s,this.update()}},Pe.prototype.jumpToFuture=function(t){if(!(t<0||t>=this.history.future.length)){var e=this.history,r=e.past,i=e.future,n=m(r,[e.present],i.slice(0,t)),o=i[t],s=i.slice(t+1);this.history.past=n,this.history.present=o,this.history.future=s,this.update("Redo")}},Pe.prototype.jump=function(t){return 0<t?this.jumpToFuture(t-1):t<0?this.jumpToPast(this.history.past.length+t):void 0},Pe.prototype.clear=function(t){this.history=Q(t)?t(this.history):{past:[],present:null,future:[]},this.updateHasHistory()},Pe.prototype.destroy=function(t){void 0===t&&(t=!1),t&&this.clear(),this.subscription.unsubscribe()},Pe.prototype.ignoreNext=function(){this.skip=!0},Pe.prototype.update=function(t){void 0===t&&(t="Undo"),this.skipUpdate=!0,S("@StateHistory - "+t),this.updateStore(this.history.present,this._entityId,this.property),this.updateHasHistory(),this.skipUpdate=!1},Pe);function Pe(t,e,r){void 0===e&&(e={});var i=me.call(this,t,{resetFn:function(){return i.clear()}})||this;return i.query=t,i.params=e,i._entityId=r,i.skip=!1,i.history={past:[],present:null,future:[]},i.skipUpdate=!1,e.maxAge=e.maxAge?e.maxAge:10,e.comparator=e.comparator||function(){return!0},i.activate(),i}var Ee,_e=(t(Oe,Ee=ge),Oe.prototype.redo=function(t){this.forEachId(t,function(t){return t.redo()})},Oe.prototype.undo=function(t){this.forEachId(t,function(t){return t.undo()})},Oe.prototype.hasPast=function(t){if(this.hasEntity(t))return this.getEntity(t).hasPast},Oe.prototype.hasFuture=function(t){if(this.hasEntity(t))return this.getEntity(t).hasFuture},Oe.prototype.jumpToFuture=function(t,e){this.forEachId(t,function(t){return t.jumpToFuture(e)})},Oe.prototype.jumpToPast=function(t,e){this.forEachId(t,function(t){return t.jumpToPast(e)})},Oe.prototype.clear=function(t){this.forEachId(t,function(t){return t.clear()})},Oe.prototype.destroy=function(t,e){void 0===e&&(e=!1),this.forEachId(t,function(t){return t.destroy(e)})},Oe.prototype.ignoreNext=function(t){this.forEachId(t,function(t){return t.ignoreNext()})},Oe.prototype.instantiatePlugin=function(t){return new Se(this.query,this.params,t)},Oe);function Oe(t,e){void 0===e&&(e={});var r=Ee.call(this,t,e.entityIds)||this;return r.query=t,(r.params=e).maxAge=q(e.maxAge)?e.maxAge:10,r.activate(),r.selectIds().pipe(A.skip(1)).subscribe(function(t){return r.activate(t)}),r}var Ae={comparator:function(t,e){return JSON.stringify(t)!==JSON.stringify(e)}};function we(t,e){return e.split(".").reduce(function(t,e){return t&&"undefined"!==t[e]?t[e]:undefined},t)}var je,xe=(t(Ie,je=oe),Ie.prototype.reset=function(t){void 0===t&&(t={});var e=this.head;Q(t.updateFn)&&(e=this.isEntityBased(this._entityId)?t.updateFn(this.head,this.getQuery().getEntity(this._entityId)):t.updateFn(this.head,this.getQuery().getValue())),S("@DirtyCheck - Revert"),this.updateStore(e,this._entityId),this._reset.next()},Ie.prototype.setHead=function(){return this.active?this.head=this._getHead():(this.activate(),this.active=!0),this.updateDirtiness(!1),this},Ie.prototype.isDirty=function(){return!!this.dirty.value},Ie.prototype.hasHead=function(){return!!this.getHead()},Ie.prototype.destroy=function(){this.head=null,this.subscription&&this.subscription.unsubscribe(),this._reset&&this._reset.complete()},Ie.prototype.isPathDirty=function(t){var e=this.getHead(),r=we(this.getQuery().getValue(),t),i=we(e,t);return this.params.comparator(r,i)},Ie.prototype.getHead=function(){return this.head},Ie.prototype.activate=function(){var i=this;this.head=this._getHead();var t=this.params.watchProperty?this.params.watchProperty.map(function(e){return i.query.select(function(t){return t[e]}).pipe(A.map(function(t){return{val:t,__akitaKey:e}}))}):[this.selectSource(this._entityId)];this.subscription=s.combineLatest.apply(void 0,m(t)).pipe(A.skip(1)).subscribe(function(t){if(!mt(i.head)){var e=t.some(function(t){var e=t.__akitaKey?i.head[t.__akitaKey]:i.head,r=t.__akitaKey?t.val:t;return i.params.comparator(e,r)});i.updateDirtiness(e)}})},Ie.prototype.updateDirtiness=function(t){this.dirty.next(t)},Ie.prototype._getHead=function(){var t=this.getSource(this._entityId);return this.params.watchProperty&&(t=this.getWatchedValues(t)),t},Ie.prototype.getWatchedValues=function(r){return this.params.watchProperty.reduce(function(t,e){return t[e]=r[e],t},{})},Ie);function Ie(t,e,r){var i=je.call(this,t)||this;if(i.query=t,i.params=e,i._entityId=r,i.dirty=new s.BehaviorSubject(!1),i.active=!1,i._reset=new s.Subject,i.isDirty$=i.dirty.asObservable().pipe(A.distinctUntilChanged()),i.reset$=i._reset.asObservable(),i.params=j({},Ae,e),i.params.watchProperty){var n=yt(i.params.watchProperty);t instanceof $t&&n.includes("entities")&&!n.includes("ids")&&n.push("ids"),i.params.watchProperty=n}return i}var Ce,ke=(t(Ue,Ce=ge),Ue.prototype.setHead=function(t){if(this.params.entityIds&&t){var e=yt(t);if(!1===yt(this.params.entityIds).some(function(t){return-1<e.indexOf(t)}))return this}return this.forEachId(t,function(t){return t.setHead()}),this._someDirty.next(),this},Ue.prototype.hasHead=function(t){return!!this.entities.has(t)&&this.getEntity(t).hasHead()},Ue.prototype.reset=function(t,e){void 0===e&&(e={}),this.forEachId(t,function(t){return t.reset(e)})},Ue.prototype.isDirty=function(t,e){if(void 0===e&&(e=!0),this.entities.has(t)){var r=this.getEntity(t);return e?r.isDirty$:r.isDirty()}return!1},Ue.prototype.someDirty=function(){return this.checkSomeDirty()},Ue.prototype.isPathDirty=function(t,e){if(this.entities.has(t)){var r=this.getEntity(t).getHead(),i=we(this.query.getEntity(t),e),n=we(r,e);return this.params.comparator(i,n)}return null},Ue.prototype.destroy=function(t){this.forEachId(t,function(t){return t.destroy()}),t||this._someDirty.complete()},Ue.prototype.instantiatePlugin=function(t){return new xe(this.query,this.params,t)},Ue.prototype.checkSomeDirty=function(){var t,e,r=this.resolvedIds();try{for(var i=x(r),n=i.next();!n.done;n=i.next()){var o=n.value;if(this.getEntity(o).isDirty())return!0}}catch(s){t={error:s}}finally{try{n&&!n.done&&(e=i["return"])&&e.call(i)}finally{if(t)throw t.error}}return!1},Ue);function Ue(t,e){void 0===e&&(e={});var r=Ce.call(this,t,e.entityIds)||this;return r.query=t,r.params=e,r._someDirty=new s.Subject,r.someDirty$=s.merge(r.query.select(function(t){return t.entities}),r._someDirty.asObservable()).pipe(A.auditTime(0),A.map(function(){return r.checkSomeDirty()})),r.params=j({},Ae,e),r.activate(),r.selectIds().pipe(A.skip(1)).subscribe(function(t){Ce.prototype.rebase.call(r,t,{afterAdd:function(t){return t.setHead()}})}),r}var Te={Update:0,AddEntities:1,SetEntities:2,UpdateEntities:3,RemoveEntities:4,UpsertEntities:5};function Fe(r,t,e,i){var n;if(void 0===i&&(i=_t),Q(t))n=t;else{var o=yt(t);n=function(t){return!0===o.includes(ht(t)?t[i]:t)}}function s(t){return t.map(function(t){return!0===n(t)?ht(t)?j({},t,e):e:t})}return p(r)?s(r):function(t){var e;return(e={})[r]=s(t[r]),e}}function Ne(r,t,e){void 0===e&&(e={});function i(t){return e.prepend?m(n,t||[]):m(t||[],n)}var n=yt(t);return p(r)?i(r):function(t){var e;return(e={})[r]=i(t[r]),e}}Te[Te.Update]="Update",Te[Te.AddEntities]="AddEntities",Te[Te.SetEntities]="SetEntities",Te[Te.UpdateEntities]="UpdateEntities",Te[Te.RemoveEntities]="RemoveEntities",Te[Te.UpsertEntities]="UpsertEntities";function Ve(){}i.EntityStore=Ot,i.EntityUIStore=jt,i.QueryEntity=$t,i.EntityUIQuery=qt,i.Query=Rt,i.Store=ct,i.applyTransaction=at,i.transaction=ut,i.commit=st,i.endBatch=nt,i.isTransactionInProcess=ot,i.startBatch=it,i.transactionManager=rt,i.withTransaction=function De(e){return function(t){return t.pipe(A.tap(function(t){return at(function(){return e(t)})}))}},i.filterNil=Jt,i.DEFAULT_ID_KEY=_t,i.action=E,i.setAction=w,i.setSkipAction=P,i.logAction=S,i.currentAction=g,i.resetCustomAction=b,i.SnapshotManager=re,i.snapshotManager=ne,i.configKey=Y,i.StoreConfig=function Ke(n){return function(t){t[Y]={idKey:"id"};for(var e=0,r=Object.keys(n);e<r.length;e++){var i=r[e];"name"===i?t[Y].storeName=n[i]:t[Y][i]=n[i]}}},i.QueryConfig=function Re(n){return function(t){t[Kt]={};for(var e=0,r=Object.keys(n);e<r.length;e++){var i=r[e];t[Kt][i]=n[i]}}},i.queryConfigKey=Kt,i.akitaConfig=function Be(t){_=j({},_,t)},i.getAkitaConfig=O,i.compareValues=Tt,i.Order=Ut,i.AkitaPlugin=oe,i.Paginator=fe,i.PaginatorPlugin=ce,i.PersistNgFormPlugin=le,i.persistState=function He(t){var e={key:"AkitaStores",enableInNonBrowser:!1,storage:J()?localStorage:t.storage,deserialize:JSON.parse,serialize:JSON.stringify,include:[],exclude:[],persistOnDestroy:!1,preStorageUpdate:function(t,e){return e},preStoreUpdate:function(t,e){return e},skipStorageUpdate:te,preStorageUpdateOperator:function(){return function(t){return t}}},r=Object.assign({},e,t),a=r.storage,i=r.enableInNonBrowser,u=r.deserialize,c=r.serialize,n=r.include,p=r.exclude,h=r.key,f=r.preStorageUpdate,l=r.persistOnDestroy,y=r.preStorageUpdateOperator,d=r.preStoreUpdate,v=r.skipStorageUpdate;if((!X||i)&&a){var g,b=0<n.length,m=0<p.length;if(b&&m)throw new H("You can't use both include and exclude");b&&(g=n.reduce(function(t,e){Q(e)?t.fns.push(e):t[e.split(".")[0]]=e;return t},{fns:[]}));var S={},P={},E=[],_=[],O=J()&&a===localStorage||function(){try{return"undefined"!=typeof sessionStorage}catch(t){return!1}}()&&a===sessionStorage;return ee(a.getItem(h)).subscribe(function(t){var n=ht(t)?t:u(t||"{}");function i(t){n.$cache=j({},n.$cache||{},t),n=Object.assign({},n,P),_.push(a.setItem(h,O?c(n):n)),function e(t){ee(t).subscribe(function(){var t=_.shift();t&&e(t)})}(_.shift())}function o(e,r){S[e]=G[e]._select(function(t){return Wt(t,r)}).pipe(A.skip(1),A.filter(function(){return!1===v()}),y()).subscribe(function(t){P[e]=f(e,t),Promise.resolve().then(function(){var t;return i(((t={})[e]=G[e]._cache().getValue(),t))})})}function s(e,t,r){if(e in n){w("@PersistState"),t._setState(function(t){return Xt(t,r,d(e,n[e]))});var i=!!n.$cache&&n.$cache[e];G[e].setHasCache(i,{restartTTL:!0})}}E.push(U.subscribe(function(t){var e;S[t]&&(!1===l&&i(((e={})[t]=!1,e)),S[t].unsubscribe(),delete S[t])})),E.push(F.subscribe(function(e){if(!("router"===e||m&&p.includes(e))){var t=G[e];if(b){var r=g[e];if(!r){if(!g.fns.some(function(t){return t(e)}))return;r=e}s(e,t,r),o(e,r)}else s(e,t,e),o(e,e)}})),Gt.next()}),{destroy:function(){E.forEach(function(t){return t.unsubscribe()});for(var t=0,e=Object.keys(S);t<e.length;t++){var r=e[t];S[r].unsubscribe()}S={}},clear:function(){a.clear()},clearStore:function(r){$(r)?ee(a.setItem(h,"{}")).subscribe():ee(a.getItem(h)).subscribe(function(t){var e=u(t||"{}");e[r]&&(delete e[r],ee(a.setItem(h,c(e))).subscribe())})}}}},i.selectPersistStateInit=function Me(){return Gt.asObservable()},i.akitaDevtools=function $e(o,u){if(void 0===u&&(u={}),!X&&window.__REDUX_DEVTOOLS_EXTENSION__){ve.length&&ve.forEach(function(t){t.unsubscribe?t.unsubscribe():t&&t()}),o&&o.run||((o=o||{}).run=function(t){return t()},u=o);var t=Object.assign({},{name:"Akita",shallow:!0,storesWhitelist:[]},u),e=t.storesWhitelist,c=window.__REDUX_DEVTOOLS_EXTENSION__.connect(t),p={},h=function(t){return!e.length||-1<e.indexOf(t)};ve.push(F.subscribe(function(t){var e;!1!==h(t)&&(p=j({},p,((e={})[t]=G[t]._value(),e)),c.send({type:"["+de(t)+"] - @@INIT"},p))})),ve.push(U.subscribe(function(t){!1!==h(t)&&(delete p[t],c.send({type:"["+t+"] - Delete Store"},p))})),ve.push(N.subscribe(function(t){var e;if(!1!==h(t)){var r=g.type,i=g.entityIds;if(g.skip)P(!1);else{var n=G[t];if(n){if(!1===u.shallow&&p[t])if(JSON.stringify(n._value())===JSON.stringify(p[t]))return;p=j({},p,((e={})[t]=n._value(),e));var o=de(t),s=L(i)?"["+o+"] - "+r+" (ids: "+i+")":"["+o+"] - "+r;if(u.logTrace&&(console.group(s),console.trace(),console.groupEnd()),u.sortAlphabetically){var a=Object.keys(p).sort().reduce(function(t,e){return t[e]=p[e],t},{});c.send({type:s},a)}else c.send({type:s},p)}}}})),ve.push(c.subscribe(function(t){if("DISPATCH"===t.type){if("COMMIT"===t.payload.type)return void c.init(p);if(t.state)for(var i=JSON.parse(t.state),e=function(t,e){var r=e[t];G[r]&&o.run(function(){G[r]._setState(function(){return i[r]},!1)})},r=0,n=Object.keys(i);r<n.length;r++)e(r,n)}}))}},i.EntityCollectionPlugin=ge,i.StateHistoryPlugin=Se,i.EntityStateHistoryPlugin=_e,i.dirtyCheckDefaultParams=Ae,i.DirtyCheckPlugin=xe,i.getNestedPath=we,i.EntityDirtyCheckPlugin=ke,i.guid=function Le(){return"xxxxxx4xyx".replace(/[xy]/g,function(t){var e=16*Math.random()|0;return("x"==t?e:3&e|8).toString(16)})},i.setEntities=u,i.isEntityState=d,i.toEntitiesIds=function Qe(t,e){var r,i;void 0===e&&(e=_t);var n=[];try{for(var o=x(t),s=o.next();!s.done;s=o.next()){var a=s.value;n.push(a[e])}}catch(u){r={error:u}}finally{try{s&&!s.done&&(i=o["return"])&&i.call(o)}finally{if(r)throw r.error}}return n},i.toEntitiesObject=f,i.hasEntity=C,i.hasActiveState=l,i.getExitingActives=a,i.isMultiActiveState=o,i.resolveActiveEntity=y,i.isEmpty=h,i.coerceArray=yt,i.updateEntities=bt,i.removeEntities=dt,i.removeAllEntities=vt,i.getInitialEntitiesState=gt,i.getActiveEntities=ft,i.addEntities=lt,i.resetStores=function qe(a){a=Object.assign({},{exclude:[]},a);var u=Object.keys(G);at(function(){var t,e;try{for(var r=x(u),i=r.next();!i.done;i=r.next()){var n=i.value,o=G[n];a.exclude?-1===a.exclude.indexOf(o.storeName)&&o.reset():o.reset()}}catch(s){t={error:s}}finally{try{i&&!i.done&&(e=r["return"])&&e.call(r)}finally{if(t)throw t.error}}})},i.isObject=ht,i.isPlainObject=z,i.isFunction=Q,i.isArray=p,i.toBoolean=q,i.isUndefined=mt,i.isNil=$,i.isString=Vt,i.isNumber=function ze(t){return!p(t)&&0<=t-parseFloat(t)+1},i.isDefined=L,i.setValue=Xt,i.getValue=Wt,i.sortByOptions=Ht,i.entitiesToArray=Ft,i.entitiesToMap=Nt,i.__stores__=G,i.isDev=R,i.enableAkitaProdMode=function Je(){i.__DEV__=!1},i.isNotBrowser=X,i.runStoreAction=function We(t,e,r){var i=G[t];if($(i))throw new H(t+" doesn't exist");switch(e){case Te.SetEntities:var n=r.payload;return void i.set(n.data);case Te.AddEntities:n=r.payload;return void i.add(n.data,n.params);case Te.UpdateEntities:n=r.payload;return void i.update(n.entityIds,n.data);case Te.RemoveEntities:n=r.payload;return void i.remove(n.entityIds);case Te.UpsertEntities:return void((n=r.payload).entityIds?i.upsert(n.entityIds,n.data):Array.isArray(n.data)?i.upsertMany(n.data):i.upsertMany([n.data]));case Te.Update:n=r.payload;return void i.update(n.data)}},i.StoreActions=Te,i.arrayUpdate=Fe,i.arrayAdd=Ne,i.arrayUpsert=function Xe(t,e,r,i){var n;void 0===i&&(i=_t);var o=ht(r);return t.some(function(t){return o?t[i]===e:t===e})?Fe(t,e,r,i):Ne(t,o?j({},r,((n={})[i]=e,n)):r)},i.arrayFind=function Ye(e,r){return function(t){return t.pipe(A.map(function(t){return!1===p(t)?t:It(t,e,r||_t)}),Ct(),A.map(function(t){return!1===p(t)?t:p(e)||Q(e)?t:t[0]}))}},i.distinctUntilArrayItemChanged=Ct,i.find=It,i.arrayRemove=function Ge(r,t,e){var i,n;return void 0===e&&(e=_t),n=Q(t)?function o(r){return function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return!r.apply(void 0,m(t))}}(t):(i=yt(t),function(t){return!1===i.includes(ht(t)?t[e]:t)}),Array.isArray(r)?r.filter(n):function(t){var e;return(e={})[r]=t[r].filter(n),e}},i.createEntityQuery=function Ze(t,e){return void 0===e&&(e={}),new $t(t,e)},i.createEntityStore=function tr(t,e){return new Ot(t,e)},i.createQuery=function er(t){return new Rt(t)},i.createStore=function rr(t,e){return new ct(t,e)},i.cacheable=function ir(t,e,r){return void 0===r&&(r={emitNext:!1}),t._cache().value?r.emitNext?s.of(undefined):s.EMPTY:e},i.combineQueries=function nr(t){return s.combineLatest(t).pipe(A.auditTime(0))},i.EntityService=Ve,i.setLoading=function or(e){return function(t){return s.defer(function(){return e.setLoading(!0),t.pipe(A.finalize(function(){return e.setLoading(!1)}))})}},i.EntityActions=St,i.dispatchDeleted=V,i.dispatchAdded=D,i.dispatchUpdate=K,i.$$deleteStore=U,i.$$addStore=F,i.$$updateStore=N,i.a=W,Object.defineProperty(i,"__esModule",{value:!0})});
//# sourceMappingURL=datorama-akita.umd.min.js.map