/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
import { pairwise, distinctUntilChanged } from 'rxjs/operators';
import { BehaviorSubject } from 'rxjs';
import { AkitaPlugin } from '../plugin';
import { logAction } from '../../actions';
import { isFunction } from '../../isFunction';
/**
 * @record
 */
export function StateHistoryParams() { }
if (false) {
    /** @type {?|undefined} */
    StateHistoryParams.prototype.maxAge;
    /** @type {?|undefined} */
    StateHistoryParams.prototype.watchProperty;
    /** @type {?|undefined} */
    StateHistoryParams.prototype.comparator;
}
/**
 * @template State
 */
var /**
 * @template State
 */
StateHistoryPlugin = /** @class */ (function (_super) {
    tslib_1.__extends(StateHistoryPlugin, _super);
    function StateHistoryPlugin(query, params, _entityId) {
        if (params === void 0) { params = {}; }
        var _this = _super.call(this, query, {
            resetFn: (/**
             * @return {?}
             */
            function () { return _this.clear(); })
        }) || this;
        _this.query = query;
        _this.params = params;
        _this._entityId = _entityId;
        /**
         * Allow skipping an update from outside
         */
        _this.skip = false;
        _this.history = {
            past: [],
            present: null,
            future: []
        };
        /**
         * Skip the update when redo/undo
         */
        _this.skipUpdate = false;
        params.maxAge = !!params.maxAge ? params.maxAge : 10;
        params.comparator = params.comparator || ((/**
         * @return {?}
         */
        function () { return true; }));
        _this.activate();
        return _this;
    }
    Object.defineProperty(StateHistoryPlugin.prototype, "hasPast$", {
        /**
         * Observable stream representing whether the history plugin has an available past
         *
         */
        get: /**
         * Observable stream representing whether the history plugin has an available past
         *
         * @return {?}
         */
        function () {
            return this._hasPast$;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(StateHistoryPlugin.prototype, "hasFuture$", {
        /**
         * Observable stream representing whether the history plugin has an available future
         *
         */
        get: /**
         * Observable stream representing whether the history plugin has an available future
         *
         * @return {?}
         */
        function () {
            return this._hasFuture$;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(StateHistoryPlugin.prototype, "hasPast", {
        get: /**
         * @return {?}
         */
        function () {
            return this.history.past.length > 0;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(StateHistoryPlugin.prototype, "hasFuture", {
        get: /**
         * @return {?}
         */
        function () {
            return this.history.future.length > 0;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(StateHistoryPlugin.prototype, "property", {
        get: /**
         * @private
         * @return {?}
         */
        function () {
            return this.params.watchProperty;
        },
        enumerable: true,
        configurable: true
    });
    /* Updates the hasPast$ hasFuture$ observables*/
    /* Updates the hasPast$ hasFuture$ observables*/
    /**
     * @private
     * @return {?}
     */
    StateHistoryPlugin.prototype.updateHasHistory = /* Updates the hasPast$ hasFuture$ observables*/
    /**
     * @private
     * @return {?}
     */
    function () {
        this.hasFutureSubject.next(this.hasFuture);
        this.hasPastSubject.next(this.hasPast);
    };
    /**
     * @return {?}
     */
    StateHistoryPlugin.prototype.activate = /**
     * @return {?}
     */
    function () {
        var _this = this;
        this.hasPastSubject = new BehaviorSubject(false);
        this._hasPast$ = this.hasPastSubject.asObservable().pipe(distinctUntilChanged());
        this.hasFutureSubject = new BehaviorSubject(false);
        this._hasFuture$ = this.hasFutureSubject.asObservable().pipe(distinctUntilChanged());
        this.history.present = this.getSource(this._entityId, this.property);
        this.subscription = ((/** @type {?} */ (this)))
            .selectSource(this._entityId, this.property)
            .pipe(pairwise())
            .subscribe((/**
         * @param {?} __0
         * @return {?}
         */
        function (_a) {
            var _b = tslib_1.__read(_a, 2), past = _b[0], present = _b[1];
            if (_this.skip) {
                _this.skip = false;
                return;
            }
            /**
             *  comparator: (prev, current) => isEqual(prev, current) === false
             * @type {?}
             */
            var shouldUpdate = _this.params.comparator(past, present);
            if (!_this.skipUpdate && shouldUpdate) {
                if (_this.history.past.length === _this.params.maxAge) {
                    _this.history.past = _this.history.past.slice(1);
                }
                _this.history.past = tslib_1.__spread(_this.history.past, [past]);
                _this.history.present = present;
                _this.updateHasHistory();
            }
        }));
    };
    /**
     * @return {?}
     */
    StateHistoryPlugin.prototype.undo = /**
     * @return {?}
     */
    function () {
        if (this.history.past.length > 0) {
            var _a = this.history, past = _a.past, present = _a.present;
            /** @type {?} */
            var previous = past[past.length - 1];
            this.history.past = past.slice(0, past.length - 1);
            this.history.present = previous;
            this.history.future = tslib_1.__spread([present], this.history.future);
            this.update();
        }
    };
    /**
     * @return {?}
     */
    StateHistoryPlugin.prototype.redo = /**
     * @return {?}
     */
    function () {
        if (this.history.future.length > 0) {
            var _a = this.history, past = _a.past, present = _a.present;
            /** @type {?} */
            var next = this.history.future[0];
            /** @type {?} */
            var newFuture = this.history.future.slice(1);
            this.history.past = tslib_1.__spread(past, [present]);
            this.history.present = next;
            this.history.future = newFuture;
            this.update('Redo');
        }
    };
    /**
     * @param {?} index
     * @return {?}
     */
    StateHistoryPlugin.prototype.jumpToPast = /**
     * @param {?} index
     * @return {?}
     */
    function (index) {
        if (index < 0 || index >= this.history.past.length)
            return;
        var _a = this.history, past = _a.past, future = _a.future, present = _a.present;
        /**
         *
         * const past = [1, 2, 3, 4, 5];
         * const present = 6;
         * const future = [7, 8, 9];
         * const index = 2;
         *
         * newPast = past.slice(0, index) = [1, 2];
         * newPresent = past[index] = 3;
         * newFuture = [...past.slice(index + 1),present, ...future] = [4, 5, 6, 7, 8, 9];
         *
         * @type {?}
         */
        var newPast = past.slice(0, index);
        /** @type {?} */
        var newFuture = tslib_1.__spread(past.slice(index + 1), [present], future);
        /** @type {?} */
        var newPresent = past[index];
        this.history.past = newPast;
        this.history.present = newPresent;
        this.history.future = newFuture;
        this.update();
    };
    /**
     * @param {?} index
     * @return {?}
     */
    StateHistoryPlugin.prototype.jumpToFuture = /**
     * @param {?} index
     * @return {?}
     */
    function (index) {
        if (index < 0 || index >= this.history.future.length)
            return;
        var _a = this.history, past = _a.past, future = _a.future, present = _a.present;
        /**
         *
         * const past = [1, 2, 3, 4, 5];
         * const present = 6;
         * const future = [7, 8, 9, 10]
         * const index = 1
         *
         * newPast = [...past, present, ...future.slice(0, index) = [1, 2, 3, 4, 5, 6, 7];
         * newPresent = future[index] = 8;
         * newFuture = futrue.slice(index+1) = [9, 10];
         *
         * @type {?}
         */
        var newPast = tslib_1.__spread(past, [present], future.slice(0, index));
        /** @type {?} */
        var newPresent = future[index];
        /** @type {?} */
        var newFuture = future.slice(index + 1);
        this.history.past = newPast;
        this.history.present = newPresent;
        this.history.future = newFuture;
        this.update('Redo');
    };
    /**
     *
     * jump n steps in the past or forward
     *
     */
    /**
     *
     * jump n steps in the past or forward
     *
     * @param {?} n
     * @return {?}
     */
    StateHistoryPlugin.prototype.jump = /**
     *
     * jump n steps in the past or forward
     *
     * @param {?} n
     * @return {?}
     */
    function (n) {
        if (n > 0)
            return this.jumpToFuture(n - 1);
        if (n < 0)
            return this.jumpToPast(this.history.past.length + n);
    };
    /**
     * Clear the history
     *
     * @param customUpdateFn Callback function for only clearing part of the history
     *
     * @example
     *
     * stateHistory.clear((history) => {
     *  return {
     *    past: history.past,
     *    present: history.present,
     *    future: []
     *  };
     * });
     */
    /**
     * Clear the history
     *
     * \@example
     *
     * stateHistory.clear((history) => {
     *  return {
     *    past: history.past,
     *    present: history.present,
     *    future: []
     *  };
     * });
     * @param {?=} customUpdateFn Callback function for only clearing part of the history
     *
     * @return {?}
     */
    StateHistoryPlugin.prototype.clear = /**
     * Clear the history
     *
     * \@example
     *
     * stateHistory.clear((history) => {
     *  return {
     *    past: history.past,
     *    present: history.present,
     *    future: []
     *  };
     * });
     * @param {?=} customUpdateFn Callback function for only clearing part of the history
     *
     * @return {?}
     */
    function (customUpdateFn) {
        this.history = isFunction(customUpdateFn)
            ? customUpdateFn(this.history)
            : {
                past: [],
                present: null,
                future: []
            };
        this.updateHasHistory();
    };
    /**
     * @param {?=} clearHistory
     * @return {?}
     */
    StateHistoryPlugin.prototype.destroy = /**
     * @param {?=} clearHistory
     * @return {?}
     */
    function (clearHistory) {
        if (clearHistory === void 0) { clearHistory = false; }
        if (clearHistory) {
            this.clear();
        }
        this.subscription.unsubscribe();
    };
    /**
     * @return {?}
     */
    StateHistoryPlugin.prototype.ignoreNext = /**
     * @return {?}
     */
    function () {
        this.skip = true;
    };
    /**
     * @private
     * @param {?=} action
     * @return {?}
     */
    StateHistoryPlugin.prototype.update = /**
     * @private
     * @param {?=} action
     * @return {?}
     */
    function (action) {
        if (action === void 0) { action = 'Undo'; }
        this.skipUpdate = true;
        logAction("@StateHistory - " + action);
        this.updateStore(this.history.present, this._entityId, this.property);
        this.updateHasHistory();
        this.skipUpdate = false;
    };
    return StateHistoryPlugin;
}(AkitaPlugin));
/**
 * @template State
 */
export { StateHistoryPlugin };
if (false) {
    /**
     * Allow skipping an update from outside
     * @type {?}
     * @private
     */
    StateHistoryPlugin.prototype.skip;
    /**
     * @type {?}
     * @private
     */
    StateHistoryPlugin.prototype.history;
    /**
     * Skip the update when redo/undo
     * @type {?}
     * @private
     */
    StateHistoryPlugin.prototype.skipUpdate;
    /**
     * @type {?}
     * @private
     */
    StateHistoryPlugin.prototype.subscription;
    /**
     * @type {?}
     * @private
     */
    StateHistoryPlugin.prototype.hasPastSubject;
    /**
     * @type {?}
     * @private
     */
    StateHistoryPlugin.prototype._hasPast$;
    /**
     * @type {?}
     * @private
     */
    StateHistoryPlugin.prototype.hasFutureSubject;
    /**
     * @type {?}
     * @private
     */
    StateHistoryPlugin.prototype._hasFuture$;
    /**
     * @type {?}
     * @protected
     */
    StateHistoryPlugin.prototype.query;
    /**
     * @type {?}
     * @private
     */
    StateHistoryPlugin.prototype.params;
    /**
     * @type {?}
     * @private
     */
    StateHistoryPlugin.prototype._entityId;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RhdGVIaXN0b3J5UGx1Z2luLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGRhdG9yYW1hL2FraXRhLyIsInNvdXJjZXMiOlsic3JjL3BsdWdpbnMvc3RhdGVIaXN0b3J5L3N0YXRlSGlzdG9yeVBsdWdpbi50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQUFBLE9BQU8sRUFBRSxRQUFRLEVBQUUsb0JBQW9CLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUNoRSxPQUFPLEVBQUUsZUFBZSxFQUFjLE1BQU0sTUFBTSxDQUFDO0FBQ25ELE9BQU8sRUFBRSxXQUFXLEVBQVcsTUFBTSxXQUFXLENBQUM7QUFDakQsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMxQyxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sa0JBQWtCLENBQUM7Ozs7QUFFOUMsd0NBSUM7OztJQUhDLG9DQUFnQjs7SUFDaEIsMkNBQXVCOztJQUN2Qix3Q0FBa0Q7Ozs7O0FBU3BEOzs7O0lBQXFELDhDQUFrQjtJQW9CckUsNEJBQXNCLEtBQXFCLEVBQVUsTUFBK0IsRUFBVSxTQUFlO1FBQXhELHVCQUFBLEVBQUEsV0FBK0I7UUFBcEYsWUFDRSxrQkFBTSxLQUFLLEVBQUU7WUFDWCxPQUFPOzs7WUFBRSxjQUFNLE9BQUEsS0FBSSxDQUFDLEtBQUssRUFBRSxFQUFaLENBQVksQ0FBQTtTQUM1QixDQUFDLFNBS0g7UUFScUIsV0FBSyxHQUFMLEtBQUssQ0FBZ0I7UUFBVSxZQUFNLEdBQU4sTUFBTSxDQUF5QjtRQUFVLGVBQVMsR0FBVCxTQUFTLENBQU07Ozs7UUFsQnJHLFVBQUksR0FBRyxLQUFLLENBQUM7UUFFYixhQUFPLEdBQUc7WUFDaEIsSUFBSSxFQUFFLEVBQUU7WUFDUixPQUFPLEVBQUUsSUFBSTtZQUNiLE1BQU0sRUFBRSxFQUFFO1NBQ1gsQ0FBQzs7OztRQUdNLGdCQUFVLEdBQUcsS0FBSyxDQUFDO1FBYXpCLE1BQU0sQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFD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InNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IHBhaXJ3aXNlLCBkaXN0aW5jdFVudGlsQ2hhbmdlZCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7IEJlaGF2aW9yU3ViamVjdCwgT2JzZXJ2YWJsZSB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgQWtpdGFQbHVnaW4sIFF1ZXJpZXMgfSBmcm9tICcuLi9wbHVnaW4nO1xuaW1wb3J0IHsgbG9nQWN0aW9uIH0gZnJvbSAnLi4vLi4vYWN0aW9ucyc7XG5pbXBvcnQgeyBpc0Z1bmN0aW9uIH0gZnJvbSAnLi4vLi4vaXNGdW5jdGlvbic7XG5cbmV4cG9ydCBpbnRlcmZhY2UgU3RhdGVIaXN0b3J5UGFyYW1zIHtcbiAgbWF4QWdlPzogbnVtYmVyO1xuICB3YXRjaFByb3BlcnR5Pzogc3RyaW5nO1xuICBjb21wYXJhdG9yPzogKHByZXZTdGF0ZSwgY3VycmVudFN0YXRlKSA9PiBib29sZWFuO1xufVxuXG5leHBvcnQgdHlwZSBIaXN0b3J5PFN0YXRlPiA9IHtcbiAgcGFzdDogU3RhdGVbXTtcbiAgcHJlc2VudDogU3RhdGUgfCBudWxsO1xuICBmdXR1cmU6IFN0YXRlW107XG59O1xuXG5leHBvcnQgY2xhc3MgU3RhdGVIaXN0b3J5UGx1Z2luPFN0YXRlID0gYW55PiBleHRlbmRzIEFraXRhUGx1Z2luPFN0YXRlPiB7XG4gIC8qKiBBbGxvdyBza2lwcGluZyBhbiB1cGRhdGUgZnJvbSBvdXRzaWRlICovXG4gIHByaXZhdGUgc2tpcCA9IGZhbHNlO1xuXG4gIHByaXZhdGUgaGlzdG9yeSA9IHtcbiAgICBwYXN0OiBbXSxcbiAgICBwcmVzZW50OiBudWxsLFxuICAgIGZ1dHVyZTogW11cbiAgfTtcblxuICAvKiogU2tpcCB0aGUgdXBkYXRlIHdoZW4gcmVkby91bmRvICovXG4gIHByaXZhdGUgc2tpcFVwZGF0ZSA9IGZhbHNlO1xuICBwcml2YXRlIHN1YnNjcmlwdGlvbjtcblxuICAvKiBTdWJqZWN0cyBmb3Igc3VwcG9ydGluZyBvYnNlcnZhYmxlIGhhc1Bhc3QkIGFuZCBoYXNGdXR1cmUkICovXG4gIHByaXZhdGUgaGFzUGFzdFN1YmplY3Q6IEJlaGF2aW9yU3ViamVjdDxib29sZWFuPjtcbiAgcHJpdmF0ZSBfaGFzUGFzdCQ6IE9ic2VydmFibGU8Ym9vbGVhbj47XG4gIHByaXZhdGUgaGFzRnV0dXJlU3ViamVjdDogQmVoYXZpb3JTdWJqZWN0PGJvb2xlYW4+O1xuICBwcml2YXRlIF9oYXNGdXR1cmUkOiBPYnNlcnZhYmxlPGJvb2xlYW4+O1xuXG4gIGNvbnN0cnVjdG9yKHByb3RlY3RlZCBxdWVyeTogUXVlcmllczxTdGF0ZT4sIHByaXZhdGUgcGFyYW1zOiBTdGF0ZUhpc3RvcnlQYXJhbXMgPSB7fSwgcHJpdmF0ZSBfZW50aXR5SWQ/OiBhbnkpIHtcbiAgICBzdXBlcihxdWVyeSwge1xuICAgICAgcmVzZXRGbjogKCkgPT4gdGhpcy5jbGVhcigpXG4gICAgfSk7XG4gICAgcGFyYW1zLm1heEFnZSA9ICEhcGFyYW1zLm1heEFnZSA/IHBhcmFtcy5tYXhBZ2UgOiAxMDtcbiAgICBwYXJhbXMuY29tcGFyYXRvciA9IHBhcmFtcy5jb21wYXJhdG9yIHx8ICgoKSA9PiB0cnVlKTtcblxuICAgIHRoaXMuYWN0aXZhdGUoKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBPYnNlcnZhYmxlIHN0cmVhbSByZXByZXNlbnRpbmcgd2hldGhlciB0aGUgaGlzdG9yeSBwbHVnaW4gaGFzIGFuIGF2YWlsYWJsZSBwYXN0XG4gICAqXG4gICAqL1xuICBnZXQgaGFzUGFzdCQoKTogT2JzZXJ2YWJsZTxib29sZWFuPiB7XG4gICAgcmV0dXJuIHRoaXMuX2hhc1Bhc3QkO1xuICB9XG5cbiAgLyoqXG4gICAqIE9ic2VydmFibGUgc3RyZWFtIHJlcHJlc2VudGluZyB3aGV0aGVyIHRoZSBoaXN0b3J5IHBsdWdpbiBoYXMgYW4gYXZhaWxhYmxlIGZ1dHVyZVxuICAgKlxuICAgKi9cbiAgZ2V0IGhhc0Z1dHVyZSQoKTogT2JzZXJ2YWJsZTxib29sZWFuPiB7XG4gICAgcmV0dXJuIHRoaXMuX2hhc0Z1dHVyZSQ7XG4gIH1cblxuICBnZXQgaGFzUGFzdCgpIHtcbiAgICByZXR1cm4gdGhpcy5oaXN0b3J5LnBhc3QubGVuZ3RoID4gMDtcbiAgfVxuXG4gIGdldCBoYXNGdXR1cmUoKSB7XG4gICAgcmV0dXJuIHRoaXMuaGlzdG9yeS5mdXR1cmUubGVuZ3RoID4gMDtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0IHByb3BlcnR5KCkge1xuICAgIHJldHVybiB0aGlzLnBhcmFtcy53YXRjaFByb3BlcnR5O1xuICB9XG5cbiAgLyogVXBkYXRlcyB0aGUgaGFzUGFzdCQgaGFzRnV0dXJlJCBvYnNlcnZhYmxlcyovXG4gIHByaXZhdGUgdXBkYXRlSGFzSGlzdG9yeSgpIHtcbiAgICB0aGlzLmhhc0Z1dHVyZVN1YmplY3QubmV4dCh0aGlzLmhhc0Z1dHVyZSk7XG4gICAgdGhpcy5oYXNQYXN0U3ViamVjdC5uZXh0KHRoaXMuaGFzUGFzdCk7XG4gIH1cblxuICBhY3RpdmF0ZSgpIHtcbiAgICB0aGlzLmhhc1Bhc3RTdWJqZWN0ID0gbmV3IEJlaGF2aW9yU3ViamVjdChmYWxzZSk7XG4gICAgdGhpcy5faGFzUGFzdCQgPSB0aGlzLmhhc1Bhc3RTdWJqZWN0LmFzT2JzZXJ2YWJsZSgpLnBpcGUoZGlzdGluY3RVbnRpbENoYW5nZWQoKSk7XG4gICAgdGhpcy5oYXNGdXR1cmVTdWJqZWN0ID0gbmV3IEJlaGF2aW9yU3ViamVjdChmYWxzZSk7XG4gICAgdGhpcy5faGFzRnV0dXJlJCA9IHRoaXMuaGFzRnV0dXJlU3ViamVjdC5hc09ic2VydmFibGUoKS5waXBlKGRpc3RpbmN0VW50aWxDaGFuZ2VkKCkpO1xuXG4gICAgdGhpcy5oaXN0b3J5LnByZXNlbnQgPSB0aGlzLmdldFNvdXJjZSh0aGlzLl9lbnRpdHlJZCwgdGhpcy5wcm9wZXJ0eSk7XG4gICAgdGhpcy5zdWJzY3JpcHRpb24gPSAodGhpcyBhcyBhbnkpXG4gICAgICAuc2VsZWN0U291cmNlKHRoaXMuX2VudGl0eUlkLCB0aGlzLnByb3BlcnR5KVxuICAgICAgLnBpcGUocGFpcndpc2UoKSlcbiAgICAgIC5zdWJzY3JpYmUoKFtwYXN0LCBwcmVzZW50XSkgPT4ge1xuICAgICAgICBpZiAodGhpcy5za2lwKSB7XG4gICAgICAgICAgdGhpcy5za2lwID0gZmFsc2U7XG4gICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIC8qKlxuICAgICAgICAgKiAgY29tcGFyYXRvcjogKHByZXYsIGN1cnJlbnQpID0+IGlzRXF1YWwocHJldiwgY3VycmVudCkgPT09IGZhbHNlXG4gICAgICAgICAqL1xuICAgICAgICBjb25zdCBzaG91bGRVcGRhdGUgPSB0aGlzLnBhcmFtcy5jb21wYXJhdG9yKHBhc3QsIHByZXNlbnQpO1xuXG4gICAgICAgIGlmICghdGhpcy5za2lwVXBkYXRlICYmIHNob3VsZFVwZGF0ZSkge1xuICAgICAgICAgIGlmICh0aGlzLmhpc3RvcnkucGFzdC5sZW5ndGggPT09IHRoaXMucGFyYW1zLm1heEFnZSkge1xuICAgICAgICAgICAgdGhpcy5oaXN0b3J5LnBhc3QgPSB0aGlzLmhpc3RvcnkucGFzdC5zbGljZSgxKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgdGhpcy5oaXN0b3J5LnBhc3QgPSBbLi4udGhpcy5oaXN0b3J5LnBhc3QsIHBhc3RdO1xuICAgICAgICAgIHRoaXMuaGlzdG9yeS5wcmVzZW50ID0gcHJlc2VudDtcbiAgICAgICAgICB0aGlzLnVwZGF0ZUhhc0hpc3RvcnkoKTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gIH1cblxuICB1bmRvKCkge1xuICAgIGlmICh0aGlzLmhpc3RvcnkucGFzdC5sZW5ndGggPiAwKSB7XG4gICAgICBjb25zdCB7IHBhc3QsIHByZXNlbnQgfSA9IHRoaXMuaGlzdG9yeTtcbiAgICAgIGNvbnN0IHByZXZpb3VzID0gcGFzdFtwYXN0Lmxlbmd0aCAtIDFdO1xuICAgICAgdGhpcy5oaXN0b3J5LnBhc3QgPSBwYXN0LnNsaWNlKDAsIHBhc3QubGVuZ3RoIC0gMSk7XG4gICAgICB0aGlzLmhpc3RvcnkucHJlc2VudCA9IHByZXZpb3VzO1xuICAgICAgdGhpcy5oaXN0b3J5LmZ1dHVyZSA9IFtwcmVzZW50LCAuLi50aGlzLmhpc3RvcnkuZnV0dXJlXTtcbiAgICAgIHRoaXMudXBkYXRlKCk7XG4gICAgfVxuICB9XG5cbiAgcmVkbygpIHtcbiAgICBpZiAodGhpcy5oaXN0b3J5LmZ1dHVyZS5sZW5ndGggPiAwKSB7XG4gICAgICBjb25zdCB7IHBhc3QsIHByZXNlbnQgfSA9IHRoaXMuaGlzdG9yeTtcbiAgICAgIGNvbnN0IG5leHQgPSB0aGlzLmhpc3RvcnkuZnV0dXJlWzBdO1xuICAgICAgY29uc3QgbmV3RnV0dXJlID0gdGhpcy5oaXN0b3J5LmZ1dHVyZS5zbGljZSgxKTtcbiAgICAgIHRoaXMuaGlzdG9yeS5wYXN0ID0gWy4uLnBhc3QsIHByZXNlbnRdO1xuICAgICAgdGhpcy5oaXN0b3J5LnByZXNlbnQgPSBuZXh0O1xuICAgICAgdGhpcy5oaXN0b3J5LmZ1dHVyZSA9IG5ld0Z1dHVyZTtcbiAgICAgIHRoaXMudXBkYXRlKCdSZWRvJyk7XG4gICAgfVxuICB9XG5cbiAganVtcFRvUGFzdChpbmRleDogbnVtYmVyKSB7XG4gICAgaWYgKGluZGV4IDwgMCB8fCBpbmRleCA+PSB0aGlzLmhpc3RvcnkucGFzdC5sZW5ndGgpIHJldHVybjtcblxuICAgIGNvbnN0IHsgcGFzdCwgZnV0dXJlLCBwcmVzZW50IH0gPSB0aGlzLmhpc3Rvcnk7XG4gICAgLyoqXG4gICAgICpcbiAgICAgKiBjb25zdCBwYXN0ID0gWzEsIDIsIDMsIDQsIDVdO1xuICAgICAqIGNvbnN0IHByZXNlbnQgPSA2O1xuICAgICAqIGNvbnN0IGZ1dHVyZSA9IFs3LCA4LCA5XTtcbiAgICAgKiBjb25zdCBpbmRleCA9IDI7XG4gICAgICpcbiAgICAgKiBuZXdQYXN0ID0gcGFzdC5zbGljZSgwLCBpbmRleCkgPSBbMSwgMl07XG4gICAgICogbmV3UHJlc2VudCA9IHBhc3RbaW5kZXhdID0gMztcbiAgICAgKiBuZXdGdXR1cmUgPSBbLi4ucGFzdC5zbGljZShpbmRleCArIDEpLHByZXNlbnQsIC4uLmZ1dHVyZV0gPSBbNCwgNSwgNiwgNywgOCwgOV07XG4gICAgICpcbiAgICAgKi9cbiAgICBjb25zdCBuZXdQYXN0ID0gcGFzdC5zbGljZSgwLCBpbmRleCk7XG4gICAgY29uc3QgbmV3RnV0dXJlID0gWy4uLnBhc3Quc2xpY2UoaW5kZXggKyAxKSwgcHJlc2VudCwgLi4uZnV0dXJlXTtcbiAgICBjb25zdCBuZXdQcmVzZW50ID0gcGFzdFtpbmRleF07XG4gICAgdGhpcy5oaXN0b3J5LnBhc3QgPSBuZXdQYXN0O1xuICAgIHRoaXMuaGlzdG9yeS5wcmVzZW50ID0gbmV3UHJlc2VudDtcbiAgICB0aGlzLmhpc3RvcnkuZnV0dXJlID0gbmV3RnV0dXJlO1xuICAgIHRoaXMudXBkYXRlKCk7XG4gIH1cblxuICBqdW1wVG9GdXR1cmUoaW5kZXg6IG51bWJlcikge1xuICAgIGlmIChpbmRleCA8IDAgfHwgaW5kZXggPj0gdGhpcy5oaXN0b3J5LmZ1dHVyZS5sZW5ndGgpIHJldHVybjtcblxuICAgIGNvbnN0IHsgcGFzdCwgZnV0dXJlLCBwcmVzZW50IH0gPSB0aGlzLmhpc3Rvcnk7XG4gICAgLyoqXG4gICAgICpcbiAgICAgKiBjb25zdCBwYXN0ID0gWzEsIDIsIDMsIDQsIDVdO1xuICAgICAqIGNvbnN0IHByZXNlbnQgPSA2O1xuICAgICAqIGNvbnN0IGZ1dHVyZSA9IFs3LCA4LCA5LCAxMF1cbiAgICAgKiBjb25zdCBpbmRleCA9IDFcbiAgICAgKlxuICAgICAqIG5ld1Bhc3QgPSBbLi4ucGFzdCwgcHJlc2VudCwgLi4uZnV0dXJlLnNsaWNlKDAsIGluZGV4KSA9IFsxLCAyLCAzLCA0LCA1LCA2LCA3XTtcbiAgICAgKiBuZXdQcmVzZW50ID0gZnV0dXJlW2luZGV4XSA9IDg7XG4gICAgICogbmV3RnV0dXJlID0gZnV0cnVlLnNsaWNlKGluZGV4KzEpID0gWzksIDEwXTtcbiAgICAgKlxuICAgICAqL1xuXG4gICAgY29uc3QgbmV3UGFzdCA9IFsuLi5wYXN0LCBwcmVzZW50LCAuLi5mdXR1cmUuc2xpY2UoMCwgaW5kZXgpXTtcbiAgICBjb25zdCBuZXdQcmVzZW50ID0gZnV0dXJlW2luZGV4XTtcbiAgICBjb25zdCBuZXdGdXR1cmUgPSBmdXR1cmUuc2xpY2UoaW5kZXggKyAxKTtcbiAgICB0aGlzLmhpc3RvcnkucGFzdCA9IG5ld1Bhc3Q7XG4gICAgdGhpcy5oaXN0b3J5LnByZXNlbnQgPSBuZXdQcmVzZW50O1xuICAgIHRoaXMuaGlzdG9yeS5mdXR1cmUgPSBuZXdGdXR1cmU7XG4gICAgdGhpcy51cGRhdGUoJ1JlZG8nKTtcbiAgfVxuXG4gIC8qKlxuICAgKlxuICAgKiBqdW1wIG4gc3RlcHMgaW4gdGhlIHBhc3Qgb3IgZm9yd2FyZFxuICAgKlxuICAgKi9cbiAganVtcChuOiBudW1iZXIpIHtcbiAgICBpZiAobiA+IDApIHJldHVybiB0aGlzLmp1bXBUb0Z1dHVyZShuIC0gMSk7XG4gICAgaWYgKG4gPCAwKSByZXR1cm4gdGhpcy5qdW1wVG9QYXN0KHRoaXMuaGlzdG9yeS5wYXN0Lmxlbmd0aCArIG4pO1xuICB9XG5cbiAgLyoqXG4gICAqIENsZWFyIHRoZSBoaXN0b3J5XG4gICAqXG4gICAqIEBwYXJhbSBjdXN0b21VcGRhdGVGbiBDYWxsYmFjayBmdW5jdGlvbiBmb3Igb25seSBjbGVhcmluZyBwYXJ0IG9mIHRoZSBoaXN0b3J5XG4gICAqXG4gICAqIEBleGFtcGxlXG4gICAqXG4gICAqIHN0YXRlSGlzdG9yeS5jbGVhcigoaGlzdG9yeSkgPT4ge1xuICAgKiAgcmV0dXJuIHtcbiAgICogICAgcGFzdDogaGlzdG9yeS5wYXN0LFxuICAgKiAgICBwcmVzZW50OiBoaXN0b3J5LnByZXNlbnQsXG4gICAqICAgIGZ1dHVyZTogW11cbiAgICogIH07XG4gICAqIH0pO1xuICAgKi9cbiAgY2xlYXIoY3VzdG9tVXBkYXRlRm4/OiAoaGlzdG9yeTogSGlzdG9yeTxTdGF0ZT4pID0+IEhpc3Rvcnk8U3RhdGU+KSB7XG4gICAgdGhpcy5oaXN0b3J5ID0gaXNGdW5jdGlvbihjdXN0b21VcGRhdGVGbilcbiAgICAgID8gY3VzdG9tVXBkYXRlRm4odGhpcy5oaXN0b3J5KVxuICAgICAgOiB7XG4gICAgICAgICAgcGFzdDogW10sXG4gICAgICAgICAgcHJlc2VudDogbnVsbCxcbiAgICAgICAgICBmdXR1cmU6IFtdXG4gICAgICAgIH07XG4gICAgdGhpcy51cGRhdGVIYXNIaXN0b3J5KCk7XG4gIH1cblxuICBkZXN0cm95KGNsZWFySGlzdG9yeSA9IGZhbHNlKSB7XG4gICAgaWYgKGNsZWFySGlzdG9yeSkge1xuICAgICAgdGhpcy5jbGVhcigpO1xuICAgIH1cbiAgICB0aGlzLnN1YnNjcmlwdGlvbi51bnN1YnNjcmliZSgpO1xuICB9XG5cbiAgaWdub3JlTmV4dCgpIHtcbiAgICB0aGlzLnNraXAgPSB0cnVlO1xuICB9XG5cbiAgcHJpdmF0ZSB1cGRhdGUoYWN0aW9uID0gJ1VuZG8nKSB7XG4gICAgdGhpcy5za2lwVXBkYXRlID0gdHJ1ZTtcbiAgICBsb2dBY3Rpb24oYEBTdGF0ZUhpc3RvcnkgLSAke2FjdGlvbn1gKTtcbiAgICB0aGlzLnVwZGF0ZVN0b3JlKHRoaXMuaGlzdG9yeS5wcmVzZW50LCB0aGlzLl9lbnRpdHlJZCwgdGhpcy5wcm9wZXJ0eSk7XG4gICAgdGhpcy51cGRhdGVIYXNIaXN0b3J5KCk7XG4gICAgdGhpcy5za2lwVXBkYXRlID0gZmFsc2U7XG4gIH1cbn1cbiJdfQ==