/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
import { BehaviorSubject } from 'rxjs';
import { distinctUntilChanged, map } from 'rxjs/operators';
import { resetCustomAction, setAction } from './actions';
import { getAkitaConfig, getGlobalProducerFn } from './config';
import { deepFreeze } from './deepFreeze';
import { dispatchAdded, dispatchDeleted, dispatchUpdate } from './dispatchers';
import { __DEV__, isDev } from './env';
import { assertStoreHasName } from './errors';
import { isDefined } from './isDefined';
import { isFunction } from './isFunction';
import { isPlainObject } from './isPlainObject';
import { isBrowser } from './root';
import { configKey } from './storeConfig';
import { __stores__ } from './stores';
import { commit, isTransactionInProcess } from './transaction';
/**
 *
 * Store for managing any type of data
 *
 * \@example
 *
 * export interface SessionState {
 *   token: string;
 *   userDetails: UserDetails
 * }
 *
 * export function createInitialState(): SessionState {
 *  return {
 *    token: '',
 *    userDetails: null
 *  };
 * }
 *
 * \@StoreConfig({ name: 'session' })
 * export class SessionStore extends Store<SessionState> {
 *   constructor() {
 *    super(createInitialState());
 *   }
 * }
 * @template S
 */
var /**
 *
 * Store for managing any type of data
 *
 * \@example
 *
 * export interface SessionState {
 *   token: string;
 *   userDetails: UserDetails
 * }
 *
 * export function createInitialState(): SessionState {
 *  return {
 *    token: '',
 *    userDetails: null
 *  };
 * }
 *
 * \@StoreConfig({ name: 'session' })
 * export class SessionStore extends Store<SessionState> {
 *   constructor() {
 *    super(createInitialState());
 *   }
 * }
 * @template S
 */
Store = /** @class */ (function () {
    function Store(initialState, options) {
        if (options === void 0) { options = {}; }
        this.options = options;
        this.inTransaction = false;
        this.cache = {
            active: new BehaviorSubject(false),
            ttl: null
        };
        this.onInit((/** @type {?} */ (initialState)));
    }
    /**
     *  Set the loading state
     *
     *  @example
     *
     *  store.setLoading(true)
     *
     */
    /**
     *  Set the loading state
     *
     * \@example
     *
     *  store.setLoading(true)
     *
     * @param {?=} loading
     * @return {?}
     */
    Store.prototype.setLoading = /**
     *  Set the loading state
     *
     * \@example
     *
     *  store.setLoading(true)
     *
     * @param {?=} loading
     * @return {?}
     */
    function (loading) {
        if (loading === void 0) { loading = false; }
        if (loading !== ((/** @type {?} */ (this._value()))).loading) {
            isDev() && setAction('Set Loading');
            this._setState((/**
             * @param {?} state
             * @return {?}
             */
            function (state) { return ((/** @type {?} */ (tslib_1.__assign({}, state, { loading: loading })))); }));
        }
    };
    /**
     *
     * Set whether the data is cached
     *
     * @example
     *
     * store.setHasCache(true)
     * store.setHasCache(false)
     * store.setHasCache(true, { restartTTL: true })
     *
     */
    /**
     *
     * Set whether the data is cached
     *
     * \@example
     *
     * store.setHasCache(true)
     * store.setHasCache(false)
     * store.setHasCache(true, { restartTTL: true })
     *
     * @param {?} hasCache
     * @param {?=} options
     * @return {?}
     */
    Store.prototype.setHasCache = /**
     *
     * Set whether the data is cached
     *
     * \@example
     *
     * store.setHasCache(true)
     * store.setHasCache(false)
     * store.setHasCache(true, { restartTTL: true })
     *
     * @param {?} hasCache
     * @param {?=} options
     * @return {?}
     */
    function (hasCache, options) {
        var _this = this;
        if (options === void 0) { options = { restartTTL: false }; }
        if (hasCache !== this.cache.active.value) {
            this.cache.active.next(hasCache);
        }
        if (options.restartTTL) {
            /** @type {?} */
            var ttlConfig = this.getCacheTTL();
            if (ttlConfig) {
                if (this.cache.ttl !== null) {
                    clearTimeout(this.cache.ttl);
                }
                this.cache.ttl = (/** @type {?} */ (setTimeout((/**
                 * @return {?}
                 */
                function () { return _this.setHasCache(false); }), ttlConfig)));
            }
        }
    };
    /**
     *
     * Sometimes we need to access the store value from a store
     *
     * @example middleware
     *
     */
    /**
     *
     * Sometimes we need to access the store value from a store
     *
     * \@example middleware
     *
     * @return {?}
     */
    Store.prototype.getValue = /**
     *
     * Sometimes we need to access the store value from a store
     *
     * \@example middleware
     *
     * @return {?}
     */
    function () {
        return this.storeValue;
    };
    /**
     *  Set the error state
     *
     *  @example
     *
     *  store.setError({text: 'unable to load data' })
     *
     */
    /**
     *  Set the error state
     *
     * \@example
     *
     *  store.setError({text: 'unable to load data' })
     *
     * @template T
     * @param {?} error
     * @return {?}
     */
    Store.prototype.setError = /**
     *  Set the error state
     *
     * \@example
     *
     *  store.setError({text: 'unable to load data' })
     *
     * @template T
     * @param {?} error
     * @return {?}
     */
    function (error) {
        if (error !== ((/** @type {?} */ (this._value()))).error) {
            isDev() && setAction('Set Error');
            this._setState((/**
             * @param {?} state
             * @return {?}
             */
            function (state) { return ((/** @type {?} */ (tslib_1.__assign({}, state, { error: error })))); }));
        }
    };
    // @internal
    // @internal
    /**
     * @template R
     * @param {?} project
     * @return {?}
     */
    Store.prototype._select = 
    // @internal
    /**
     * @template R
     * @param {?} project
     * @return {?}
     */
    function (project) {
        return this.store.asObservable().pipe(map(project), distinctUntilChanged());
    };
    // @internal
    // @internal
    /**
     * @return {?}
     */
    Store.prototype._value = 
    // @internal
    /**
     * @return {?}
     */
    function () {
        return this.storeValue;
    };
    // @internal
    // @internal
    /**
     * @return {?}
     */
    Store.prototype._cache = 
    // @internal
    /**
     * @return {?}
     */
    function () {
        return this.cache.active;
    };
    Object.defineProperty(Store.prototype, "config", {
        // @internal
        get: 
        // @internal
        /**
         * @return {?}
         */
        function () {
            return this.constructor[configKey] || {};
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(Store.prototype, "storeName", {
        // @internal
        get: 
        // @internal
        /**
         * @return {?}
         */
        function () {
            return ((/** @type {?} */ (this.config))).storeName || ((/** @type {?} */ (this.options))).storeName || this.options.name;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(Store.prototype, "deepFreeze", {
        // @internal
        get: 
        // @internal
        /**
         * @return {?}
         */
        function () {
            return this.config.deepFreezeFn || this.options.deepFreezeFn || deepFreeze;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(Store.prototype, "cacheConfig", {
        // @internal
        get: 
        // @internal
        /**
         * @return {?}
         */
        function () {
            return this.config.cache || this.options.cache;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(Store.prototype, "_producerFn", {
        get: /**
         * @return {?}
         */
        function () {
            return this.config.producerFn || this.options.producerFn || getGlobalProducerFn();
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(Store.prototype, "resettable", {
        // @internal
        get: 
        // @internal
        /**
         * @return {?}
         */
        function () {
            return isDefined(this.config.resettable) ? this.config.resettable : this.options.resettable;
        },
        enumerable: true,
        configurable: true
    });
    // @internal
    // @internal
    /**
     * @param {?} newState
     * @param {?=} _dispatchAction
     * @return {?}
     */
    Store.prototype._setState = 
    // @internal
    /**
     * @param {?} newState
     * @param {?=} _dispatchAction
     * @return {?}
     */
    function (newState, _dispatchAction) {
        if (_dispatchAction === void 0) { _dispatchAction = true; }
        if (isFunction(newState)) {
            /** @type {?} */
            var _newState = newState(this._value());
            this.storeValue = __DEV__ ? this.deepFreeze(_newState) : _newState;
        }
        else {
            this.storeValue = newState;
        }
        if (!this.store) {
            this.store = new BehaviorSubject(this.storeValue);
            return;
        }
        if (isTransactionInProcess()) {
            this.handleTransaction();
            return;
        }
        this.dispatch(this.storeValue, _dispatchAction);
    };
    /**
     *
     * Reset the current store back to the initial value
     *
     * @example
     *
     * store.reset()
     *
     */
    /**
     *
     * Reset the current store back to the initial value
     *
     * \@example
     *
     * store.reset()
     *
     * @return {?}
     */
    Store.prototype.reset = /**
     *
     * Reset the current store back to the initial value
     *
     * \@example
     *
     * store.reset()
     *
     * @return {?}
     */
    function () {
        var _this = this;
        if (this.isResettable()) {
            isDev() && setAction('Reset');
            this._setState((/**
             * @return {?}
             */
            function () { return Object.assign({}, _this._initialState); }));
            this.setHasCache(false);
        }
        else {
            isDev() && console.warn("You need to enable the reset functionality");
        }
    };
    /**
     * @param {?} stateOrCallback
     * @return {?}
     */
    Store.prototype.update = /**
     * @param {?} stateOrCallback
     * @return {?}
     */
    function (stateOrCallback) {
        isDev() && setAction('Update');
        /** @type {?} */
        var newState;
        /** @type {?} */
        var currentState = this._value();
        if (isFunction(stateOrCallback)) {
            newState = isFunction(this._producerFn) ? this._producerFn(currentState, stateOrCallback) : stateOrCallback(currentState);
        }
        else {
            newState = stateOrCallback;
        }
        /** @type {?} */
        var withHook = this.akitaPreUpdate(currentState, (/** @type {?} */ (tslib_1.__assign({}, currentState, newState))));
        /** @type {?} */
        var resolved = isPlainObject(currentState) ? withHook : new ((/** @type {?} */ (currentState))).constructor(withHook);
        this._setState(resolved);
    };
    /**
     * @param {?} newOptions
     * @return {?}
     */
    Store.prototype.updateStoreConfig = /**
     * @param {?} newOptions
     * @return {?}
     */
    function (newOptions) {
        this.options = tslib_1.__assign({}, this.options, newOptions);
    };
    // @internal
    // @internal
    /**
     * @param {?} _
     * @param {?} nextState
     * @return {?}
     */
    Store.prototype.akitaPreUpdate = 
    // @internal
    /**
     * @param {?} _
     * @param {?} nextState
     * @return {?}
     */
    function (_, nextState) {
        return nextState;
    };
    /**
     * @return {?}
     */
    Store.prototype.ngOnDestroy = /**
     * @return {?}
     */
    function () {
        this.destroy();
    };
    /**
     *
     * Destroy the store
     *
     * @example
     *
     * store.destroy()
     *
     */
    /**
     *
     * Destroy the store
     *
     * \@example
     *
     * store.destroy()
     *
     * @return {?}
     */
    Store.prototype.destroy = /**
     *
     * Destroy the store
     *
     * \@example
     *
     * store.destroy()
     *
     * @return {?}
     */
    function () {
        /** @type {?} */
        var hmrEnabled = isBrowser ? ((/** @type {?} */ (window))).hmrEnabled : false;
        if (!hmrEnabled && this === __stores__[this.storeName]) {
            delete __stores__[this.storeName];
            dispatchDeleted(this.storeName);
            this.setHasCache(false);
            this.cache.active.complete();
        }
    };
    /**
     * @private
     * @param {?} initialState
     * @return {?}
     */
    Store.prototype.onInit = /**
     * @private
     * @param {?} initialState
     * @return {?}
     */
    function (initialState) {
        __stores__[this.storeName] = this;
        this._setState((/**
         * @return {?}
         */
        function () { return initialState; }));
        dispatchAdded(this.storeName);
        if (this.isResettable()) {
            this._initialState = initialState;
        }
        isDev() && assertStoreHasName(this.storeName, this.constructor.name);
    };
    /**
     * @private
     * @param {?} state
     * @param {?=} _dispatchAction
     * @return {?}
     */
    Store.prototype.dispatch = /**
     * @private
     * @param {?} state
     * @param {?=} _dispatchAction
     * @return {?}
     */
    function (state, _dispatchAction) {
        if (_dispatchAction === void 0) { _dispatchAction = true; }
        this.store.next(state);
        if (_dispatchAction) {
            dispatchUpdate(this.storeName);
            resetCustomAction();
        }
    };
    /**
     * @private
     * @return {?}
     */
    Store.prototype.watchTransaction = /**
     * @private
     * @return {?}
     */
    function () {
        var _this = this;
        commit().subscribe((/**
         * @return {?}
         */
        function () {
            _this.inTransaction = false;
            _this.dispatch(_this._value());
        }));
    };
    /**
     * @private
     * @return {?}
     */
    Store.prototype.isResettable = /**
     * @private
     * @return {?}
     */
    function () {
        if (this.resettable === false) {
            return false;
        }
        return this.resettable || getAkitaConfig().resettable;
    };
    /**
     * @private
     * @return {?}
     */
    Store.prototype.handleTransaction = /**
     * @private
     * @return {?}
     */
    function () {
        if (!this.inTransaction) {
            this.watchTransaction();
            this.inTransaction = true;
        }
    };
    /**
     * @private
     * @return {?}
     */
    Store.prototype.getCacheTTL = /**
     * @private
     * @return {?}
     */
    function () {
        return (this.cacheConfig && this.cacheConfig.ttl) || getAkitaConfig().ttl;
    };
    return Store;
}());
/**
 *
 * Store for managing any type of data
 *
 * \@example
 *
 * export interface SessionState {
 *   token: string;
 *   userDetails: UserDetails
 * }
 *
 * export function createInitialState(): SessionState {
 *  return {
 *    token: '',
 *    userDetails: null
 *  };
 * }
 *
 * \@StoreConfig({ name: 'session' })
 * export class SessionStore extends Store<SessionState> {
 *   constructor() {
 *    super(createInitialState());
 *   }
 * }
 * @template S
 */
export { Store };
if (false) {
    /**
     * @type {?}
     * @private
     */
    Store.prototype.store;
    /**
     * @type {?}
     * @private
     */
    Store.prototype.storeValue;
    /**
     * @type {?}
     * @private
     */
    Store.prototype.inTransaction;
    /**
     * @type {?}
     * @private
     */
    Store.prototype._initialState;
    /**
     * @type {?}
     * @protected
     */
    Store.prototype.cache;
    /**
     * @type {?}
     * @protected
     */
    Store.prototype.options;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RvcmUuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZGF0b3JhbWEvYWtpdGEvIiwic291cmNlcyI6WyJzcmMvc3RvcmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFBQSxPQUFPLEVBQUUsZUFBZSxFQUFjLE1BQU0sTUFBTSxDQUFDO0FBQ25ELE9BQU8sRUFBRSxvQkFBb0IsRUFBRSxHQUFHLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUMzRCxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsU0FBUyxFQUFFLE1BQU0sV0FBVyxDQUFDO0FBQ3pELE9BQU8sRUFBRSxjQUFjLEVBQUUsbUJBQW1CLEVBQUUsTUFBTSxVQUFVLENBQUM7QUFDL0QsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGNBQWMsQ0FBQztBQUMxQyxPQUFPLEVBQUUsYUFBYSxFQUFFLGVBQWUsRUFBRSxjQUFjLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDL0UsT0FBTyxFQUFFLE9BQU8sRUFBRSxLQUFLLEVBQUUsTUFBTSxPQUFPLENBQUM7QUFDdkMsT0FBTyxFQUFFLGtCQUFrQixFQUFFLE1BQU0sVUFBVSxDQUFDO0FBQzlDLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFDeEMsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGNBQWMsQ0FBQztBQUMxQyxPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFDaEQsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLFFBQVEsQ0FBQztBQUNuQyxPQUFPLEVBQUUsU0FBUyxFQUFtRCxNQUFNLGVBQWUsQ0FBQztBQUMzRixPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sVUFBVSxDQUFDO0FBQ3RDLE9BQU8sRUFBRSxNQUFNLEVBQUUsc0JBQXNCLEVBQUUsTUFBTSxlQUFlLENBQUM7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQTRCL0Q7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztJQVVFLGVBQVksWUFBd0IsRUFB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Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztJQXJSQyxzQkFBNEM7Ozs7O0lBQzVDLDJCQUFzQjs7Ozs7SUFDdEIsOEJBQThCOzs7OztJQUM5Qiw4QkFBeUI7Ozs7O0lBQ3pCLHNCQUdFOzs7OztJQUVvQyx3QkFBbUQiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBCZWhhdmlvclN1YmplY3QsIE9ic2VydmFibGUgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IGRpc3RpbmN0VW50aWxDaGFuZ2VkLCBtYXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQgeyByZXNldEN1c3RvbUFjdGlvbiwgc2V0QWN0aW9uIH0gZnJvbSAnLi9hY3Rpb25zJztcbmltcG9ydCB7IGdldEFraXRhQ29uZmlnLCBnZXRHbG9iYWxQcm9kdWNlckZuIH0gZnJvbSAnLi9jb25maWcnO1xuaW1wb3J0IHsgZGVlcEZyZWV6ZSB9IGZyb20gJy4vZGVlcEZyZWV6ZSc7XG5pbXBvcnQgeyBkaXNwYXRjaEFkZGVkLCBkaXNwYXRjaERlbGV0ZWQsIGRpc3BhdGNoVXBkYXRlIH0gZnJvbSAnLi9kaXNwYXRjaGVycyc7XG5pbXBvcnQgeyBfX0RFVl9fLCBpc0RldiB9IGZyb20gJy4vZW52JztcbmltcG9ydCB7IGFzc2VydFN0b3JlSGFzTmFtZSB9IGZyb20gJy4vZXJyb3JzJztcbmltcG9ydCB7IGlzRGVmaW5lZCB9IGZyb20gJy4vaXNEZWZpbmVkJztcbmltcG9ydCB7IGlzRnVuY3Rpb24gfSBmcm9tICcuL2lzRnVuY3Rpb24nO1xuaW1wb3J0IHsgaXNQbGFpbk9iamVjdCB9IGZyb20gJy4vaXNQbGFpbk9iamVjdCc7XG5pbXBvcnQgeyBpc0Jyb3dzZXIgfSBmcm9tICcuL3Jvb3QnO1xuaW1wb3J0IHsgY29uZmlnS2V5LCBTdG9yZUNvbmZpZ09wdGlvbnMsIFVwZGF0YWJsZVN0b3JlQ29uZmlnT3B0aW9ucyB9IGZyb20gJy4vc3RvcmVDb25maWcnO1xuaW1wb3J0IHsgX19zdG9yZXNfXyB9IGZyb20gJy4vc3RvcmVzJztcbmltcG9ydCB7IGNvbW1pdCwgaXNUcmFuc2FjdGlvbkluUHJvY2VzcyB9IGZyb20gJy4vdHJhbnNhY3Rpb24nO1xuaW1wb3J0IHsgU3RvcmVDYWNoZSwgVXBkYXRlU3RhdGVDYWxsYmFjayB9IGZyb20gJy4vdHlwZXMnO1xuXG4vKipcbiAqXG4gKiBTdG9yZSBmb3IgbWFuYWdpbmcgYW55IHR5cGUgb2YgZGF0YVxuICpcbiAqIEBleGFtcGxlXG4gKlxuICogZXhwb3J0IGludGVyZmFjZSBTZXNzaW9uU3RhdGUge1xuICogICB0b2tlbjogc3RyaW5nO1xuICogICB1c2VyRGV0YWlsczogVXNlckRldGFpbHNcbiAqIH1cbiAqXG4gKiBleHBvcnQgZnVuY3Rpb24gY3JlYXRlSW5pdGlhbFN0YXRlKCk6IFNlc3Npb25TdGF0ZSB7XG4gKiAgcmV0dXJuIHtcbiAqICAgIHRva2VuOiAnJyxcbiAqICAgIHVzZXJEZXRhaWxzOiBudWxsXG4gKiAgfTtcbiAqIH1cbiAqXG4gKiBAU3RvcmVDb25maWcoeyBuYW1lOiAnc2Vzc2lvbicgfSlcbiAqIGV4cG9ydCBjbGFzcyBTZXNzaW9uU3RvcmUgZXh0ZW5kcyBTdG9yZTxTZXNzaW9uU3RhdGU+IHtcbiAqICAgY29uc3RydWN0b3IoKSB7XG4gKiAgICBzdXBlcihjcmVhdGVJbml0aWFsU3RhdGUoKSk7XG4gKiAgIH1cbiAqIH1cbiAqL1xuZXhwb3J0IGNsYXNzIFN0b3JlPFMgPSBhbnk+IHtcbiAgcHJpdmF0ZSBzdG9yZTogQmVoYXZpb3JTdWJqZWN0PFJlYWRvbmx5PFM+PjtcbiAgcHJpdmF0ZSBzdG9yZVZhbHVlOiBTO1xuICBwcml2YXRlIGluVHJhbnNhY3Rpb24gPSBmYWxzZTtcbiAgcHJpdmF0ZSBfaW5pdGlhbFN0YXRlOiBTO1xuICBwcm90ZWN0ZWQgY2FjaGU6IFN0b3JlQ2FjaGUgPSB7XG4gICAgYWN0aXZlOiBuZXcgQmVoYXZpb3JTdWJqZWN0PGJvb2xlYW4+KGZhbHNlKSxcbiAgICB0dGw6IG51bGxcbiAgfTtcblxuICBjb25zdHJ1Y3Rvcihpbml0aWFsU3RhdGU6IFBhcnRpYWw8Uz4sIHByb3RlY3RlZCBvcHRpb25zOiBQYXJ0aWFsPFN0b3JlQ29uZmlnT3B0aW9ucz4gPSB7fSkge1xuICAgIHRoaXMub25Jbml0KGluaXRpYWxTdGF0ZSBhcyBTKTtcbiAgfVxuXG4gIC8qKlxuICAgKiAgU2V0IHRoZSBsb2FkaW5nIHN0YXRlXG4gICAqXG4gICAqICBAZXhhbXBsZVxuICAgKlxuICAgKiAgc3RvcmUuc2V0TG9hZGluZyh0cnVlKVxuICAgKlxuICAgKi9cbiAgc2V0TG9hZGluZyhsb2FkaW5nID0gZmFsc2UpIHtcbiAgICBpZiAobG9hZGluZyAhPT0gKHRoaXMuX3ZhbHVlKCkgYXMgUyAmIHsgbG9hZGluZzogYm9vbGVhbiB9KS5sb2FkaW5nKSB7XG4gICAgICBpc0RldigpICYmIHNldEFjdGlvbignU2V0IExvYWRpbmcnKTtcbiAgICAgIHRoaXMuX3NldFN0YXRlKHN0YXRlID0+ICh7IC4uLnN0YXRlLCBsb2FkaW5nIH0gYXMgUyAmIHsgbG9hZGluZzogYm9vbGVhbiB9KSk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqXG4gICAqIFNldCB3aGV0aGVyIHRoZSBkYXRhIGlzIGNhY2hlZFxuICAgKlxuICAgKiBAZXhhbXBsZVxuICAgKlxuICAgKiBzdG9yZS5zZXRIYXNDYWNoZSh0cnVlKVxuICAgKiBzdG9yZS5zZXRIYXNDYWNoZShmYWxzZSlcbiAgICogc3RvcmUuc2V0SGFzQ2FjaGUodHJ1ZSwgeyByZXN0YXJ0VFRMOiB0cnVlIH0pXG4gICAqXG4gICAqL1xuICBzZXRIYXNDYWNoZShoYXNDYWNoZTogYm9vbGVhbiwgb3B0aW9uczogeyByZXN0YXJ0VFRMOiBib29sZWFuIH0gPSB7IHJlc3RhcnRUVEw6IGZhbHNlIH0pIHtcbiAgICBpZiAoaGFzQ2FjaGUgIT09IHRoaXMuY2FjaGUuYWN0aXZlLnZhbHVlKSB7XG4gICAgICB0aGlzLmNhY2hlLmFjdGl2ZS5uZXh0KGhhc0NhY2hlKTtcbiAgICB9XG5cbiAgICBpZiAob3B0aW9ucy5yZXN0YXJ0VFRMKSB7XG4gICAgICBjb25zdCB0dGxDb25maWcgPSB0aGlzLmdldENhY2hlVFRMKCk7XG4gICAgICBpZiAodHRsQ29uZmlnKSB7XG4gICAgICAgIGlmICh0aGlzLmNhY2hlLnR0bCAhPT0gbnVsbCkge1xuICAgICAgICAgIGNsZWFyVGltZW91dCh0aGlzLmNhY2hlLnR0bCk7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5jYWNoZS50dGwgPSA8YW55PnNldFRpbWVvdXQoKCkgPT4gdGhpcy5zZXRIYXNDYWNoZShmYWxzZSksIHR0bENvbmZpZyk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqXG4gICAqIFNvbWV0aW1lcyB3ZSBuZWVkIHRvIGFjY2VzcyB0aGUgc3RvcmUgdmFsdWUgZnJvbSBhIHN0b3JlXG4gICAqXG4gICAqIEBleGFtcGxlIG1pZGRsZXdhcmVcbiAgICpcbiAgICovXG4gIGdldFZhbHVlKCkge1xuICAgIHJldHVybiB0aGlzLnN0b3JlVmFsdWU7XG4gIH1cblxuICAvKipcbiAgICogIFNldCB0aGUgZXJyb3Igc3RhdGVcbiAgICpcbiAgICogIEBleGFtcGxlXG4gICAqXG4gICAqICBzdG9yZS5zZXRFcnJvcih7dGV4dDogJ3VuYWJsZSB0byBsb2FkIGRhdGEnIH0pXG4gICAqXG4gICAqL1xuICBzZXRFcnJvcjxUPihlcnJvcjogVCkge1xuICAgIGlmIChlcnJvciAhPT0gKHRoaXMuX3ZhbHVlKCkgYXMgUyAmIHsgZXJyb3I6IGFueSB9KS5lcnJvcikge1xuICAgICAgaXNEZXYoKSAmJiBzZXRBY3Rpb24oJ1NldCBFcnJvcicpO1xuICAgICAgdGhpcy5fc2V0U3RhdGUoc3RhdGUgPT4gKHsgLi4uc3RhdGUsIGVycm9yIH0gYXMgUyAmIHsgZXJyb3I6IGFueSB9KSk7XG4gICAgfVxuICB9XG5cbiAgLy8gQGludGVybmFsXG4gIF9zZWxlY3Q8Uj4ocHJvamVjdDogKHN0b3JlOiBTKSA9PiBSKTogT2JzZXJ2YWJsZTxSPiB7XG4gICAgcmV0dXJuIHRoaXMuc3RvcmUuYXNPYnNlcnZhYmxlKCkucGlwZShcbiAgICAgIG1hcChwcm9qZWN0KSxcbiAgICAgIGRpc3RpbmN0VW50aWxDaGFuZ2VkKClcbiAgICApO1xuICB9XG5cbiAgLy8gQGludGVybmFsXG4gIF92YWx1ZSgpOiBTIHtcbiAgICByZXR1cm4gdGhpcy5zdG9yZVZhbHVlO1xuICB9XG5cbiAgLy8gQGludGVybmFsXG4gIF9jYWNoZSgpOiBCZWhhdmlvclN1YmplY3Q8Ym9vbGVhbj4ge1xuICAgIHJldHVybiB0aGlzLmNhY2hlLmFjdGl2ZTtcbiAgfVxuXG4gIC8vIEBpbnRlcm5hbFxuICBnZXQgY29uZmlnKCk6IFN0b3JlQ29uZmlnT3B0aW9ucyB7XG4gICAgcmV0dXJuIHRoaXMuY29uc3RydWN0b3JbY29uZmlnS2V5XSB8fCB7fTtcbiAgfVxuXG4gIC8vIEBpbnRlcm5hbFxuICBnZXQgc3RvcmVOYW1lKCkge1xuICAgIHJldHVybiAodGhpcy5jb25maWcgYXMgU3RvcmVDb25maWdPcHRpb25zICYgeyBzdG9yZU5hbWU6IHN0cmluZyB9KS5zdG9yZU5hbWUgfHwgKHRoaXMub3B0aW9ucyBhcyBTdG9yZUNvbmZpZ09wdGlvbnMgJiB7IHN0b3JlTmFtZTogc3RyaW5nIH0pLnN0b3JlTmFtZSB8fCB0aGlzLm9wdGlvbnMubmFtZTtcbiAgfVxuXG4gIC8vIEBpbnRlcm5hbFxuICBnZXQgZGVlcEZyZWV6ZSgpIHtcbiAgICByZXR1cm4gdGhpcy5jb25maWcuZGVlcEZyZWV6ZUZuIHx8IHRoaXMub3B0aW9ucy5kZWVwRnJlZXplRm4gfHwgZGVlcEZyZWV6ZTtcbiAgfVxuXG4gIC8vIEBpbnRlcm5hbFxuICBnZXQgY2FjaGVDb25maWcoKSB7XG4gICAgcmV0dXJuIHRoaXMuY29uZmlnLmNhY2hlIHx8IHRoaXMub3B0aW9ucy5jYWNoZTtcbiAgfVxuXG4gIGdldCBfcHJvZHVjZXJGbigpIHtcbiAgICByZXR1cm4gdGhpcy5jb25maWcucHJvZHVjZXJGbiB8fCB0aGlzLm9wdGlvbnMucHJvZHVjZXJGbiB8fCBnZXRHbG9iYWxQcm9kdWNlckZuKCk7XG4gIH1cblxuICAvLyBAaW50ZXJuYWxcbiAgZ2V0IHJlc2V0dGFibGUoKSB7XG4gICAgcmV0dXJuIGlzRGVmaW5lZCh0aGlzLmNvbmZpZy5yZXNldHRhYmxlKSA/IHRoaXMuY29uZmlnLnJlc2V0dGFibGUgOiB0aGlzLm9wdGlvbnMucmVzZXR0YWJsZTtcbiAgfVxuXG4gIC8vIEBpbnRlcm5hbFxuICBfc2V0U3RhdGUobmV3U3RhdGU6ICgoc3RhdGU6IFJlYWRvbmx5PFM+KSA9PiBTKSB8IFMsIF9kaXNwYXRjaEFjdGlvbiA9IHRydWUpIHtcbiAgICBpZiAoaXNGdW5jdGlvbihuZXdTdGF0ZSkpIHtcbiAgICAgIGNvbnN0IF9uZXdTdGF0ZSA9IG5ld1N0YXRlKHRoaXMuX3ZhbHVlKCkpO1xuICAgICAgdGhpcy5zdG9yZVZhbHVlID0gX19ERVZfXyA/IHRoaXMuZGVlcEZyZWV6ZShfbmV3U3RhdGUpIDogX25ld1N0YXRlO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLnN0b3JlVmFsdWUgPSBuZXdTdGF0ZTtcbiAgICB9XG5cbiAgICBpZiAoIXRoaXMuc3RvcmUpIHtcbiAgICAgIHRoaXMuc3RvcmUgPSBuZXcgQmVoYXZpb3JTdWJqZWN0KHRoaXMuc3RvcmVWYWx1ZSk7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgaWYgKGlzVHJhbnNhY3Rpb25JblByb2Nlc3MoKSkge1xuICAgICAgdGhpcy5oYW5kbGVUcmFuc2FjdGlvbigpO1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIHRoaXMuZGlzcGF0Y2godGhpcy5zdG9yZVZhbHVlLCBfZGlzcGF0Y2hBY3Rpb24pO1xuICB9XG5cbiAgLyoqXG4gICAqXG4gICAqIFJlc2V0IHRoZSBjdXJyZW50IHN0b3JlIGJhY2sgdG8gdGhlIGluaXRpYWwgdmFsdWVcbiAgICpcbiAgICogQGV4YW1wbGVcbiAgICpcbiAgICogc3RvcmUucmVzZXQoKVxuICAgKlxuICAgKi9cbiAgcmVzZXQoKSB7XG4gICAgaWYgKHRoaXMuaXNSZXNldHRhYmxlKCkpIHtcbiAgICAgIGlzRGV2KCkgJiYgc2V0QWN0aW9uKCdSZXNldCcpO1xuICAgICAgdGhpcy5fc2V0U3RhdGUoKCkgPT4gT2JqZWN0LmFzc2lnbih7fSwgdGhpcy5faW5pdGlhbFN0YXRlKSk7XG4gICAgICB0aGlzLnNldEhhc0NhY2hlKGZhbHNlKTtcbiAgICB9IGVsc2Uge1xuICAgICAgaXNEZXYoKSAmJiBjb25zb2xlLndhcm4oYFlvdSBuZWVkIHRvIGVuYWJsZSB0aGUgcmVzZXQgZnVuY3Rpb25hbGl0eWApO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKlxuICAgKiBVcGRhdGUgdGhlIHN0b3JlJ3MgdmFsdWVcbiAgICpcbiAgICogQGV4YW1wbGVcbiAgICpcbiAgICogdGhpcy5zdG9yZS51cGRhdGUoc3RhdGUgPT4ge1xuICAgKiAgIHJldHVybiB7Li4ufVxuICAgKiB9KVxuICAgKi9cbiAgdXBkYXRlKHN0YXRlQ2FsbGJhY2s6IFVwZGF0ZVN0YXRlQ2FsbGJhY2s8Uz4pO1xuICAvKipcbiAgICpcbiAgICogQGV4YW1wbGVcbiAgICpcbiAgICogIHRoaXMuc3RvcmUudXBkYXRlKHsgdG9rZW46IHRva2VuIH0pXG4gICAqL1xuICB1cGRhdGUoc3RhdGU6IFBhcnRpYWw8Uz4pO1xuICB1cGRhdGUoc3RhdGVPckNhbGxiYWNrOiBQYXJ0aWFsPFM+IHwgVXBkYXRlU3RhdGVDYWxsYmFjazxTPikge1xuICAgIGlzRGV2KCkgJiYgc2V0QWN0aW9uKCdVcGRhdGUnKTtcblxuICAgIGxldCBuZXdTdGF0ZTtcbiAgICBjb25zdCBjdXJyZW50U3RhdGUgPSB0aGlzLl92YWx1ZSgpO1xuICAgIGlmIChpc0Z1bmN0aW9uKHN0YXRlT3JDYWxsYmFjaykpIHtcbiAgICAgIG5ld1N0YXRlID0gaXNGdW5jdGlvbih0aGlzLl9wcm9kdWNlckZuKSA/IHRoaXMuX3Byb2R1Y2VyRm4oY3VycmVudFN0YXRlLCBzdGF0ZU9yQ2FsbGJhY2spIDogc3RhdGVPckNhbGxiYWNrKGN1cnJlbnRTdGF0ZSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIG5ld1N0YXRlID0gc3RhdGVPckNhbGxiYWNrO1xuICAgIH1cblxuICAgIGNvbnN0IHdpdGhIb29rID0gdGhpcy5ha2l0YVByZVVwZGF0ZShjdXJyZW50U3RhdGUsIHsgLi4uY3VycmVudFN0YXRlLCAuLi5uZXdTdGF0ZSB9IGFzIFMpO1xuICAgIGNvbnN0IHJlc29sdmVkID0gaXNQbGFpbk9iamVjdChjdXJyZW50U3RhdGUpID8gd2l0aEhvb2sgOiBuZXcgKGN1cnJlbnRTdGF0ZSBhcyBhbnkpLmNvbnN0cnVjdG9yKHdpdGhIb29rKTtcbiAgICB0aGlzLl9zZXRTdGF0ZShyZXNvbHZlZCk7XG4gIH1cblxuICB1cGRhdGVTdG9yZUNvbmZpZyhuZXdPcHRpb25zOiBVcGRhdGFibGVTdG9yZUNvbmZpZ09wdGlvbnMpIHtcbiAgICB0aGlzLm9wdGlvbnMgPSB7IC4uLnRoaXMub3B0aW9ucywgLi4ubmV3T3B0aW9ucyB9O1xuICB9XG5cbiAgLy8gQGludGVybmFsXG4gIGFraXRhUHJlVXBkYXRlKF86IFJlYWRvbmx5PFM+LCBuZXh0U3RhdGU6IFJlYWRvbmx5PFM+KTogUyB7XG4gICAgcmV0dXJuIG5leHRTdGF0ZTtcbiAgfVxuXG4gIG5nT25EZXN0cm95KCkge1xuICAgIHRoaXMuZGVzdHJveSgpO1xuICB9XG5cbiAgLyoqXG4gICAqXG4gICAqIERlc3Ryb3kgdGhlIHN0b3JlXG4gICAqXG4gICAqIEBleGFtcGxlXG4gICAqXG4gICAqIHN0b3JlLmRlc3Ryb3koKVxuICAgKlxuICAgKi9cbiAgZGVzdHJveSgpIHtcbiAgICBjb25zdCBobXJFbmFibGVkID0gaXNCcm93c2VyID8gKHdpbmRvdyBhcyBhbnkpLmhtckVuYWJsZWQgOiBmYWxzZTtcbiAgICBpZiAoIWhtckVuYWJsZWQgJiYgdGhpcyA9PT0gX19zdG9yZXNfX1t0aGlzLnN0b3JlTmFtZV0pIHtcbiAgICAgIGRlbGV0ZSBfX3N0b3Jlc19fW3RoaXMuc3RvcmVOYW1lXTtcbiAgICAgIGRpc3BhdGNoRGVsZXRlZCh0aGlzLnN0b3JlTmFtZSk7XG4gICAgICB0aGlzLnNldEhhc0NhY2hlKGZhbHNlKTtcbiAgICAgIHRoaXMuY2FjaGUuYWN0aXZlLmNvbXBsZXRlKCk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBvbkluaXQoaW5pdGlhbFN0YXRlOiBTKSB7XG4gICAgX19zdG9yZXNfX1t0aGlzLnN0b3JlTmFtZV0gPSB0aGlzO1xuICAgIHRoaXMuX3NldFN0YXRlKCgpID0+IGluaXRpYWxTdGF0ZSk7XG4gICAgZGlzcGF0Y2hBZGRlZCh0aGlzLnN0b3JlTmFtZSk7XG4gICAgaWYgKHRoaXMuaXNSZXNldHRhYmxlKCkpIHtcbiAgICAgIHRoaXMuX2luaXRpYWxTdGF0ZSA9IGluaXRpYWxTdGF0ZTtcbiAgICB9XG4gICAgaXNEZXYoKSAmJiBhc3NlcnRTdG9yZUhhc05hbWUodGhpcy5zdG9yZU5hbWUsIHRoaXMuY29uc3RydWN0b3IubmFtZSk7XG4gIH1cblxuICBwcml2YXRlIGRpc3BhdGNoKHN0YXRlOiBTLCBfZGlzcGF0Y2hBY3Rpb24gPSB0cnVlKSB7XG4gICAgdGhpcy5zdG9yZS5uZXh0KHN0YXRlKTtcbiAgICBpZiAoX2Rpc3BhdGNoQWN0aW9uKSB7XG4gICAgICBkaXNwYXRjaFVwZGF0ZSh0aGlzLnN0b3JlTmFtZSk7XG4gICAgICByZXNldEN1c3RvbUFjdGlvbigpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgd2F0Y2hUcmFuc2FjdGlvbigpIHtcbiAgICBjb21taXQoKS5zdWJzY3JpYmUoKCkgPT4ge1xuICAgICAgdGhpcy5pblRyYW5zYWN0aW9uID0gZmFsc2U7XG4gICAgICB0aGlzLmRpc3BhdGNoKHRoaXMuX3ZhbHVlKCkpO1xuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBpc1Jlc2V0dGFibGUoKSB7XG4gICAgaWYgKHRoaXMucmVzZXR0YWJsZSA9PT0gZmFsc2UpIHtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMucmVzZXR0YWJsZSB8fCBnZXRBa2l0YUNvbmZpZygpLnJlc2V0dGFibGU7XG4gIH1cblxuICBwcml2YXRlIGhhbmRsZVRyYW5zYWN0aW9uKCkge1xuICAgIGlmICghdGhpcy5pblRyYW5zYWN0aW9uKSB7XG4gICAgICB0aGlzLndhdGNoVHJhbnNhY3Rpb24oKTtcbiAgICAgIHRoaXMuaW5UcmFuc2FjdGlvbiA9IHRydWU7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBnZXRDYWNoZVRUTCgpIHtcbiAgICByZXR1cm4gKHRoaXMuY2FjaGVDb25maWcgJiYgdGhpcy5jYWNoZUNvbmZpZy50dGwpIHx8IGdldEFraXRhQ29uZmlnKCkudHRsO1xuICB9XG59XG4iXX0=