/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { BehaviorSubject } from 'rxjs';
import { distinctUntilChanged, map } from 'rxjs/operators';
import { resetCustomAction, setAction } from './actions';
import { getAkitaConfig, getGlobalProducerFn } from './config';
import { deepFreeze } from './deepFreeze';
import { dispatchAdded, dispatchDeleted, dispatchUpdate } from './dispatchers';
import { __DEV__, isDev } from './env';
import { assertStoreHasName } from './errors';
import { isDefined } from './isDefined';
import { isFunction } from './isFunction';
import { isPlainObject } from './isPlainObject';
import { isBrowser } from './root';
import { configKey } from './storeConfig';
import { __stores__ } from './stores';
import { commit, isTransactionInProcess } from './transaction';
/**
 *
 * Store for managing any type of data
 *
 * \@example
 *
 * export interface SessionState {
 *   token: string;
 *   userDetails: UserDetails
 * }
 *
 * export function createInitialState(): SessionState {
 *  return {
 *    token: '',
 *    userDetails: null
 *  };
 * }
 *
 * \@StoreConfig({ name: 'session' })
 * export class SessionStore extends Store<SessionState> {
 *   constructor() {
 *    super(createInitialState());
 *   }
 * }
 * @template S
 */
export class Store {
    /**
     * @param {?} initialState
     * @param {?=} options
     */
    constructor(initialState, options = {}) {
        this.options = options;
        this.inTransaction = false;
        this.cache = {
            active: new BehaviorSubject(false),
            ttl: null
        };
        this.onInit((/** @type {?} */ (initialState)));
    }
    /**
     *  Set the loading state
     *
     * \@example
     *
     *  store.setLoading(true)
     *
     * @param {?=} loading
     * @return {?}
     */
    setLoading(loading = false) {
        if (loading !== ((/** @type {?} */ (this._value()))).loading) {
            isDev() && setAction('Set Loading');
            this._setState((/**
             * @param {?} state
             * @return {?}
             */
            state => ((/** @type {?} */ (Object.assign({}, state, { loading }))))));
        }
    }
    /**
     *
     * Set whether the data is cached
     *
     * \@example
     *
     * store.setHasCache(true)
     * store.setHasCache(false)
     * store.setHasCache(true, { restartTTL: true })
     *
     * @param {?} hasCache
     * @param {?=} options
     * @return {?}
     */
    setHasCache(hasCache, options = { restartTTL: false }) {
        if (hasCache !== this.cache.active.value) {
            this.cache.active.next(hasCache);
        }
        if (options.restartTTL) {
            /** @type {?} */
            const ttlConfig = this.getCacheTTL();
            if (ttlConfig) {
                if (this.cache.ttl !== null) {
                    clearTimeout(this.cache.ttl);
                }
                this.cache.ttl = (/** @type {?} */ (setTimeout((/**
                 * @return {?}
                 */
                () => this.setHasCache(false)), ttlConfig)));
            }
        }
    }
    /**
     *
     * Sometimes we need to access the store value from a store
     *
     * \@example middleware
     *
     * @return {?}
     */
    getValue() {
        return this.storeValue;
    }
    /**
     *  Set the error state
     *
     * \@example
     *
     *  store.setError({text: 'unable to load data' })
     *
     * @template T
     * @param {?} error
     * @return {?}
     */
    setError(error) {
        if (error !== ((/** @type {?} */ (this._value()))).error) {
            isDev() && setAction('Set Error');
            this._setState((/**
             * @param {?} state
             * @return {?}
             */
            state => ((/** @type {?} */ (Object.assign({}, state, { error }))))));
        }
    }
    // @internal
    /**
     * @template R
     * @param {?} project
     * @return {?}
     */
    _select(project) {
        return this.store.asObservable().pipe(map(project), distinctUntilChanged());
    }
    // @internal
    /**
     * @return {?}
     */
    _value() {
        return this.storeValue;
    }
    // @internal
    /**
     * @return {?}
     */
    _cache() {
        return this.cache.active;
    }
    // @internal
    /**
     * @return {?}
     */
    get config() {
        return this.constructor[configKey] || {};
    }
    // @internal
    /**
     * @return {?}
     */
    get storeName() {
        return ((/** @type {?} */ (this.config))).storeName || ((/** @type {?} */ (this.options))).storeName || this.options.name;
    }
    // @internal
    /**
     * @return {?}
     */
    get deepFreeze() {
        return this.config.deepFreezeFn || this.options.deepFreezeFn || deepFreeze;
    }
    // @internal
    /**
     * @return {?}
     */
    get cacheConfig() {
        return this.config.cache || this.options.cache;
    }
    /**
     * @return {?}
     */
    get _producerFn() {
        return this.config.producerFn || this.options.producerFn || getGlobalProducerFn();
    }
    // @internal
    /**
     * @return {?}
     */
    get resettable() {
        return isDefined(this.config.resettable) ? this.config.resettable : this.options.resettable;
    }
    // @internal
    /**
     * @param {?} newState
     * @param {?=} _dispatchAction
     * @return {?}
     */
    _setState(newState, _dispatchAction = true) {
        if (isFunction(newState)) {
            /** @type {?} */
            const _newState = newState(this._value());
            this.storeValue = __DEV__ ? this.deepFreeze(_newState) : _newState;
        }
        else {
            this.storeValue = newState;
        }
        if (!this.store) {
            this.store = new BehaviorSubject(this.storeValue);
            return;
        }
        if (isTransactionInProcess()) {
            this.handleTransaction();
            return;
        }
        this.dispatch(this.storeValue, _dispatchAction);
    }
    /**
     *
     * Reset the current store back to the initial value
     *
     * \@example
     *
     * store.reset()
     *
     * @return {?}
     */
    reset() {
        if (this.isResettable()) {
            isDev() && setAction('Reset');
            this._setState((/**
             * @return {?}
             */
            () => Object.assign({}, this._initialState)));
            this.setHasCache(false);
        }
        else {
            isDev() && console.warn(`You need to enable the reset functionality`);
        }
    }
    /**
     * @param {?} stateOrCallback
     * @return {?}
     */
    update(stateOrCallback) {
        isDev() && setAction('Update');
        /** @type {?} */
        let newState;
        /** @type {?} */
        const currentState = this._value();
        if (isFunction(stateOrCallback)) {
            newState = isFunction(this._producerFn) ? this._producerFn(currentState, stateOrCallback) : stateOrCallback(currentState);
        }
        else {
            newState = stateOrCallback;
        }
        /** @type {?} */
        const withHook = this.akitaPreUpdate(currentState, (/** @type {?} */ (Object.assign({}, currentState, newState))));
        /** @type {?} */
        const resolved = isPlainObject(currentState) ? withHook : new ((/** @type {?} */ (currentState))).constructor(withHook);
        this._setState(resolved);
    }
    /**
     * @param {?} newOptions
     * @return {?}
     */
    updateStoreConfig(newOptions) {
        this.options = Object.assign({}, this.options, newOptions);
    }
    // @internal
    /**
     * @param {?} _
     * @param {?} nextState
     * @return {?}
     */
    akitaPreUpdate(_, nextState) {
        return nextState;
    }
    /**
     * @return {?}
     */
    ngOnDestroy() {
        this.destroy();
    }
    /**
     *
     * Destroy the store
     *
     * \@example
     *
     * store.destroy()
     *
     * @return {?}
     */
    destroy() {
        /** @type {?} */
        const hmrEnabled = isBrowser ? ((/** @type {?} */ (window))).hmrEnabled : false;
        if (!hmrEnabled && this === __stores__[this.storeName]) {
            delete __stores__[this.storeName];
            dispatchDeleted(this.storeName);
            this.setHasCache(false);
            this.cache.active.complete();
        }
    }
    /**
     * @private
     * @param {?} initialState
     * @return {?}
     */
    onInit(initialState) {
        __stores__[this.storeName] = this;
        this._setState((/**
         * @return {?}
         */
        () => initialState));
        dispatchAdded(this.storeName);
        if (this.isResettable()) {
            this._initialState = initialState;
        }
        isDev() && assertStoreHasName(this.storeName, this.constructor.name);
    }
    /**
     * @private
     * @param {?} state
     * @param {?=} _dispatchAction
     * @return {?}
     */
    dispatch(state, _dispatchAction = true) {
        this.store.next(state);
        if (_dispatchAction) {
            dispatchUpdate(this.storeName);
            resetCustomAction();
        }
    }
    /**
     * @private
     * @return {?}
     */
    watchTransaction() {
        commit().subscribe((/**
         * @return {?}
         */
        () => {
            this.inTransaction = false;
            this.dispatch(this._value());
        }));
    }
    /**
     * @private
     * @return {?}
     */
    isResettable() {
        if (this.resettable === false) {
            return false;
        }
        return this.resettable || getAkitaConfig().resettable;
    }
    /**
     * @private
     * @return {?}
     */
    handleTransaction() {
        if (!this.inTransaction) {
            this.watchTransaction();
            this.inTransaction = true;
        }
    }
    /**
     * @private
     * @return {?}
     */
    getCacheTTL() {
        return (this.cacheConfig && this.cacheConfig.ttl) || getAkitaConfig().ttl;
    }
}
if (false) {
    /**
     * @type {?}
     * @private
     */
    Store.prototype.store;
    /**
     * @type {?}
     * @private
     */
    Store.prototype.storeValue;
    /**
     * @type {?}
     * @private
     */
    Store.prototype.inTransaction;
    /**
     * @type {?}
     * @private
     */
    Store.prototype._initialState;
    /**
     * @type {?}
     * @protected
     */
    Store.prototype.cache;
    /**
     * @type {?}
     * @protected
     */
    Store.prototype.options;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RvcmUuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZGF0b3JhbWEvYWtpdGEvIiwic291cmNlcyI6WyJzcmMvc3RvcmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7OztBQUFBLE9BQU8sRUFBRSxlQUFlLEVBQWMsTUFBTSxNQUFNLENBQUM7QUFDbkQsT0FBTyxFQUFFLG9CQUFvQixFQUFFLEdBQUcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQzNELE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxTQUFTLEVBQUUsTUFBTSxXQUFXLENBQUM7QUFDekQsT0FBTyxFQUFFLGNBQWMsRUFBRSxtQkFBbUIsRUFBRSxNQUFNLFVBQVUsQ0FBQztBQUMvRCxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sY0FBYyxDQUFDO0FBQzFDLE9BQU8sRUFBRSxhQUFhLEVBQUUsZUFBZSxFQUFFLGNBQWMsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMvRSxPQUFPLEVBQUUsT0FBTyxFQUFFLEtBQUssRUFBRSxNQUFNLE9BQU8sQ0FBQztBQUN2QyxPQUFPLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSxVQUFVLENBQUM7QUFDOUMsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLGFBQWEsQ0FBQztBQUN4QyxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sY0FBYyxDQUFDO0FBQzFDLE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUNoRCxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sUUFBUSxDQUFDO0FBQ25DLE9BQU8sRUFBRSxTQUFTLEVBQW1ELE1BQU0sZUFBZSxDQUFDO0FBQzNGLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxVQUFVLENBQUM7QUFDdEMsT0FBTyxFQUFFLE1BQU0sRUFBRSxzQkFBc0IsRUFBRSxNQUFNLGVBQWUsQ0FBQzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBNEIvRCxNQUFNLE9BQU8sS0FBSzs7Ozs7SUFVaEIsWUFBWSxZQUF3QixFQUFZLFVBQXVD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QUFFLENBQUM7WUFDeEIsSUFBSSxDQUFDLGFBQWEsR0FBRyxJQUFJLENBQUM7U0FDM0I7SUFDSCxDQUFDOzs7OztJQUVPLFdBQVc7UUFDakIsT0FBTyxDQUFDLElBQUksQ0FBQyxXQUFXLElBQUksSUFBSSxDQUFDLFdBQVcsQ0FBQyxHQUFHLENBQUMsSUFBSSxjQUFjLEVBQUUsQ0FBQyxHQUFHLENBQUM7SUFDNUUsQ0FBQztDQUNGOzs7Ozs7SUFyUkMsc0JBQTRDOzs7OztJQUM1QywyQkFBc0I7Ozs7O0lBQ3RCLDhCQUE4Qjs7Ozs7SUFDOUIsOEJBQXlCOzs7OztJQUN6QixzQkFHRTs7Ozs7SUFFb0Msd0JBQW1EIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQmVoYXZpb3JTdWJqZWN0LCBPYnNlcnZhYmxlIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBkaXN0aW5jdFVudGlsQ2hhbmdlZCwgbWFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHsgcmVzZXRDdXN0b21BY3Rpb24sIHNldEFjdGlvbiB9IGZyb20gJy4vYWN0aW9ucyc7XG5pbXBvcnQgeyBnZXRBa2l0YUNvbmZpZywgZ2V0R2xvYmFsUHJvZHVjZXJGbiB9IGZyb20gJy4vY29uZmlnJztcbmltcG9ydCB7IGRlZXBGcmVlemUgfSBmcm9tICcuL2RlZXBGcmVlemUnO1xuaW1wb3J0IHsgZGlzcGF0Y2hBZGRlZCwgZGlzcGF0Y2hEZWxldGVkLCBkaXNwYXRjaFVwZGF0ZSB9IGZyb20gJy4vZGlzcGF0Y2hlcnMnO1xuaW1wb3J0IHsgX19ERVZfXywgaXNEZXYgfSBmcm9tICcuL2Vudic7XG5pbXBvcnQgeyBhc3NlcnRTdG9yZUhhc05hbWUgfSBmcm9tICcuL2Vycm9ycyc7XG5pbXBvcnQgeyBpc0RlZmluZWQgfSBmcm9tICcuL2lzRGVmaW5lZCc7XG5pbXBvcnQgeyBpc0Z1bmN0aW9uIH0gZnJvbSAnLi9pc0Z1bmN0aW9uJztcbmltcG9ydCB7IGlzUGxhaW5PYmplY3QgfSBmcm9tICcuL2lzUGxhaW5PYmplY3QnO1xuaW1wb3J0IHsgaXNCcm93c2VyIH0gZnJvbSAnLi9yb290JztcbmltcG9ydCB7IGNvbmZpZ0tleSwgU3RvcmVDb25maWdPcHRpb25zLCBVcGRhdGFibGVTdG9yZUNvbmZpZ09wdGlvbnMgfSBmcm9tICcuL3N0b3JlQ29uZmlnJztcbmltcG9ydCB7IF9fc3RvcmVzX18gfSBmcm9tICcuL3N0b3Jlcyc7XG5pbXBvcnQgeyBjb21taXQsIGlzVHJhbnNhY3Rpb25JblByb2Nlc3MgfSBmcm9tICcuL3RyYW5zYWN0aW9uJztcbmltcG9ydCB7IFN0b3JlQ2FjaGUsIFVwZGF0ZVN0YXRlQ2FsbGJhY2sgfSBmcm9tICcuL3R5cGVzJztcblxuLyoqXG4gKlxuICogU3RvcmUgZm9yIG1hbmFnaW5nIGFueSB0eXBlIG9mIGRhdGFcbiAqXG4gKiBAZXhhbXBsZVxuICpcbiAqIGV4cG9ydCBpbnRlcmZhY2UgU2Vzc2lvblN0YXRlIHtcbiAqICAgdG9rZW46IHN0cmluZztcbiAqICAgdXNlckRldGFpbHM6IFVzZXJEZXRhaWxzXG4gKiB9XG4gKlxuICogZXhwb3J0IGZ1bmN0aW9uIGNyZWF0ZUluaXRpYWxTdGF0ZSgpOiBTZXNzaW9uU3RhdGUge1xuICogIHJldHVybiB7XG4gKiAgICB0b2tlbjogJycsXG4gKiAgICB1c2VyRGV0YWlsczogbnVsbFxuICogIH07XG4gKiB9XG4gKlxuICogQFN0b3JlQ29uZmlnKHsgbmFtZTogJ3Nlc3Npb24nIH0pXG4gKiBleHBvcnQgY2xhc3MgU2Vzc2lvblN0b3JlIGV4dGVuZHMgU3RvcmU8U2Vzc2lvblN0YXRlPiB7XG4gKiAgIGNvbnN0cnVjdG9yKCkge1xuICogICAgc3VwZXIoY3JlYXRlSW5pdGlhbFN0YXRlKCkpO1xuICogICB9XG4gKiB9XG4gKi9cbmV4cG9ydCBjbGFzcyBTdG9yZTxTID0gYW55PiB7XG4gIHByaXZhdGUgc3RvcmU6IEJlaGF2aW9yU3ViamVjdDxSZWFkb25seTxTPj47XG4gIHByaXZhdGUgc3RvcmVWYWx1ZTogUztcbiAgcHJpdmF0ZSBpblRyYW5zYWN0aW9uID0gZmFsc2U7XG4gIHByaXZhdGUgX2luaXRpYWxTdGF0ZTogUztcbiAgcHJvdGVjdGVkIGNhY2hlOiBTdG9yZUNhY2hlID0ge1xuICAgIGFjdGl2ZTogbmV3IEJlaGF2aW9yU3ViamVjdDxib29sZWFuPihmYWxzZSksXG4gICAgdHRsOiBudWxsXG4gIH07XG5cbiAgY29uc3RydWN0b3IoaW5pdGlhbFN0YXRlOiBQYXJ0aWFsPFM+LCBwcm90ZWN0ZWQgb3B0aW9uczogUGFydGlhbDxTdG9yZUNvbmZpZ09wdGlvbnM+ID0ge30pIHtcbiAgICB0aGlzLm9uSW5pdChpbml0aWFsU3RhdGUgYXMgUyk7XG4gIH1cblxuICAvKipcbiAgICogIFNldCB0aGUgbG9hZGluZyBzdGF0ZVxuICAgKlxuICAgKiAgQGV4YW1wbGVcbiAgICpcbiAgICogIHN0b3JlLnNldExvYWRpbmcodHJ1ZSlcbiAgICpcbiAgICovXG4gIHNldExvYWRpbmcobG9hZGluZyA9IGZhbHNlKSB7XG4gICAgaWYgKGxvYWRpbmcgIT09ICh0aGlzLl92YWx1ZSgpIGFzIFMgJiB7IGxvYWRpbmc6IGJvb2xlYW4gfSkubG9hZGluZykge1xuICAgICAgaXNEZXYoKSAmJiBzZXRBY3Rpb24oJ1NldCBMb2FkaW5nJyk7XG4gICAgICB0aGlzLl9zZXRTdGF0ZShzdGF0ZSA9PiAoeyAuLi5zdGF0ZSwgbG9hZGluZyB9IGFzIFMgJiB7IGxvYWRpbmc6IGJvb2xlYW4gfSkpO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKlxuICAgKiBTZXQgd2hldGhlciB0aGUgZGF0YSBpcyBjYWNoZWRcbiAgICpcbiAgICogQGV4YW1wbGVcbiAgICpcbiAgICogc3RvcmUuc2V0SGFzQ2FjaGUodHJ1ZSlcbiAgICogc3RvcmUuc2V0SGFzQ2FjaGUoZmFsc2UpXG4gICAqIHN0b3JlLnNldEhhc0NhY2hlKHRydWUsIHsgcmVzdGFydFRUTDogdHJ1ZSB9KVxuICAgKlxuICAgKi9cbiAgc2V0SGFzQ2FjaGUoaGFzQ2FjaGU6IGJvb2xlYW4sIG9wdGlvbnM6IHsgcmVzdGFydFRUTDogYm9vbGVhbiB9ID0geyByZXN0YXJ0VFRMOiBmYWxzZSB9KSB7XG4gICAgaWYgKGhhc0NhY2hlICE9PSB0aGlzLmNhY2hlLmFjdGl2ZS52YWx1ZSkge1xuICAgICAgdGhpcy5jYWNoZS5hY3RpdmUubmV4dChoYXNDYWNoZSk7XG4gICAgfVxuXG4gICAgaWYgKG9wdGlvbnMucmVzdGFydFRUTCkge1xuICAgICAgY29uc3QgdHRsQ29uZmlnID0gdGhpcy5nZXRDYWNoZVRUTCgpO1xuICAgICAgaWYgKHR0bENvbmZpZykge1xuICAgICAgICBpZiAodGhpcy5jYWNoZS50dGwgIT09IG51bGwpIHtcbiAgICAgICAgICBjbGVhclRpbWVvdXQodGhpcy5jYWNoZS50dGwpO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuY2FjaGUudHRsID0gPGFueT5zZXRUaW1lb3V0KCgpID0+IHRoaXMuc2V0SGFzQ2FjaGUoZmFsc2UpLCB0dGxDb25maWcpO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKlxuICAgKiBTb21ldGltZXMgd2UgbmVlZCB0byBhY2Nlc3MgdGhlIHN0b3JlIHZhbHVlIGZyb20gYSBzdG9yZVxuICAgKlxuICAgKiBAZXhhbXBsZSBtaWRkbGV3YXJlXG4gICAqXG4gICAqL1xuICBnZXRWYWx1ZSgpIHtcbiAgICByZXR1cm4gdGhpcy5zdG9yZVZhbHVlO1xuICB9XG5cbiAgLyoqXG4gICAqICBTZXQgdGhlIGVycm9yIHN0YXRlXG4gICAqXG4gICAqICBAZXhhbXBsZVxuICAgKlxuICAgKiAgc3RvcmUuc2V0RXJyb3Ioe3RleHQ6ICd1bmFibGUgdG8gbG9hZCBkYXRhJyB9KVxuICAgKlxuICAgKi9cbiAgc2V0RXJyb3I8VD4oZXJyb3I6IFQpIHtcbiAgICBpZiAoZXJyb3IgIT09ICh0aGlzLl92YWx1ZSgpIGFzIFMgJiB7IGVycm9yOiBhbnkgfSkuZXJyb3IpIHtcbiAgICAgIGlzRGV2KCkgJiYgc2V0QWN0aW9uKCdTZXQgRXJyb3InKTtcbiAgICAgIHRoaXMuX3NldFN0YXRlKHN0YXRlID0+ICh7IC4uLnN0YXRlLCBlcnJvciB9IGFzIFMgJiB7IGVycm9yOiBhbnkgfSkpO1xuICAgIH1cbiAgfVxuXG4gIC8vIEBpbnRlcm5hbFxuICBfc2VsZWN0PFI+KHByb2plY3Q6IChzdG9yZTogUykgPT4gUik6IE9ic2VydmFibGU8Uj4ge1xuICAgIHJldHVybiB0aGlzLnN0b3JlLmFzT2JzZXJ2YWJsZSgpLnBpcGUoXG4gICAgICBtYXAocHJvamVjdCksXG4gICAgICBkaXN0aW5jdFVudGlsQ2hhbmdlZCgpXG4gICAgKTtcbiAgfVxuXG4gIC8vIEBpbnRlcm5hbFxuICBfdmFsdWUoKTogUyB7XG4gICAgcmV0dXJuIHRoaXMuc3RvcmVWYWx1ZTtcbiAgfVxuXG4gIC8vIEBpbnRlcm5hbFxuICBfY2FjaGUoKTogQmVoYXZpb3JTdWJqZWN0PGJvb2xlYW4+IHtcbiAgICByZXR1cm4gdGhpcy5jYWNoZS5hY3RpdmU7XG4gIH1cblxuICAvLyBAaW50ZXJuYWxcbiAgZ2V0IGNvbmZpZygpOiBTdG9yZUNvbmZpZ09wdGlvbnMge1xuICAgIHJldHVybiB0aGlzLmNvbnN0cnVjdG9yW2NvbmZpZ0tleV0gfHwge307XG4gIH1cblxuICAvLyBAaW50ZXJuYWxcbiAgZ2V0IHN0b3JlTmFtZSgpIHtcbiAgICByZXR1cm4gKHRoaXMuY29uZmlnIGFzIFN0b3JlQ29uZmlnT3B0aW9ucyAmIHsgc3RvcmVOYW1lOiBzdHJpbmcgfSkuc3RvcmVOYW1lIHx8ICh0aGlzLm9wdGlvbnMgYXMgU3RvcmVDb25maWdPcHRpb25zICYgeyBzdG9yZU5hbWU6IHN0cmluZyB9KS5zdG9yZU5hbWUgfHwgdGhpcy5vcHRpb25zLm5hbWU7XG4gIH1cblxuICAvLyBAaW50ZXJuYWxcbiAgZ2V0IGRlZXBGcmVlemUoKSB7XG4gICAgcmV0dXJuIHRoaXMuY29uZmlnLmRlZXBGcmVlemVGbiB8fCB0aGlzLm9wdGlvbnMuZGVlcEZyZWV6ZUZuIHx8IGRlZXBGcmVlemU7XG4gIH1cblxuICAvLyBAaW50ZXJuYWxcbiAgZ2V0IGNhY2hlQ29uZmlnKCkge1xuICAgIHJldHVybiB0aGlzLmNvbmZpZy5jYWNoZSB8fCB0aGlzLm9wdGlvbnMuY2FjaGU7XG4gIH1cblxuICBnZXQgX3Byb2R1Y2VyRm4oKSB7XG4gICAgcmV0dXJuIHRoaXMuY29uZmlnLnByb2R1Y2VyRm4gfHwgdGhpcy5vcHRpb25zLnByb2R1Y2VyRm4gfHwgZ2V0R2xvYmFsUHJvZHVjZXJGbigpO1xuICB9XG5cbiAgLy8gQGludGVybmFsXG4gIGdldCByZXNldHRhYmxlKCkge1xuICAgIHJldHVybiBpc0RlZmluZWQodGhpcy5jb25maWcucmVzZXR0YWJsZSkgPyB0aGlzLmNvbmZpZy5yZXNldHRhYmxlIDogdGhpcy5vcHRpb25zLnJlc2V0dGFibGU7XG4gIH1cblxuICAvLyBAaW50ZXJuYWxcbiAgX3NldFN0YXRlKG5ld1N0YXRlOiAoKHN0YXRlOiBSZWFkb25seTxTPikgPT4gUykgfCBTLCBfZGlzcGF0Y2hBY3Rpb24gPSB0cnVlKSB7XG4gICAgaWYgKGlzRnVuY3Rpb24obmV3U3RhdGUpKSB7XG4gICAgICBjb25zdCBfbmV3U3RhdGUgPSBuZXdTdGF0ZSh0aGlzLl92YWx1ZSgpKTtcbiAgICAgIHRoaXMuc3RvcmVWYWx1ZSA9IF9fREVWX18gPyB0aGlzLmRlZXBGcmVlemUoX25ld1N0YXRlKSA6IF9uZXdTdGF0ZTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5zdG9yZVZhbHVlID0gbmV3U3RhdGU7XG4gICAgfVxuXG4gICAgaWYgKCF0aGlzLnN0b3JlKSB7XG4gICAgICB0aGlzLnN0b3JlID0gbmV3IEJlaGF2aW9yU3ViamVjdCh0aGlzLnN0b3JlVmFsdWUpO1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGlmIChpc1RyYW5zYWN0aW9uSW5Qcm9jZXNzKCkpIHtcbiAgICAgIHRoaXMuaGFuZGxlVHJhbnNhY3Rpb24oKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICB0aGlzLmRpc3BhdGNoKHRoaXMuc3RvcmVWYWx1ZSwgX2Rpc3BhdGNoQWN0aW9uKTtcbiAgfVxuXG4gIC8qKlxuICAgKlxuICAgKiBSZXNldCB0aGUgY3VycmVudCBzdG9yZSBiYWNrIHRvIHRoZSBpbml0aWFsIHZhbHVlXG4gICAqXG4gICAqIEBleGFtcGxlXG4gICAqXG4gICAqIHN0b3JlLnJlc2V0KClcbiAgICpcbiAgICovXG4gIHJlc2V0KCkge1xuICAgIGlmICh0aGlzLmlzUmVzZXR0YWJsZSgpKSB7XG4gICAgICBpc0RldigpICYmIHNldEFjdGlvbignUmVzZXQnKTtcbiAgICAgIHRoaXMuX3NldFN0YXRlKCgpID0+IE9iamVjdC5hc3NpZ24oe30sIHRoaXMuX2luaXRpYWxTdGF0ZSkpO1xuICAgICAgdGhpcy5zZXRIYXNDYWNoZShmYWxzZSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGlzRGV2KCkgJiYgY29uc29sZS53YXJuKGBZb3UgbmVlZCB0byBlbmFibGUgdGhlIHJlc2V0IGZ1bmN0aW9uYWxpdHlgKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICpcbiAgICogVXBkYXRlIHRoZSBzdG9yZSdzIHZhbHVlXG4gICAqXG4gICAqIEBleGFtcGxlXG4gICAqXG4gICAqIHRoaXMuc3RvcmUudXBkYXRlKHN0YXRlID0+IHtcbiAgICogICByZXR1cm4gey4uLn1cbiAgICogfSlcbiAgICovXG4gIHVwZGF0ZShzdGF0ZUNhbGxiYWNrOiBVcGRhdGVTdGF0ZUNhbGxiYWNrPFM+KTtcbiAgLyoqXG4gICAqXG4gICAqIEBleGFtcGxlXG4gICAqXG4gICAqICB0aGlzLnN0b3JlLnVwZGF0ZSh7IHRva2VuOiB0b2tlbiB9KVxuICAgKi9cbiAgdXBkYXRlKHN0YXRlOiBQYXJ0aWFsPFM+KTtcbiAgdXBkYXRlKHN0YXRlT3JDYWxsYmFjazogUGFydGlhbDxTPiB8IFVwZGF0ZVN0YXRlQ2FsbGJhY2s8Uz4pIHtcbiAgICBpc0RldigpICYmIHNldEFjdGlvbignVXBkYXRlJyk7XG5cbiAgICBsZXQgbmV3U3RhdGU7XG4gICAgY29uc3QgY3VycmVudFN0YXRlID0gdGhpcy5fdmFsdWUoKTtcbiAgICBpZiAoaXNGdW5jdGlvbihzdGF0ZU9yQ2FsbGJhY2spKSB7XG4gICAgICBuZXdTdGF0ZSA9IGlzRnVuY3Rpb24odGhpcy5fcHJvZHVjZXJGbikgPyB0aGlzLl9wcm9kdWNlckZuKGN1cnJlbnRTdGF0ZSwgc3RhdGVPckNhbGxiYWNrKSA6IHN0YXRlT3JDYWxsYmFjayhjdXJyZW50U3RhdGUpO1xuICAgIH0gZWxzZSB7XG4gICAgICBuZXdTdGF0ZSA9IHN0YXRlT3JDYWxsYmFjaztcbiAgICB9XG5cbiAgICBjb25zdCB3aXRoSG9vayA9IHRoaXMuYWtpdGFQcmVVcGRhdGUoY3VycmVudFN0YXRlLCB7IC4uLmN1cnJlbnRTdGF0ZSwgLi4ubmV3U3RhdGUgfSBhcyBTKTtcbiAgICBjb25zdCByZXNvbHZlZCA9IGlzUGxhaW5PYmplY3QoY3VycmVudFN0YXRlKSA/IHdpdGhIb29rIDogbmV3IChjdXJyZW50U3RhdGUgYXMgYW55KS5jb25zdHJ1Y3Rvcih3aXRoSG9vayk7XG4gICAgdGhpcy5fc2V0U3RhdGUocmVzb2x2ZWQpO1xuICB9XG5cbiAgdXBkYXRlU3RvcmVDb25maWcobmV3T3B0aW9uczogVXBkYXRhYmxlU3RvcmVDb25maWdPcHRpb25zKSB7XG4gICAgdGhpcy5vcHRpb25zID0geyAuLi50aGlzLm9wdGlvbnMsIC4uLm5ld09wdGlvbnMgfTtcbiAgfVxuXG4gIC8vIEBpbnRlcm5hbFxuICBha2l0YVByZVVwZGF0ZShfOiBSZWFkb25seTxTPiwgbmV4dFN0YXRlOiBSZWFkb25seTxTPik6IFMge1xuICAgIHJldHVybiBuZXh0U3RhdGU7XG4gIH1cblxuICBuZ09uRGVzdHJveSgpIHtcbiAgICB0aGlzLmRlc3Ryb3koKTtcbiAgfVxuXG4gIC8qKlxuICAgKlxuICAgKiBEZXN0cm95IHRoZSBzdG9yZVxuICAgKlxuICAgKiBAZXhhbXBsZVxuICAgKlxuICAgKiBzdG9yZS5kZXN0cm95KClcbiAgICpcbiAgICovXG4gIGRlc3Ryb3koKSB7XG4gICAgY29uc3QgaG1yRW5hYmxlZCA9IGlzQnJvd3NlciA/ICh3aW5kb3cgYXMgYW55KS5obXJFbmFibGVkIDogZmFsc2U7XG4gICAgaWYgKCFobXJFbmFibGVkICYmIHRoaXMgPT09IF9fc3RvcmVzX19bdGhpcy5zdG9yZU5hbWVdKSB7XG4gICAgICBkZWxldGUgX19zdG9yZXNfX1t0aGlzLnN0b3JlTmFtZV07XG4gICAgICBkaXNwYXRjaERlbGV0ZWQodGhpcy5zdG9yZU5hbWUpO1xuICAgICAgdGhpcy5zZXRIYXNDYWNoZShmYWxzZSk7XG4gICAgICB0aGlzLmNhY2hlLmFjdGl2ZS5jb21wbGV0ZSgpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgb25Jbml0KGluaXRpYWxTdGF0ZTogUykge1xuICAgIF9fc3RvcmVzX19bdGhpcy5zdG9yZU5hbWVdID0gdGhpcztcbiAgICB0aGlzLl9zZXRTdGF0ZSgoKSA9PiBpbml0aWFsU3RhdGUpO1xuICAgIGRpc3BhdGNoQWRkZWQodGhpcy5zdG9yZU5hbWUpO1xuICAgIGlmICh0aGlzLmlzUmVzZXR0YWJsZSgpKSB7XG4gICAgICB0aGlzLl9pbml0aWFsU3RhdGUgPSBpbml0aWFsU3RhdGU7XG4gICAgfVxuICAgIGlzRGV2KCkgJiYgYXNzZXJ0U3RvcmVIYXNOYW1lKHRoaXMuc3RvcmVOYW1lLCB0aGlzLmNvbnN0cnVjdG9yLm5hbWUpO1xuICB9XG5cbiAgcHJpdmF0ZSBkaXNwYXRjaChzdGF0ZTogUywgX2Rpc3BhdGNoQWN0aW9uID0gdHJ1ZSkge1xuICAgIHRoaXMuc3RvcmUubmV4dChzdGF0ZSk7XG4gICAgaWYgKF9kaXNwYXRjaEFjdGlvbikge1xuICAgICAgZGlzcGF0Y2hVcGRhdGUodGhpcy5zdG9yZU5hbWUpO1xuICAgICAgcmVzZXRDdXN0b21BY3Rpb24oKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIHdhdGNoVHJhbnNhY3Rpb24oKSB7XG4gICAgY29tbWl0KCkuc3Vic2NyaWJlKCgpID0+IHtcbiAgICAgIHRoaXMuaW5UcmFuc2FjdGlvbiA9IGZhbHNlO1xuICAgICAgdGhpcy5kaXNwYXRjaCh0aGlzLl92YWx1ZSgpKTtcbiAgICB9KTtcbiAgfVxuXG4gIHByaXZhdGUgaXNSZXNldHRhYmxlKCkge1xuICAgIGlmICh0aGlzLnJlc2V0dGFibGUgPT09IGZhbHNlKSB7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuICAgIHJldHVybiB0aGlzLnJlc2V0dGFibGUgfHwgZ2V0QWtpdGFDb25maWcoKS5yZXNldHRhYmxlO1xuICB9XG5cbiAgcHJpdmF0ZSBoYW5kbGVUcmFuc2FjdGlvbigpIHtcbiAgICBpZiAoIXRoaXMuaW5UcmFuc2FjdGlvbikge1xuICAgICAgdGhpcy53YXRjaFRyYW5zYWN0aW9uKCk7XG4gICAgICB0aGlzLmluVHJhbnNhY3Rpb24gPSB0cnVlO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgZ2V0Q2FjaGVUVEwoKSB7XG4gICAgcmV0dXJuICh0aGlzLmNhY2hlQ29uZmlnICYmIHRoaXMuY2FjaGVDb25maWcudHRsKSB8fCBnZXRBa2l0YUNvbmZpZygpLnR0bDtcbiAgfVxufVxuIl19