/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { filter, skip } from 'rxjs/operators';
import { from, isObservable, of, ReplaySubject } from 'rxjs';
import { isFunction } from './isFunction';
import { AkitaError } from './errors';
import { __stores__ } from './stores';
import { getValue } from './getValueByString';
import { setAction } from './actions';
import { setValue } from './setValueByString';
import { $$addStore, $$deleteStore } from './dispatchers';
import { isNil } from './isNil';
import { isObject } from './isObject';
import { isNotBrowser, hasLocalStorage, hasSessionStorage } from './root';
/** @type {?} */
let skipStorageUpdate = false;
/** @type {?} */
const _persistStateInit = new ReplaySubject(1);
/**
 * @return {?}
 */
export function selectPersistStateInit() {
    return _persistStateInit.asObservable();
}
/**
 * @param {?} skip
 * @return {?}
 */
export function setSkipStorageUpdate(skip) {
    skipStorageUpdate = skip;
}
/**
 * @return {?}
 */
export function getSkipStorageUpdate() {
    return skipStorageUpdate;
}
/**
 * @record
 */
export function PersistStateStorage() { }
if (false) {
    /**
     * @param {?} key
     * @return {?}
     */
    PersistStateStorage.prototype.getItem = function (key) { };
    /**
     * @param {?} key
     * @param {?} value
     * @return {?}
     */
    PersistStateStorage.prototype.setItem = function (key, value) { };
    /**
     * @return {?}
     */
    PersistStateStorage.prototype.clear = function () { };
}
/**
 * @param {?} v
 * @return {?}
 */
function isPromise(v) {
    return v && isFunction(v.then);
}
/**
 * @param {?} asyncOrValue
 * @return {?}
 */
function observify(asyncOrValue) {
    if (isPromise(asyncOrValue) || isObservable(asyncOrValue)) {
        return from(asyncOrValue);
    }
    return of(asyncOrValue);
}
/**
 * @record
 */
export function PersistStateParams() { }
if (false) {
    /**
     * The storage key
     * @type {?}
     */
    PersistStateParams.prototype.key;
    /**
     * Whether to enable persistState in a non-browser environment
     * @type {?}
     */
    PersistStateParams.prototype.enableInNonBrowser;
    /**
     * Storage strategy to use. This defaults to LocalStorage but you can pass SessionStorage or anything that implements the StorageEngine API.
     * @type {?}
     */
    PersistStateParams.prototype.storage;
    /**
     * Custom deserializer. Defaults to JSON.parse
     * @type {?}
     */
    PersistStateParams.prototype.deserialize;
    /**
     * Custom serializer, defaults to JSON.stringify
     * @type {?}
     */
    PersistStateParams.prototype.serialize;
    /**
     * By default the whole state is saved to storage, use this param to include only the stores you need.
     * Pay attention that you can't use both include and exclude
     * @type {?}
     */
    PersistStateParams.prototype.include;
    /**
     *  By default the whole state is saved to storage, use this param to exclude stores that you don't need.
     *  Pay attention that you can't use both include and exclude
     * @type {?}
     */
    PersistStateParams.prototype.exclude;
    /** @type {?} */
    PersistStateParams.prototype.skipStorageUpdate;
    /** @type {?} */
    PersistStateParams.prototype.preStorageUpdateOperator;
    /**
     * Whether to persist a dynamic store upon destroy
     * @type {?}
     */
    PersistStateParams.prototype.persistOnDestroy;
    /**
     * @param {?} storeName
     * @param {?} state
     * @return {?}
     */
    PersistStateParams.prototype.preStorageUpdate = function (storeName, state) { };
    /**
     * @param {?} storeName
     * @param {?} state
     * @return {?}
     */
    PersistStateParams.prototype.preStoreUpdate = function (storeName, state) { };
}
/**
 * @param {?=} params
 * @return {?}
 */
export function persistState(params) {
    /** @type {?} */
    const defaults = {
        key: 'AkitaStores',
        enableInNonBrowser: false,
        storage: !hasLocalStorage() ? params.storage : localStorage,
        deserialize: JSON.parse,
        serialize: JSON.stringify,
        include: [],
        /**
         * @deprecated use include with a callback
         */
        exclude: [],
        persistOnDestroy: false,
        preStorageUpdate: (/**
         * @param {?} storeName
         * @param {?} state
         * @return {?}
         */
        function (storeName, state) {
            return state;
        }),
        preStoreUpdate: (/**
         * @param {?} storeName
         * @param {?} state
         * @return {?}
         */
        function (storeName, state) {
            return state;
        }),
        skipStorageUpdate: getSkipStorageUpdate,
        preStorageUpdateOperator: (/**
         * @return {?}
         */
        () => (/**
         * @param {?} source
         * @return {?}
         */
        source => source))
    };
    const { storage, enableInNonBrowser, deserialize, serialize, include, exclude, key, preStorageUpdate, persistOnDestroy, preStorageUpdateOperator, preStoreUpdate, skipStorageUpdate } = Object.assign({}, defaults, params);
    if ((isNotBrowser && !enableInNonBrowser) || !storage)
        return;
    /** @type {?} */
    const hasInclude = include.length > 0;
    /** @type {?} */
    const hasExclude = exclude.length > 0;
    /** @type {?} */
    let includeStores;
    if (hasInclude && hasExclude) {
        throw new AkitaError("You can't use both include and exclude");
    }
    if (hasInclude) {
        includeStores = include.reduce((/**
         * @param {?} acc
         * @param {?} path
         * @return {?}
         */
        (acc, path) => {
            if (isFunction(path)) {
                acc.fns.push(path);
            }
            else {
                /** @type {?} */
                const storeName = path.split('.')[0];
                acc[storeName] = path;
            }
            return acc;
        }), { fns: [] });
    }
    /** @type {?} */
    let stores = {};
    /** @type {?} */
    let acc = {};
    /** @type {?} */
    let subscriptions = [];
    /** @type {?} */
    const buffer = [];
    /**
     * @param {?} v
     * @return {?}
     */
    function _save(v) {
        observify(v).subscribe((/**
         * @return {?}
         */
        () => {
            /** @type {?} */
            const next = buffer.shift();
            next && _save(next);
        }));
    }
    // when we use the local/session storage we perform the serialize, otherwise we let the passed storage implementation to do it
    /** @type {?} */
    const isLocalStorage = (hasLocalStorage() && storage === localStorage) || (hasSessionStorage() && storage === sessionStorage);
    observify(storage.getItem(key)).subscribe((/**
     * @param {?} value
     * @return {?}
     */
    (value) => {
        /** @type {?} */
        let storageState = isObject(value) ? value : deserialize(value || '{}');
        /**
         * @param {?} storeCache
         * @return {?}
         */
        function save(storeCache) {
            storageState['$cache'] = Object.assign({}, (storageState['$cache'] || {}), storeCache);
            storageState = Object.assign({}, storageState, acc);
            buffer.push(storage.setItem(key, isLocalStorage ? serialize(storageState) : storageState));
            _save(buffer.shift());
        }
        /**
         * @param {?} storeName
         * @param {?} path
         * @return {?}
         */
        function subscribe(storeName, path) {
            stores[storeName] = __stores__[storeName]
                ._select((/**
             * @param {?} state
             * @return {?}
             */
            state => getValue(state, path)))
                .pipe(skip(1), filter((/**
             * @return {?}
             */
            () => skipStorageUpdate() === false)), preStorageUpdateOperator())
                .subscribe((/**
             * @param {?} data
             * @return {?}
             */
            data => {
                acc[storeName] = preStorageUpdate(storeName, data);
                Promise.resolve().then((/**
                 * @return {?}
                 */
                () => save({ [storeName]: __stores__[storeName]._cache().getValue() })));
            }));
        }
        /**
         * @param {?} storeName
         * @param {?} store
         * @param {?} path
         * @return {?}
         */
        function setInitial(storeName, store, path) {
            if (storeName in storageState) {
                setAction('@PersistState');
                store._setState((/**
                 * @param {?} state
                 * @return {?}
                 */
                state => {
                    return setValue(state, path, preStoreUpdate(storeName, storageState[storeName]));
                }));
                /** @type {?} */
                const hasCache = storageState['$cache'] ? storageState['$cache'][storeName] : false;
                __stores__[storeName].setHasCache(hasCache, { restartTTL: true });
            }
        }
        subscriptions.push($$deleteStore.subscribe((/**
         * @param {?} storeName
         * @return {?}
         */
        storeName => {
            if (stores[storeName]) {
                if (persistOnDestroy === false) {
                    save({ [storeName]: false });
                }
                stores[storeName].unsubscribe();
                delete stores[storeName];
            }
        })));
        subscriptions.push($$addStore.subscribe((/**
         * @param {?} storeName
         * @return {?}
         */
        storeName => {
            if (storeName === 'router' || (hasExclude && exclude.includes(storeName))) {
                return;
            }
            /** @type {?} */
            const store = __stores__[storeName];
            if (hasInclude) {
                /** @type {?} */
                let path = includeStores[storeName];
                if (!path) {
                    /** @type {?} */
                    const passPredicate = includeStores.fns.some((/**
                     * @param {?} fn
                     * @return {?}
                     */
                    fn => fn(storeName)));
                    if (passPredicate) {
                        path = storeName;
                    }
                    else {
                        return;
                    }
                }
                setInitial(storeName, store, path);
                subscribe(storeName, path);
            }
            else {
                setInitial(storeName, store, storeName);
                subscribe(storeName, storeName);
            }
        })));
        _persistStateInit.next();
    }));
    return {
        /**
         * @return {?}
         */
        destroy() {
            subscriptions.forEach((/**
             * @param {?} s
             * @return {?}
             */
            s => s.unsubscribe()));
            for (let i = 0, keys = Object.keys(stores); i < keys.length; i++) {
                /** @type {?} */
                const storeName = keys[i];
                stores[storeName].unsubscribe();
            }
            stores = {};
        },
        /**
         * @return {?}
         */
        clear() {
            storage.clear();
        },
        /**
         * @param {?=} storeName
         * @return {?}
         */
        clearStore(storeName) {
            if (isNil(storeName)) {
                /** @type {?} */
                const value = observify(storage.setItem(key, '{}'));
                value.subscribe();
                return;
            }
            /** @type {?} */
            const value = storage.getItem(key);
            observify(value).subscribe((/**
             * @param {?} v
             * @return {?}
             */
            v => {
                /** @type {?} */
                const storageState = deserialize(v || '{}');
                if (storageState[storeName]) {
                    delete storageState[storeName];
                    /** @type {?} */
                    const value = observify(storage.setItem(key, serialize(storageState)));
                    value.subscribe();
                }
            }));
        }
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGVyc2lzdFN0YXRlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGRhdG9yYW1hL2FraXRhLyIsInNvdXJjZXMiOlsic3JjL3BlcnNpc3RTdGF0ZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQUEsT0FBTyxFQUFFLE1BQU0sRUFBRSxJQUFJLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUM5QyxPQUFPLEVBQUUsSUFBSSxFQUFFLFlBQVksRUFBRSxFQUFFLEVBQW9CLGFBQWEsRUFBZ0IsTUFBTSxNQUFNLENBQUM7QUFFN0YsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGNBQWMsQ0FBQztBQUMxQyxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sVUFBVSxDQUFDO0FBQ3RDLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxVQUFVLENBQUM7QUFDdEMsT0FBTyxFQUFFLFFBQVEsRUFBRSxNQUFNLG9CQUFvQixDQUFDO0FBQzlDLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxXQUFXLENBQUM7QUFDdEMsT0FBTyxFQUFFLFFBQVEsRUFBRSxNQUFNLG9CQUFvQixDQUFDO0FBQzlDLE9BQU8sRUFBRSxVQUFVLEVBQUUsYUFBYSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzFELE9BQU8sRUFBRSxLQUFLLEVBQUUsTUFBTSxTQUFTLENBQUM7QUFDaEMsT0FBTyxFQUFFLFFBQVEsRUFBRSxNQUFNLFlBQVksQ0FBQztBQUN0QyxPQUFPLEVBQUUsWUFBWSxFQUFFLGVBQWUsRUFBRSxpQkFBaUIsRUFBRSxNQUFNLFFBQVEsQ0FBQzs7SUFFdEUsaUJBQWlCLEdBQUcsS0FBSzs7TUFFdkIsaUJBQWlCLEdBQUcsSUFBSSxhQUFhLENBQUMsQ0FBQyxDQUFDOzs7O0FBRTlDLE1BQU0sVUFBVSxzQkFBc0I7SUFDcEMsT0FBTyxpQkFBaUIsQ0FBQyxZQUFZLEVBQUUsQ0FBQztBQUMxQyxDQUFDOzs7OztBQUVELE1BQU0sVUFBVSxvQkFBb0IsQ0FBQyxJQUFhO0lBQ2hELGlCQUFpQixH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LFNBQVMsQ0FBQyxDQUFDLFdBQVcsRUFBRSxDQUFDO2FBQ2pDO1lBQ0QsTUFBTSxHQUFHLEVBQUUsQ0FBQztRQUNkLENBQUM7Ozs7UUFDRCxLQUFLO1lBQ0gsT0FBTyxDQUFDLEtBQUssRUFBRSxDQUFDO1FBQ2xCLENBQUM7Ozs7O1FBQ0QsVUFBVSxDQUFDLFNBQWtCO1lBQzNCLElBQUksS0FBSyxDQUFDLFNBQVMsQ0FBQyxFQUFFOztzQkFDZCxLQUFLLEdBQUcsU0FBUyxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsR0FBRyxFQUFFLElBQUksQ0FBQyxDQUFDO2dCQUNuRCxLQUFLLENBQUMsU0FBUyxFQUFFLENBQUM7Z0JBQ2xCLE9BQU87YUFDUjs7a0JBQ0ssS0FBSyxHQUFHLE9BQU8sQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDO1lBQ2xDLFNBQVMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxTQUFTOzs7O1lBQUMsQ0FBQyxDQUFDLEVBQUU7O3NCQUN2QixZQUFZLEdBQUcsV0FBVyxDQUFDLENBQUMsSUFBSSxJQUFJLENBQUM7Z0JBRTNDLElBQUksWUFBWSxDQUFDLFNBQVMsQ0FBQyxFQUFFO29CQUMzQixPQUFPLFlBQVksQ0FBQyxTQUFTLENBQUMsQ0FBQzs7MEJBQ3pCLEtBQUssR0FBRyxTQUFTLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxHQUFHLEVBQUUsU0FBUyxDQUFDLFlBQVksQ0FBQyxDQUFDLENBQUM7b0JBQ3RFLEtBQUssQ0FBQyxTQUFTLEVBQUUsQ0FBQztpQkFDbkI7WUFDSCxDQUFDLEVBQUMsQ0FBQztRQUNMLENBQUM7S0FDRixDQUFDO0FBQ0osQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGZpbHRlciwgc2tpcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7IGZyb20sIGlzT2JzZXJ2YWJsZSwgb2YsIE9wZXJhdG9yRnVuY3Rpb24sIFJlcGxheVN1YmplY3QsIFN1YnNjcmlwdGlvbiB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgSGFzaE1hcCwgTWF5YmVBc3luYyB9IGZyb20gJy4vdHlwZXMnO1xuaW1wb3J0IHsgaXNGdW5jdGlvbiB9IGZyb20gJy4vaXNGdW5jdGlvbic7XG5pbXBvcnQgeyBBa2l0YUVycm9yIH0gZnJvbSAnLi9lcnJvcnMnO1xuaW1wb3J0IHsgX19zdG9yZXNfXyB9IGZyb20gJy4vc3RvcmVzJztcbmltcG9ydCB7IGdldFZhbHVlIH0gZnJvbSAnLi9nZXRWYWx1ZUJ5U3RyaW5nJztcbmltcG9ydCB7IHNldEFjdGlvbiB9IGZyb20gJy4vYWN0aW9ucyc7XG5pbXBvcnQgeyBzZXRWYWx1ZSB9IGZyb20gJy4vc2V0VmFsdWVCeVN0cmluZyc7XG5pbXBvcnQgeyAkJGFkZFN0b3JlLCAkJGRlbGV0ZVN0b3JlIH0gZnJvbSAnLi9kaXNwYXRjaGVycyc7XG5pbXBvcnQgeyBpc05pbCB9IGZyb20gJy4vaXNOaWwnO1xuaW1wb3J0IHsgaXNPYmplY3QgfSBmcm9tICcuL2lzT2JqZWN0JztcbmltcG9ydCB7IGlzTm90QnJvd3NlciwgaGFzTG9jYWxTdG9yYWdlLCBoYXNTZXNzaW9uU3RvcmFnZSB9IGZyb20gJy4vcm9vdCc7XG5cbmxldCBza2lwU3RvcmFnZVVwZGF0ZSA9IGZhbHNlO1xuXG5jb25zdCBfcGVyc2lzdFN0YXRlSW5pdCA9IG5ldyBSZXBsYXlTdWJqZWN0KDEpO1xuXG5leHBvcnQgZnVuY3Rpb24gc2VsZWN0UGVyc2lzdFN0YXRlSW5pdCgpIHtcbiAgcmV0dXJuIF9wZXJzaXN0U3RhdGVJbml0LmFzT2JzZXJ2YWJsZSgpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gc2V0U2tpcFN0b3JhZ2VVcGRhdGUoc2tpcDogYm9vbGVhbikge1xuICBza2lwU3RvcmFnZVVwZGF0ZSA9IHNraXA7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXRTa2lwU3RvcmFnZVVwZGF0ZSgpIHtcbiAgcmV0dXJuIHNraXBTdG9yYWdlVXBkYXRlO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIFBlcnNpc3RTdGF0ZVN0b3JhZ2Uge1xuICBnZXRJdGVtKGtleTogc3RyaW5nKTogTWF5YmVBc3luYztcblxuICBzZXRJdGVtKGtleTogc3RyaW5nLCB2YWx1ZTogYW55KTogTWF5YmVBc3luYztcblxuICBjbGVhcigpOiB2b2lkO1xufVxuXG5mdW5jdGlvbiBpc1Byb21pc2UodjogYW55KSB7XG4gIHJldHVybiB2ICYmIGlzRnVuY3Rpb24odi50aGVuKTtcbn1cblxuZnVuY3Rpb24gb2JzZXJ2aWZ5KGFzeW5jT3JWYWx1ZTogYW55KSB7XG4gIGlmIChpc1Byb21pc2UoYXN5bmNPclZhbHVlKSB8fCBpc09ic2VydmFibGUoYXN5bmNPclZhbHVlKSkge1xuICAgIHJldHVybiBmcm9tKGFzeW5jT3JWYWx1ZSk7XG4gIH1cblxuICByZXR1cm4gb2YoYXN5bmNPclZhbHVlKTtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBQZXJzaXN0U3RhdGVQYXJhbXMge1xuICAvKiogVGhlIHN0b3JhZ2Uga2V5ICovXG4gIGtleTogc3RyaW5nO1xuICAvKiogV2hldGhlciB0byBlbmFibGUgcGVyc2lzdFN0YXRlIGluIGEgbm9uLWJyb3dzZXIgZW52aXJvbm1lbnQgKi9cbiAgZW5hYmxlSW5Ob25Ccm93c2VyOiBib29sZWFuO1xuICAvKiogU3RvcmFnZSBzdHJhdGVneSB0byB1c2UuIFRoaXMgZGVmYXVsdHMgdG8gTG9jYWxTdG9yYWdlIGJ1dCB5b3UgY2FuIHBhc3MgU2Vzc2lvblN0b3JhZ2Ugb3IgYW55dGhpbmcgdGhhdCBpbXBsZW1lbnRzIHRoZSBTdG9yYWdlRW5naW5lIEFQSS4gKi9cbiAgc3RvcmFnZTogUGVyc2lzdFN0YXRlU3RvcmFnZTtcbiAgLyoqIEN1c3RvbSBkZXNlcmlhbGl6ZXIuIERlZmF1bHRzIHRvIEpTT04ucGFyc2UgKi9cbiAgZGVzZXJpYWxpemU6IEZ1bmN0aW9uO1xuICAvKiogQ3VzdG9tIHNlcmlhbGl6ZXIsIGRlZmF1bHRzIHRvIEpTT04uc3RyaW5naWZ5ICovXG4gIHNlcmlhbGl6ZTogRnVuY3Rpb247XG4gIC8qKlxuICAgKiBCeSBkZWZhdWx0IHRoZSB3aG9sZSBzdGF0ZSBpcyBzYXZlZCB0byBzdG9yYWdlLCB1c2UgdGhpcyBwYXJhbSB0byBpbmNsdWRlIG9ubHkgdGhlIHN0b3JlcyB5b3UgbmVlZC5cbiAgICogUGF5IGF0dGVudGlvbiB0aGF0IHlvdSBjYW4ndCB1c2UgYm90aCBpbmNsdWRlIGFuZCBleGNsdWRlXG4gICAqL1xuICBpbmNsdWRlOiAoc3RyaW5nIHwgKChzdG9yZU5hbWU6IHN0cmluZykgPT4gYm9vbGVhbikpW107XG4gIC8qKlxuICAgKiAgQnkgZGVmYXVsdCB0aGUgd2hvbGUgc3RhdGUgaXMgc2F2ZWQgdG8gc3RvcmFnZSwgdXNlIHRoaXMgcGFyYW0gdG8gZXhjbHVkZSBzdG9yZXMgdGhhdCB5b3UgZG9uJ3QgbmVlZC5cbiAgICogIFBheSBhdHRlbnRpb24gdGhhdCB5b3UgY2FuJ3QgdXNlIGJvdGggaW5jbHVkZSBhbmQgZXhjbHVkZVxuICAgKi9cbiAgZXhjbHVkZTogc3RyaW5nW107XG5cbiAgcHJlU3RvcmFnZVVwZGF0ZShzdG9yZU5hbWU6IHN0cmluZywgc3RhdGU6IGFueSk6IGFueTtcblxuICBwcmVTdG9yZVVwZGF0ZShzdG9yZU5hbWU6IHN0cmluZywgc3RhdGU6IGFueSk6IGFueTtcblxuICBza2lwU3RvcmFnZVVwZGF0ZTogKCkgPT4gYm9vbGVhbjtcbiAgcHJlU3RvcmFnZVVwZGF0ZU9wZXJhdG9yOiAoKSA9PiBPcGVyYXRvckZ1bmN0aW9uPGFueSwgYW55PjtcbiAgLyoqIFdoZXRoZXIgdG8gcGVyc2lzdCBhIGR5bmFtaWMgc3RvcmUgdXBvbiBkZXN0cm95ICovXG4gIHBlcnNpc3RPbkRlc3Ryb3k6IGJvb2xlYW47XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBwZXJzaXN0U3RhdGUocGFyYW1zPzogUGFydGlhbDxQZXJzaXN0U3RhdGVQYXJhbXM+KSB7XG4gIGNvbnN0IGRlZmF1bHRzOiBQZXJzaXN0U3RhdGVQYXJhbXMgPSB7XG4gICAga2V5OiAnQWtpdGFTdG9yZXMnLFxuICAgIGVuYWJsZUluTm9uQnJvd3NlcjogZmFsc2UsXG4gICAgc3RvcmFnZTogIWhhc0xvY2FsU3RvcmFnZSgpID8gcGFyYW1zLnN0b3JhZ2UgOiBsb2NhbFN0b3JhZ2UsXG4gICAgZGVzZXJpYWxpemU6IEpTT04ucGFyc2UsXG4gICAgc2VyaWFsaXplOiBKU09OLnN0cmluZ2lmeSxcbiAgICBpbmNsdWRlOiBbXSxcbiAgICAvKipcbiAgICAgKiBAZGVwcmVjYXRlZCB1c2UgaW5jbHVkZSB3aXRoIGEgY2FsbGJhY2tcbiAgICAgKi9cbiAgICBleGNsdWRlOiBbXSxcbiAgICBwZXJzaXN0T25EZXN0cm95OiBmYWxzZSxcbiAgICBwcmVTdG9yYWdlVXBkYXRlOiBmdW5jdGlvbihzdG9yZU5hbWUsIHN0YXRlKSB7XG4gICAgICByZXR1cm4gc3RhdGU7XG4gICAgfSxcbiAgICBwcmVTdG9yZVVwZGF0ZTogZnVuY3Rpb24oc3RvcmVOYW1lLCBzdGF0ZSkge1xuICAgICAgcmV0dXJuIHN0YXRlO1xuICAgIH0sXG4gICAgc2tpcFN0b3JhZ2VVcGRhdGU6IGdldFNraXBTdG9yYWdlVXBkYXRlLFxuICAgIHByZVN0b3JhZ2VVcGRhdGVPcGVyYXRvcjogKCkgPT4gc291cmNlID0+IHNvdXJjZVxuICB9O1xuXG4gIGNvbnN0IHsgc3RvcmFnZSwgZW5hYmxlSW5Ob25Ccm93c2VyLCBkZXNlcmlhbGl6ZSwgc2VyaWFsaXplLCBpbmNsdWRlLCBleGNsdWRlLCBrZXksIHByZVN0b3JhZ2VVcGRhdGUsIHBlcnNpc3RPbkRlc3Ryb3ksIHByZVN0b3JhZ2VVcGRhdGVPcGVyYXRvciwgcHJlU3RvcmVVcGRhdGUsIHNraXBTdG9yYWdlVXBkYXRlIH0gPSBPYmplY3QuYXNzaWduKFxuICAgIHt9LFxuICAgIGRlZmF1bHRzLFxuICAgIHBhcmFtc1xuICApO1xuXG4gIGlmICgoaXNOb3RCcm93c2VyICYmICFlbmFibGVJbk5vbkJyb3dzZXIpIHx8ICFzdG9yYWdlKSByZXR1cm47XG5cbiAgY29uc3QgaGFzSW5jbHVkZSA9IGluY2x1ZGUubGVuZ3RoID4gMDtcbiAgY29uc3QgaGFzRXhjbHVkZSA9IGV4Y2x1ZGUubGVuZ3RoID4gMDtcbiAgbGV0IGluY2x1ZGVTdG9yZXM6IHsgZm5zOiBGdW5jdGlvbltdOyBba2V5OiBzdHJpbmddOiBGdW5jdGlvbltdIHwgc3RyaW5nIH07XG5cbiAgaWYgKGhhc0luY2x1ZGUgJiYgaGFzRXhjbHVkZSkge1xuICAgIHRocm93IG5ldyBBa2l0YUVycm9yKFwiWW91IGNhbid0IHVzZSBib3RoIGluY2x1ZGUgYW5kIGV4Y2x1ZGVcIik7XG4gIH1cblxuICBpZiAoaGFzSW5jbHVkZSkge1xuICAgIGluY2x1ZGVTdG9yZXMgPSBpbmNsdWRlLnJlZHVjZShcbiAgICAgIChhY2MsIHBhdGgpID0+IHtcbiAgICAgICAgaWYgKGlzRnVuY3Rpb24ocGF0aCkpIHtcbiAgICAgICAgICBhY2MuZm5zLnB1c2gocGF0aCk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgY29uc3Qgc3RvcmVOYW1lID0gcGF0aC5zcGxpdCgnLicpWzBdO1xuICAgICAgICAgIGFjY1tzdG9yZU5hbWVdID0gcGF0aDtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gYWNjO1xuICAgICAgfSxcbiAgICAgIHsgZm5zOiBbXSB9XG4gICAgKTtcbiAgfVxuXG4gIGxldCBzdG9yZXM6IEhhc2hNYXA8U3Vic2NyaXB0aW9uPiA9IHt9O1xuICBsZXQgYWNjID0ge307XG4gIGxldCBzdWJzY3JpcHRpb25zOiBTdWJzY3JpcHRpb25bXSA9IFtdO1xuXG4gIGNvbnN0IGJ1ZmZlciA9IFtdO1xuXG4gIGZ1bmN0aW9uIF9zYXZlKHY6IGFueSkge1xuICAgIG9ic2VydmlmeSh2KS5zdWJzY3JpYmUoKCkgPT4ge1xuICAgICAgY29uc3QgbmV4dCA9IGJ1ZmZlci5zaGlmdCgpO1xuICAgICAgbmV4dCAmJiBfc2F2ZShuZXh0KTtcbiAgICB9KTtcbiAgfVxuXG4gIC8vIHdoZW4gd2UgdXNlIHRoZSBsb2NhbC9zZXNzaW9uIHN0b3JhZ2Ugd2UgcGVyZm9ybSB0aGUgc2VyaWFsaXplLCBvdGhlcndpc2Ugd2UgbGV0IHRoZSBwYXNzZWQgc3RvcmFnZSBpbXBsZW1lbnRhdGlvbiB0byBkbyBpdFxuICBjb25zdCBpc0xvY2FsU3RvcmFnZSA9IChoYXNMb2NhbFN0b3JhZ2UoKSAmJiBzdG9yYWdlID09PSBsb2NhbFN0b3JhZ2UpIHx8IChoYXNTZXNzaW9uU3RvcmFnZSgpICYmIHN0b3JhZ2UgPT09IHNlc3Npb25TdG9yYWdlKTtcblxuICBvYnNlcnZpZnkoc3RvcmFnZS5nZXRJdGVtKGtleSkpLnN1YnNjcmliZSgodmFsdWU6IGFueSkgPT4ge1xuICAgIGxldCBzdG9yYWdlU3RhdGUgPSBpc09iamVjdCh2YWx1ZSkgPyB2YWx1ZSA6IGRlc2VyaWFsaXplKHZhbHVlIHx8ICd7fScpO1xuXG4gICAgZnVuY3Rpb24gc2F2ZShzdG9yZUNhY2hlKSB7XG4gICAgICBzdG9yYWdlU3RhdGVbJyRjYWNoZSddID0geyAuLi4oc3RvcmFnZVN0YXRlWyckY2FjaGUnXSB8fCB7fSksIC4uLnN0b3JlQ2FjaGUgfTtcbiAgICAgIHN0b3JhZ2VTdGF0ZSA9IE9iamVjdC5hc3NpZ24oe30sIHN0b3JhZ2VTdGF0ZSwgYWNjKTtcblxuICAgICAgYnVmZmVyLnB1c2goc3RvcmFnZS5zZXRJdGVtKGtleSwgaXNMb2NhbFN0b3JhZ2UgPyBzZXJpYWxpemUoc3RvcmFnZVN0YXRlKSA6IHN0b3JhZ2VTdGF0ZSkpO1xuICAgICAgX3NhdmUoYnVmZmVyLnNoaWZ0KCkpO1xuICAgIH1cblxuICAgIGZ1bmN0aW9uIHN1YnNjcmliZShzdG9yZU5hbWUsIHBhdGgpIHtcbiAgICAgIHN0b3Jlc1tzdG9yZU5hbWVdID0gX19zdG9yZXNfX1tzdG9yZU5hbWVdXG4gICAgICAgIC5fc2VsZWN0KHN0YXRlID0+IGdldFZhbHVlKHN0YXRlLCBwYXRoKSlcbiAgICAgICAgLnBpcGUoXG4gICAgICAgICAgc2tpcCgxKSxcbiAgICAgICAgICBmaWx0ZXIoKCkgPT4gc2tpcFN0b3JhZ2VVcGRhdGUoKSA9PT0gZmFsc2UpLFxuICAgICAgICAgIHByZVN0b3JhZ2VVcGRhdGVPcGVyYXRvcigpXG4gICAgICAgIClcbiAgICAgICAgLnN1YnNjcmliZShkYXRhID0+IHtcbiAgICAgICAgICBhY2Nbc3RvcmVOYW1lXSA9IHByZVN0b3JhZ2VVcGRhdGUoc3RvcmVOYW1lLCBkYXRhKTtcbiAgICAgICAgICBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IHNhdmUoeyBbc3RvcmVOYW1lXTogX19zdG9yZXNfX1tzdG9yZU5hbWVdLl9jYWNoZSgpLmdldFZhbHVlKCkgfSkpO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBmdW5jdGlvbiBzZXRJbml0aWFsKHN0b3JlTmFtZSwgc3RvcmUsIHBhdGgpIHtcbiAgICAgIGlmIChzdG9yZU5hbWUgaW4gc3RvcmFnZVN0YXRlKSB7XG4gICAgICAgIHNldEFjdGlvbignQFBlcnNpc3RTdGF0ZScpO1xuICAgICAgICBzdG9yZS5fc2V0U3RhdGUoc3RhdGUgPT4ge1xuICAgICAgICAgIHJldHVybiBzZXRWYWx1ZShzdGF0ZSwgcGF0aCwgcHJlU3RvcmVVcGRhdGUoc3RvcmVOYW1lLCBzdG9yYWdlU3RhdGVbc3RvcmVOYW1lXSkpO1xuICAgICAgICB9KTtcbiAgICAgICAgY29uc3QgaGFzQ2FjaGUgPSBzdG9yYWdlU3RhdGVbJyRjYWNoZSddID8gc3RvcmFnZVN0YXRlWyckY2FjaGUnXVtzdG9yZU5hbWVdIDogZmFsc2U7XG4gICAgICAgIF9fc3RvcmVzX19bc3RvcmVOYW1lXS5zZXRIYXNDYWNoZShoYXNDYWNoZSwgeyByZXN0YXJ0VFRMOiB0cnVlIH0pO1xuICAgICAgfVxuICAgIH1cblxuICAgIHN1YnNjcmlwdGlvbnMucHVzaChcbiAgICAgICQkZGVsZXRlU3RvcmUuc3Vic2NyaWJlKHN0b3JlTmFtZSA9PiB7XG4gICAgICAgIGlmIChzdG9yZXNbc3RvcmVOYW1lXSkge1xuICAgICAgICAgIGlmIChwZXJzaXN0T25EZXN0cm95ID09PSBmYWxzZSkge1xuICAgICAgICAgICAgc2F2ZSh7IFtzdG9yZU5hbWVdOiBmYWxzZSB9KTtcbiAgICAgICAgICB9XG4gICAgICAgICAgc3RvcmVzW3N0b3JlTmFtZV0udW5zdWJzY3JpYmUoKTtcbiAgICAgICAgICBkZWxldGUgc3RvcmVzW3N0b3JlTmFtZV07XG4gICAgICAgIH1cbiAgICAgIH0pXG4gICAgKTtcblxuICAgIHN1YnNjcmlwdGlvbnMucHVzaChcbiAgICAgICQkYWRkU3RvcmUuc3Vic2NyaWJlKHN0b3JlTmFtZSA9PiB7XG4gICAgICAgIGlmIChzdG9yZU5hbWUgPT09ICdyb3V0ZXInIHx8IChoYXNFeGNsdWRlICYmIGV4Y2x1ZGUuaW5jbHVkZXMoc3RvcmVOYW1lKSkpIHtcbiAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBzdG9yZSA9IF9fc3RvcmVzX19bc3RvcmVOYW1lXTtcbiAgICAgICAgaWYgKGhhc0luY2x1ZGUpIHtcbiAgICAgICAgICBsZXQgcGF0aCA9IGluY2x1ZGVTdG9yZXNbc3RvcmVOYW1lXTtcblxuICAgICAgICAgIGlmICghcGF0aCkge1xuICAgICAgICAgICAgY29uc3QgcGFzc1ByZWRpY2F0ZSA9IGluY2x1ZGVTdG9yZXMuZm5zLnNvbWUoZm4gPT4gZm4oc3RvcmVOYW1lKSk7XG4gICAgICAgICAgICBpZiAocGFzc1ByZWRpY2F0ZSkge1xuICAgICAgICAgICAgICBwYXRoID0gc3RvcmVOYW1lO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgICBzZXRJbml0aWFsKHN0b3JlTmFtZSwgc3RvcmUsIHBhdGgpO1xuICAgICAgICAgIHN1YnNjcmliZShzdG9yZU5hbWUsIHBhdGgpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHNldEluaXRpYWwoc3RvcmVOYW1lLCBzdG9yZSwgc3RvcmVOYW1lKTtcbiAgICAgICAgICBzdWJzY3JpYmUoc3RvcmVOYW1lLCBzdG9yZU5hbWUpO1xuICAgICAgICB9XG4gICAgICB9KVxuICAgICk7XG5cbiAgICBfcGVyc2lzdFN0YXRlSW5pdC5uZXh0KCk7XG4gIH0pO1xuXG4gIHJldHVybiB7XG4gICAgZGVzdHJveSgpIHtcbiAgICAgIHN1YnNjcmlwdGlvbnMuZm9yRWFjaChzID0+IHMudW5zdWJzY3JpYmUoKSk7XG4gICAgICBmb3IgKGxldCBpID0gMCwga2V5cyA9IE9iamVjdC5rZXlzKHN0b3Jlcyk7IGkgPCBrZXlzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgIGNvbnN0IHN0b3JlTmFtZSA9IGtleXNbaV07XG4gICAgICAgIHN0b3Jlc1tzdG9yZU5hbWVdLnVuc3Vic2NyaWJlKCk7XG4gICAgICB9XG4gICAgICBzdG9yZXMgPSB7fTtcbiAgICB9LFxuICAgIGNsZWFyKCkge1xuICAgICAgc3RvcmFnZS5jbGVhcigpO1xuICAgIH0sXG4gICAgY2xlYXJTdG9yZShzdG9yZU5hbWU/OiBzdHJpbmcpIHtcbiAgICAgIGlmIChpc05pbChzdG9yZU5hbWUpKSB7XG4gICAgICAgIGNvbnN0IHZhbHVlID0gb2JzZXJ2aWZ5KHN0b3JhZ2Uuc2V0SXRlbShrZXksICd7fScpKTtcbiAgICAgICAgdmFsdWUuc3Vic2NyaWJlKCk7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cbiAgICAgIGNvbnN0IHZhbHVlID0gc3RvcmFnZS5nZXRJdGVtKGtleSk7XG4gICAgICBvYnNlcnZpZnkodmFsdWUpLnN1YnNjcmliZSh2ID0+IHtcbiAgICAgICAgY29uc3Qgc3RvcmFnZVN0YXRlID0gZGVzZXJpYWxpemUodiB8fCAne30nKTtcblxuICAgICAgICBpZiAoc3RvcmFnZVN0YXRlW3N0b3JlTmFtZV0pIHtcbiAgICAgICAgICBkZWxldGUgc3RvcmFnZVN0YXRlW3N0b3JlTmFtZV07XG4gICAgICAgICAgY29uc3QgdmFsdWUgPSBvYnNlcnZpZnkoc3RvcmFnZS5zZXRJdGVtKGtleSwgc2VyaWFsaXplKHN0b3JhZ2VTdGF0ZSkpKTtcbiAgICAgICAgICB2YWx1ZS5zdWJzY3JpYmUoKTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfVxuICB9O1xufVxuIl19