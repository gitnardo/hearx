import * as tslib_1 from "tslib";
var _a;
/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { isEmpty } from './isEmpty';
import { setEntities } from './setEntities';
import { Store } from './store';
import { getActiveEntities } from './getActiveEntities';
import { addEntities } from './addEntities';
import { coerceArray } from './coerceArray';
import { removeEntities } from './removeEntities';
import { getInitialEntitiesState } from './getInitialEntitiesState';
import { isDefined } from './isDefined';
import { updateEntities } from './updateEntities';
import { transaction } from './transaction';
import { isNil } from './isNil';
import { isFunction } from './isFunction';
import { isUndefined } from './isUndefined';
import { logAction, setAction } from './actions';
import { isDev } from './env';
import { hasEntity } from './hasEntity';
import { Subject } from 'rxjs';
import { EntityActions } from './entityActions';
import { DEFAULT_ID_KEY } from './defaultIDKey';
/**
 *
 * Store for managing a collection of entities
 *
 * \@example
 *
 * export interface WidgetsState extends EntityState<Widget> { }
 *
 * \@StoreConfig({ name: 'widgets' })
 *  export class WidgetsStore extends EntityStore<WidgetsState> {
 *   constructor() {
 *     super();
 *   }
 * }
 *
 *
 * @template S, EntityType, IDType
 */
export class EntityStore extends Store {
    /**
     * @param {?=} initialState
     * @param {?=} options
     */
    constructor(initialState = {}, options = {}) {
        super(Object.assign({}, getInitialEntitiesState(), initialState), options);
        this.options = options;
        this.entityActions = new Subject();
    }
    // @internal
    /**
     * @return {?}
     */
    get selectEntityAction$() {
        return this.entityActions.asObservable();
    }
    // @internal
    /**
     * @return {?}
     */
    get idKey() {
        return ((/** @type {?} */ (this.config))).idKey || this.options.idKey || DEFAULT_ID_KEY;
    }
    /**
     *
     * Replace current collection with provided collection
     *
     * \@example
     *
     * this.store.set([Entity, Entity])
     * this.store.set({ids: [], entities: {}})
     * this.store.set({ 1: {}, 2: {}})
     *
     * @param {?} entities
     * @param {?=} options
     * @return {?}
     */
    set(entities, options = {}) {
        if (isNil(entities))
            return;
        isDev() && setAction('Set Entity');
        /** @type {?} */
        const isNativePreAdd = this.akitaPreAddEntity === EntityStore.prototype.akitaPreAddEntity;
        this._setState((/**
         * @param {?} state
         * @return {?}
         */
        state => {
            /** @type {?} */
            const newState = setEntities({
                state,
                entities,
                idKey: this.idKey,
                preAddEntity: this.akitaPreAddEntity,
                isNativePreAdd
            });
            if (isUndefined(options.activeId) === false) {
                ((/** @type {?} */ (newState))).active = options.activeId;
            }
            return newState;
        }));
        this.setHasCache(true, { restartTTL: true });
        if (this.hasInitialUIState()) {
            this.handleUICreation();
        }
        this.entityActions.next({ type: EntityActions.Set, ids: this.ids });
    }
    /**
     * Add entities
     *
     * \@example
     *
     * this.store.add([Entity, Entity])
     * this.store.add(Entity)
     * this.store.add(Entity, { prepend: true })
     *
     * this.store.add(Entity, { loading: false })
     * @param {?} entities
     * @param {?=} options
     * @return {?}
     */
    add(entities, options = { loading: false }) {
        /** @type {?} */
        const collection = coerceArray(entities);
        if (isEmpty(collection))
            return;
        /** @type {?} */
        const data = addEntities({
            state: this._value(),
            preAddEntity: this.akitaPreAddEntity,
            entities: collection,
            idKey: this.idKey,
            options
        });
        if (data) {
            isDev() && setAction('Add Entity');
            data.newState.loading = options.loading;
            this._setState((/**
             * @return {?}
             */
            () => data.newState));
            if (this.hasInitialUIState()) {
                this.handleUICreation(true);
            }
            this.entityActions.next({ type: EntityActions.Add, ids: data.newIds });
        }
    }
    /**
     * @param {?} idsOrFnOrState
     * @param {?=} newStateOrFn
     * @return {?}
     */
    update(idsOrFnOrState, newStateOrFn) {
        if (isUndefined(newStateOrFn)) {
            super.update((/** @type {?} */ (idsOrFnOrState)));
            return;
        }
        /** @type {?} */
        let ids = [];
        if (isFunction(idsOrFnOrState)) {
            // We need to filter according the predicate function
            ids = this.ids.filter((/**
             * @param {?} id
             * @return {?}
             */
            id => ((/** @type {?} */ (idsOrFnOrState)))(this.entities[id])));
        }
        else {
            // If it's nil we want all of them
            ids = isNil(idsOrFnOrState) ? this.ids : coerceArray((/** @type {?} */ (idsOrFnOrState)));
        }
        if (isEmpty(ids))
            return;
        isDev() && setAction('Update Entity', ids);
        this._setState((/**
         * @param {?} state
         * @return {?}
         */
        state => updateEntities({
            idKey: this.idKey,
            ids,
            preUpdateEntity: this.akitaPreUpdateEntity,
            state,
            newStateOrFn,
            producerFn: this._producerFn
        })));
        this.entityActions.next({ type: EntityActions.Update, ids });
    }
    /**
     *
     * Create or update
     *
     * \@example
     *
     * store.upsert(1, { active: true })
     * store.upsert([2, 3], { active: true })
     * store.upsert([2, 3], entity => ({ isOpen: !entity.isOpen}))
     *
     * @param {?} ids
     * @param {?} newState
     * @param {?=} options
     * @return {?}
     */
    upsert(ids, newState, options = {}) {
        /** @type {?} */
        const toArray = coerceArray(ids);
        /** @type {?} */
        const predicate = (/**
         * @param {?} isUpdate
         * @return {?}
         */
        isUpdate => (/**
         * @param {?} id
         * @return {?}
         */
        id => hasEntity(this.entities, id) === isUpdate));
        /** @type {?} */
        const isClassBased = isFunction(options.baseClass);
        /** @type {?} */
        const updateIds = toArray.filter(predicate(true));
        /** @type {?} */
        const newEntities = toArray.filter(predicate(false)).map((/**
         * @param {?} id
         * @return {?}
         */
        id => {
            /** @type {?} */
            let entity = isFunction(newState) ? newState((/** @type {?} */ ({}))) : newState;
            /** @type {?} */
            const withId = Object.assign({}, ((/** @type {?} */ (entity))), { [this.idKey]: id });
            if (isClassBased) {
                return new options.baseClass(withId);
            }
            return withId;
        }));
        // it can be any of the three types
        this.update((/** @type {?} */ (updateIds)), (/** @type {?} */ (newState)));
        this.add(newEntities);
        isDev() && logAction('Upsert Entity');
    }
    /**
     *
     * Upsert entity collection (idKey must be present)
     *
     * \@example
     *
     * store.upsertMany([ { id: 1 }, { id: 2 }]);
     *
     * store.upsertMany([ { id: 1 }, { id: 2 }], { loading: true  });
     * store.upsertMany([ { id: 1 }, { id: 2 }], { baseClass: Todo  });
     *
     * @param {?} entities
     * @param {?=} options
     * @return {?}
     */
    upsertMany(entities, options = {}) {
        /** @type {?} */
        const addedIds = [];
        /** @type {?} */
        const updatedIds = [];
        /** @type {?} */
        const updatedEntities = {};
        // Update the state directly to optimize performance
        for (const entity of entities) {
            /** @type {?} */
            const withPreCheckHook = this.akitaPreCheckEntity(entity);
            /** @type {?} */
            const id = withPreCheckHook[this.idKey];
            if (hasEntity(this.entities, id)) {
                /** @type {?} */
                const prev = this._value().entities[id];
                /** @type {?} */
                const merged = Object.assign({}, this._value().entities[id], withPreCheckHook);
                /** @type {?} */
                const next = options.baseClass ? new options.baseClass(merged) : merged;
                /** @type {?} */
                const withHook = this.akitaPreUpdateEntity(prev, next);
                /** @type {?} */
                const nextId = withHook[this.idKey];
                updatedEntities[nextId] = withHook;
                updatedIds.push(nextId);
            }
            else {
                /** @type {?} */
                const newEntity = options.baseClass ? new options.baseClass(withPreCheckHook) : withPreCheckHook;
                /** @type {?} */
                const withHook = this.akitaPreAddEntity(newEntity);
                /** @type {?} */
                const nextId = withHook[this.idKey];
                addedIds.push(nextId);
                updatedEntities[nextId] = withHook;
            }
        }
        isDev() && logAction('Upsert Many');
        this._setState((/**
         * @param {?} state
         * @return {?}
         */
        state => (Object.assign({}, state, { ids: addedIds.length ? [...state.ids, ...addedIds] : state.ids, entities: Object.assign({}, state.entities, updatedEntities), loading: !!options.loading }))));
        updatedIds.length && this.entityActions.next({ type: EntityActions.Update, ids: updatedIds });
        addedIds.length && this.entityActions.next({ type: EntityActions.Add, ids: addedIds });
        if (addedIds.length && this.hasUIStore()) {
            this.handleUICreation(true);
        }
    }
    /**
     *
     * Replace one or more entities (except the id property)
     *
     *
     * \@example
     *
     * this.store.replace(5, newEntity)
     * this.store.replace([1,2,3], newEntity)
     * @param {?} ids
     * @param {?} newState
     * @return {?}
     */
    replace(ids, newState) {
        /** @type {?} */
        const toArray = coerceArray(ids);
        if (isEmpty(toArray))
            return;
        /** @type {?} */
        let replaced = {};
        for (const id of toArray) {
            newState[this.idKey] = id;
            replaced[id] = newState;
        }
        isDev() && setAction('Replace Entity', ids);
        this._setState((/**
         * @param {?} state
         * @return {?}
         */
        state => (Object.assign({}, state, { entities: Object.assign({}, state.entities, replaced) }))));
    }
    /**
     *
     * Move entity inside the collection
     *
     *
     * \@example
     *
     * this.store.move(fromIndex, toIndex)
     * @param {?} from
     * @param {?} to
     * @return {?}
     */
    move(from, to) {
        /** @type {?} */
        const ids = this.ids.slice();
        ids.splice(to < 0 ? ids.length + to : to, 0, ids.splice(from, 1)[0]);
        isDev() && setAction('Move Entity');
        this._setState((/**
         * @param {?} state
         * @return {?}
         */
        state => (Object.assign({}, state, { entities: Object.assign({}, state.entities), ids }))));
    }
    /**
     * @param {?=} idsOrFn
     * @return {?}
     */
    remove(idsOrFn) {
        if (isEmpty(this.ids))
            return;
        /** @type {?} */
        const idPassed = isDefined(idsOrFn);
        // null means remove all
        /** @type {?} */
        let ids = [];
        if (isFunction(idsOrFn)) {
            ids = this.ids.filter((/**
             * @param {?} entityId
             * @return {?}
             */
            entityId => idsOrFn(this.entities[entityId])));
        }
        else {
            ids = idPassed ? coerceArray(idsOrFn) : null;
        }
        if (isEmpty(ids))
            return;
        isDev() && setAction('Remove Entity', ids);
        this._setState((/**
         * @param {?} state
         * @return {?}
         */
        (state) => removeEntities({ state, ids })));
        if (ids === null) {
            this.setHasCache(false);
        }
        this.handleUIRemove(ids);
        this.entityActions.next({ type: EntityActions.Remove, ids });
    }
    /**
     *
     * Update the active entity
     *
     * \@example
     *
     * this.store.updateActive({ completed: true })
     * this.store.updateActive(active => {
     *   return {
     *     config: {
     *      ..active.config,
     *      date
     *     }
     *   }
     * })
     * @param {?} newStateOrCallback
     * @return {?}
     */
    updateActive(newStateOrCallback) {
        /** @type {?} */
        const ids = coerceArray(this.active);
        isDev() && setAction('Update Active', ids);
        this.update(ids, (/** @type {?} */ (newStateOrCallback)));
    }
    /**
     * @param {?} idOrOptions
     * @return {?}
     */
    setActive(idOrOptions) {
        /** @type {?} */
        const active = getActiveEntities(idOrOptions, this.ids, this.active);
        if (active === undefined) {
            return;
        }
        isDev() && setAction('Set Active', active);
        this._setActive(active);
    }
    /**
     * Add active entities
     *
     * \@example
     *
     * store.addActive(2);
     * store.addActive([3, 4, 5]);
     * @template T
     * @param {?} ids
     * @return {?}
     */
    addActive(ids) {
        /** @type {?} */
        const toArray = coerceArray(ids);
        if (isEmpty(toArray))
            return;
        /** @type {?} */
        const everyExist = toArray.every((/**
         * @param {?} id
         * @return {?}
         */
        id => this.active.indexOf(id) > -1));
        if (everyExist)
            return;
        isDev() && setAction('Add Active', ids);
        this._setState((/**
         * @param {?} state
         * @return {?}
         */
        state => {
            /**
             * Protect against case that one of the items in the array exist
             * @type {?}
             */
            const uniques = Array.from(new Set([...((/** @type {?} */ (state.active))), ...toArray]));
            return Object.assign({}, state, { active: uniques });
        }));
    }
    /**
     * Remove active entities
     *
     * \@example
     *
     * store.removeActive(2)
     * store.removeActive([3, 4, 5])
     * @template T
     * @param {?} ids
     * @return {?}
     */
    removeActive(ids) {
        /** @type {?} */
        const toArray = coerceArray(ids);
        if (isEmpty(toArray))
            return;
        /** @type {?} */
        const someExist = toArray.some((/**
         * @param {?} id
         * @return {?}
         */
        id => this.active.indexOf(id) > -1));
        if (!someExist)
            return;
        isDev() && setAction('Remove Active', ids);
        this._setState((/**
         * @param {?} state
         * @return {?}
         */
        state => {
            return Object.assign({}, state, { active: Array.isArray(state.active) ? state.active.filter((/**
                 * @param {?} currentId
                 * @return {?}
                 */
                currentId => toArray.indexOf(currentId) === -1)) : null });
        }));
    }
    /**
     * Toggle active entities
     *
     * \@example
     *
     * store.toggle(2)
     * store.toggle([3, 4, 5])
     * @template T
     * @param {?} ids
     * @return {?}
     */
    toggleActive(ids) {
        /** @type {?} */
        const toArray = coerceArray(ids);
        /** @type {?} */
        const filterExists = (/**
         * @param {?} remove
         * @return {?}
         */
        remove => (/**
         * @param {?} id
         * @return {?}
         */
        id => this.active.includes(id) === remove));
        /** @type {?} */
        const remove = toArray.filter(filterExists(true));
        /** @type {?} */
        const add = toArray.filter(filterExists(false));
        this.removeActive(remove);
        this.addActive(add);
        isDev() && logAction('Toggle Active');
    }
    /**
     *
     * Create sub UI store for managing Entity's UI state
     *
     * \@example
     *
     * export type ProductUI = {
     *   isLoading: boolean;
     *   isOpen: boolean
     * }
     *
     * interface ProductsUIState extends EntityState<ProductUI> {}
     *
     * export class ProductsStore EntityStore<ProductsState, Product> {
     *   ui: EntityUIStore<ProductsUIState, ProductUI>;
     *
     *   constructor() {
     *     super();
     *     this.createUIStore();
     *   }
     *
     * }
     * @param {?=} initialState
     * @param {?=} storeConfig
     * @return {?}
     */
    createUIStore(initialState = {}, storeConfig = {}) {
        /** @type {?} */
        const defaults = { name: `UI/${this.storeName}`, idKey: this.idKey };
        this.ui = new EntityUIStore(initialState, Object.assign({}, defaults, storeConfig));
        return this.ui;
    }
    // @internal
    /**
     * @return {?}
     */
    destroy() {
        super.destroy();
        if (this.ui instanceof EntityStore) {
            this.ui.destroy();
        }
        this.entityActions.complete();
    }
    // @internal
    /**
     * @param {?} _
     * @param {?} nextEntity
     * @return {?}
     */
    akitaPreUpdateEntity(_, nextEntity) {
        return (/** @type {?} */ (nextEntity));
    }
    // @internal
    /**
     * @param {?} newEntity
     * @return {?}
     */
    akitaPreAddEntity(newEntity) {
        return (/** @type {?} */ (newEntity));
    }
    // @internal
    /**
     * @param {?} newEntity
     * @return {?}
     */
    akitaPreCheckEntity(newEntity) {
        return newEntity;
    }
    /**
     * @private
     * @return {?}
     */
    get ids() {
        return this._value().ids;
    }
    /**
     * @private
     * @return {?}
     */
    get entities() {
        return this._value().entities;
    }
    /**
     * @private
     * @return {?}
     */
    get active() {
        return this._value().active;
    }
    /**
     * @private
     * @param {?} ids
     * @return {?}
     */
    _setActive(ids) {
        this._setState((/**
         * @param {?} state
         * @return {?}
         */
        state => {
            return Object.assign({}, state, { active: ids });
        }));
    }
    /**
     * @private
     * @param {?=} add
     * @return {?}
     */
    handleUICreation(add = false) {
        /** @type {?} */
        const ids = this.ids;
        /** @type {?} */
        const isFunc = isFunction(this.ui._akitaCreateEntityFn);
        /** @type {?} */
        let uiEntities;
        /** @type {?} */
        const createFn = (/**
         * @param {?} id
         * @return {?}
         */
        id => {
            /** @type {?} */
            const current = this.entities[id];
            /** @type {?} */
            const ui = isFunc ? this.ui._akitaCreateEntityFn(current) : this.ui._akitaCreateEntityFn;
            return Object.assign({ [this.idKey]: current[this.idKey] }, ui);
        });
        if (add) {
            uiEntities = this.ids.filter((/**
             * @param {?} id
             * @return {?}
             */
            id => isUndefined(this.ui.entities[id]))).map(createFn);
        }
        else {
            uiEntities = ids.map(createFn);
        }
        add ? this.ui.add(uiEntities) : this.ui.set(uiEntities);
    }
    /**
     * @private
     * @return {?}
     */
    hasInitialUIState() {
        return this.hasUIStore() && isUndefined(this.ui._akitaCreateEntityFn) === false;
    }
    /**
     * @private
     * @param {?} ids
     * @return {?}
     */
    handleUIRemove(ids) {
        if (this.hasUIStore()) {
            this.ui.remove(ids);
        }
    }
    /**
     * @private
     * @return {?}
     */
    hasUIStore() {
        return this.ui instanceof EntityUIStore;
    }
}
tslib_1.__decorate([
    transaction(),
    tslib_1.__metadata("design:type", Function),
    tslib_1.__metadata("design:paramtypes", [Object, Object, Object]),
    tslib_1.__metadata("design:returntype", void 0)
], EntityStore.prototype, "upsert", null);
tslib_1.__decorate([
    transaction(),
    tslib_1.__metadata("design:type", Function),
    tslib_1.__metadata("design:paramtypes", [typeof (_a = typeof T !== "undefined" && T) === "function" ? _a : Object]),
    tslib_1.__metadata("design:returntype", void 0)
], EntityStore.prototype, "toggleActive", null);
if (false) {
    /** @type {?} */
    EntityStore.prototype.ui;
    /**
     * @type {?}
     * @private
     */
    EntityStore.prototype.entityActions;
    /**
     * @type {?}
     * @protected
     */
    EntityStore.prototype.options;
}
// @internal
/**
 * @template UIState, DEPRECATED
 */
export class EntityUIStore extends EntityStore {
    /**
     * @param {?=} initialState
     * @param {?=} storeConfig
     */
    constructor(initialState = {}, storeConfig = {}) {
        super(initialState, storeConfig);
    }
    /**
     *
     * Set the initial UI entity state. This function will determine the entity's
     * initial state when we call `set()` or `add()`.
     *
     * \@example
     *
     * constructor() {
     *   super();
     *   this.createUIStore().setInitialEntityState(entity => ({ isLoading: false, isOpen: true }));
     *   this.createUIStore().setInitialEntityState({ isLoading: false, isOpen: true });
     * }
     *
     * @template EntityUI, Entity
     * @param {?} createFn
     * @return {?}
     */
    setInitialEntityState(createFn) {
        this._akitaCreateEntityFn = createFn;
    }
}
if (false) {
    /** @type {?} */
    EntityUIStore.prototype._akitaCreateEntityFn;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZW50aXR5U3RvcmUuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZGF0b3JhbWEvYWtpdGEvIiwic291cmNlcyI6WyJzcmMvZW50aXR5U3RvcmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQUEsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLFdBQVcsQ0FBQztBQUNwQyxPQUFPLEVBQWUsV0FBVyxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ3pELE9BQU8sRUFBRSxLQUFLLEVBQUUsTUFBTSxTQUFTLENBQUM7QUFFaEMsT0FBTyxFQUFFLGlCQUFpQixFQUFvQixNQUFNLHFCQUFxQixDQUFDO0FBQzFFLE9BQU8sRUFBRSxXQUFXLEVBQXNCLE1BQU0sZUFBZSxDQUFDO0FBQ2hFLE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDNUMsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLGtCQUFrQixDQUFDO0FBQ2xELE9BQU8sRUFBRSx1QkFBdUIsRUFBRSxNQUFNLDJCQUEyQixDQUFDO0FBQ3BFLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFDeEMsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLGtCQUFrQixDQUFDO0FBQ2xELE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDNUMsT0FBTyxFQUFFLEtBQUssRUFBRSxNQUFNLFNBQVMsQ0FBQztBQUNoQyxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sY0FBYyxDQUFDO0FBQzFDLE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFFNUMsT0FBTyxFQUFFLFNBQVMsRUFBRSxTQUFTLEVBQUUsTUFBTSxXQUFXLENBQUM7QUFDakQsT0FBTyxFQUFFLEtBQUssRUFBRSxNQUFNLE9BQU8sQ0FBQztBQUM5QixPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sYUFBYSxDQUFDO0FBQ3hDLE9BQU8sRUFBYyxPQUFPLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFD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QURDLFdBQVcsRUFBRTs7aUVBQ3lCLENBQUMsb0JBQUQsQ0FBQzs7K0NBUXZDOzs7SUFoY0QseUJBQW1DOzs7OztJQUNuQyxvQ0FBNEQ7Ozs7O0lBRWpCLDhCQUFtRDs7Ozs7O0FBK2lCaEcsTUFBTSxPQUFPLGFBQXlDLFNBQVEsV0FBb0I7Ozs7O0lBR2hGLFlBQVksWUFBWSxHQUFHLEVBQUUsRUFBRSxjQUEyQyxFQUFFO1FBQzFFLEtBQUssQ0FBQyxZQUFZLEVBQUUsV0FBVyxDQUFDLENBQUM7SUFDbkMsQ0FBQzs7Ozs7Ozs7Ozs7Ozs7Ozs7O0lBZ0JELHFCQUFxQixDQUErQixRQUE0QztRQUM5RixJQUFJLENBQUMsb0JBQW9CLEdBQUcsUUFBUSxDQUFDO0lBQ3ZDLENBQUM7Q0FDRjs7O0lBdkJDLDZDQUF1QyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGlzRW1wdHkgfSBmcm9tICcuL2lzRW1wdHknO1xuaW1wb3J0IHsgU2V0RW50aXRpZXMsIHNldEVudGl0aWVzIH0gZnJvbSAnLi9zZXRFbnRpdGllcyc7XG5pbXBvcnQgeyBTdG9yZSB9IGZyb20gJy4vc3RvcmUnO1xuaW1wb3J0IHsgQ29uc3RydWN0b3IsIEVudGl0eVN0YXRlLCBFbnRpdHlVSUNyZWF0ZUZuLCBJRFMsIE9yQXJyYXksIFN0YXRlV2l0aEFjdGl2ZSwgVXBkYXRlRW50aXR5UHJlZGljYXRlLCBVcGRhdGVTdGF0ZUNhbGxiYWNrLCBnZXRFbnRpdHlUeXBlLCBnZXRJRFR5cGUgfSBmcm9tICcuL3R5cGVzJztcbmltcG9ydCB7IGdldEFjdGl2ZUVudGl0aWVzLCBTZXRBY3RpdmVPcHRpb25zIH0gZnJvbSAnLi9nZXRBY3RpdmVFbnRpdGllcyc7XG5pbXBvcnQgeyBhZGRFbnRpdGllcywgQWRkRW50aXRpZXNPcHRpb25zIH0gZnJvbSAnLi9hZGRFbnRpdGllcyc7XG5pbXBvcnQgeyBjb2VyY2VBcnJheSB9IGZyb20gJy4vY29lcmNlQXJyYXknO1xuaW1wb3J0IHsgcmVtb3ZlRW50aXRpZXMgfSBmcm9tICcuL3JlbW92ZUVudGl0aWVzJztcbmltcG9ydCB7IGdldEluaXRpYWxFbnRpdGllc1N0YXRlIH0gZnJvbSAnLi9nZXRJbml0aWFsRW50aXRpZXNTdGF0ZSc7XG5pbXBvcnQgeyBpc0RlZmluZWQgfSBmcm9tICcuL2lzRGVmaW5lZCc7XG5pbXBvcnQgeyB1cGRhdGVFbnRpdGllcyB9IGZyb20gJy4vdXBkYXRlRW50aXRpZXMnO1xuaW1wb3J0IHsgdHJhbnNhY3Rpb24gfSBmcm9tICcuL3RyYW5zYWN0aW9uJztcbmltcG9ydCB7IGlzTmlsIH0gZnJvbSAnLi9pc05pbCc7XG5pbXBvcnQgeyBpc0Z1bmN0aW9uIH0gZnJvbSAnLi9pc0Z1bmN0aW9uJztcbmltcG9ydCB7IGlzVW5kZWZpbmVkIH0gZnJvbSAnLi9pc1VuZGVmaW5lZCc7XG5pbXBvcnQgeyBTdG9yZUNvbmZpZ09wdGlvbnMgfSBmcm9tICcuL3N0b3JlQ29uZmlnJztcbmltcG9ydCB7IGxvZ0FjdGlvbiwgc2V0QWN0aW9uIH0gZnJvbSAnLi9hY3Rpb25zJztcbmltcG9ydCB7IGlzRGV2IH0gZnJvbSAnLi9lbnYnO1xuaW1wb3J0IHsgaGFzRW50aXR5IH0gZnJvbSAnLi9oYXNFbnRpdHknO1xuaW1wb3J0IHsgT2JzZXJ2YWJsZSwgU3ViamVjdCB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgRW50aXR5QWN0aW9uLCBFbnRpdHlBY3Rpb25zIH0gZnJvbSAnLi9lbnRpdHlBY3Rpb25zJztcbmltcG9ydCB7IERFRkFVTFRfSURfS0VZIH0gZnJvbSAnLi9kZWZhdWx0SURLZXknO1xuXG4vKipcbiAqXG4gKiBTdG9yZSBmb3IgbWFuYWdpbmcgYSBjb2xsZWN0aW9uIG9mIGVudGl0aWVzXG4gKlxuICogQGV4YW1wbGVcbiAqXG4gKiBleHBvcnQgaW50ZXJmYWNlIFdpZGdldHNTdGF0ZSBleHRlbmRzIEVudGl0eVN0YXRlPFdpZGdldD4geyB9XG4gKlxuICogQFN0b3JlQ29uZmlnKHsgbmFtZTogJ3dpZGdldHMnIH0pXG4gKiAgZXhwb3J0IGNsYXNzIFdpZGdldHNTdG9yZSBleHRlbmRzIEVudGl0eVN0b3JlPFdpZGdldHNTdGF0ZT4ge1xuICogICBjb25zdHJ1Y3RvcigpIHtcbiAqICAgICBzdXBlcigpO1xuICogICB9XG4gKiB9XG4gKlxuICpcbiAqL1xuZXhwb3J0IGNsYXNzIEVudGl0eVN0b3JlPFMgZXh0ZW5kcyBFbnRpdHlTdGF0ZSA9IGFueSwgRW50aXR5VHlwZSA9IGdldEVudGl0eVR5cGU8Uz4sIElEVHlwZSA9IGdldElEVHlwZTxTPj4gZXh0ZW5kcyBTdG9yZTxTPiB7XG4gIHVpOiBFbnRpdHlVSVN0b3JlPGFueSwgRW50aXR5VHlwZT47XG4gIHByaXZhdGUgZW50aXR5QWN0aW9ucyA9IG5ldyBTdWJqZWN0PEVudGl0eUFjdGlvbjxJRFR5cGU+PigpO1xuXG4gIGNvbnN0cnVjdG9yKGluaXRpYWxTdGF0ZTogUGFydGlhbDxTPiA9IHt9LCBwcm90ZWN0ZWQgb3B0aW9uczogUGFydGlhbDxTdG9yZUNvbmZpZ09wdGlvbnM+ID0ge30pIHtcbiAgICBzdXBlcih7IC4uLmdldEluaXRpYWxFbnRpdGllc1N0YXRlKCksIC4uLmluaXRpYWxTdGF0ZSB9LCBvcHRpb25zKTtcbiAgfVxuXG4gIC8vIEBpbnRlcm5hbFxuICBnZXQgc2VsZWN0RW50aXR5QWN0aW9uJCgpOiBPYnNlcnZhYmxlPEVudGl0eUFjdGlvbjxJRFR5cGU+PiB7XG4gICAgcmV0dXJuIHRoaXMuZW50aXR5QWN0aW9ucy5hc09ic2VydmFibGUoKTtcbiAgfVxuXG4gIC8vIEBpbnRlcm5hbFxuICBnZXQgaWRLZXkoKSB7XG4gICAgcmV0dXJuICh0aGlzLmNvbmZpZyBhcyBTdG9yZUNvbmZpZ09wdGlvbnMpLmlkS2V5IHx8IHRoaXMub3B0aW9ucy5pZEtleSB8fCBERUZBVUxUX0lEX0tFWTtcbiAgfVxuXG4gIC8qKlxuICAgKlxuICAgKiBSZXBsYWNlIGN1cnJlbnQgY29sbGVjdGlvbiB3aXRoIHByb3ZpZGVkIGNvbGxlY3Rpb25cbiAgICpcbiAgICogQGV4YW1wbGVcbiAgICpcbiAgICogdGhpcy5zdG9yZS5zZXQoW0VudGl0eSwgRW50aXR5XSlcbiAgICogdGhpcy5zdG9yZS5zZXQoe2lkczogW10sIGVudGl0aWVzOiB7fX0pXG4gICAqIHRoaXMuc3RvcmUuc2V0KHsgMToge30sIDI6IHt9fSlcbiAgICpcbiAgICovXG4gIHNldChlbnRpdGllczogU2V0RW50aXRpZXM8RW50aXR5VHlwZT4sIG9wdGlvbnM6IHsgYWN0aXZlSWQ/OiBJRFR5cGUgfCBudWxsIH0gPSB7fSkge1xuICAgIGlmIChpc05pbChlbnRpdGllcykpIHJldHVybjtcblxuICAgIGlzRGV2KCkgJiYgc2V0QWN0aW9uKCdTZXQgRW50aXR5Jyk7XG5cbiAgICBjb25zdCBpc05hdGl2ZVByZUFkZCA9IHRoaXMuYWtpdGFQcmVBZGRFbnRpdHkgPT09IEVudGl0eVN0b3JlLnByb3RvdHlwZS5ha2l0YVByZUFkZEVudGl0eTtcblxuICAgIHRoaXMuX3NldFN0YXRlKHN0YXRlID0+IHtcbiAgICAgIGNvbnN0IG5ld1N0YXRlID0gc2V0RW50aXRpZXMoe1xuICAgICAgICBzdGF0ZSxcbiAgICAgICAgZW50aXRpZXMsXG4gICAgICAgIGlkS2V5OiB0aGlzLmlkS2V5LFxuICAgICAgICBwcmVBZGRFbnRpdHk6IHRoaXMuYWtpdGFQcmVBZGRFbnRpdHksXG4gICAgICAgIGlzTmF0aXZlUHJlQWRkXG4gICAgICB9KTtcblxuICAgICAgaWYgKGlzVW5kZWZpbmVkKG9wdGlvbnMuYWN0aXZlSWQpID09PSBmYWxzZSkge1xuICAgICAgICAobmV3U3RhdGUgYXMgYW55KS5hY3RpdmUgPSBvcHRpb25zLmFjdGl2ZUlkO1xuICAgICAgfVxuXG4gICAgICByZXR1cm4gbmV3U3RhdGU7XG4gICAgfSk7XG5cbiAgICB0aGlzLnNldEhhc0NhY2hlKHRydWUsIHsgcmVzdGFydFRUTDogdHJ1ZSB9KTtcblxuICAgIGlmICh0aGlzLmhhc0luaXRpYWxVSVN0YXRlKCkpIHtcbiAgICAgIHRoaXMuaGFuZGxlVUlDcmVhdGlvbigpO1xuICAgIH1cblxuICAgIHRoaXMuZW50aXR5QWN0aW9ucy5uZXh0KHsgdHlwZTogRW50aXR5QWN0aW9ucy5TZXQsIGlkczogdGhpcy5pZHMgfSk7XG4gIH1cblxuICAvKipcbiAgICogQWRkIGVudGl0aWVzXG4gICAqXG4gICAqIEBleGFtcGxlXG4gICAqXG4gICAqIHRoaXMuc3RvcmUuYWRkKFtFbnRpdHksIEVudGl0eV0pXG4gICAqIHRoaXMuc3RvcmUuYWRkKEVudGl0eSlcbiAgICogdGhpcy5zdG9yZS5hZGQoRW50aXR5LCB7IHByZXBlbmQ6IHRydWUgfSlcbiAgICpcbiAgICogdGhpcy5zdG9yZS5hZGQoRW50aXR5LCB7IGxvYWRpbmc6IGZhbHNlIH0pXG4gICAqL1xuICBhZGQoZW50aXRpZXM6IE9yQXJyYXk8RW50aXR5VHlwZT4sIG9wdGlvbnM6IEFkZEVudGl0aWVzT3B0aW9ucyA9IHsgbG9hZGluZzogZmFsc2UgfSkge1xuICAgIGNvbnN0IGNvbGxlY3Rpb24gPSBjb2VyY2VBcnJheShlbnRpdGllcyk7XG5cbiAgICBpZiAoaXNFbXB0eShjb2xsZWN0aW9uKSkgcmV0dXJuO1xuXG4gICAgY29uc3QgZGF0YSA9IGFkZEVudGl0aWVzKHtcbiAgICAgIHN0YXRlOiB0aGlzLl92YWx1ZSgpLFxuICAgICAgcHJlQWRkRW50aXR5OiB0aGlzLmFraXRhUHJlQWRkRW50aXR5LFxuICAgICAgZW50aXRpZXM6IGNvbGxlY3Rpb24sXG4gICAgICBpZEtleTogdGhpcy5pZEtleSxcbiAgICAgIG9wdGlvbnNcbiAgICB9KTtcblxuICAgIGlmIChkYXRhKSB7XG4gICAgICBpc0RldigpICYmIHNldEFjdGlvbignQWRkIEVudGl0eScpO1xuICAgICAgZGF0YS5uZXdTdGF0ZS5sb2FkaW5nID0gb3B0aW9ucy5sb2FkaW5nO1xuXG4gICAgICB0aGlzLl9zZXRTdGF0ZSgoKSA9PiBkYXRhLm5ld1N0YXRlKTtcblxuICAgICAgaWYgKHRoaXMuaGFzSW5pdGlhbFVJU3RhdGUoKSkge1xuICAgICAgICB0aGlzLmhhbmRsZVVJQ3JlYXRpb24odHJ1ZSk7XG4gICAgICB9XG5cbiAgICAgIHRoaXMuZW50aXR5QWN0aW9ucy5uZXh0KHsgdHlwZTogRW50aXR5QWN0aW9ucy5BZGQsIGlkczogZGF0YS5uZXdJZHMgfSk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqXG4gICAqIFVwZGF0ZSBlbnRpdGllc1xuICAgKlxuICAgKiBAZXhhbXBsZVxuICAgKlxuICAgKiBzdG9yZS51cGRhdGUoMSwgZW50aXR5ID0+IC4uLilcbiAgICogc3RvcmUudXBkYXRlKFsxLCAyLCAzXSwgZW50aXR5ID0+IC4uLilcbiAgICogc3RvcmUudXBkYXRlKG51bGwsIGVudGl0eSA9PiAuLi4pXG4gICAqL1xuICB1cGRhdGUoaWQ6IE9yQXJyYXk8SURUeXBlPiB8IG51bGwsIG5ld1N0YXRlRm46IFVwZGF0ZVN0YXRlQ2FsbGJhY2s8RW50aXR5VHlwZT4pO1xuICAvKipcbiAgICogc3RvcmUudXBkYXRlKDEsIHsgbmFtZTogbmV3TmFtZSB9KVxuICAgKi9cbiAgdXBkYXRlKGlkOiBPckFycmF5PElEVHlwZT4gfCBudWxsLCBuZXdTdGF0ZTogUGFydGlhbDxFbnRpdHlUeXBlPik7XG4gIC8qKlxuICAgKiBzdG9yZS51cGRhdGUoZW50aXR5ID0+IGVudGl0eS5wcmljZSA+IDMsIGVudGl0eSA9PiAoeyBuYW1lOiBuZXdOYW1lIH0pKVxuICAgKi9cbiAgdXBkYXRlKHByZWRpY2F0ZTogVXBkYXRlRW50aXR5UHJlZGljYXRlPEVudGl0eVR5cGU+LCBuZXdTdGF0ZUZuOiBVcGRhdGVTdGF0ZUNhbGxiYWNrPEVudGl0eVR5cGU+KTtcbiAgLyoqXG4gICAqIHN0b3JlLnVwZGF0ZShlbnRpdHkgPT4gZW50aXR5LnByaWNlID4gMywgeyBuYW1lOiBuZXdOYW1lIH0pXG4gICAqL1xuICB1cGRhdGUocHJlZGljYXRlOiBVcGRhdGVFbnRpdHlQcmVkaWNhdGU8RW50aXR5VHlwZT4sIG5ld1N0YXRlOiBQYXJ0aWFsPEVudGl0eVR5cGU+KTtcbiAgLyoqIFN1cHBvcnQgbm9uLWVudGl0eSB1cGRhdGVzICovXG4gIHVwZGF0ZShuZXdTdGF0ZTogVXBkYXRlU3RhdGVDYWxsYmFjazxTPik7XG4gIHVwZGF0ZShuZXdTdGF0ZTogUGFydGlhbDxTPik7XG4gIHVwZGF0ZShcbiAgICBpZHNPckZuT3JTdGF0ZTogT3JBcnJheTxJRFR5cGU+IHwgbnVsbCB8IFBhcnRpYWw8Uz4gfCBVcGRhdGVTdGF0ZUNhbGxiYWNrPFM+IHwgVXBkYXRlRW50aXR5UHJlZGljYXRlPEVudGl0eVR5cGU+LFxuICAgIG5ld1N0YXRlT3JGbj86IFVwZGF0ZVN0YXRlQ2FsbGJhY2s8RW50aXR5VHlwZT4gfCBQYXJ0aWFsPEVudGl0eVR5cGU+IHwgUGFydGlhbDxTPlxuICApIHtcbiAgICBpZiAoaXNVbmRlZmluZWQobmV3U3RhdGVPckZuKSkge1xuICAgICAgc3VwZXIudXBkYXRlKGlkc09yRm5PclN0YXRlIGFzIFBhcnRpYWw8Uz4pO1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBsZXQgaWRzOiBJRFR5cGVbXSA9IFtdO1xuXG4gICAgaWYgKGlzRnVuY3Rpb24oaWRzT3JGbk9yU3RhdGUpKSB7XG4gICAgICAvLyBXZSBuZWVkIHRvIGZpbHRlciBhY2NvcmRpbmcgdGhlIHByZWRpY2F0ZSBmdW5jdGlvblxuICAgICAgaWRzID0gdGhpcy5pZHMuZmlsdGVyKGlkID0+IChpZHNPckZuT3JTdGF0ZSBhcyBVcGRhdGVFbnRpdHlQcmVkaWNhdGU8RW50aXR5VHlwZT4pKHRoaXMuZW50aXRpZXNbaWRdKSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIC8vIElmIGl0J3MgbmlsIHdlIHdhbnQgYWxsIG9mIHRoZW1cbiAgICAgIGlkcyA9IGlzTmlsKGlkc09yRm5PclN0YXRlKSA/IHRoaXMuaWRzIDogY29lcmNlQXJyYXkoaWRzT3JGbk9yU3RhdGUgYXMgT3JBcnJheTxJRFR5cGU+KTtcbiAgICB9XG5cbiAgICBpZiAoaXNFbXB0eShpZHMpKSByZXR1cm47XG5cbiAgICBpc0RldigpICYmIHNldEFjdGlvbignVXBkYXRlIEVudGl0eScsIGlkcyk7XG4gICAgdGhpcy5fc2V0U3RhdGUoc3RhdGUgPT5cbiAgICAgIHVwZGF0ZUVudGl0aWVzKHtcbiAgICAgICAgaWRLZXk6IHRoaXMuaWRLZXksXG4gICAgICAgIGlkcyxcbiAgICAgICAgcHJlVXBkYXRlRW50aXR5OiB0aGlzLmFraXRhUHJlVXBkYXRlRW50aXR5LFxuICAgICAgICBzdGF0ZSxcbiAgICAgICAgbmV3U3RhdGVPckZuLFxuICAgICAgICBwcm9kdWNlckZuOiB0aGlzLl9wcm9kdWNlckZuXG4gICAgICB9KVxuICAgICk7XG5cbiAgICB0aGlzLmVudGl0eUFjdGlvbnMubmV4dCh7IHR5cGU6IEVudGl0eUFjdGlvbnMuVXBkYXRlLCBpZHMgfSk7XG4gIH1cblxuICAvKipcbiAgICpcbiAgICogQ3JlYXRlIG9yIHVwZGF0ZVxuICAgKlxuICAgKiBAZXhhbXBsZVxuICAgKlxuICAgKiBzdG9yZS51cHNlcnQoMSwgeyBhY3RpdmU6IHRydWUgfSlcbiAgICogc3RvcmUudXBzZXJ0KFsyLCAzXSwgeyBhY3RpdmU6IHRydWUgfSlcbiAgICogc3RvcmUudXBzZXJ0KFsyLCAzXSwgZW50aXR5ID0+ICh7IGlzT3BlbjogIWVudGl0eS5pc09wZW59KSlcbiAgICpcbiAgICovXG4gIEB0cmFuc2FjdGlvbigpXG4gIHVwc2VydChpZHM6IE9yQXJyYXk8SURUeXBlPiwgbmV3U3RhdGU6IFBhcnRpYWw8RW50aXR5VHlwZT4gfCBFbnRpdHlUeXBlIHwgVXBkYXRlU3RhdGVDYWxsYmFjazxFbnRpdHlUeXBlPiB8IEVudGl0eVR5cGVbXSwgb3B0aW9uczogeyBiYXNlQ2xhc3M/OiBDb25zdHJ1Y3RvciB9ID0ge30pIHtcbiAgICBjb25zdCB0b0FycmF5ID0gY29lcmNlQXJyYXkoaWRzKTtcbiAgICBjb25zdCBwcmVkaWNhdGUgPSBpc1VwZGF0ZSA9PiBpZCA9PiBoYXNFbnRpdHkodGhpcy5lbnRpdGllcywgaWQpID09PSBpc1VwZGF0ZTtcbiAgICBjb25zdCBpc0NsYXNzQmFzZWQgPSBpc0Z1bmN0aW9uKG9wdGlvbnMuYmFzZUNsYXNzKTtcbiAgICBjb25zdCB1cGRhdGVJZHMgPSB0b0FycmF5LmZpbHRlcihwcmVkaWNhdGUodHJ1ZSkpO1xuICAgIGNvbnN0IG5ld0VudGl0aWVzID0gdG9BcnJheS5maWx0ZXIocHJlZGljYXRlKGZhbHNlKSkubWFwKGlkID0+IHtcbiAgICAgIGxldCBlbnRpdHkgPSBpc0Z1bmN0aW9uKG5ld1N0YXRlKSA/IG5ld1N0YXRlKHt9IGFzIEVudGl0eVR5cGUpIDogbmV3U3RhdGU7XG4gICAgICBjb25zdCB3aXRoSWQgPSB7IC4uLihlbnRpdHkgYXMgRW50aXR5VHlwZSksIFt0aGlzLmlkS2V5XTogaWQgfTtcbiAgICAgIGlmIChpc0NsYXNzQmFzZWQpIHtcbiAgICAgICAgcmV0dXJuIG5ldyBvcHRpb25zLmJhc2VDbGFzcyh3aXRoSWQpO1xuICAgICAgfVxuICAgICAgcmV0dXJuIHdpdGhJZDtcbiAgICB9KTtcblxuICAgIC8vIGl0IGNhbiBiZSBhbnkgb2YgdGhlIHRocmVlIHR5cGVzXG4gICAgdGhpcy51cGRhdGUodXBkYXRlSWRzIGFzIGFueSwgbmV3U3RhdGUgYXMgYW55KTtcbiAgICB0aGlzLmFkZChuZXdFbnRpdGllcyk7XG4gICAgaXNEZXYoKSAmJiBsb2dBY3Rpb24oJ1Vwc2VydCBFbnRpdHknKTtcbiAgfVxuXG4gIC8qKlxuICAgKlxuICAgKiBVcHNlcnQgZW50aXR5IGNvbGxlY3Rpb24gKGlkS2V5IG11c3QgYmUgcHJlc2VudClcbiAgICpcbiAgICogQGV4YW1wbGVcbiAgICpcbiAgICogc3RvcmUudXBzZXJ0TWFueShbIHsgaWQ6IDEgfSwgeyBpZDogMiB9XSk7XG4gICAqXG4gICAqIHN0b3JlLnVwc2VydE1hbnkoWyB7IGlkOiAxIH0sIHsgaWQ6IDIgfV0sIHsgbG9hZGluZzogdHJ1ZSAgfSk7XG4gICAqIHN0b3JlLnVwc2VydE1hbnkoWyB7IGlkOiAxIH0sIHsgaWQ6IDIgfV0sIHsgYmFzZUNsYXNzOiBUb2RvICB9KTtcbiAgICpcbiAgICovXG4gIHVwc2VydE1hbnkoZW50aXRpZXM6IEVudGl0eVR5cGVbXSwgb3B0aW9uczogeyBiYXNlQ2xhc3M/OiBDb25zdHJ1Y3RvcjsgbG9hZGluZz86IGJvb2xlYW4gfSA9IHt9KSB7XG4gICAgY29uc3QgYWRkZWRJZHMgPSBbXTtcbiAgICBjb25zdCB1cGRhdGVkSWRzID0gW107XG4gICAgY29uc3QgdXBkYXRlZEVudGl0aWVzID0ge307XG5cbiAgICAvLyBVcGRhdGUgdGhlIHN0YXRlIGRpcmVjdGx5IHRvIG9wdGltaXplIHBlcmZvcm1hbmNlXG4gICAgZm9yIChjb25zdCBlbnRpdHkgb2YgZW50aXRpZXMpIHtcbiAgICAgIGNvbnN0IHdpdGhQcmVDaGVja0hvb2sgPSB0aGlzLmFraXRhUHJlQ2hlY2tFbnRpdHkoZW50aXR5KTtcbiAgICAgIGNvbnN0IGlkID0gd2l0aFByZUNoZWNrSG9va1t0aGlzLmlkS2V5XTtcbiAgICAgIGlmIChoYXNFbnRpdHkodGhpcy5lbnRpdGllcywgaWQpKSB7XG4gICAgICAgIGNvbnN0IHByZXYgPSB0aGlzLl92YWx1ZSgpLmVudGl0aWVzW2lkXTtcbiAgICAgICAgY29uc3QgbWVyZ2VkID0geyAuLi50aGlzLl92YWx1ZSgpLmVudGl0aWVzW2lkXSwgLi4ud2l0aFByZUNoZWNrSG9vayB9O1xuICAgICAgICBjb25zdCBuZXh0ID0gb3B0aW9ucy5iYXNlQ2xhc3MgPyBuZXcgb3B0aW9ucy5iYXNlQ2xhc3MobWVyZ2VkKSA6IG1lcmdlZDtcbiAgICAgICAgY29uc3Qgd2l0aEhvb2sgPSB0aGlzLmFraXRhUHJlVXBkYXRlRW50aXR5KHByZXYsIG5leHQpO1xuICAgICAgICBjb25zdCBuZXh0SWQgPSB3aXRoSG9va1t0aGlzLmlkS2V5XTtcbiAgICAgICAgdXBkYXRlZEVudGl0aWVzW25leHRJZF0gPSB3aXRoSG9vaztcbiAgICAgICAgdXBkYXRlZElkcy5wdXNoKG5leHRJZCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBjb25zdCBuZXdFbnRpdHkgPSBvcHRpb25zLmJhc2VDbGFzcyA/IG5ldyBvcHRpb25zLmJhc2VDbGFzcyh3aXRoUHJlQ2hlY2tIb29rKSA6IHdpdGhQcmVDaGVja0hvb2s7XG4gICAgICAgIGNvbnN0IHdpdGhIb29rID0gdGhpcy5ha2l0YVByZUFkZEVudGl0eShuZXdFbnRpdHkpO1xuICAgICAgICBjb25zdCBuZXh0SWQgPSB3aXRoSG9va1t0aGlzLmlkS2V5XTtcbiAgICAgICAgYWRkZWRJZHMucHVzaChuZXh0SWQpO1xuICAgICAgICB1cGRhdGVkRW50aXRpZXNbbmV4dElkXSA9IHdpdGhIb29rO1xuICAgICAgfVxuICAgIH1cblxuICAgIGlzRGV2KCkgJiYgbG9nQWN0aW9uKCdVcHNlcnQgTWFueScpO1xuXG4gICAgdGhpcy5fc2V0U3RhdGUoc3RhdGUgPT4gKHtcbiAgICAgIC4uLnN0YXRlLFxuICAgICAgaWRzOiBhZGRlZElkcy5sZW5ndGggPyBbLi4uc3RhdGUuaWRzLCAuLi5hZGRlZElkc10gOiBzdGF0ZS5pZHMsXG4gICAgICBlbnRpdGllczoge1xuICAgICAgICAuLi5zdGF0ZS5lbnRpdGllcyxcbiAgICAgICAgLi4udXBkYXRlZEVudGl0aWVzXG4gICAgICB9LFxuICAgICAgbG9hZGluZzogISFvcHRpb25zLmxvYWRpbmdcbiAgICB9KSk7XG5cbiAgICB1cGRhdGVkSWRzLmxlbmd0aCAmJiB0aGlzLmVudGl0eUFjdGlvbnMubmV4dCh7IHR5cGU6IEVudGl0eUFjdGlvbnMuVXBkYXRlLCBpZHM6IHVwZGF0ZWRJZHMgfSk7XG4gICAgYWRkZWRJZHMubGVuZ3RoICYmIHRoaXMuZW50aXR5QWN0aW9ucy5uZXh0KHsgdHlwZTogRW50aXR5QWN0aW9ucy5BZGQsIGlkczogYWRkZWRJZHMgfSk7XG4gICAgaWYgKGFkZGVkSWRzLmxlbmd0aCAmJiB0aGlzLmhhc1VJU3RvcmUoKSkge1xuICAgICAgdGhpcy5oYW5kbGVVSUNyZWF0aW9uKHRydWUpO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKlxuICAgKiBSZXBsYWNlIG9uZSBvciBtb3JlIGVudGl0aWVzIChleGNlcHQgdGhlIGlkIHByb3BlcnR5KVxuICAgKlxuICAgKlxuICAgKiBAZXhhbXBsZVxuICAgKlxuICAgKiB0aGlzLnN0b3JlLnJlcGxhY2UoNSwgbmV3RW50aXR5KVxuICAgKiB0aGlzLnN0b3JlLnJlcGxhY2UoWzEsMiwzXSwgbmV3RW50aXR5KVxuICAgKi9cbiAgcmVwbGFjZShpZHM6IElEUywgbmV3U3RhdGU6IFBhcnRpYWw8RW50aXR5VHlwZT4pIHtcbiAgICBjb25zdCB0b0FycmF5ID0gY29lcmNlQXJyYXkoaWRzKTtcbiAgICBpZiAoaXNFbXB0eSh0b0FycmF5KSkgcmV0dXJuO1xuICAgIGxldCByZXBsYWNlZCA9IHt9O1xuICAgIGZvciAoY29uc3QgaWQgb2YgdG9BcnJheSkge1xuICAgICAgbmV3U3RhdGVbdGhpcy5pZEtleV0gPSBpZDtcbiAgICAgIHJlcGxhY2VkW2lkXSA9IG5ld1N0YXRlO1xuICAgIH1cbiAgICBpc0RldigpICYmIHNldEFjdGlvbignUmVwbGFjZSBFbnRpdHknLCBpZHMpO1xuICAgIHRoaXMuX3NldFN0YXRlKHN0YXRlID0+ICh7XG4gICAgICAuLi5zdGF0ZSxcbiAgICAgIGVudGl0aWVzOiB7XG4gICAgICAgIC4uLnN0YXRlLmVudGl0aWVzLFxuICAgICAgICAuLi5yZXBsYWNlZFxuICAgICAgfVxuICAgIH0pKTtcbiAgfVxuXG4gIC8qKlxuICAgKlxuICAgKiBNb3ZlIGVudGl0eSBpbnNpZGUgdGhlIGNvbGxlY3Rpb25cbiAgICpcbiAgICpcbiAgICogQGV4YW1wbGVcbiAgICpcbiAgICogdGhpcy5zdG9yZS5tb3ZlKGZyb21JbmRleCwgdG9JbmRleClcbiAgICovXG4gIG1vdmUoZnJvbTogbnVtYmVyLCB0bzogbnVtYmVyKSB7XG4gICAgY29uc3QgaWRzID0gdGhpcy5pZHMuc2xpY2UoKTtcbiAgICBpZHMuc3BsaWNlKHRvIDwgMCA/IGlkcy5sZW5ndGggKyB0byA6IHRvLCAwLCBpZHMuc3BsaWNlKGZyb20sIDEpWzBdKTtcblxuICAgIGlzRGV2KCkgJiYgc2V0QWN0aW9uKCdNb3ZlIEVudGl0eScpO1xuICAgIHRoaXMuX3NldFN0YXRlKHN0YXRlID0+ICh7XG4gICAgICAuLi5zdGF0ZSxcbiAgICAgIC8vIENoYW5nZSB0aGUgZW50aXRpZXMgcmVmZXJlbmNlIHNvIHRoYXQgc2VsZWN0QWxsIGVtaXRcbiAgICAgIGVudGl0aWVzOiB7XG4gICAgICAgIC4uLnN0YXRlLmVudGl0aWVzXG4gICAgICB9LFxuICAgICAgaWRzXG4gICAgfSkpO1xuICB9XG5cbiAgLyoqXG4gICAqXG4gICAqIFJlbW92ZSBvbmUgb3IgbW9yZSBlbnRpdGllc1xuICAgKlxuICAgKiBAZXhhbXBsZVxuICAgKlxuICAgKiB0aGlzLnN0b3JlLnJlbW92ZSg1KVxuICAgKiB0aGlzLnN0b3JlLnJlbW92ZShbMSwyLDNdKVxuICAgKiB0aGlzLnN0b3JlLnJlbW92ZSgpXG4gICAqL1xuICByZW1vdmUoaWQ/OiBPckFycmF5PElEVHlwZT4pO1xuICAvKipcbiAgICogdGhpcy5zdG9yZS5yZW1vdmUoZW50aXR5ID0+IGVudGl0eS5pZCA9PT0gMSlcbiAgICovXG4gIHJlbW92ZShwcmVkaWNhdGU6IChlbnRpdHk6IFJlYWRvbmx5PEVudGl0eVR5cGU+KSA9PiBib29sZWFuKTtcbiAgcmVtb3ZlKGlkc09yRm4/OiBPckFycmF5PElEVHlwZT4gfCAoKGVudGl0eTogUmVhZG9ubHk8RW50aXR5VHlwZT4pID0+IGJvb2xlYW4pKSB7XG4gICAgaWYgKGlzRW1wdHkodGhpcy5pZHMpKSByZXR1cm47XG5cbiAgICBjb25zdCBpZFBhc3NlZCA9IGlzRGVmaW5lZChpZHNPckZuKTtcblxuICAgIC8vIG51bGwgbWVhbnMgcmVtb3ZlIGFsbFxuICAgIGxldCBpZHM6IElEVHlwZVtdIHwgbnVsbCA9IFtdO1xuXG4gICAgaWYgKGlzRnVuY3Rpb24oaWRzT3JGbikpIHtcbiAgICAgIGlkcyA9IHRoaXMuaWRzLmZpbHRlcihlbnRpdHlJZCA9PiBpZHNPckZuKHRoaXMuZW50aXRpZXNbZW50aXR5SWRdKSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGlkcyA9IGlkUGFzc2VkID8gY29lcmNlQXJyYXkoaWRzT3JGbikgOiBudWxsO1xuICAgIH1cblxuICAgIGlmIChpc0VtcHR5KGlkcykpIHJldHVybjtcblxuICAgIGlzRGV2KCkgJiYgc2V0QWN0aW9uKCdSZW1vdmUgRW50aXR5JywgaWRzKTtcbiAgICB0aGlzLl9zZXRTdGF0ZSgoc3RhdGU6IFN0YXRlV2l0aEFjdGl2ZTxTPikgPT4gcmVtb3ZlRW50aXRpZXMoeyBzdGF0ZSwgaWRzIH0pKTtcbiAgICBpZiAoaWRzID09PSBudWxsKSB7XG4gICAgICB0aGlzLnNldEhhc0NhY2hlKGZhbHNlKTtcbiAgICB9XG5cbiAgICB0aGlzLmhhbmRsZVVJUmVtb3ZlKGlkcyk7XG4gICAgdGhpcy5lbnRpdHlBY3Rpb25zLm5leHQoeyB0eXBlOiBFbnRpdHlBY3Rpb25zLlJlbW92ZSwgaWRzIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqXG4gICAqIFVwZGF0ZSB0aGUgYWN0aXZlIGVudGl0eVxuICAgKlxuICAgKiBAZXhhbXBsZVxuICAgKlxuICAgKiB0aGlzLnN0b3JlLnVwZGF0ZUFjdGl2ZSh7IGNvbXBsZXRlZDogdHJ1ZSB9KVxuICAgKiB0aGlzLnN0b3JlLnVwZGF0ZUFjdGl2ZShhY3RpdmUgPT4ge1xuICAgKiAgIHJldHVybiB7XG4gICAqICAgICBjb25maWc6IHtcbiAgICogICAgICAuLmFjdGl2ZS5jb25maWcsXG4gICAqICAgICAgZGF0ZVxuICAgKiAgICAgfVxuICAgKiAgIH1cbiAgICogfSlcbiAgICovXG4gIHVwZGF0ZUFjdGl2ZShuZXdTdGF0ZU9yQ2FsbGJhY2s6IFVwZGF0ZVN0YXRlQ2FsbGJhY2s8RW50aXR5VHlwZT4gfCBQYXJ0aWFsPEVudGl0eVR5cGU+KSB7XG4gICAgY29uc3QgaWRzID0gY29lcmNlQXJyYXkodGhpcy5hY3RpdmUpO1xuICAgIGlzRGV2KCkgJiYgc2V0QWN0aW9uKCdVcGRhdGUgQWN0aXZlJywgaWRzKTtcbiAgICB0aGlzLnVwZGF0ZShpZHMsIG5ld1N0YXRlT3JDYWxsYmFjayBhcyBQYXJ0aWFsPEVudGl0eVR5cGU+KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBTZXQgdGhlIGdpdmVuIGVudGl0eSBhcyBhY3RpdmVcbiAgICpcbiAgICogQGV4YW1wbGVcbiAgICpcbiAgICogc3RvcmUuc2V0QWN0aXZlKDEpXG4gICAqIHN0b3JlLnNldEFjdGl2ZShbMSwgMiwgM10pXG4gICAqL1xuICBzZXRBY3RpdmUoaWRPck9wdGlvbnM6IFNbJ2FjdGl2ZSddIGV4dGVuZHMgYW55W10gPyBTWydhY3RpdmUnXSA6IChTZXRBY3RpdmVPcHRpb25zIHwgU1snYWN0aXZlJ10pKTtcbiAgc2V0QWN0aXZlKGlkT3JPcHRpb25zOiBJRFR5cGUgfCBTZXRBY3RpdmVPcHRpb25zIHwgbnVsbCkge1xuICAgIGNvbnN0IGFjdGl2ZSA9IGdldEFjdGl2ZUVudGl0aWVzKGlkT3JPcHRpb25zLCB0aGlzLmlkcywgdGhpcy5hY3RpdmUpO1xuXG4gICAgaWYgKGFjdGl2ZSA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgaXNEZXYoKSAmJiBzZXRBY3Rpb24oJ1NldCBBY3RpdmUnLCBhY3RpdmUpO1xuICAgIHRoaXMuX3NldEFjdGl2ZShhY3RpdmUpO1xuICB9XG5cbiAgLyoqXG4gICAqIEFkZCBhY3RpdmUgZW50aXRpZXNcbiAgICpcbiAgICogQGV4YW1wbGVcbiAgICpcbiAgICogc3RvcmUuYWRkQWN0aXZlKDIpO1xuICAgKiBzdG9yZS5hZGRBY3RpdmUoWzMsIDQsIDVdKTtcbiAgICovXG4gIGFkZEFjdGl2ZTxUID0gT3JBcnJheTxJRFR5cGU+PihpZHM6IFQpIHtcbiAgICBjb25zdCB0b0FycmF5ID0gY29lcmNlQXJyYXkoaWRzKTtcbiAgICBpZiAoaXNFbXB0eSh0b0FycmF5KSkgcmV0dXJuO1xuICAgIGNvbnN0IGV2ZXJ5RXhpc3QgPSB0b0FycmF5LmV2ZXJ5KGlkID0+IHRoaXMuYWN0aXZlLmluZGV4T2YoaWQpID4gLTEpO1xuICAgIGlmIChldmVyeUV4aXN0KSByZXR1cm47XG5cbiAgICBpc0RldigpICYmIHNldEFjdGlvbignQWRkIEFjdGl2ZScsIGlkcyk7XG4gICAgdGhpcy5fc2V0U3RhdGUoc3RhdGUgPT4ge1xuICAgICAgLyoqIFByb3RlY3QgYWdhaW5zdCBjYXNlIHRoYXQgb25lIG9mIHRoZSBpdGVtcyBpbiB0aGUgYXJyYXkgZXhpc3QgKi9cbiAgICAgIGNvbnN0IHVuaXF1ZXMgPSBBcnJheS5mcm9tKG5ldyBTZXQoWy4uLihzdGF0ZS5hY3RpdmUgYXMgSURUeXBlW10pLCAuLi50b0FycmF5XSkpO1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgLi4uc3RhdGUsXG4gICAgICAgIGFjdGl2ZTogdW5pcXVlc1xuICAgICAgfTtcbiAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZW1vdmUgYWN0aXZlIGVudGl0aWVzXG4gICAqXG4gICAqIEBleGFtcGxlXG4gICAqXG4gICAqIHN0b3JlLnJlbW92ZUFjdGl2ZSgyKVxuICAgKiBzdG9yZS5yZW1vdmVBY3RpdmUoWzMsIDQsIDVdKVxuICAgKi9cbiAgcmVtb3ZlQWN0aXZlPFQgPSBPckFycmF5PElEVHlwZT4+KGlkczogVCkge1xuICAgIGNvbnN0IHRvQXJyYXkgPSBjb2VyY2VBcnJheShpZHMpO1xuICAgIGlmIChpc0VtcHR5KHRvQXJyYXkpKSByZXR1cm47XG4gICAgY29uc3Qgc29tZUV4aXN0ID0gdG9BcnJheS5zb21lKGlkID0+IHRoaXMuYWN0aXZlLmluZGV4T2YoaWQpID4gLTEpO1xuICAgIGlmICghc29tZUV4aXN0KSByZXR1cm47XG5cbiAgICBpc0RldigpICYmIHNldEFjdGlvbignUmVtb3ZlIEFjdGl2ZScsIGlkcyk7XG4gICAgdGhpcy5fc2V0U3RhdGUoc3RhdGUgPT4ge1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgLi4uc3RhdGUsXG4gICAgICAgIGFjdGl2ZTogQXJyYXkuaXNBcnJheShzdGF0ZS5hY3RpdmUpID8gc3RhdGUuYWN0aXZlLmZpbHRlcihjdXJyZW50SWQgPT4gdG9BcnJheS5pbmRleE9mKGN1cnJlbnRJZCkgPT09IC0xKSA6IG51bGxcbiAgICAgIH07XG4gICAgfSk7XG4gIH1cblxuICAvKipcbiAgICogVG9nZ2xlIGFjdGl2ZSBlbnRpdGllc1xuICAgKlxuICAgKiBAZXhhbXBsZVxuICAgKlxuICAgKiBzdG9yZS50b2dnbGUoMilcbiAgICogc3RvcmUudG9nZ2xlKFszLCA0LCA1XSlcbiAgICovXG4gIEB0cmFuc2FjdGlvbigpXG4gIHRvZ2dsZUFjdGl2ZTxUID0gT3JBcnJheTxJRFR5cGU+PihpZHM6IFQpIHtcbiAgICBjb25zdCB0b0FycmF5ID0gY29lcmNlQXJyYXkoaWRzKTtcbiAgICBjb25zdCBmaWx0ZXJFeGlzdHMgPSByZW1vdmUgPT4gaWQgPT4gdGhpcy5hY3RpdmUuaW5jbHVkZXMoaWQpID09PSByZW1vdmU7XG4gICAgY29uc3QgcmVtb3ZlID0gdG9BcnJheS5maWx0ZXIoZmlsdGVyRXhpc3RzKHRydWUpKTtcbiAgICBjb25zdCBhZGQgPSB0b0FycmF5LmZpbHRlcihmaWx0ZXJFeGlzdHMoZmFsc2UpKTtcbiAgICB0aGlzLnJlbW92ZUFjdGl2ZShyZW1vdmUpO1xuICAgIHRoaXMuYWRkQWN0aXZlKGFkZCk7XG4gICAgaXNEZXYoKSAmJiBsb2dBY3Rpb24oJ1RvZ2dsZSBBY3RpdmUnKTtcbiAgfVxuXG4gIC8qKlxuICAgKlxuICAgKiBDcmVhdGUgc3ViIFVJIHN0b3JlIGZvciBtYW5hZ2luZyBFbnRpdHkncyBVSSBzdGF0ZVxuICAgKlxuICAgKiBAZXhhbXBsZVxuICAgKlxuICAgKiBleHBvcnQgdHlwZSBQcm9kdWN0VUkgPSB7XG4gICAqICAgaXNMb2FkaW5nOiBib29sZWFuO1xuICAgKiAgIGlzT3BlbjogYm9vbGVhblxuICAgKiB9XG4gICAqXG4gICAqIGludGVyZmFjZSBQcm9kdWN0c1VJU3RhdGUgZXh0ZW5kcyBFbnRpdHlTdGF0ZTxQcm9kdWN0VUk+IHt9XG4gICAqXG4gICAqIGV4cG9ydCBjbGFzcyBQcm9kdWN0c1N0b3JlIEVudGl0eVN0b3JlPFByb2R1Y3RzU3RhdGUsIFByb2R1Y3Q+IHtcbiAgICogICB1aTogRW50aXR5VUlTdG9yZTxQcm9kdWN0c1VJU3RhdGUsIFByb2R1Y3RVST47XG4gICAqXG4gICAqICAgY29uc3RydWN0b3IoKSB7XG4gICAqICAgICBzdXBlcigpO1xuICAgKiAgICAgdGhpcy5jcmVhdGVVSVN0b3JlKCk7XG4gICAqICAgfVxuICAgKlxuICAgKiB9XG4gICAqL1xuICBjcmVhdGVVSVN0b3JlKGluaXRpYWxTdGF0ZSA9IHt9LCBzdG9yZUNvbmZpZzogUGFydGlhbDxTdG9yZUNvbmZpZ09wdGlvbnM+ID0ge30pIHtcbiAgICBjb25zdCBkZWZhdWx0czogUGFydGlhbDxTdG9yZUNvbmZpZ09wdGlvbnM+ID0geyBuYW1lOiBgVUkvJHt0aGlzLnN0b3JlTmFtZX1gLCBpZEtleTogdGhpcy5pZEtleSB9O1xuICAgIHRoaXMudWkgPSBuZXcgRW50aXR5VUlTdG9yZShpbml0aWFsU3RhdGUsIHsgLi4uZGVmYXVsdHMsIC4uLnN0b3JlQ29uZmlnIH0pO1xuICAgIHJldHVybiB0aGlzLnVpO1xuICB9XG5cbiAgLy8gQGludGVybmFsXG4gIGRlc3Ryb3koKSB7XG4gICAgc3VwZXIuZGVzdHJveSgpO1xuICAgIGlmICh0aGlzLnVpIGluc3RhbmNlb2YgRW50aXR5U3RvcmUpIHtcbiAgICAgIHRoaXMudWkuZGVzdHJveSgpO1xuICAgIH1cbiAgICB0aGlzLmVudGl0eUFjdGlvbnMuY29tcGxldGUoKTtcbiAgfVxuXG4gIC8vIEBpbnRlcm5hbFxuICBha2l0YVByZVVwZGF0ZUVudGl0eShfOiBSZWFkb25seTxFbnRpdHlUeXBlPiwgbmV4dEVudGl0eTogYW55KTogRW50aXR5VHlwZSB7XG4gICAgcmV0dXJuIG5leHRFbnRpdHkgYXMgRW50aXR5VHlwZTtcbiAgfVxuXG4gIC8vIEBpbnRlcm5hbFxuICBha2l0YVByZUFkZEVudGl0eShuZXdFbnRpdHk6IGFueSk6IEVudGl0eVR5cGUge1xuICAgIHJldHVybiBuZXdFbnRpdHkgYXMgRW50aXR5VHlwZTtcbiAgfVxuXG4gIC8vIEBpbnRlcm5hbFxuICBha2l0YVByZUNoZWNrRW50aXR5KG5ld0VudGl0eTogUmVhZG9ubHk8RW50aXR5VHlwZT4pOiBFbnRpdHlUeXBlIHtcbiAgICByZXR1cm4gbmV3RW50aXR5O1xuICB9XG5cbiAgcHJpdmF0ZSBnZXQgaWRzKCkge1xuICAgIHJldHVybiB0aGlzLl92YWx1ZSgpLmlkcztcbiAgfVxuXG4gIHByaXZhdGUgZ2V0IGVudGl0aWVzKCkge1xuICAgIHJldHVybiB0aGlzLl92YWx1ZSgpLmVudGl0aWVzO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXQgYWN0aXZlKCkge1xuICAgIHJldHVybiB0aGlzLl92YWx1ZSgpLmFjdGl2ZTtcbiAgfVxuXG4gIHByaXZhdGUgX3NldEFjdGl2ZShpZHM6IE9yQXJyYXk8SURUeXBlPikge1xuICAgIHRoaXMuX3NldFN0YXRlKHN0YXRlID0+IHtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIC4uLnN0YXRlLFxuICAgICAgICBhY3RpdmU6IGlkc1xuICAgICAgfTtcbiAgICB9KTtcbiAgfVxuXG4gIHByaXZhdGUgaGFuZGxlVUlDcmVhdGlvbihhZGQgPSBmYWxzZSkge1xuICAgIGNvbnN0IGlkcyA9IHRoaXMuaWRzO1xuICAgIGNvbnN0IGlzRnVuYyA9IGlzRnVuY3Rpb24odGhpcy51aS5fYWtpdGFDcmVhdGVFbnRpdHlGbik7XG4gICAgbGV0IHVpRW50aXRpZXM7XG4gICAgY29uc3QgY3JlYXRlRm4gPSBpZCA9PiB7XG4gICAgICBjb25zdCBjdXJyZW50ID0gdGhpcy5lbnRpdGllc1tpZF07XG4gICAgICBjb25zdCB1aSA9IGlzRnVuYyA/IHRoaXMudWkuX2FraXRhQ3JlYXRlRW50aXR5Rm4oY3VycmVudCkgOiB0aGlzLnVpLl9ha2l0YUNyZWF0ZUVudGl0eUZuO1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgW3RoaXMuaWRLZXldOiBjdXJyZW50W3RoaXMuaWRLZXldLFxuICAgICAgICAuLi51aVxuICAgICAgfTtcbiAgICB9O1xuXG4gICAgaWYgKGFkZCkge1xuICAgICAgdWlFbnRpdGllcyA9IHRoaXMuaWRzLmZpbHRlcihpZCA9PiBpc1VuZGVmaW5lZCh0aGlzLnVpLmVudGl0aWVzW2lkXSkpLm1hcChjcmVhdGVGbik7XG4gICAgfSBlbHNlIHtcbiAgICAgIHVpRW50aXRpZXMgPSBpZHMubWFwKGNyZWF0ZUZuKTtcbiAgICB9XG5cbiAgICBhZGQgPyB0aGlzLnVpLmFkZCh1aUVudGl0aWVzKSA6IHRoaXMudWkuc2V0KHVpRW50aXRpZXMpO1xuICB9XG5cbiAgcHJpdmF0ZSBoYXNJbml0aWFsVUlTdGF0ZSgpIHtcbiAgICByZXR1cm4gdGhpcy5oYXNVSVN0b3JlKCkgJiYgaXNVbmRlZmluZWQodGhpcy51aS5fYWtpdGFDcmVhdGVFbnRpdHlGbikgPT09IGZhbHNlO1xuICB9XG5cbiAgcHJpdmF0ZSBoYW5kbGVVSVJlbW92ZShpZHM6IElEVHlwZVtdKSB7XG4gICAgaWYgKHRoaXMuaGFzVUlTdG9yZSgpKSB7XG4gICAgICB0aGlzLnVpLnJlbW92ZShpZHMpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgaGFzVUlTdG9yZSgpIHtcbiAgICByZXR1cm4gdGhpcy51aSBpbnN0YW5jZW9mIEVudGl0eVVJU3RvcmU7XG4gIH1cbn1cblxuLy8gQGludGVybmFsXG5leHBvcnQgY2xhc3MgRW50aXR5VUlTdG9yZTxVSVN0YXRlLCBERVBSRUNBVEVEID0gYW55PiBleHRlbmRzIEVudGl0eVN0b3JlPFVJU3RhdGU+IHtcbiAgX2FraXRhQ3JlYXRlRW50aXR5Rm46IEVudGl0eVVJQ3JlYXRlRm47XG5cbiAgY29uc3RydWN0b3IoaW5pdGlhbFN0YXRlID0ge30sIHN0b3JlQ29uZmlnOiBQYXJ0aWFsPFN0b3JlQ29uZmlnT3B0aW9ucz4gPSB7fSkge1xuICAgIHN1cGVyKGluaXRpYWxTdGF0ZSwgc3RvcmVDb25maWcpO1xuICB9XG5cbiAgLyoqXG4gICAqXG4gICAqIFNldCB0aGUgaW5pdGlhbCBVSSBlbnRpdHkgc3RhdGUuIFRoaXMgZnVuY3Rpb24gd2lsbCBkZXRlcm1pbmUgdGhlIGVudGl0eSdzXG4gICAqIGluaXRpYWwgc3RhdGUgd2hlbiB3ZSBjYWxsIGBzZXQoKWAgb3IgYGFkZCgpYC5cbiAgICpcbiAgICogQGV4YW1wbGVcbiAgICpcbiAgICogY29uc3RydWN0b3IoKSB7XG4gICAqICAgc3VwZXIoKTtcbiAgICogICB0aGlzLmNyZWF0ZVVJU3RvcmUoKS5zZXRJbml0aWFsRW50aXR5U3RhdGUoZW50aXR5ID0+ICh7IGlzTG9hZGluZzogZmFsc2UsIGlzT3BlbjogdHJ1ZSB9KSk7XG4gICAqICAgdGhpcy5jcmVhdGVVSVN0b3JlKCkuc2V0SW5pdGlhbEVudGl0eVN0YXRlKHsgaXNMb2FkaW5nOiBmYWxzZSwgaXNPcGVuOiB0cnVlIH0pO1xuICAgKiB9XG4gICAqXG4gICAqL1xuICBzZXRJbml0aWFsRW50aXR5U3RhdGU8RW50aXR5VUkgPSBhbnksIEVudGl0eSA9IGFueT4oY3JlYXRlRm46IEVudGl0eVVJQ3JlYXRlRm48RW50aXR5VUksIEVudGl0eT4pIHtcbiAgICB0aGlzLl9ha2l0YUNyZWF0ZUVudGl0eUZuID0gY3JlYXRlRm47XG4gIH1cbn1cbiJdfQ==