/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { pairwise, distinctUntilChanged } from 'rxjs/operators';
import { BehaviorSubject } from 'rxjs';
import { AkitaPlugin } from '../plugin';
import { logAction } from '../../actions';
import { isFunction } from '../../isFunction';
/**
 * @record
 */
export function StateHistoryParams() { }
if (false) {
    /** @type {?|undefined} */
    StateHistoryParams.prototype.maxAge;
    /** @type {?|undefined} */
    StateHistoryParams.prototype.watchProperty;
    /** @type {?|undefined} */
    StateHistoryParams.prototype.comparator;
}
/**
 * @template State
 */
export class StateHistoryPlugin extends AkitaPlugin {
    /**
     * @param {?} query
     * @param {?=} params
     * @param {?=} _entityId
     */
    constructor(query, params = {}, _entityId) {
        super(query, {
            resetFn: (/**
             * @return {?}
             */
            () => this.clear())
        });
        this.query = query;
        this.params = params;
        this._entityId = _entityId;
        /**
         * Allow skipping an update from outside
         */
        this.skip = false;
        this.history = {
            past: [],
            present: null,
            future: []
        };
        /**
         * Skip the update when redo/undo
         */
        this.skipUpdate = false;
        params.maxAge = !!params.maxAge ? params.maxAge : 10;
        params.comparator = params.comparator || ((/**
         * @return {?}
         */
        () => true));
        this.activate();
    }
    /**
     * Observable stream representing whether the history plugin has an available past
     *
     * @return {?}
     */
    get hasPast$() {
        return this._hasPast$;
    }
    /**
     * Observable stream representing whether the history plugin has an available future
     *
     * @return {?}
     */
    get hasFuture$() {
        return this._hasFuture$;
    }
    /**
     * @return {?}
     */
    get hasPast() {
        return this.history.past.length > 0;
    }
    /**
     * @return {?}
     */
    get hasFuture() {
        return this.history.future.length > 0;
    }
    /**
     * @private
     * @return {?}
     */
    get property() {
        return this.params.watchProperty;
    }
    /* Updates the hasPast$ hasFuture$ observables*/
    /**
     * @private
     * @return {?}
     */
    updateHasHistory() {
        this.hasFutureSubject.next(this.hasFuture);
        this.hasPastSubject.next(this.hasPast);
    }
    /**
     * @return {?}
     */
    activate() {
        this.hasPastSubject = new BehaviorSubject(false);
        this._hasPast$ = this.hasPastSubject.asObservable().pipe(distinctUntilChanged());
        this.hasFutureSubject = new BehaviorSubject(false);
        this._hasFuture$ = this.hasFutureSubject.asObservable().pipe(distinctUntilChanged());
        this.history.present = this.getSource(this._entityId, this.property);
        this.subscription = ((/** @type {?} */ (this)))
            .selectSource(this._entityId, this.property)
            .pipe(pairwise())
            .subscribe((/**
         * @param {?} __0
         * @return {?}
         */
        ([past, present]) => {
            if (this.skip) {
                this.skip = false;
                return;
            }
            /**
             *  comparator: (prev, current) => isEqual(prev, current) === false
             * @type {?}
             */
            const shouldUpdate = this.params.comparator(past, present);
            if (!this.skipUpdate && shouldUpdate) {
                if (this.history.past.length === this.params.maxAge) {
                    this.history.past = this.history.past.slice(1);
                }
                this.history.past = [...this.history.past, past];
                this.history.present = present;
                this.updateHasHistory();
            }
        }));
    }
    /**
     * @return {?}
     */
    undo() {
        if (this.history.past.length > 0) {
            const { past, present } = this.history;
            /** @type {?} */
            const previous = past[past.length - 1];
            this.history.past = past.slice(0, past.length - 1);
            this.history.present = previous;
            this.history.future = [present, ...this.history.future];
            this.update();
        }
    }
    /**
     * @return {?}
     */
    redo() {
        if (this.history.future.length > 0) {
            const { past, present } = this.history;
            /** @type {?} */
            const next = this.history.future[0];
            /** @type {?} */
            const newFuture = this.history.future.slice(1);
            this.history.past = [...past, present];
            this.history.present = next;
            this.history.future = newFuture;
            this.update('Redo');
        }
    }
    /**
     * @param {?} index
     * @return {?}
     */
    jumpToPast(index) {
        if (index < 0 || index >= this.history.past.length)
            return;
        const { past, future, present } = this.history;
        /**
         *
         * const past = [1, 2, 3, 4, 5];
         * const present = 6;
         * const future = [7, 8, 9];
         * const index = 2;
         *
         * newPast = past.slice(0, index) = [1, 2];
         * newPresent = past[index] = 3;
         * newFuture = [...past.slice(index + 1),present, ...future] = [4, 5, 6, 7, 8, 9];
         *
         * @type {?}
         */
        const newPast = past.slice(0, index);
        /** @type {?} */
        const newFuture = [...past.slice(index + 1), present, ...future];
        /** @type {?} */
        const newPresent = past[index];
        this.history.past = newPast;
        this.history.present = newPresent;
        this.history.future = newFuture;
        this.update();
    }
    /**
     * @param {?} index
     * @return {?}
     */
    jumpToFuture(index) {
        if (index < 0 || index >= this.history.future.length)
            return;
        const { past, future, present } = this.history;
        /**
         *
         * const past = [1, 2, 3, 4, 5];
         * const present = 6;
         * const future = [7, 8, 9, 10]
         * const index = 1
         *
         * newPast = [...past, present, ...future.slice(0, index) = [1, 2, 3, 4, 5, 6, 7];
         * newPresent = future[index] = 8;
         * newFuture = futrue.slice(index+1) = [9, 10];
         *
         * @type {?}
         */
        const newPast = [...past, present, ...future.slice(0, index)];
        /** @type {?} */
        const newPresent = future[index];
        /** @type {?} */
        const newFuture = future.slice(index + 1);
        this.history.past = newPast;
        this.history.present = newPresent;
        this.history.future = newFuture;
        this.update('Redo');
    }
    /**
     *
     * jump n steps in the past or forward
     *
     * @param {?} n
     * @return {?}
     */
    jump(n) {
        if (n > 0)
            return this.jumpToFuture(n - 1);
        if (n < 0)
            return this.jumpToPast(this.history.past.length + n);
    }
    /**
     * Clear the history
     *
     * \@example
     *
     * stateHistory.clear((history) => {
     *  return {
     *    past: history.past,
     *    present: history.present,
     *    future: []
     *  };
     * });
     * @param {?=} customUpdateFn Callback function for only clearing part of the history
     *
     * @return {?}
     */
    clear(customUpdateFn) {
        this.history = isFunction(customUpdateFn)
            ? customUpdateFn(this.history)
            : {
                past: [],
                present: null,
                future: []
            };
        this.updateHasHistory();
    }
    /**
     * @param {?=} clearHistory
     * @return {?}
     */
    destroy(clearHistory = false) {
        if (clearHistory) {
            this.clear();
        }
        this.subscription.unsubscribe();
    }
    /**
     * @return {?}
     */
    ignoreNext() {
        this.skip = true;
    }
    /**
     * @private
     * @param {?=} action
     * @return {?}
     */
    update(action = 'Undo') {
        this.skipUpdate = true;
        logAction(`@StateHistory - ${action}`);
        this.updateStore(this.history.present, this._entityId, this.property);
        this.updateHasHistory();
        this.skipUpdate = false;
    }
}
if (false) {
    /**
     * Allow skipping an update from outside
     * @type {?}
     * @private
     */
    StateHistoryPlugin.prototype.skip;
    /**
     * @type {?}
     * @private
     */
    StateHistoryPlugin.prototype.history;
    /**
     * Skip the update when redo/undo
     * @type {?}
     * @private
     */
    StateHistoryPlugin.prototype.skipUpdate;
    /**
     * @type {?}
     * @private
     */
    StateHistoryPlugin.prototype.subscription;
    /**
     * @type {?}
     * @private
     */
    StateHistoryPlugin.prototype.hasPastSubject;
    /**
     * @type {?}
     * @private
     */
    StateHistoryPlugin.prototype._hasPast$;
    /**
     * @type {?}
     * @private
     */
    StateHistoryPlugin.prototype.hasFutureSubject;
    /**
     * @type {?}
     * @private
     */
    StateHistoryPlugin.prototype._hasFuture$;
    /**
     * @type {?}
     * @protected
     */
    StateHistoryPlugin.prototype.query;
    /**
     * @type {?}
     * @private
     */
    StateHistoryPlugin.prototype.params;
    /**
     * @type {?}
     * @private
     */
    StateHistoryPlugin.prototype._entityId;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RhdGVIaXN0b3J5UGx1Z2luLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGRhdG9yYW1hL2FraXRhLyIsInNvdXJjZXMiOlsic3JjL3BsdWdpbnMvc3RhdGVIaXN0b3J5L3N0YXRlSGlzdG9yeVBsdWdpbi50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQUEsT0FBTyxFQUFFLFFBQVEsRUFBRSxvQkFBb0IsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQ2hFLE9BQU8sRUFBRSxlQUFlLEVBQWMsTUFBTSxNQUFNLENBQUM7QUFDbkQsT0FBTyxFQUFFLFdBQVcsRUFBVyxNQUFNLFdBQVcsQ0FBQztBQUNqRCxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzFDLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxrQkFBa0IsQ0FBQzs7OztBQUU5Qyx3Q0FJQzs7O0lBSEMsb0NBQWdCOztJQUNoQiwyQ0FBdUI7O0lBQ3ZCLHdDQUFrRDs7Ozs7QUFTcEQsTUFBTSxPQUFPLGtCQUFnQyxTQUFRLFdBQWtCOzs7Ozs7SUFvQnJFLFlBQXNCLEtBQXFCLEVBQVUsU0FBNkIsRUFBRSxFQUFVLFNBQWU7UUFDM0csS0FBSyxDQUFDLEtBQUssRUFBRTtZQUNYLE9BQU87OztZQUFFLEdBQUcsRUFBRSxDQUFDLElBQUksQ0FBQyxLQUFLLEVBQUUsQ0FBQTtTQUM1QixDQUFDLENBQUM7UUFIaUIsVUFBSyxHQUFMLEtBQUssQ0FBZ0I7UUFBVSxXQUFNLEdBQU4sTUFBTSxDQUF5QjtRQUFVLGNBQVMsR0FBVCxTQUFTLENBQU07Ozs7UUFsQnJHLFNBQUksR0FBRyxLQUFLLENBQUM7UUFFYixZQUFPLEdBQUc7WUFDaEIsSUFBSSxFQUFFLEVBQUU7WUFDUixPQUFPLEVBQUUsSUFBSTtZQUNiLE1BQU0sRUFBRSxFQUFFO1NBQ1gsQ0FBQzs7OztRQUdNLGVBQVUsR0FBRyxLQUFLLENBQUM7UUFhekIsTUFBTSxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUMsTUFBTSxDQUFD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QUksWUFBWSxFQUFFO1lBQ2hCLElBQUksQ0FBQyxLQUFLLEVBQUUsQ0FBQztTQUNkO1FBQ0QsSUFBSSxDQUFDLFlBQVksQ0FBQyxXQUFXLEVBQUUsQ0FBQztJQUNsQyxDQUFDOzs7O0lBRUQsVUFBVTtRQUNSLElBQUksQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDO0lBQ25CLENBQUM7Ozs7OztJQUVPLE1BQU0sQ0FBQyxNQUFNLEdBQUcsTUFBTTtRQUM1QixJQUFJLENBQUMsVUFBVSxHQUFHLElBQUksQ0FBQztRQUN2QixTQUFTLENBQUMsbUJBQW1CLE1BQU0sRUFBRSxDQUFDLENBQUM7UUFDdkMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLE9BQU8sRUFBRSxJQUFJLENBQUMsU0FBUyxFQUFFLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUN0RSxJQUFJLENBQUMsZ0JBQWdCLEVBQUUsQ0FBQztRQUN4QixJQUFJLENBQUMsVUFBVSxHQUFHLEtBQUssQ0FBQztJQUMxQixDQUFDO0NBQ0Y7Ozs7Ozs7SUE3TkMsa0NBQXFCOzs7OztJQUVyQixxQ0FJRTs7Ozs7O0lBR0Ysd0NBQTJCOzs7OztJQUMzQiwwQ0FBcUI7Ozs7O0lBR3JCLDRDQUFpRDs7Ozs7SUFDakQsdUNBQXVDOzs7OztJQUN2Qyw4Q0FBbUQ7Ozs7O0lBQ25ELHlDQUF5Qzs7Ozs7SUFFN0IsbUNBQStCOzs7OztJQUFFLG9DQUF1Qzs7Ozs7SUFBRSx1Q0FBdUIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBwYWlyd2lzZSwgZGlzdGluY3RVbnRpbENoYW5nZWQgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQgeyBCZWhhdmlvclN1YmplY3QsIE9ic2VydmFibGUgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IEFraXRhUGx1Z2luLCBRdWVyaWVzIH0gZnJvbSAnLi4vcGx1Z2luJztcbmltcG9ydCB7IGxvZ0FjdGlvbiB9IGZyb20gJy4uLy4uL2FjdGlvbnMnO1xuaW1wb3J0IHsgaXNGdW5jdGlvbiB9IGZyb20gJy4uLy4uL2lzRnVuY3Rpb24nO1xuXG5leHBvcnQgaW50ZXJmYWNlIFN0YXRlSGlzdG9yeVBhcmFtcyB7XG4gIG1heEFnZT86IG51bWJlcjtcbiAgd2F0Y2hQcm9wZXJ0eT86IHN0cmluZztcbiAgY29tcGFyYXRvcj86IChwcmV2U3RhdGUsIGN1cnJlbnRTdGF0ZSkgPT4gYm9vbGVhbjtcbn1cblxuZXhwb3J0IHR5cGUgSGlzdG9yeTxTdGF0ZT4gPSB7XG4gIHBhc3Q6IFN0YXRlW107XG4gIHByZXNlbnQ6IFN0YXRlIHwgbnVsbDtcbiAgZnV0dXJlOiBTdGF0ZVtdO1xufTtcblxuZXhwb3J0IGNsYXNzIFN0YXRlSGlzdG9yeVBsdWdpbjxTdGF0ZSA9IGFueT4gZXh0ZW5kcyBBa2l0YVBsdWdpbjxTdGF0ZT4ge1xuICAvKiogQWxsb3cgc2tpcHBpbmcgYW4gdXBkYXRlIGZyb20gb3V0c2lkZSAqL1xuICBwcml2YXRlIHNraXAgPSBmYWxzZTtcblxuICBwcml2YXRlIGhpc3RvcnkgPSB7XG4gICAgcGFzdDogW10sXG4gICAgcHJlc2VudDogbnVsbCxcbiAgICBmdXR1cmU6IFtdXG4gIH07XG5cbiAgLyoqIFNraXAgdGhlIHVwZGF0ZSB3aGVuIHJlZG8vdW5kbyAqL1xuICBwcml2YXRlIHNraXBVcGRhdGUgPSBmYWxzZTtcbiAgcHJpdmF0ZSBzdWJzY3JpcHRpb247XG5cbiAgLyogU3ViamVjdHMgZm9yIHN1cHBvcnRpbmcgb2JzZXJ2YWJsZSBoYXNQYXN0JCBhbmQgaGFzRnV0dXJlJCAqL1xuICBwcml2YXRlIGhhc1Bhc3RTdWJqZWN0OiBCZWhhdmlvclN1YmplY3Q8Ym9vbGVhbj47XG4gIHByaXZhdGUgX2hhc1Bhc3QkOiBPYnNlcnZhYmxlPGJvb2xlYW4+O1xuICBwcml2YXRlIGhhc0Z1dHVyZVN1YmplY3Q6IEJlaGF2aW9yU3ViamVjdDxib29sZWFuPjtcbiAgcHJpdmF0ZSBfaGFzRnV0dXJlJDogT2JzZXJ2YWJsZTxib29sZWFuPjtcblxuICBjb25zdHJ1Y3Rvcihwcm90ZWN0ZWQgcXVlcnk6IFF1ZXJpZXM8U3RhdGU+LCBwcml2YXRlIHBhcmFtczogU3RhdGVIaXN0b3J5UGFyYW1zID0ge30sIHByaXZhdGUgX2VudGl0eUlkPzogYW55KSB7XG4gICAgc3VwZXIocXVlcnksIHtcbiAgICAgIHJlc2V0Rm46ICgpID0+IHRoaXMuY2xlYXIoKVxuICAgIH0pO1xuICAgIHBhcmFtcy5tYXhBZ2UgPSAhIXBhcmFtcy5tYXhBZ2UgPyBwYXJhbXMubWF4QWdlIDogMTA7XG4gICAgcGFyYW1zLmNvbXBhcmF0b3IgPSBwYXJhbXMuY29tcGFyYXRvciB8fCAoKCkgPT4gdHJ1ZSk7XG5cbiAgICB0aGlzLmFjdGl2YXRlKCk7XG4gIH1cblxuICAvKipcbiAgICogT2JzZXJ2YWJsZSBzdHJlYW0gcmVwcmVzZW50aW5nIHdoZXRoZXIgdGhlIGhpc3RvcnkgcGx1Z2luIGhhcyBhbiBhdmFpbGFibGUgcGFzdFxuICAgKlxuICAgKi9cbiAgZ2V0IGhhc1Bhc3QkKCk6IE9ic2VydmFibGU8Ym9vbGVhbj4ge1xuICAgIHJldHVybiB0aGlzLl9oYXNQYXN0JDtcbiAgfVxuXG4gIC8qKlxuICAgKiBPYnNlcnZhYmxlIHN0cmVhbSByZXByZXNlbnRpbmcgd2hldGhlciB0aGUgaGlzdG9yeSBwbHVnaW4gaGFzIGFuIGF2YWlsYWJsZSBmdXR1cmVcbiAgICpcbiAgICovXG4gIGdldCBoYXNGdXR1cmUkKCk6IE9ic2VydmFibGU8Ym9vbGVhbj4ge1xuICAgIHJldHVybiB0aGlzLl9oYXNGdXR1cmUkO1xuICB9XG5cbiAgZ2V0IGhhc1Bhc3QoKSB7XG4gICAgcmV0dXJuIHRoaXMuaGlzdG9yeS5wYXN0Lmxlbmd0aCA+IDA7XG4gIH1cblxuICBnZXQgaGFzRnV0dXJlKCkge1xuICAgIHJldHVybiB0aGlzLmhpc3RvcnkuZnV0dXJlLmxlbmd0aCA+IDA7XG4gIH1cblxuICBwcml2YXRlIGdldCBwcm9wZXJ0eSgpIHtcbiAgICByZXR1cm4gdGhpcy5wYXJhbXMud2F0Y2hQcm9wZXJ0eTtcbiAgfVxuXG4gIC8qIFVwZGF0ZXMgdGhlIGhhc1Bhc3QkIGhhc0Z1dHVyZSQgb2JzZXJ2YWJsZXMqL1xuICBwcml2YXRlIHVwZGF0ZUhhc0hpc3RvcnkoKSB7XG4gICAgdGhpcy5oYXNGdXR1cmVTdWJqZWN0Lm5leHQodGhpcy5oYXNGdXR1cmUpO1xuICAgIHRoaXMuaGFzUGFzdFN1YmplY3QubmV4dCh0aGlzLmhhc1Bhc3QpO1xuICB9XG5cbiAgYWN0aXZhdGUoKSB7XG4gICAgdGhpcy5oYXNQYXN0U3ViamVjdCA9IG5ldyBCZWhhdmlvclN1YmplY3QoZmFsc2UpO1xuICAgIHRoaXMuX2hhc1Bhc3QkID0gdGhpcy5oYXNQYXN0U3ViamVjdC5hc09ic2VydmFibGUoKS5waXBlKGRpc3RpbmN0VW50aWxDaGFuZ2VkKCkpO1xuICAgIHRoaXMuaGFzRnV0dXJlU3ViamVjdCA9IG5ldyBCZWhhdmlvclN1YmplY3QoZmFsc2UpO1xuICAgIHRoaXMuX2hhc0Z1dHVyZSQgPSB0aGlzLmhhc0Z1dHVyZVN1YmplY3QuYXNPYnNlcnZhYmxlKCkucGlwZShkaXN0aW5jdFVudGlsQ2hhbmdlZCgpKTtcblxuICAgIHRoaXMuaGlzdG9yeS5wcmVzZW50ID0gdGhpcy5nZXRTb3VyY2UodGhpcy5fZW50aXR5SWQsIHRoaXMucHJvcGVydHkpO1xuICAgIHRoaXMuc3Vic2NyaXB0aW9uID0gKHRoaXMgYXMgYW55KVxuICAgICAgLnNlbGVjdFNvdXJjZSh0aGlzLl9lbnRpdHlJZCwgdGhpcy5wcm9wZXJ0eSlcbiAgICAgIC5waXBlKHBhaXJ3aXNlKCkpXG4gICAgICAuc3Vic2NyaWJlKChbcGFzdCwgcHJlc2VudF0pID0+IHtcbiAgICAgICAgaWYgKHRoaXMuc2tpcCkge1xuICAgICAgICAgIHRoaXMuc2tpcCA9IGZhbHNlO1xuICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICAvKipcbiAgICAgICAgICogIGNvbXBhcmF0b3I6IChwcmV2LCBjdXJyZW50KSA9PiBpc0VxdWFsKHByZXYsIGN1cnJlbnQpID09PSBmYWxzZVxuICAgICAgICAgKi9cbiAgICAgICAgY29uc3Qgc2hvdWxkVXBkYXRlID0gdGhpcy5wYXJhbXMuY29tcGFyYXRvcihwYXN0LCBwcmVzZW50KTtcblxuICAgICAgICBpZiAoIXRoaXMuc2tpcFVwZGF0ZSAmJiBzaG91bGRVcGRhdGUpIHtcbiAgICAgICAgICBpZiAodGhpcy5oaXN0b3J5LnBhc3QubGVuZ3RoID09PSB0aGlzLnBhcmFtcy5tYXhBZ2UpIHtcbiAgICAgICAgICAgIHRoaXMuaGlzdG9yeS5wYXN0ID0gdGhpcy5oaXN0b3J5LnBhc3Quc2xpY2UoMSk7XG4gICAgICAgICAgfVxuICAgICAgICAgIHRoaXMuaGlzdG9yeS5wYXN0ID0gWy4uLnRoaXMuaGlzdG9yeS5wYXN0LCBwYXN0XTtcbiAgICAgICAgICB0aGlzLmhpc3RvcnkucHJlc2VudCA9IHByZXNlbnQ7XG4gICAgICAgICAgdGhpcy51cGRhdGVIYXNIaXN0b3J5KCk7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICB9XG5cbiAgdW5kbygpIHtcbiAgICBpZiAodGhpcy5oaXN0b3J5LnBhc3QubGVuZ3RoID4gMCkge1xuICAgICAgY29uc3QgeyBwYXN0LCBwcmVzZW50IH0gPSB0aGlzLmhpc3Rvcnk7XG4gICAgICBjb25zdCBwcmV2aW91cyA9IHBhc3RbcGFzdC5sZW5ndGggLSAxXTtcbiAgICAgIHRoaXMuaGlzdG9yeS5wYXN0ID0gcGFzdC5zbGljZSgwLCBwYXN0Lmxlbmd0aCAtIDEpO1xuICAgICAgdGhpcy5oaXN0b3J5LnByZXNlbnQgPSBwcmV2aW91cztcbiAgICAgIHRoaXMuaGlzdG9yeS5mdXR1cmUgPSBbcHJlc2VudCwgLi4udGhpcy5oaXN0b3J5LmZ1dHVyZV07XG4gICAgICB0aGlzLnVwZGF0ZSgpO1xuICAgIH1cbiAgfVxuXG4gIHJlZG8oKSB7XG4gICAgaWYgKHRoaXMuaGlzdG9yeS5mdXR1cmUubGVuZ3RoID4gMCkge1xuICAgICAgY29uc3QgeyBwYXN0LCBwcmVzZW50IH0gPSB0aGlzLmhpc3Rvcnk7XG4gICAgICBjb25zdCBuZXh0ID0gdGhpcy5oaXN0b3J5LmZ1dHVyZVswXTtcbiAgICAgIGNvbnN0IG5ld0Z1dHVyZSA9IHRoaXMuaGlzdG9yeS5mdXR1cmUuc2xpY2UoMSk7XG4gICAgICB0aGlzLmhpc3RvcnkucGFzdCA9IFsuLi5wYXN0LCBwcmVzZW50XTtcbiAgICAgIHRoaXMuaGlzdG9yeS5wcmVzZW50ID0gbmV4dDtcbiAgICAgIHRoaXMuaGlzdG9yeS5mdXR1cmUgPSBuZXdGdXR1cmU7XG4gICAgICB0aGlzLnVwZGF0ZSgnUmVkbycpO1xuICAgIH1cbiAgfVxuXG4gIGp1bXBUb1Bhc3QoaW5kZXg6IG51bWJlcikge1xuICAgIGlmIChpbmRleCA8IDAgfHwgaW5kZXggPj0gdGhpcy5oaXN0b3J5LnBhc3QubGVuZ3RoKSByZXR1cm47XG5cbiAgICBjb25zdCB7IHBhc3QsIGZ1dHVyZSwgcHJlc2VudCB9ID0gdGhpcy5oaXN0b3J5O1xuICAgIC8qKlxuICAgICAqXG4gICAgICogY29uc3QgcGFzdCA9IFsxLCAyLCAzLCA0LCA1XTtcbiAgICAgKiBjb25zdCBwcmVzZW50ID0gNjtcbiAgICAgKiBjb25zdCBmdXR1cmUgPSBbNywgOCwgOV07XG4gICAgICogY29uc3QgaW5kZXggPSAyO1xuICAgICAqXG4gICAgICogbmV3UGFzdCA9IHBhc3Quc2xpY2UoMCwgaW5kZXgpID0gWzEsIDJdO1xuICAgICAqIG5ld1ByZXNlbnQgPSBwYXN0W2luZGV4XSA9IDM7XG4gICAgICogbmV3RnV0dXJlID0gWy4uLnBhc3Quc2xpY2UoaW5kZXggKyAxKSxwcmVzZW50LCAuLi5mdXR1cmVdID0gWzQsIDUsIDYsIDcsIDgsIDldO1xuICAgICAqXG4gICAgICovXG4gICAgY29uc3QgbmV3UGFzdCA9IHBhc3Quc2xpY2UoMCwgaW5kZXgpO1xuICAgIGNvbnN0IG5ld0Z1dHVyZSA9IFsuLi5wYXN0LnNsaWNlKGluZGV4ICsgMSksIHByZXNlbnQsIC4uLmZ1dHVyZV07XG4gICAgY29uc3QgbmV3UHJlc2VudCA9IHBhc3RbaW5kZXhdO1xuICAgIHRoaXMuaGlzdG9yeS5wYXN0ID0gbmV3UGFzdDtcbiAgICB0aGlzLmhpc3RvcnkucHJlc2VudCA9IG5ld1ByZXNlbnQ7XG4gICAgdGhpcy5oaXN0b3J5LmZ1dHVyZSA9IG5ld0Z1dHVyZTtcbiAgICB0aGlzLnVwZGF0ZSgpO1xuICB9XG5cbiAganVtcFRvRnV0dXJlKGluZGV4OiBudW1iZXIpIHtcbiAgICBpZiAoaW5kZXggPCAwIHx8IGluZGV4ID49IHRoaXMuaGlzdG9yeS5mdXR1cmUubGVuZ3RoKSByZXR1cm47XG5cbiAgICBjb25zdCB7IHBhc3QsIGZ1dHVyZSwgcHJlc2VudCB9ID0gdGhpcy5oaXN0b3J5O1xuICAgIC8qKlxuICAgICAqXG4gICAgICogY29uc3QgcGFzdCA9IFsxLCAyLCAzLCA0LCA1XTtcbiAgICAgKiBjb25zdCBwcmVzZW50ID0gNjtcbiAgICAgKiBjb25zdCBmdXR1cmUgPSBbNywgOCwgOSwgMTBdXG4gICAgICogY29uc3QgaW5kZXggPSAxXG4gICAgICpcbiAgICAgKiBuZXdQYXN0ID0gWy4uLnBhc3QsIHByZXNlbnQsIC4uLmZ1dHVyZS5zbGljZSgwLCBpbmRleCkgPSBbMSwgMiwgMywgNCwgNSwgNiwgN107XG4gICAgICogbmV3UHJlc2VudCA9IGZ1dHVyZVtpbmRleF0gPSA4O1xuICAgICAqIG5ld0Z1dHVyZSA9IGZ1dHJ1ZS5zbGljZShpbmRleCsxKSA9IFs5LCAxMF07XG4gICAgICpcbiAgICAgKi9cblxuICAgIGNvbnN0IG5ld1Bhc3QgPSBbLi4ucGFzdCwgcHJlc2VudCwgLi4uZnV0dXJlLnNsaWNlKDAsIGluZGV4KV07XG4gICAgY29uc3QgbmV3UHJlc2VudCA9IGZ1dHVyZVtpbmRleF07XG4gICAgY29uc3QgbmV3RnV0dXJlID0gZnV0dXJlLnNsaWNlKGluZGV4ICsgMSk7XG4gICAgdGhpcy5oaXN0b3J5LnBhc3QgPSBuZXdQYXN0O1xuICAgIHRoaXMuaGlzdG9yeS5wcmVzZW50ID0gbmV3UHJlc2VudDtcbiAgICB0aGlzLmhpc3RvcnkuZnV0dXJlID0gbmV3RnV0dXJlO1xuICAgIHRoaXMudXBkYXRlKCdSZWRvJyk7XG4gIH1cblxuICAvKipcbiAgICpcbiAgICoganVtcCBuIHN0ZXBzIGluIHRoZSBwYXN0IG9yIGZvcndhcmRcbiAgICpcbiAgICovXG4gIGp1bXAobjogbnVtYmVyKSB7XG4gICAgaWYgKG4gPiAwKSByZXR1cm4gdGhpcy5qdW1wVG9GdXR1cmUobiAtIDEpO1xuICAgIGlmIChuIDwgMCkgcmV0dXJuIHRoaXMuanVtcFRvUGFzdCh0aGlzLmhpc3RvcnkucGFzdC5sZW5ndGggKyBuKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDbGVhciB0aGUgaGlzdG9yeVxuICAgKlxuICAgKiBAcGFyYW0gY3VzdG9tVXBkYXRlRm4gQ2FsbGJhY2sgZnVuY3Rpb24gZm9yIG9ubHkgY2xlYXJpbmcgcGFydCBvZiB0aGUgaGlzdG9yeVxuICAgKlxuICAgKiBAZXhhbXBsZVxuICAgKlxuICAgKiBzdGF0ZUhpc3RvcnkuY2xlYXIoKGhpc3RvcnkpID0+IHtcbiAgICogIHJldHVybiB7XG4gICAqICAgIHBhc3Q6IGhpc3RvcnkucGFzdCxcbiAgICogICAgcHJlc2VudDogaGlzdG9yeS5wcmVzZW50LFxuICAgKiAgICBmdXR1cmU6IFtdXG4gICAqICB9O1xuICAgKiB9KTtcbiAgICovXG4gIGNsZWFyKGN1c3RvbVVwZGF0ZUZuPzogKGhpc3Rvcnk6IEhpc3Rvcnk8U3RhdGU+KSA9PiBIaXN0b3J5PFN0YXRlPikge1xuICAgIHRoaXMuaGlzdG9yeSA9IGlzRnVuY3Rpb24oY3VzdG9tVXBkYXRlRm4pXG4gICAgICA/IGN1c3RvbVVwZGF0ZUZuKHRoaXMuaGlzdG9yeSlcbiAgICAgIDoge1xuICAgICAgICAgIHBhc3Q6IFtdLFxuICAgICAgICAgIHByZXNlbnQ6IG51bGwsXG4gICAgICAgICAgZnV0dXJlOiBbXVxuICAgICAgICB9O1xuICAgIHRoaXMudXBkYXRlSGFzSGlzdG9yeSgpO1xuICB9XG5cbiAgZGVzdHJveShjbGVhckhpc3RvcnkgPSBmYWxzZSkge1xuICAgIGlmIChjbGVhckhpc3RvcnkpIHtcbiAgICAgIHRoaXMuY2xlYXIoKTtcbiAgICB9XG4gICAgdGhpcy5zdWJzY3JpcHRpb24udW5zdWJzY3JpYmUoKTtcbiAgfVxuXG4gIGlnbm9yZU5leHQoKSB7XG4gICAgdGhpcy5za2lwID0gdHJ1ZTtcbiAgfVxuXG4gIHByaXZhdGUgdXBkYXRlKGFjdGlvbiA9ICdVbmRvJykge1xuICAgIHRoaXMuc2tpcFVwZGF0ZSA9IHRydWU7XG4gICAgbG9nQWN0aW9uKGBAU3RhdGVIaXN0b3J5IC0gJHthY3Rpb259YCk7XG4gICAgdGhpcy51cGRhdGVTdG9yZSh0aGlzLmhpc3RvcnkucHJlc2VudCwgdGhpcy5fZW50aXR5SWQsIHRoaXMucHJvcGVydHkpO1xuICAgIHRoaXMudXBkYXRlSGFzSGlzdG9yeSgpO1xuICAgIHRoaXMuc2tpcFVwZGF0ZSA9IGZhbHNlO1xuICB9XG59XG4iXX0=