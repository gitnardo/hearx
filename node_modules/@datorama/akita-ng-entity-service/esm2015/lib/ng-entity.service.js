/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { EntityService, isDefined } from '@datorama/akita';
import { throwError } from 'rxjs';
import { inject } from '@angular/core';
import { HttpClient } from '@angular/common/http';
import { catchError, finalize, map, tap } from 'rxjs/operators';
import { HttpMethod, NgEntityServiceNotifier } from './ng-entity-service-notifier';
import { NgEntityServiceLoader } from './ng-entity-service.loader';
import { defaultConfig, mergeDeep, NG_ENTITY_SERVICE_CONFIG } from './ng-entity-service.config';
import { isID } from './helpers';
import { errorAction, successAction } from './action-factory';
/** @type {?} */
export const mapResponse = (/**
 * @param {?} config
 * @return {?}
 */
(config) => map((/**
 * @param {?} res
 * @return {?}
 */
res => ((config || {}).mapResponseFn ? config.mapResponseFn(res) : res))));
/**
 * @template S
 */
export class NgEntityService extends EntityService {
    /**
     * @param {?} store
     * @param {?=} config
     */
    constructor(store, config = {}) {
        super();
        this.store = store;
        this.config = config;
        this.globalConfig = {};
        this.http = inject(HttpClient);
        this.loader = inject(NgEntityServiceLoader);
        this.notifier = inject(NgEntityServiceNotifier);
        this.globalConfig = inject(NG_ENTITY_SERVICE_CONFIG);
        this.mergedConfig = mergeDeep(defaultConfig, this.globalConfig, config);
        this.dispatchSuccess = successAction(this.store.storeName, this.notifier);
        this.dispatchError = errorAction(this.store.storeName, this.notifier);
    }
    /**
     * @return {?}
     */
    get api() {
        return `${this.baseUrl || this.getConfigValue('baseUrl')}/${this.resourceName}`;
    }
    /**
     * @return {?}
     */
    get resourceName() {
        return this.getConfigValue('resourceName') || this.store.storeName;
    }
    /**
     * @param {?} api
     * @return {?}
     */
    setBaseUrl(api) {
        this.baseUrl = api;
    }
    /**
     * @return {?}
     */
    getHttp() {
        return this.http;
    }
    /**
     * @return {?}
     */
    getConfig() {
        return this.mergedConfig;
    }
    /**
     * @template T
     * @param {?=} idOrConfig
     * @param {?=} config
     * @return {?}
     */
    get(idOrConfig, config) {
        /** @type {?} */
        let url;
        /** @type {?} */
        const isSingle = isID(idOrConfig);
        /** @type {?} */
        const _config = (isSingle ? config : idOrConfig) || {};
        /** @type {?} */
        const method = this.getHttpMethod(HttpMethod.GET);
        if (_config.url) {
            url = _config.url;
        }
        else {
            url = isSingle ? `${this.api}/${idOrConfig}` : this.api;
        }
        this.loader.dispatch({
            method,
            loading: true,
            entityId: isSingle ? idOrConfig : null,
            storeName: this.store.storeName
        });
        return (/** @type {?} */ (this.http[method.toLowerCase()](url, _config).pipe(mapResponse(_config), tap((/**
         * @param {?} data
         * @return {?}
         */
        (data) => {
            if (isSingle) {
                this.store.upsert((/** @type {?} */ (idOrConfig)), data);
            }
            else {
                if (_config.append) {
                    this.store.add(data);
                }
                else if (_config.upsert) {
                    this.store.upsertMany(data);
                }
                else {
                    this.store.set(data);
                }
            }
            this.dispatchSuccess({
                method,
                payload: data,
                successMsg: _config.successMsg
            });
        })), catchError((/**
         * @param {?} error
         * @return {?}
         */
        error => this.handleError(method, error, _config.errorMsg))), finalize((/**
         * @return {?}
         */
        () => {
            this.loader.dispatch({
                method,
                loading: false,
                storeName: this.store.storeName
            });
        })))));
    }
    /**
     *
     * Add a new entity - Creates a POST request
     *
     * service.add(entity)
     * service.add(entity, config)
     *
     * @template T
     * @param {?} entity
     * @param {?=} config
     * @return {?}
     */
    add(entity, config) {
        /** @type {?} */
        const method = this.getHttpMethod(HttpMethod.POST);
        this.loader.dispatch({
            method,
            loading: true,
            storeName: this.store.storeName
        });
        return (/** @type {?} */ (this.http[method.toLowerCase()](this.resolveUrl(config), entity, config).pipe(mapResponse(config), tap((/**
         * @param {?} entity
         * @return {?}
         */
        (entity) => {
            this.store.add(entity, config);
            this.dispatchSuccess({
                method,
                payload: entity,
                successMsg: config && config.successMsg
            });
        })), catchError((/**
         * @param {?} error
         * @return {?}
         */
        error => this.handleError(method, error, config && config.errorMsg))), finalize((/**
         * @return {?}
         */
        () => {
            this.loader.dispatch({
                method,
                loading: false,
                storeName: this.store.storeName
            });
        })))));
    }
    /**
     *
     * Update an entity - Creates a PUT/PATCH request
     *
     * service.update(id, entity)
     * service.update(id, entity, config)
     *
     * @template T
     * @param {?} id
     * @param {?} entity
     * @param {?=} config
     * @return {?}
     */
    update(id, entity, config) {
        /** @type {?} */
        const method = config && config.method ? config.method : this.getHttpMethod(HttpMethod.PUT);
        this.loader.dispatch({
            method,
            loading: true,
            entityId: id,
            storeName: this.store.storeName
        });
        return (/** @type {?} */ (this.http[method.toLocaleLowerCase()](this.resolveUrl(config, id), entity, config).pipe(mapResponse(config), tap((/**
         * @param {?} entity
         * @return {?}
         */
        entity => {
            this.store.update(id, (/** @type {?} */ (entity)));
            this.dispatchSuccess({
                method,
                payload: entity,
                successMsg: config && config.successMsg
            });
        })), catchError((/**
         * @param {?} error
         * @return {?}
         */
        error => this.handleError(method, error, config && config.errorMsg))), finalize((/**
         * @return {?}
         */
        () => {
            this.loader.dispatch({
                method,
                loading: false,
                entityId: id,
                storeName: this.store.storeName
            });
        })))));
    }
    /**
     *
     * Delete an entity - Creates a DELETE request
     *
     * service.delete(id)
     * service.delete(id, config)
     *
     * @template T
     * @param {?} id
     * @param {?=} config
     * @return {?}
     */
    delete(id, config) {
        /** @type {?} */
        const method = this.getHttpMethod(HttpMethod.DELETE);
        this.loader.dispatch({
            method,
            loading: true,
            entityId: id,
            storeName: this.store.storeName
        });
        return (/** @type {?} */ (this.http[method.toLowerCase()](this.resolveUrl(config, id), config).pipe(mapResponse(config), tap((/**
         * @param {?} res
         * @return {?}
         */
        res => {
            this.store.remove(id);
            this.dispatchSuccess({
                method,
                payload: res,
                successMsg: config && config.successMsg
            });
        })), catchError((/**
         * @param {?} error
         * @return {?}
         */
        error => this.handleError(method, error, config && config.errorMsg))), finalize((/**
         * @return {?}
         */
        () => {
            this.loader.dispatch({
                method,
                loading: false,
                entityId: id,
                storeName: this.store.storeName
            });
        })))));
    }
    /**
     * @private
     * @param {?} type
     * @return {?}
     */
    getHttpMethod(type) {
        return this.mergedConfig.httpMethods[type];
    }
    /**
     * @private
     * @param {?} key
     * @return {?}
     */
    getConfigValue(key) {
        return this.constructor[key] || this.mergedConfig[key];
    }
    /**
     * @private
     * @param {?} config
     * @param {?=} id
     * @return {?}
     */
    resolveUrl(config, id) {
        /** @type {?} */
        const customUrl = (config || {}).url;
        if (isDefined(id)) {
            return customUrl || `${this.api}/${id}`;
        }
        return customUrl || this.api;
    }
    /**
     * @private
     * @param {?} method
     * @param {?} error
     * @param {?} errorMsg
     * @return {?}
     */
    handleError(method, error, errorMsg) {
        this.dispatchError({
            method,
            errorMsg,
            payload: error
        });
        return throwError(error);
    }
}
if (false) {
    /** @type {?} */
    NgEntityService.prototype.baseUrl;
    /** @type {?} */
    NgEntityService.prototype.loader;
    /**
     * @type {?}
     * @private
     */
    NgEntityService.prototype.http;
    /**
     * @type {?}
     * @private
     */
    NgEntityService.prototype.notifier;
    /**
     * @type {?}
     * @private
     */
    NgEntityService.prototype.globalConfig;
    /**
     * @type {?}
     * @private
     */
    NgEntityService.prototype.mergedConfig;
    /**
     * @type {?}
     * @private
     */
    NgEntityService.prototype.dispatchSuccess;
    /**
     * @type {?}
     * @private
     */
    NgEntityService.prototype.dispatchError;
    /**
     * @type {?}
     * @protected
     */
    NgEntityService.prototype.store;
    /**
     * @type {?}
     * @private
     */
    NgEntityService.prototype.config;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmctZW50aXR5LnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZGF0b3JhbWEvYWtpdGEtbmctZW50aXR5LXNlcnZpY2UvIiwic291cmNlcyI6WyJsaWIvbmctZW50aXR5LnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7OztBQUFBLE9BQU8sRUFFTCxhQUFhLEVBS2IsU0FBUyxFQUNWLE1BQU0saUJBQWlCLENBQUM7QUFDekIsT0FBTyxFQUFjLFVBQVUsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUM5QyxPQUFPLEVBQUUsTUFBTSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ3ZDLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQztBQUNsRCxPQUFPLEVBQUUsVUFBVSxFQUFFLFFBQVEsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFFaEUsT0FBTyxFQUF1QixVQUFVLEVBQUUsdUJBQXVCLEVBQUUsTUFBTSw4QkFBOEIsQ0FBQztBQUN4RyxPQUFPLEVBQUUscUJBQXFCLEVBQUUsTUFBTSw0QkFBNEIsQ0FBQztBQUNuRSxPQUFPLEVBQ0wsYUFBYSxFQUNiLFNBQVMsRUFDVCx3QkFBd0IsRUFFekIsTUFBTSw0QkFBNEIsQ0FBQztBQUNwQyxPQUFPLEVBQUUsSUFBSSxFQUFFLE1BQU0sV0FBVyxDQUFDO0FBQ2pDLE9BQU8sRUFBRSxXQUFXLEVBQUUsYUFBYSxFQUFFLE1BQU0sa0JBQWtCLENBQUM7O0FBRTlELE1BQU0sT0FBTyxXQUFXOzs7O0FBQUcsQ0FBQyxNQUFrQixFQUFFLEVBQUUsQ0FDaEQsR0FBRzs7OztBQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLE1BQU0sSUFBSSxFQUFFLENBQUMsQ0FBQyxhQUFhLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxhQUFhLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxFQUFDLENBQUE7Ozs7QUFFOUUsTUFBTSxPQUFPLGVBQTZDLFNBQVEsYUFBZ0I7Ozs7O0lBWWhGLFlBQXNCLEtBQXFCLEVBQVUsU0FBZ0MsRUFBRTtRQUNyRixLQUFLLEVBQUUsQ0FBQztRQURZLFVBQUssR0FBTCxLQUFLLENBQWdCO1FBQVUsV0FBTSxHQUFOLE1BQU0sQ0FBNEI7UUFOL0UsaUJBQVksR0FBZ0MsRUFBRSxDQUFDO1FBUXJELElBQUksQ0FBQyxJQUFJLEdBQUcsTUFBTSxDQUFDLFVBQVUsQ0FBQyxDQUFDO1FBQy9CLElBQUksQ0FBQyxNQUFNLEdBQUcsTUFBTSxDQUFDLHFCQUFxQixDQUFDLENBQUM7UUFDNUMsSUFBSSxDQUFDLFFBQVEsR0FBRyxNQUFNLENBQUMsdUJBQXVCLENBQUMsQ0FBQztRQUNoRCxJQUFJLENBQUMsWUFBWSxHQUFHLE1BQU0sQ0FBQyx3QkFBd0IsQ0FBQyxDQUFDO1FBRXJELElBQUksQ0FBQyxZQUFZLEdBQUcsU0FBUyxDQUFDLGFBQWEsRUFBRSxJQUFJLENBQUMsWUFBWSxFQUFFLE1BQU0sQ0FBQyxDQUFDO1FBRXhFLElBQUksQ0FBQyxlQUFlLEdBQUcsYUFBYSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsU0FBUyxFQUFFLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUMxRSxJQUFJLENBQUMsYUFBYSxHQUFHLFdBQVcsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLFNBQVMsRUFBRSxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUM7SUFDeEUsQ0FBQzs7OztJQUVELElBQUksR0FBRztRQUNMLE9BQU8sR0FBRyxJQUFJLENBQUMsT0FBTyxJQUFJLElBQUksQ0FBQyxjQUFjLENBQUMsU0FBUyxDQUFDLElBQUksSUFBSSxDQUFDLFlBQVksRUFBRSxDQUFDO0lBQ2xGLENBQUM7Ozs7SUFFRCxJQUFJLFlBQVk7UUFDZCxPQUFPLElBQUksQ0FBQyxjQUFjLENBQUMsY0FBYyxDQUFDLElBQUksSUFBSSxDQUFDLEtBQUssQ0FBQyxTQUFTLENBQUM7SUFDckUsQ0FBQzs7Ozs7SUFFRCxVQUFVLENBQUMsR0FBVztRQUNwQixJQUFJLENBQUMsT0FBTyxHQUFHLEdBQUcsQ0FBQztJQUNyQixDQUFDOzs7O0lBRUQsT0FBTztRQUNMLE9BQU8sSUFBSSxDQUFDLElBQUksQ0FBQztJQUNuQixDQUFDOzs7O0lBRUQsU0FBUztRQUNQLE9BQU8sSUFBSSxDQUFDLFlBQVksQ0FBQztJQUMzQixDQUFDOzs7Ozs7O0lBZUQsR0FBRyxDQUNELFVBQXNDLEVBQ3RDLE1BQWtFOztZQUU5RCxHQUFXOztjQUNULFFBQVEsR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDOztjQUMzQixPQUFPLEdBQThELENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLFVBQVUsQ0FBQyxJQUFJLEVBQUU7O2NBQzNHLE1BQU0sR0FBRyxJQUFJLENBQUMsYUFBYSxDQUFDLFVBQVUsQ0FBQyxHQUFHLENBQUM7UUFFakQsSUFBSSxPQUFPLENBQUMsR0FBRyxFQUFFO1lBQ2YsR0FBRyxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUM7U0FDbkI7YUFBTTtZQUNMLEdBQUcsR0FBRyxRQUFRLENBQUMsQ0FBQyxDQUFDLEdBQUcsSUFBSSxDQUFDLEdBQUcsSUFBSSxVQUFVLEVBQUUsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQztTQUN6RDtRQUVELElBQUksQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDO1lBQ25CLE1BQU07WUFDTixPQUFPLEVBQUUsSUFBSTtZQUNiLFFBQVEsRUFBRSxRQUFRLENBQUMsQ0FBQyxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsSUFBSTtZQUN0QyxTQUFTLEVBQUUsSUFBSSxDQUFDLEtBQUssQ0FBQyxTQUFTO1NBQ2hDLENBQUMsQ0FBQztRQUVILE9BQU8sbUJBQUEsSUFBSSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsV0FBVyxFQUFFLENBQUMsQ0FBQyxHQUFHLEVBQUUsT0FBTyxDQUFDLENBQUMsSUFBSSxDQUN2RCxXQUFXLENBQUMsT0FBTyxDQUFDLEVBQ3BCLEdBQUc7Ozs7UUFBQyxDQUFDLElBQVMsRUFBRSxFQUFFO1lBQ2hCLElBQUksUUFBUSxFQUFFO2dCQUNaLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLG1CQUFBLFVBQVUsRUFBZ0IsRUFBRSxJQUFJLENBQUMsQ0FBQzthQUNyRDtpQkFBTTtnQkFDTCxJQUFJLE9BQU8sQ0FBQyxNQUFNLEVBQUU7b0JBQ2xCLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFDO2lCQUN0QjtxQkFBTSxJQUFJLE9BQU8sQ0FBQyxNQUFNLEVBQUU7b0JBQ3pCLElBQUksQ0FBQyxLQUFLLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxDQUFDO2lCQUM3QjtxQkFBTTtvQkFDTCxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQztpQkFDdEI7YUFDRjtZQUVELElBQUksQ0FBQyxlQUFlLENBQUM7Z0JBQ25CLE1BQU07Z0JBQ04sT0FBTyxFQUFFLElBQUk7Z0JBQ2IsVUFBVSxFQUFFLE9BQU8sQ0FBQyxVQUFVO2FBQy9CLENBQUMsQ0FBQztRQUNMLENBQUMsRUFBQyxFQUNGLFVBQVU7Ozs7UUFBQyxLQUFLLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsTUFBTSxFQUFFLEtBQUssRUFBRSxPQUFPLENBQUMsUUFBUSxDQUFDLEVBQUMsRUFDdEUsUUFBUTs7O1FBQUMsR0FBRyxFQUFFO1lBQ1osSUFBSSxDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUM7Z0JBQ25CLE1BQU07Z0JBQ04sT0FBTyxFQUFFLEtBQUs7Z0JBQ2QsU0FBUyxFQUFFLElBQUksQ0FBQyxLQUFLLENBQUMsU0FBUzthQUNoQyxDQUFDLENBQUM7UUFDTCxDQUFDLEVBQUMsQ0FDSCxFQUFpQixDQUFDO0lBQ3JCLENBQUM7Ozs7Ozs7Ozs7Ozs7SUFVRCxHQUFHLENBQUksTUFBd0IsRUFBRSxNQUErRDs7Y0FDeEYsTUFBTSxHQUFHLElBQUksQ0FBQyxhQUFhLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQztRQUVsRCxJQUFJLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQztZQUNuQixNQUFNO1lBQ04sT0FBTyxFQUFFLElBQUk7WUFDYixTQUFTLEVBQUUsSUFBSSxDQUFDLEtBQUssQ0FBQyxTQUFTO1NBQ2hDLENBQUMsQ0FBQztRQUNILE9BQU8sbUJBQUEsSUFBSSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsV0FBVyxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLE1BQU0sQ0FBQyxFQUFFLE1BQU0sRUFBRSxNQUFNLENBQUMsQ0FBQyxJQUFJLENBQ2xGLFdBQVcsQ0FBQyxNQUFNLENBQUMsRUFDbkIsR0FBRzs7OztRQUFDLENBQUMsTUFBVyxFQUFFLEVBQUU7WUFDbEIsSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsTUFBTSxFQUFFLE1BQU0sQ0FBQyxDQUFDO1lBQy9CLElBQUksQ0FBQyxlQUFlLENBQUM7Z0JBQ25CLE1BQU07Z0JBQ04sT0FBTyxFQUFFLE1BQU07Z0JBQ2YsVUFBVSxFQUFFLE1BQU0sSUFBSSxNQUFNLENBQUMsVUFBVTthQUN4QyxDQUFDLENBQUM7UUFDTCxDQUFDLEVBQUMsRUFDRixVQUFVOzs7O1FBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLE1BQU0sRUFBRSxLQUFLLEVBQUUsTUFBTSxJQUFJLE1BQU0sQ0FBQyxRQUFRLENBQUMsRUFBQyxFQUMvRSxRQUFROzs7UUFBQyxHQUFHLEVBQUU7WUFDWixJQUFJLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQztnQkFDbkIsTUFBTTtnQkFDTixPQUFPLEVBQUUsS0FBSztnQkFDZCxTQUFTLEVBQUUsSUFBSSxDQUFDLEtBQUssQ0FBQyxTQUFTO2FBQ2hDLENBQUMsQ0FBQztRQUNMLENBQUMsRUFBQyxDQUNILEVBQWlCLENBQUM7SUFDckIsQ0FBQzs7Ozs7Ozs7Ozs7Ozs7SUFVRCxNQUFNLENBQ0osRUFBZ0IsRUFDaEIsTUFBaUMsRUFDakMsTUFBeUU7O2NBRW5FLE1BQU0sR0FBRyxNQUFNLElBQUksTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxVQUFVLENBQUMsR0FBRyxDQUFDO1FBRTNGLElBQUksQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDO1lBQ25CLE1BQU07WUFDTixPQUFPLEVBQUUsSUFBSTtZQUNiLFFBQVEsRUFBRSxFQUFFO1lBQ1osU0FBUyxFQUFFLElBQUksQ0FBQyxLQUFLLENBQUMsU0FBUztTQUNoQyxDQUFDLENBQUM7UUFFSCxPQUFPLG1CQUFBLElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLGlCQUFpQixFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLE1BQU0sRUFBRSxFQUFFLENBQUMsRUFBRSxNQUFNLEVBQUUsTUFBTSxDQUFDLENBQUMsSUFBSSxDQUM1RixXQUFXLENBQUMsTUFBTSxDQUFDLEVBQ25CLEdBQUc7Ozs7UUFBQyxNQUFNLENBQUMsRUFBRTtZQUNYLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLEVBQUUsRUFBRSxtQkFBQSxNQUFNLEVBQU8sQ0FBQyxDQUFDO1lBQ3JDLElBQUksQ0FBQyxlQUFlLENBQUM7Z0JBQ25CLE1BQU07Z0JBQ04sT0FBTyxFQUFFLE1BQU07Z0JBQ2YsVUFBVSxFQUFFLE1BQU0sSUFBSSxNQUFNLENBQUMsVUFBVTthQUN4QyxDQUFDLENBQUM7UUFDTCxDQUFDLEVBQUMsRUFDRixVQUFVOzs7O1FBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLE1BQU0sRUFBRSxLQUFLLEVBQUUsTUFBTSxJQUFJLE1BQU0sQ0FBQyxRQUFRLENBQUMsRUFBQyxFQUMvRSxRQUFROzs7UUFBQyxHQUFHLEVBQUU7WUFDWixJQUFJLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQztnQkFDbkIsTUFBTTtnQkFDTixPQUFPLEVBQUUsS0FBSztnQkFDZCxRQUFRLEVBQUUsRUFBRTtnQkFDWixTQUFTLEVBQUUsSUFBSSxDQUFDLEtBQUssQ0FBQyxTQUFTO2FBQ2hDLENBQUMsQ0FBQztRQUNMLENBQUMsRUFBQyxDQUNILEVBQWlCLENBQUM7SUFDckIsQ0FBQzs7Ozs7Ozs7Ozs7OztJQVVELE1BQU0sQ0FBSSxFQUFnQixFQUFFLE1BQXlCOztjQUM3QyxNQUFNLEdBQUcsSUFBSSxDQUFDLGFBQWEsQ0FBQyxVQUFVLENBQUMsTUFBTSxDQUFDO1FBRXBELElBQUksQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDO1lBQ25CLE1BQU07WUFDTixPQUFPLEVBQUUsSUFBSTtZQUNiLFFBQVEsRUFBRSxFQUFFO1lBQ1osU0FBUyxFQUFFLElBQUksQ0FBQyxLQUFLLENBQUMsU0FBUztTQUNoQyxDQUFDLENBQUM7UUFFSCxPQUFPLG1CQUFBLElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLFdBQVcsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxNQUFNLEVBQUUsRUFBRSxDQUFDLEVBQUUsTUFBTSxDQUFDLENBQUMsSUFBSSxDQUM5RSxXQUFXLENBQUMsTUFBTSxDQUFDLEVBQ25CLEdBQUc7Ozs7UUFBQyxHQUFHLENBQUMsRUFBRTtZQUNSLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1lBQ3RCLElBQUksQ0FBQyxlQUFlLENBQUM7Z0JBQ25CLE1BQU07Z0JBQ04sT0FBTyxFQUFFLEdBQUc7Z0JBQ1osVUFBVSxFQUFFLE1BQU0sSUFBSSxNQUFNLENBQUMsVUFBVTthQUN4QyxDQUFDLENBQUM7UUFDTCxDQUFDLEVBQUMsRUFDRixVQUFVOzs7O1FBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLE1BQU0sRUFBRSxLQUFLLEVBQUUsTUFBTSxJQUFJLE1BQU0sQ0FBQyxRQUFRLENBQUMsRUFBQyxFQUMvRSxRQUFROzs7UUFBQyxHQUFHLEVBQUU7WUFDWixJQUFJLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQztnQkFDbkIsTUFBTTtnQkFDTixPQUFPLEVBQUUsS0FBSztnQkFDZCxRQUFRLEVBQUUsRUFBRTtnQkFDWixTQUFTLEVBQUUsSUFBSSxDQUFDLEtBQUssQ0FBQyxTQUFTO2FBQ2hDLENBQUMsQ0FBQztRQUNMLENBQUMsRUFBQyxDQUNILEVBQWlCLENBQUM7SUFDckIsQ0FBQzs7Ozs7O0lBRU8sYUFBYSxDQUFDLElBQWdCO1FBQ3BDLE9BQU8sSUFBSSxDQUFDLFlBQVksQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDN0MsQ0FBQzs7Ozs7O0lBRU8sY0FBYyxDQUFDLEdBQVc7UUFDaEMsT0FBTyxJQUFJLENBQUMsV0FBVyxDQUFDLEdBQUcsQ0FBQyxJQUFJLElBQUksQ0FBQyxZQUFZLENBQUMsR0FBRyxDQUFDLENBQUM7SUFDekQsQ0FBQzs7Ozs7OztJQUVPLFVBQVUsQ0FBQyxNQUFrQixFQUFFLEVBQVE7O2NBQ3ZDLFNBQVMsR0FBRyxDQUFDLE1BQU0sSUFBSSxFQUFFLENBQUMsQ0FBQyxHQUFHO1FBQ3BDLElBQUksU0FBUyxDQUFDLEVBQUUsQ0FBQyxFQUFFO1lBQ2pCLE9BQU8sU0FBUyxJQUFJLEdBQUcsSUFBSSxDQUFDLEdBQUcsSUFBSSxFQUFFLEVBQUUsQ0FBQztTQUN6QztRQUVELE9BQU8sU0FBUyxJQUFJLElBQUksQ0FBQyxHQUFHLENBQUM7SUFDL0IsQ0FBQzs7Ozs7Ozs7SUFFTyxXQUFXLENBQUMsTUFBa0IsRUFBRSxLQUFVLEVBQUUsUUFBZ0I7UUFDbEUsSUFBSSxDQUFDLGFBQWEsQ0FBQztZQUNqQixNQUFNO1lBQ04sUUFBUTtZQUNSLE9BQU8sRUFBRSxLQUFLO1NBQ2YsQ0FBQyxDQUFDO1FBRUgsT0FBTyxVQUFVLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDM0IsQ0FBQztDQUNGOzs7SUFsUUMsa0NBQWdCOztJQUNoQixpQ0FBOEI7Ozs7O0lBRTlCLCtCQUF5Qjs7Ozs7SUFDekIsbUNBQTBDOzs7OztJQUMxQyx1Q0FBdUQ7Ozs7O0lBQ3ZELHVDQUEwRTs7Ozs7SUFFMUUsMENBQXdFOzs7OztJQUN4RSx3Q0FBc0U7Ozs7O0lBRTFELGdDQUErQjs7Ozs7SUFBRSxpQ0FBMEMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBBZGRFbnRpdGllc09wdGlvbnMsXG4gIEVudGl0eVNlcnZpY2UsXG4gIEVudGl0eVN0YXRlLFxuICBFbnRpdHlTdG9yZSxcbiAgZ2V0RW50aXR5VHlwZSxcbiAgZ2V0SURUeXBlLFxuICBpc0RlZmluZWRcbn0gZnJvbSAnQGRhdG9yYW1hL2FraXRhJztcbmltcG9ydCB7IE9ic2VydmFibGUsIHRocm93RXJyb3IgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IGluamVjdCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgSHR0cENsaWVudCB9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbi9odHRwJztcbmltcG9ydCB7IGNhdGNoRXJyb3IsIGZpbmFsaXplLCBtYXAsIHRhcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7IEh0dHBDb25maWcsIE1zZywgTmdFbnRpdHlTZXJ2aWNlUGFyYW1zIH0gZnJvbSAnLi90eXBlcyc7XG5pbXBvcnQgeyBFbnRpdHlTZXJ2aWNlQWN0aW9uLCBIdHRwTWV0aG9kLCBOZ0VudGl0eVNlcnZpY2VOb3RpZmllciB9IGZyb20gJy4vbmctZW50aXR5LXNlcnZpY2Utbm90aWZpZXInO1xuaW1wb3J0IHsgTmdFbnRpdHlTZXJ2aWNlTG9hZGVyIH0gZnJvbSAnLi9uZy1lbnRpdHktc2VydmljZS5sb2FkZXInO1xuaW1wb3J0IHtcbiAgZGVmYXVsdENvbmZpZyxcbiAgbWVyZ2VEZWVwLFxuICBOR19FTlRJVFlfU0VSVklDRV9DT05GSUcsXG4gIE5nRW50aXR5U2VydmljZUdsb2JhbENvbmZpZ1xufSBmcm9tICcuL25nLWVudGl0eS1zZXJ2aWNlLmNvbmZpZyc7XG5pbXBvcnQgeyBpc0lEIH0gZnJvbSAnLi9oZWxwZXJzJztcbmltcG9ydCB7IGVycm9yQWN0aW9uLCBzdWNjZXNzQWN0aW9uIH0gZnJvbSAnLi9hY3Rpb24tZmFjdG9yeSc7XG5cbmV4cG9ydCBjb25zdCBtYXBSZXNwb25zZSA9IChjb25maWc6IEh0dHBDb25maWcpID0+XG4gIG1hcChyZXMgPT4gKChjb25maWcgfHwge30pLm1hcFJlc3BvbnNlRm4gPyBjb25maWcubWFwUmVzcG9uc2VGbihyZXMpIDogcmVzKSk7XG5cbmV4cG9ydCBjbGFzcyBOZ0VudGl0eVNlcnZpY2U8UyBleHRlbmRzIEVudGl0eVN0YXRlID0gYW55PiBleHRlbmRzIEVudGl0eVNlcnZpY2U8Uz4ge1xuICBiYXNlVXJsOiBzdHJpbmc7XG4gIGxvYWRlcjogTmdFbnRpdHlTZXJ2aWNlTG9hZGVyO1xuXG4gIHByaXZhdGUgaHR0cDogSHR0cENsaWVudDtcbiAgcHJpdmF0ZSBub3RpZmllcjogTmdFbnRpdHlTZXJ2aWNlTm90aWZpZXI7XG4gIHByaXZhdGUgZ2xvYmFsQ29uZmlnOiBOZ0VudGl0eVNlcnZpY2VHbG9iYWxDb25maWcgPSB7fTtcbiAgcHJpdmF0ZSBtZXJnZWRDb25maWc6IE5nRW50aXR5U2VydmljZVBhcmFtcyAmIE5nRW50aXR5U2VydmljZUdsb2JhbENvbmZpZztcblxuICBwcml2YXRlIGRpc3BhdGNoU3VjY2VzczogKGFjdGlvbjogUGFydGlhbDxFbnRpdHlTZXJ2aWNlQWN0aW9uPikgPT4gdm9pZDtcbiAgcHJpdmF0ZSBkaXNwYXRjaEVycm9yOiAoYWN0aW9uOiBQYXJ0aWFsPEVudGl0eVNlcnZpY2VBY3Rpb24+KSA9PiB2b2lkO1xuXG4gIGNvbnN0cnVjdG9yKHByb3RlY3RlZCBzdG9yZTogRW50aXR5U3RvcmU8Uz4sIHByaXZhdGUgY29uZmlnOiBOZ0VudGl0eVNlcnZpY2VQYXJhbXMgPSB7fSkge1xuICAgIHN1cGVyKCk7XG4gICAgdGhpcy5odHRwID0gaW5qZWN0KEh0dHBDbGllbnQpO1xuICAgIHRoaXMubG9hZGVyID0gaW5qZWN0KE5nRW50aXR5U2VydmljZUxvYWRlcik7XG4gICAgdGhpcy5ub3RpZmllciA9IGluamVjdChOZ0VudGl0eVNlcnZpY2VOb3RpZmllcik7XG4gICAgdGhpcy5nbG9iYWxDb25maWcgPSBpbmplY3QoTkdfRU5USVRZX1NFUlZJQ0VfQ09ORklHKTtcblxuICAgIHRoaXMubWVyZ2VkQ29uZmlnID0gbWVyZ2VEZWVwKGRlZmF1bHRDb25maWcsIHRoaXMuZ2xvYmFsQ29uZmlnLCBjb25maWcpO1xuXG4gICAgdGhpcy5kaXNwYXRjaFN1Y2Nlc3MgPSBzdWNjZXNzQWN0aW9uKHRoaXMuc3RvcmUuc3RvcmVOYW1lLCB0aGlzLm5vdGlmaWVyKTtcbiAgICB0aGlzLmRpc3BhdGNoRXJyb3IgPSBlcnJvckFjdGlvbih0aGlzLnN0b3JlLnN0b3JlTmFtZSwgdGhpcy5ub3RpZmllcik7XG4gIH1cblxuICBnZXQgYXBpKCkge1xuICAgIHJldHVybiBgJHt0aGlzLmJhc2VVcmwgfHwgdGhpcy5nZXRDb25maWdWYWx1ZSgnYmFzZVVybCcpfS8ke3RoaXMucmVzb3VyY2VOYW1lfWA7XG4gIH1cblxuICBnZXQgcmVzb3VyY2VOYW1lKCkge1xuICAgIHJldHVybiB0aGlzLmdldENvbmZpZ1ZhbHVlKCdyZXNvdXJjZU5hbWUnKSB8fCB0aGlzLnN0b3JlLnN0b3JlTmFtZTtcbiAgfVxuXG4gIHNldEJhc2VVcmwoYXBpOiBzdHJpbmcpIHtcbiAgICB0aGlzLmJhc2VVcmwgPSBhcGk7XG4gIH1cblxuICBnZXRIdHRwKCkge1xuICAgIHJldHVybiB0aGlzLmh0dHA7XG4gIH1cblxuICBnZXRDb25maWcoKSB7XG4gICAgcmV0dXJuIHRoaXMubWVyZ2VkQ29uZmlnO1xuICB9XG5cbiAgLyoqXG4gICAqXG4gICAqIEdldCBhbGwgb3Igb25lIGVudGl0eSAtIENyZWF0ZXMgYSBHRVQgcmVxdWVzdFxuICAgKlxuICAgKiBzZXJ2aWNlLmdldCgpLnN1YnNjcmliZSgpXG4gICAqIHNlcnZpY2UuZ2V0KHsgaGVhZGVycywgcGFyYW1zLCB1cmwgfSlcbiAgICpcbiAgICogc2VydmljZS5nZXQoaWQpXG4gICAqIHNlcnZpY2UuZ2V0KGlkLCB7IGhlYWRlcnMsIHBhcmFtcywgdXJsIH0pXG4gICAqXG4gICAqL1xuICBnZXQ8VD4oaWQ/OiBnZXRJRFR5cGU8Uz4sIGNvbmZpZz86IEh0dHBDb25maWcgJiB7IGFwcGVuZD86IGJvb2xlYW4gfSAmIE1zZyk6IE9ic2VydmFibGU8VD47XG4gIGdldDxUPihjb25maWc/OiBIdHRwQ29uZmlnICYgeyBhcHBlbmQ/OiBib29sZWFuIH0gJiBNc2cpOiBPYnNlcnZhYmxlPFQ+O1xuICBnZXQ8VD4oXG4gICAgaWRPckNvbmZpZz86IGdldElEVHlwZTxTPiB8IEh0dHBDb25maWcsXG4gICAgY29uZmlnPzogSHR0cENvbmZpZyAmIHsgYXBwZW5kPzogYm9vbGVhbjsgdXBzZXJ0PzogYm9vbGVhbiB9ICYgTXNnXG4gICk6IE9ic2VydmFibGU8VD4ge1xuICAgIGxldCB1cmw6IHN0cmluZztcbiAgICBjb25zdCBpc1NpbmdsZSA9IGlzSUQoaWRPckNvbmZpZyk7XG4gICAgY29uc3QgX2NvbmZpZzogSHR0cENvbmZpZyAmIHsgYXBwZW5kPzogYm9vbGVhbjsgdXBzZXJ0PzogYm9vbGVhbiB9ICYgTXNnID0gKGlzU2luZ2xlID8gY29uZmlnIDogaWRPckNvbmZpZykgfHwge307XG4gICAgY29uc3QgbWV0aG9kID0gdGhpcy5nZXRIdHRwTWV0aG9kKEh0dHBNZXRob2QuR0VUKTtcblxuICAgIGlmIChfY29uZmlnLnVybCkge1xuICAgICAgdXJsID0gX2NvbmZpZy51cmw7XG4gICAgfSBlbHNlIHtcbiAgICAgIHVybCA9IGlzU2luZ2xlID8gYCR7dGhpcy5hcGl9LyR7aWRPckNvbmZpZ31gIDogdGhpcy5hcGk7XG4gICAgfVxuXG4gICAgdGhpcy5sb2FkZXIuZGlzcGF0Y2goe1xuICAgICAgbWV0aG9kLFxuICAgICAgbG9hZGluZzogdHJ1ZSxcbiAgICAgIGVudGl0eUlkOiBpc1NpbmdsZSA/IGlkT3JDb25maWcgOiBudWxsLFxuICAgICAgc3RvcmVOYW1lOiB0aGlzLnN0b3JlLnN0b3JlTmFtZVxuICAgIH0pO1xuXG4gICAgcmV0dXJuIHRoaXMuaHR0cFttZXRob2QudG9Mb3dlckNhc2UoKV0odXJsLCBfY29uZmlnKS5waXBlKFxuICAgICAgbWFwUmVzcG9uc2UoX2NvbmZpZyksXG4gICAgICB0YXAoKGRhdGE6IGFueSkgPT4ge1xuICAgICAgICBpZiAoaXNTaW5nbGUpIHtcbiAgICAgICAgICB0aGlzLnN0b3JlLnVwc2VydChpZE9yQ29uZmlnIGFzIGdldElEVHlwZTxTPiwgZGF0YSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgaWYgKF9jb25maWcuYXBwZW5kKSB7XG4gICAgICAgICAgICB0aGlzLnN0b3JlLmFkZChkYXRhKTtcbiAgICAgICAgICB9IGVsc2UgaWYgKF9jb25maWcudXBzZXJ0KSB7XG4gICAgICAgICAgICB0aGlzLnN0b3JlLnVwc2VydE1hbnkoZGF0YSk7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMuc3RvcmUuc2V0KGRhdGEpO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMuZGlzcGF0Y2hTdWNjZXNzKHtcbiAgICAgICAgICBtZXRob2QsXG4gICAgICAgICAgcGF5bG9hZDogZGF0YSxcbiAgICAgICAgICBzdWNjZXNzTXNnOiBfY29uZmlnLnN1Y2Nlc3NNc2dcbiAgICAgICAgfSk7XG4gICAgICB9KSxcbiAgICAgIGNhdGNoRXJyb3IoZXJyb3IgPT4gdGhpcy5oYW5kbGVFcnJvcihtZXRob2QsIGVycm9yLCBfY29uZmlnLmVycm9yTXNnKSksXG4gICAgICBmaW5hbGl6ZSgoKSA9PiB7XG4gICAgICAgIHRoaXMubG9hZGVyLmRpc3BhdGNoKHtcbiAgICAgICAgICBtZXRob2QsXG4gICAgICAgICAgbG9hZGluZzogZmFsc2UsXG4gICAgICAgICAgc3RvcmVOYW1lOiB0aGlzLnN0b3JlLnN0b3JlTmFtZVxuICAgICAgICB9KTtcbiAgICAgIH0pXG4gICAgKSBhcyBPYnNlcnZhYmxlPFQ+O1xuICB9XG5cbiAgLyoqXG4gICAqXG4gICAqIEFkZCBhIG5ldyBlbnRpdHkgLSBDcmVhdGVzIGEgUE9TVCByZXF1ZXN0XG4gICAqXG4gICAqIHNlcnZpY2UuYWRkKGVudGl0eSlcbiAgICogc2VydmljZS5hZGQoZW50aXR5LCBjb25maWcpXG4gICAqXG4gICAqL1xuICBhZGQ8VD4oZW50aXR5OiBnZXRFbnRpdHlUeXBlPFM+LCBjb25maWc/OiBIdHRwQ29uZmlnICYgUGljazxBZGRFbnRpdGllc09wdGlvbnMsICdwcmVwZW5kJz4gJiBNc2cpOiBPYnNlcnZhYmxlPFQ+IHtcbiAgICBjb25zdCBtZXRob2QgPSB0aGlzLmdldEh0dHBNZXRob2QoSHR0cE1ldGhvZC5QT1NUKTtcblxuICAgIHRoaXMubG9hZGVyLmRpc3BhdGNoKHtcbiAgICAgIG1ldGhvZCxcbiAgICAgIGxvYWRpbmc6IHRydWUsXG4gICAgICBzdG9yZU5hbWU6IHRoaXMuc3RvcmUuc3RvcmVOYW1lXG4gICAgfSk7XG4gICAgcmV0dXJuIHRoaXMuaHR0cFttZXRob2QudG9Mb3dlckNhc2UoKV0odGhpcy5yZXNvbHZlVXJsKGNvbmZpZyksIGVudGl0eSwgY29uZmlnKS5waXBlKFxuICAgICAgbWFwUmVzcG9uc2UoY29uZmlnKSxcbiAgICAgIHRhcCgoZW50aXR5OiBhbnkpID0+IHtcbiAgICAgICAgdGhpcy5zdG9yZS5hZGQoZW50aXR5LCBjb25maWcpO1xuICAgICAgICB0aGlzLmRpc3BhdGNoU3VjY2Vzcyh7XG4gICAgICAgICAgbWV0aG9kLFxuICAgICAgICAgIHBheWxvYWQ6IGVudGl0eSxcbiAgICAgICAgICBzdWNjZXNzTXNnOiBjb25maWcgJiYgY29uZmlnLnN1Y2Nlc3NNc2dcbiAgICAgICAgfSk7XG4gICAgICB9KSxcbiAgICAgIGNhdGNoRXJyb3IoZXJyb3IgPT4gdGhpcy5oYW5kbGVFcnJvcihtZXRob2QsIGVycm9yLCBjb25maWcgJiYgY29uZmlnLmVycm9yTXNnKSksXG4gICAgICBmaW5hbGl6ZSgoKSA9PiB7XG4gICAgICAgIHRoaXMubG9hZGVyLmRpc3BhdGNoKHtcbiAgICAgICAgICBtZXRob2QsXG4gICAgICAgICAgbG9hZGluZzogZmFsc2UsXG4gICAgICAgICAgc3RvcmVOYW1lOiB0aGlzLnN0b3JlLnN0b3JlTmFtZVxuICAgICAgICB9KTtcbiAgICAgIH0pXG4gICAgKSBhcyBPYnNlcnZhYmxlPFQ+O1xuICB9XG5cbiAgLyoqXG4gICAqXG4gICAqIFVwZGF0ZSBhbiBlbnRpdHkgLSBDcmVhdGVzIGEgUFVUL1BBVENIIHJlcXVlc3RcbiAgICpcbiAgICogc2VydmljZS51cGRhdGUoaWQsIGVudGl0eSlcbiAgICogc2VydmljZS51cGRhdGUoaWQsIGVudGl0eSwgY29uZmlnKVxuICAgKlxuICAgKi9cbiAgdXBkYXRlPFQ+KFxuICAgIGlkOiBnZXRJRFR5cGU8Uz4sXG4gICAgZW50aXR5OiBQYXJ0aWFsPGdldEVudGl0eVR5cGU8Uz4+LFxuICAgIGNvbmZpZz86IEh0dHBDb25maWcgJiB7IG1ldGhvZDogSHR0cE1ldGhvZC5QVVQgfCBIdHRwTWV0aG9kLlBBVENIIH0gJiBNc2dcbiAgKTogT2JzZXJ2YWJsZTxUPiB7XG4gICAgY29uc3QgbWV0aG9kID0gY29uZmlnICYmIGNvbmZpZy5tZXRob2QgPyBjb25maWcubWV0aG9kIDogdGhpcy5nZXRIdHRwTWV0aG9kKEh0dHBNZXRob2QuUFVUKTtcblxuICAgIHRoaXMubG9hZGVyLmRpc3BhdGNoKHtcbiAgICAgIG1ldGhvZCxcbiAgICAgIGxvYWRpbmc6IHRydWUsXG4gICAgICBlbnRpdHlJZDogaWQsXG4gICAgICBzdG9yZU5hbWU6IHRoaXMuc3RvcmUuc3RvcmVOYW1lXG4gICAgfSk7XG5cbiAgICByZXR1cm4gdGhpcy5odHRwW21ldGhvZC50b0xvY2FsZUxvd2VyQ2FzZSgpXSh0aGlzLnJlc29sdmVVcmwoY29uZmlnLCBpZCksIGVudGl0eSwgY29uZmlnKS5waXBlKFxuICAgICAgbWFwUmVzcG9uc2UoY29uZmlnKSxcbiAgICAgIHRhcChlbnRpdHkgPT4ge1xuICAgICAgICB0aGlzLnN0b3JlLnVwZGF0ZShpZCwgZW50aXR5IGFzIGFueSk7XG4gICAgICAgIHRoaXMuZGlzcGF0Y2hTdWNjZXNzKHtcbiAgICAgICAgICBtZXRob2QsXG4gICAgICAgICAgcGF5bG9hZDogZW50aXR5LFxuICAgICAgICAgIHN1Y2Nlc3NNc2c6IGNvbmZpZyAmJiBjb25maWcuc3VjY2Vzc01zZ1xuICAgICAgICB9KTtcbiAgICAgIH0pLFxuICAgICAgY2F0Y2hFcnJvcihlcnJvciA9PiB0aGlzLmhhbmRsZUVycm9yKG1ldGhvZCwgZXJyb3IsIGNvbmZpZyAmJiBjb25maWcuZXJyb3JNc2cpKSxcbiAgICAgIGZpbmFsaXplKCgpID0+IHtcbiAgICAgICAgdGhpcy5sb2FkZXIuZGlzcGF0Y2goe1xuICAgICAgICAgIG1ldGhvZCxcbiAgICAgICAgICBsb2FkaW5nOiBmYWxzZSxcbiAgICAgICAgICBlbnRpdHlJZDogaWQsXG4gICAgICAgICAgc3RvcmVOYW1lOiB0aGlzLnN0b3JlLnN0b3JlTmFtZVxuICAgICAgICB9KTtcbiAgICAgIH0pXG4gICAgKSBhcyBPYnNlcnZhYmxlPFQ+O1xuICB9XG5cbiAgLyoqXG4gICAqXG4gICAqIERlbGV0ZSBhbiBlbnRpdHkgLSBDcmVhdGVzIGEgREVMRVRFIHJlcXVlc3RcbiAgICpcbiAgICogc2VydmljZS5kZWxldGUoaWQpXG4gICAqIHNlcnZpY2UuZGVsZXRlKGlkLCBjb25maWcpXG4gICAqXG4gICAqL1xuICBkZWxldGU8VD4oaWQ6IGdldElEVHlwZTxTPiwgY29uZmlnPzogSHR0cENvbmZpZyAmIE1zZyk6IE9ic2VydmFibGU8VD4ge1xuICAgIGNvbnN0IG1ldGhvZCA9IHRoaXMuZ2V0SHR0cE1ldGhvZChIdHRwTWV0aG9kLkRFTEVURSk7XG5cbiAgICB0aGlzLmxvYWRlci5kaXNwYXRjaCh7XG4gICAgICBtZXRob2QsXG4gICAgICBsb2FkaW5nOiB0cnVlLFxuICAgICAgZW50aXR5SWQ6IGlkLFxuICAgICAgc3RvcmVOYW1lOiB0aGlzLnN0b3JlLnN0b3JlTmFtZVxuICAgIH0pO1xuXG4gICAgcmV0dXJuIHRoaXMuaHR0cFttZXRob2QudG9Mb3dlckNhc2UoKV0odGhpcy5yZXNvbHZlVXJsKGNvbmZpZywgaWQpLCBjb25maWcpLnBpcGUoXG4gICAgICBtYXBSZXNwb25zZShjb25maWcpLFxuICAgICAgdGFwKHJlcyA9PiB7XG4gICAgICAgIHRoaXMuc3RvcmUucmVtb3ZlKGlkKTtcbiAgICAgICAgdGhpcy5kaXNwYXRjaFN1Y2Nlc3Moe1xuICAgICAgICAgIG1ldGhvZCxcbiAgICAgICAgICBwYXlsb2FkOiByZXMsXG4gICAgICAgICAgc3VjY2Vzc01zZzogY29uZmlnICYmIGNvbmZpZy5zdWNjZXNzTXNnXG4gICAgICAgIH0pO1xuICAgICAgfSksXG4gICAgICBjYXRjaEVycm9yKGVycm9yID0+IHRoaXMuaGFuZGxlRXJyb3IobWV0aG9kLCBlcnJvciwgY29uZmlnICYmIGNvbmZpZy5lcnJvck1zZykpLFxuICAgICAgZmluYWxpemUoKCkgPT4ge1xuICAgICAgICB0aGlzLmxvYWRlci5kaXNwYXRjaCh7XG4gICAgICAgICAgbWV0aG9kLFxuICAgICAgICAgIGxvYWRpbmc6IGZhbHNlLFxuICAgICAgICAgIGVudGl0eUlkOiBpZCxcbiAgICAgICAgICBzdG9yZU5hbWU6IHRoaXMuc3RvcmUuc3RvcmVOYW1lXG4gICAgICAgIH0pO1xuICAgICAgfSlcbiAgICApIGFzIE9ic2VydmFibGU8VD47XG4gIH1cblxuICBwcml2YXRlIGdldEh0dHBNZXRob2QodHlwZTogSHR0cE1ldGhvZCkge1xuICAgIHJldHVybiB0aGlzLm1lcmdlZENvbmZpZy5odHRwTWV0aG9kc1t0eXBlXTtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0Q29uZmlnVmFsdWUoa2V5OiBzdHJpbmcpIHtcbiAgICByZXR1cm4gdGhpcy5jb25zdHJ1Y3RvcltrZXldIHx8IHRoaXMubWVyZ2VkQ29uZmlnW2tleV07XG4gIH1cblxuICBwcml2YXRlIHJlc29sdmVVcmwoY29uZmlnOiBIdHRwQ29uZmlnLCBpZD86IGFueSkge1xuICAgIGNvbnN0IGN1c3RvbVVybCA9IChjb25maWcgfHwge30pLnVybDtcbiAgICBpZiAoaXNEZWZpbmVkKGlkKSkge1xuICAgICAgcmV0dXJuIGN1c3RvbVVybCB8fCBgJHt0aGlzLmFwaX0vJHtpZH1gO1xuICAgIH1cblxuICAgIHJldHVybiBjdXN0b21VcmwgfHwgdGhpcy5hcGk7XG4gIH1cblxuICBwcml2YXRlIGhhbmRsZUVycm9yKG1ldGhvZDogSHR0cE1ldGhvZCwgZXJyb3I6IGFueSwgZXJyb3JNc2c6IHN0cmluZykge1xuICAgIHRoaXMuZGlzcGF0Y2hFcnJvcih7XG4gICAgICBtZXRob2QsXG4gICAgICBlcnJvck1zZyxcbiAgICAgIHBheWxvYWQ6IGVycm9yXG4gICAgfSk7XG5cbiAgICByZXR1cm4gdGhyb3dFcnJvcihlcnJvcik7XG4gIH1cbn1cbiJdfQ==