import * as tslib_1 from "tslib";
import { Injectable } from '@angular/core';
import { NavigationCancel, NavigationError, Router, RoutesRecognized } from '@angular/router';
import { of } from 'rxjs';
import { RouterStore } from './router.store';
import { RouterQuery } from './router.query';
import { action, setSkipAction } from '@datorama/akita';
import * as i0 from "@angular/core";
import * as i1 from "./router.store";
import * as i2 from "./router.query";
import * as i3 from "@angular/router";
let RouterService = class RouterService {
    constructor(routerStore, routerQuery, router) {
        this.routerStore = routerStore;
        this.routerQuery = routerQuery;
        this.router = router;
        this.dispatchTriggeredByRouter = false;
        this.navigationTriggeredByDispatch = false;
    }
    dispatchRouterCancel(event) {
        this.update();
    }
    dispatchRouterError(event) {
        this.update();
    }
    dispatchRouterNavigation() {
        this.update();
    }
    init() {
        this.setUpRouterHook();
        this.setUpStoreListener();
        this.setUpStateRollbackEvents();
    }
    update() {
        this.dispatchTriggeredByRouter = true;
        this.routerStore.update((state) => {
            return Object.assign({}, state, { state: this.routerStateSnapshot, navigationId: this.lastRoutesRecognized ? this.lastRoutesRecognized.id : null });
        });
        this.dispatchTriggeredByRouter = false;
        this.navigationTriggeredByDispatch = false;
    }
    /**
     * Hook into the angular router before each navigation action is performed
     * since the route tree can be large, we serialize it into something more manageable
     */
    setUpRouterHook() {
        this.router.hooks.beforePreactivation = (routerStateSnapshot) => {
            this.routerStateSnapshot = {
                root: this.serializeRoute(routerStateSnapshot.root),
                url: routerStateSnapshot.url
            };
            if (this.shouldDispatchRouterNavigation())
                this.dispatchRouterNavigation();
            return of(true);
        };
    }
    setUpStoreListener() {
        this.routerQuery
            .select(state => state)
            .subscribe(s => {
            this.routerState = s;
            this.navigateIfNeeded();
        });
    }
    shouldDispatchRouterNavigation() {
        if (!this.routerState)
            return true;
        return !this.navigationTriggeredByDispatch;
    }
    navigateIfNeeded() {
        if (!this.routerState || !this.routerState.state) {
            return;
        }
        if (this.dispatchTriggeredByRouter)
            return;
        if (this.router.url !== this.routerState.state.url) {
            this.navigationTriggeredByDispatch = true;
            setSkipAction();
            this.router.navigateByUrl(this.routerState.state.url);
        }
    }
    setUpStateRollbackEvents() {
        this.router.events.subscribe(e => {
            if (e instanceof RoutesRecognized) {
                this.lastRoutesRecognized = e;
            }
            else if (e instanceof NavigationCancel) {
                this.dispatchRouterCancel(e);
            }
            else if (e instanceof NavigationError) {
                this.dispatchRouterError(e);
            }
        });
    }
    serializeRoute(route) {
        let state = route.root;
        while (state.firstChild) {
            state = state.firstChild;
        }
        const { params, data, paramMap, queryParamMap, queryParams, fragment } = state;
        return {
            url: route.url,
            params,
            queryParams,
            fragment,
            data,
            paramMap,
            queryParamMap
        };
    }
};
RouterService.ngInjectableDef = i0.defineInjectable({ factory: function RouterService_Factory() { return new RouterService(i0.inject(i1.RouterStore), i0.inject(i2.RouterQuery), i0.inject(i3.Router)); }, token: RouterService, providedIn: "root" });
tslib_1.__decorate([
    action('Navigation Cancelled'),
    tslib_1.__metadata("design:type", Function),
    tslib_1.__metadata("design:paramtypes", [NavigationCancel]),
    tslib_1.__metadata("design:returntype", void 0)
], RouterService.prototype, "dispatchRouterCancel", null);
tslib_1.__decorate([
    action('Navigation Error'),
    tslib_1.__metadata("design:type", Function),
    tslib_1.__metadata("design:paramtypes", [NavigationError]),
    tslib_1.__metadata("design:returntype", void 0)
], RouterService.prototype, "dispatchRouterError", null);
tslib_1.__decorate([
    action('Navigation'),
    tslib_1.__metadata("design:type", Function),
    tslib_1.__metadata("design:paramtypes", []),
    tslib_1.__metadata("design:returntype", void 0)
], RouterService.prototype, "dispatchRouterNavigation", null);
RouterService = tslib_1.__decorate([
    Injectable({
        providedIn: 'root'
    }),
    tslib_1.__metadata("design:paramtypes", [RouterStore, RouterQuery, Router])
], RouterService);
export { RouterService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicm91dGVyLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZGF0b3JhbWEvYWtpdGEtbmctcm91dGVyLXN0b3JlLyIsInNvdXJjZXMiOlsicm91dGVyLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDM0MsT0FBTyxFQUVMLGdCQUFnQixFQUNoQixlQUFlLEVBQ2YsTUFBTSxFQUVOLGdCQUFnQixFQUNqQixNQUFNLGlCQUFpQixDQUFDO0FBQ3pCLE9BQU8sRUFBRSxFQUFFLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDMUIsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQzdDLE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUM3QyxPQUFPLEVBQUUsTUFBTSxFQUFFLGFBQWEsRUFBRSxNQUFNLGlCQUFpQixDQUFDOzs7OztBQUt4RCxJQUFhLGFBQWEsR0FBMUIsTUFBYSxhQUFhO0lBT3hCLFlBQW9CLFdBQXdCLEVBQVUsV0FBd0IsRUFBVSxNQUFjO1FBQWxGLGdCQUFXLEdBQVgsV0FBVyxDQUFhO1FBQVUsZ0JBQVcsR0FBWCxXQUFXLENBQWE7UUFBVSxXQUFNLEdBQU4sTUFBTSxDQUFRO1FBSjlGLDhCQUF5QixHQUFHLEtBQUssQ0FBQztRQUNsQyxrQ0FBNkIsR0FBRyxLQUFLLENBQUM7SUFHMkQsQ0FBQztJQUcxRyxvQkFBb0IsQ0FBQyxLQUF1QjtRQUMxQyxJQUFJLENBQUMsTUFBTSxFQUFFLENBQUM7SUFDaEIsQ0FBQztJQUdELG1CQUFtQixDQUFDLEtBQXNCO1FBQ3hDLElBQUksQ0FBQyxNQUFNLEVBQUUsQ0FBQztJQUNoQixDQUFDO0lBR0Qsd0JBQXdCO1FBQ3RCLElBQUksQ0FBQyxNQUFNLEVBQUUsQ0FBQztJQUNoQixDQUFDO0lBRUQsSUFBSTtRQUNGLElBQUksQ0FBQyxlQUFlLEVBQUUsQ0FBQztRQUN2QixJ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QUMsQ0FBQztJQUNMLENBQUM7SUFFTyxjQUFjLENBQUMsS0FBNkI7UUFDbEQsSUFBSSxLQUFLLEdBQTJCLEtBQUssQ0FBQyxJQUFJLENBQUM7UUFDL0MsT0FBTyxLQUFLLENBQUMsVUFBVSxFQUFFO1lBQ3ZCLEtBQUssR0FBRyxLQUFLLENBQUMsVUFBVSxDQUFDO1NBQzFCO1FBQ0QsTUFBTSxFQUFFLE1BQU0sRUFBRSxJQUFJLEVBQUUsUUFBUSxFQUFFLGFBQWEsRUFBRSxXQUFXLEVBQUUsUUFBUSxFQUFFLEdBQUcsS0FBSyxDQUFDO1FBRS9FLE9BQU87WUFDTCxHQUFHLEVBQUUsS0FBSyxDQUFDLEdBQUc7WUFDZCxNQUFNO1lBQ04sV0FBVztZQUNYLFFBQVE7WUFDUixJQUFJO1lBQ0osUUFBUTtZQUNSLGFBQWE7U0FDZCxDQUFDO0lBQ0osQ0FBQztDQUNGLENBQUE7O0FBeEdDO0lBREMsTUFBTSxDQUFDLHNCQUFzQixDQUFDOzs2Q0FDSCxnQkFBZ0I7O3lEQUUzQztBQUdEO0lBREMsTUFBTSxDQUFDLGtCQUFrQixDQUFDOzs2Q0FDQSxlQUFlOzt3REFFekM7QUFHRDtJQURDLE1BQU0sQ0FBQyxZQUFZLENBQUM7Ozs7NkRBR3BCO0FBdEJVLGFBQWE7SUFIekIsVUFBVSxDQUFDO1FBQ1YsVUFBVSxFQUFFLE1BQU07S0FDbkIsQ0FBQzs2Q0FRaUMsV0FBVyxFQUF1QixXQUFXLEVBQWtCLE1BQU07R0FQM0YsYUFBYSxDQWtIekI7U0FsSFksYUFBYSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7XG4gIEFjdGl2YXRlZFJvdXRlU25hcHNob3QsXG4gIE5hdmlnYXRpb25DYW5jZWwsXG4gIE5hdmlnYXRpb25FcnJvcixcbiAgUm91dGVyLFxuICBSb3V0ZXJTdGF0ZVNuYXBzaG90LFxuICBSb3V0ZXNSZWNvZ25pemVkXG59IGZyb20gJ0Bhbmd1bGFyL3JvdXRlcic7XG5pbXBvcnQgeyBvZiB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgUm91dGVyU3RvcmUgfSBmcm9tICcuL3JvdXRlci5zdG9yZSc7XG5pbXBvcnQgeyBSb3V0ZXJRdWVyeSB9IGZyb20gJy4vcm91dGVyLnF1ZXJ5JztcbmltcG9ydCB7IGFjdGlvbiwgc2V0U2tpcEFjdGlvbiB9IGZyb20gJ0BkYXRvcmFtYS9ha2l0YSc7XG5cbkBJbmplY3RhYmxlKHtcbiAgcHJvdmlkZWRJbjogJ3Jvb3QnXG59KVxuZXhwb3J0IGNsYXNzIFJvdXRlclNlcnZpY2Uge1xuICBwcml2YXRlIHJvdXRlclN0YXRlU25hcHNob3Q6IGFueTtcbiAgcHJpdmF0ZSBsYXN0Um91dGVzUmVjb2duaXplZDogYW55O1xuICBwcml2YXRlIGRpc3BhdGNoVHJpZ2dlcmVkQnlSb3V0ZXIgPSBmYWxzZTtcbiAgcHJpdmF0ZSBuYXZpZ2F0aW9uVHJpZ2dlcmVkQnlEaXNwYXRjaCA9IGZhbHNlO1xuICBwcml2YXRlIHJvdXRlclN0YXRlOiBhbnk7XG5cbiAgY29uc3RydWN0b3IocHJpdmF0ZSByb3V0ZXJTdG9yZTogUm91dGVyU3RvcmUsIHByaXZhdGUgcm91dGVyUXVlcnk6IFJvdXRlclF1ZXJ5LCBwcml2YXRlIHJvdXRlcjogUm91dGVyKSB7fVxuXG4gIEBhY3Rpb24oJ05hdmlnYXRpb24gQ2FuY2VsbGVkJylcbiAgZGlzcGF0Y2hSb3V0ZXJDYW5jZWwoZXZlbnQ6IE5hdmlnYXRpb25DYW5jZWwpIHtcbiAgICB0aGlzLnVwZGF0ZSgpO1xuICB9XG5cbiAgQGFjdGlvbignTmF2aWdhdGlvbiBFcnJvcicpXG4gIGRpc3BhdGNoUm91dGVyRXJyb3IoZXZlbnQ6IE5hdmlnYXRpb25FcnJvcikge1xuICAgIHRoaXMudXBkYXRlKCk7XG4gIH1cblxuICBAYWN0aW9uKCdOYXZpZ2F0aW9uJylcbiAgZGlzcGF0Y2hSb3V0ZXJOYXZpZ2F0aW9uKCkge1xuICAgIHRoaXMudXBkYXRlKCk7XG4gIH1cblxuICBpbml0KCkge1xuICAgIHRoaXMuc2V0VXBSb3V0ZXJIb29rKCk7XG4gICAgdGhpcy5zZXRVcFN0b3JlTGlzdGVuZXIoKTtcbiAgICB0aGlzLnNldFVwU3RhdGVSb2xsYmFja0V2ZW50cygpO1xuICB9XG5cbiAgcHJpdmF0ZSB1cGRhdGUoKSB7XG4gICAgdGhpcy5kaXNwYXRjaFRyaWdnZXJlZEJ5Um91dGVyID0gdHJ1ZTtcbiAgICB0aGlzLnJvdXRlclN0b3JlLnVwZGF0ZSgoc3RhdGU6IGFueSkgPT4ge1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgLi4uc3RhdGUsXG4gICAgICAgIHN0YXRlOiB0aGlzLnJvdXRlclN0YXRlU25hcHNob3QsXG4gICAgICAgIG5hdmlnYXRpb25JZDogdGhpcy5sYXN0Um91dGVzUmVjb2duaXplZCA/IHRoaXMubGFzdFJvdXRlc1JlY29nbml6ZWQuaWQgOiBudWxsXG4gICAgICB9O1xuICAgIH0pO1xuICAgIHRoaXMuZGlzcGF0Y2hUcmlnZ2VyZWRCeVJvdXRlciA9IGZhbHNlO1xuICAgIHRoaXMubmF2aWdhdGlvblRyaWdnZXJlZEJ5RGlzcGF0Y2ggPSBmYWxzZTtcbiAgfVxuXG4gIC8qKlxuICAgKiBIb29rIGludG8gdGhlIGFuZ3VsYXIgcm91dGVyIGJlZm9yZSBlYWNoIG5hdmlnYXRpb24gYWN0aW9uIGlzIHBlcmZvcm1lZFxuICAgKiBzaW5jZSB0aGUgcm91dGUgdHJlZSBjYW4gYmUgbGFyZ2UsIHdlIHNlcmlhbGl6ZSBpdCBpbnRvIHNvbWV0aGluZyBtb3JlIG1hbmFnZWFibGVcbiAgICovXG4gIHByaXZhdGUgc2V0VXBSb3V0ZXJIb29rKCk6IHZvaWQge1xuICAgICh0aGlzLnJvdXRlciBhcyBhbnkpLmhvb2tzLmJlZm9yZVByZWFjdGl2YXRpb24gPSAocm91dGVyU3RhdGVTbmFwc2hvdDogUm91dGVyU3RhdGVTbmFwc2hvdCkgPT4ge1xuICAgICAgdGhpcy5yb3V0ZXJTdGF0ZVNuYXBzaG90ID0ge1xuICAgICAgICByb290OiB0aGlzLnNlcmlhbGl6ZVJvdXRlKHJvdXRlclN0YXRlU25hcHNob3Qucm9vdCksXG4gICAgICAgIHVybDogcm91dGVyU3RhdGVTbmFwc2hvdC51cmxcbiAgICAgIH07XG4gICAgICBpZiAodGhpcy5zaG91bGREaXNwYXRjaFJvdXRlck5hdmlnYXRpb24oKSkgdGhpcy5kaXNwYXRjaFJvdXRlck5hdmlnYXRpb24oKTtcbiAgICAgIHJldHVybiBvZih0cnVlKTtcbiAgICB9O1xuICB9XG5cbiAgcHJpdmF0ZSBzZXRVcFN0b3JlTGlzdGVuZXIoKTogdm9pZCB7XG4gICAgdGhpcy5yb3V0ZXJRdWVyeVxuICAgICAgLnNlbGVjdChzdGF0ZSA9PiBzdGF0ZSlcbiAgICAgIC5zdWJzY3JpYmUocyA9PiB7XG4gICAgICAgIHRoaXMucm91dGVyU3RhdGUgPSBzO1xuICAgICAgICB0aGlzLm5hdmlnYXRlSWZOZWVkZWQoKTtcbiAgICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBzaG91bGREaXNwYXRjaFJvdXRlck5hdmlnYXRpb24oKTogYm9vbGVhbiB7XG4gICAgaWYgKCF0aGlzLnJvdXRlclN0YXRlKSByZXR1cm4gdHJ1ZTtcbiAgICByZXR1cm4gIXRoaXMubmF2aWdhdGlvblRyaWdnZXJlZEJ5RGlzcGF0Y2g7XG4gIH1cblxuICBwcml2YXRlIG5hdmlnYXRlSWZOZWVkZWQoKTogdm9pZCB7XG4gICAgaWYgKCF0aGlzLnJvdXRlclN0YXRlIHx8ICF0aGlzLnJvdXRlclN0YXRlLnN0YXRlKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGlmICh0aGlzLmRpc3BhdGNoVHJpZ2dlcmVkQnlSb3V0ZXIpIHJldHVybjtcblxuICAgIGlmICh0aGlzLnJvdXRlci51cmwgIT09IHRoaXMucm91dGVyU3RhdGUuc3RhdGUudXJsKSB7XG4gICAgICB0aGlzLm5hdmlnYXRpb25UcmlnZ2VyZWRCeURpc3BhdGNoID0gdHJ1ZTtcbiAgICAgIHNldFNraXBBY3Rpb24oKTtcbiAgICAgIHRoaXMucm91dGVyLm5hdmlnYXRlQnlVcmwodGhpcy5yb3V0ZXJTdGF0ZS5zdGF0ZS51cmwpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgc2V0VXBTdGF0ZVJvbGxiYWNrRXZlbnRzKCk6IHZvaWQge1xuICAgIHRoaXMucm91dGVyLmV2ZW50cy5zdWJzY3JpYmUoZSA9PiB7XG4gICAgICBpZiAoZSBpbnN0YW5jZW9mIFJvdXRlc1JlY29nbml6ZWQpIHtcbiAgICAgICAgdGhpcy5sYXN0Um91dGVzUmVjb2duaXplZCA9IGU7XG4gICAgICB9IGVsc2UgaWYgKGUgaW5zdGFuY2VvZiBOYXZpZ2F0aW9uQ2FuY2VsKSB7XG4gICAgICAgIHRoaXMuZGlzcGF0Y2hSb3V0ZXJDYW5jZWwoZSk7XG4gICAgICB9IGVsc2UgaWYgKGUgaW5zdGFuY2VvZiBOYXZpZ2F0aW9uRXJyb3IpIHtcbiAgICAgICAgdGhpcy5kaXNwYXRjaFJvdXRlckVycm9yKGUpO1xuICAgICAgfVxuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBzZXJpYWxpemVSb3V0ZShyb3V0ZTogQWN0aXZhdGVkUm91dGVTbmFwc2hvdCk6IFBhcnRpYWw8QWN0aXZhdGVkUm91dGVTbmFwc2hvdD4ge1xuICAgIGxldCBzdGF0ZTogQWN0aXZhdGVkUm91dGVTbmFwc2hvdCA9IHJvdXRlLnJvb3Q7XG4gICAgd2hpbGUgKHN0YXRlLmZpcnN0Q2hpbGQpIHtcbiAgICAgIHN0YXRlID0gc3RhdGUuZmlyc3RDaGlsZDtcbiAgICB9XG4gICAgY29uc3QgeyBwYXJhbXMsIGRhdGEsIHBhcmFtTWFwLCBxdWVyeVBhcmFtTWFwLCBxdWVyeVBhcmFtcywgZnJhZ21lbnQgfSA9IHN0YXRlO1xuXG4gICAgcmV0dXJuIHtcbiAgICAgIHVybDogcm91dGUudXJsLFxuICAgICAgcGFyYW1zLFxuICAgICAgcXVlcnlQYXJhbXMsXG4gICAgICBmcmFnbWVudCxcbiAgICAgIGRhdGEsXG4gICAgICBwYXJhbU1hcCxcbiAgICAgIHF1ZXJ5UGFyYW1NYXBcbiAgICB9O1xuICB9XG59XG4iXX0=