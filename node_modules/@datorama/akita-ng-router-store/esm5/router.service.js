import * as tslib_1 from "tslib";
import { Injectable } from '@angular/core';
import { NavigationCancel, NavigationError, Router, RoutesRecognized } from '@angular/router';
import { of } from 'rxjs';
import { RouterStore } from './router.store';
import { RouterQuery } from './router.query';
import { action, setSkipAction } from '@datorama/akita';
import * as i0 from "@angular/core";
import * as i1 from "./router.store";
import * as i2 from "./router.query";
import * as i3 from "@angular/router";
var RouterService = /** @class */ (function () {
    function RouterService(routerStore, routerQuery, router) {
        this.routerStore = routerStore;
        this.routerQuery = routerQuery;
        this.router = router;
        this.dispatchTriggeredByRouter = false;
        this.navigationTriggeredByDispatch = false;
    }
    RouterService.prototype.dispatchRouterCancel = function (event) {
        this.update();
    };
    RouterService.prototype.dispatchRouterError = function (event) {
        this.update();
    };
    RouterService.prototype.dispatchRouterNavigation = function () {
        this.update();
    };
    RouterService.prototype.init = function () {
        this.setUpRouterHook();
        this.setUpStoreListener();
        this.setUpStateRollbackEvents();
    };
    RouterService.prototype.update = function () {
        var _this = this;
        this.dispatchTriggeredByRouter = true;
        this.routerStore.update(function (state) {
            return tslib_1.__assign({}, state, { state: _this.routerStateSnapshot, navigationId: _this.lastRoutesRecognized ? _this.lastRoutesRecognized.id : null });
        });
        this.dispatchTriggeredByRouter = false;
        this.navigationTriggeredByDispatch = false;
    };
    /**
     * Hook into the angular router before each navigation action is performed
     * since the route tree can be large, we serialize it into something more manageable
     */
    RouterService.prototype.setUpRouterHook = function () {
        var _this = this;
        this.router.hooks.beforePreactivation = function (routerStateSnapshot) {
            _this.routerStateSnapshot = {
                root: _this.serializeRoute(routerStateSnapshot.root),
                url: routerStateSnapshot.url
            };
            if (_this.shouldDispatchRouterNavigation())
                _this.dispatchRouterNavigation();
            return of(true);
        };
    };
    RouterService.prototype.setUpStoreListener = function () {
        var _this = this;
        this.routerQuery
            .select(function (state) { return state; })
            .subscribe(function (s) {
            _this.routerState = s;
            _this.navigateIfNeeded();
        });
    };
    RouterService.prototype.shouldDispatchRouterNavigation = function () {
        if (!this.routerState)
            return true;
        return !this.navigationTriggeredByDispatch;
    };
    RouterService.prototype.navigateIfNeeded = function () {
        if (!this.routerState || !this.routerState.state) {
            return;
        }
        if (this.dispatchTriggeredByRouter)
            return;
        if (this.router.url !== this.routerState.state.url) {
            this.navigationTriggeredByDispatch = true;
            setSkipAction();
            this.router.navigateByUrl(this.routerState.state.url);
        }
    };
    RouterService.prototype.setUpStateRollbackEvents = function () {
        var _this = this;
        this.router.events.subscribe(function (e) {
            if (e instanceof RoutesRecognized) {
                _this.lastRoutesRecognized = e;
            }
            else if (e instanceof NavigationCancel) {
                _this.dispatchRouterCancel(e);
            }
            else if (e instanceof NavigationError) {
                _this.dispatchRouterError(e);
            }
        });
    };
    RouterService.prototype.serializeRoute = function (route) {
        var state = route.root;
        while (state.firstChild) {
            state = state.firstChild;
        }
        var params = state.params, data = state.data, paramMap = state.paramMap, queryParamMap = state.queryParamMap, queryParams = state.queryParams, fragment = state.fragment;
        return {
            url: route.url,
            params: params,
            queryParams: queryParams,
            fragment: fragment,
            data: data,
            paramMap: paramMap,
            queryParamMap: queryParamMap
        };
    };
    RouterService.ngInjectableDef = i0.defineInjectable({ factory: function RouterService_Factory() { return new RouterService(i0.inject(i1.RouterStore), i0.inject(i2.RouterQuery), i0.inject(i3.Router)); }, token: RouterService, providedIn: "root" });
    tslib_1.__decorate([
        action('Navigation Cancelled'),
        tslib_1.__metadata("design:type", Function),
        tslib_1.__metadata("design:paramtypes", [NavigationCancel]),
        tslib_1.__metadata("design:returntype", void 0)
    ], RouterService.prototype, "dispatchRouterCancel", null);
    tslib_1.__decorate([
        action('Navigation Error'),
        tslib_1.__metadata("design:type", Function),
        tslib_1.__metadata("design:paramtypes", [NavigationError]),
        tslib_1.__metadata("design:returntype", void 0)
    ], RouterService.prototype, "dispatchRouterError", null);
    tslib_1.__decorate([
        action('Navigation'),
        tslib_1.__metadata("design:type", Function),
        tslib_1.__metadata("design:paramtypes", []),
        tslib_1.__metadata("design:returntype", void 0)
    ], RouterService.prototype, "dispatchRouterNavigation", null);
    RouterService = tslib_1.__decorate([
        Injectable({
            providedIn: 'root'
        }),
        tslib_1.__metadata("design:paramtypes", [RouterStore, RouterQuery, Router])
    ], RouterService);
    return RouterService;
}());
export { RouterService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicm91dGVyLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZGF0b3JhbWEvYWtpdGEtbmctcm91dGVyLXN0b3JlLyIsInNvdXJjZXMiOlsicm91dGVyLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDM0MsT0FBTyxFQUVMLGdCQUFnQixFQUNoQixlQUFlLEVBQ2YsTUFBTSxFQUVOLGdCQUFnQixFQUNqQixNQUFNLGlCQUFpQixDQUFDO0FBQ3pCLE9BQU8sRUFBRSxFQUFFLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDMUIsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQzdDLE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUM3QyxPQUFPLEVBQUUsTUFBTSxFQUFFLGFBQWEsRUFBRSxNQUFNLGlCQUFpQixDQUFDOzs7OztBQUt4RDtJQU9FLHVCQUFvQixXQUF3QixFQUFVLFdBQXdCLEVBQVUsTUFBYztRQUFsRixnQkFBVyxHQUFYLFdBQVcsQ0FBYTtRQUFVLGdCQUFXLEdBQVgsV0FBVyxDQUFhO1FBQVUsV0FBTSxHQUFOLE1BQU0sQ0FBUTtRQUo5Riw4QkFBeUIsR0FBRyxLQUFLLENBQUM7UUFDbEMsa0NBQTZCLEdBQUcsS0FBSyxDQUFDO0lBRzJELENBQUM7SUFHMUcsNENBQW9CLEdBQXBCLFVBQXFCLEtBQXVCO1FBQzFDLElBQUksQ0FBQyxNQUFNLEVBQUUsQ0FBQztJQUNoQixDQUFDO0lBR0QsMkNBQW1CLEdBQW5CLFVBQW9CLEtBQXNCO1FBQ3hDLElBQUksQ0FBQyxNQUFNLEVBQUUsQ0FBQztJQUNoQixDQUFDO0lBR0QsZ0RBQXdCLEdBQXhCO1FBQ0UsSUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFDO0lBQ2hCLENBQUM7SUFFRCw0QkFBSSxHQUFKO1FBQ0UsSUFBSSxDQUFDLGVBQWUsRUFBRSxDQUFDO1FBQ3ZCLElB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S0FBSSxDQUFDLG1CQUFtQixDQUFDLENBQUMsQ0FBQyxDQUFDO2FBQzdCO1FBQ0gsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDO0lBRU8sc0NBQWMsR0FBdEIsVUFBdUIsS0FBNkI7UUFDbEQsSUFBSSxLQUFLLEdBQTJCLEtBQUssQ0FBQyxJQUFJLENBQUM7UUFDL0MsT0FBTyxLQUFLLENBQUMsVUFBVSxFQUFFO1lBQ3ZCLEtBQUssR0FBRyxLQUFLLENBQUMsVUFBVSxDQUFDO1NBQzFCO1FBQ08sSUFBQSxxQkFBTSxFQUFFLGlCQUFJLEVBQUUseUJBQVEsRUFBRSxtQ0FBYSxFQUFFLCtCQUFXLEVBQUUseUJBQVEsQ0FBVztRQUUvRSxPQUFPO1lBQ0wsR0FBRyxFQUFFLEtBQUssQ0FBQyxHQUFHO1lBQ2QsTUFBTSxRQUFBO1lBQ04sV0FBVyxhQUFBO1lBQ1gsUUFBUSxVQUFBO1lBQ1IsSUFBSSxNQUFBO1lBQ0osUUFBUSxVQUFBO1lBQ1IsYUFBYSxlQUFBO1NBQ2QsQ0FBQztJQUNKLENBQUM7O0lBdkdEO1FBREMsTUFBTSxDQUFDLHNCQUFzQixDQUFDOztpREFDSCxnQkFBZ0I7OzZEQUUzQztJQUdEO1FBREMsTUFBTSxDQUFDLGtCQUFrQixDQUFDOztpREFDQSxlQUFlOzs0REFFekM7SUFHRDtRQURDLE1BQU0sQ0FBQyxZQUFZLENBQUM7Ozs7aUVBR3BCO0lBdEJVLGFBQWE7UUFIekIsVUFBVSxDQUFDO1lBQ1YsVUFBVSxFQUFFLE1BQU07U0FDbkIsQ0FBQztpREFRaUMsV0FBVyxFQUF1QixXQUFXLEVBQWtCLE1BQU07T0FQM0YsYUFBYSxDQWtIekI7d0JBbklEO0NBbUlDLEFBbEhELElBa0hDO1NBbEhZLGFBQWEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQge1xuICBBY3RpdmF0ZWRSb3V0ZVNuYXBzaG90LFxuICBOYXZpZ2F0aW9uQ2FuY2VsLFxuICBOYXZpZ2F0aW9uRXJyb3IsXG4gIFJvdXRlcixcbiAgUm91dGVyU3RhdGVTbmFwc2hvdCxcbiAgUm91dGVzUmVjb2duaXplZFxufSBmcm9tICdAYW5ndWxhci9yb3V0ZXInO1xuaW1wb3J0IHsgb2YgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IFJvdXRlclN0b3JlIH0gZnJvbSAnLi9yb3V0ZXIuc3RvcmUnO1xuaW1wb3J0IHsgUm91dGVyUXVlcnkgfSBmcm9tICcuL3JvdXRlci5xdWVyeSc7XG5pbXBvcnQgeyBhY3Rpb24sIHNldFNraXBBY3Rpb24gfSBmcm9tICdAZGF0b3JhbWEvYWtpdGEnO1xuXG5ASW5qZWN0YWJsZSh7XG4gIHByb3ZpZGVkSW46ICdyb290J1xufSlcbmV4cG9ydCBjbGFzcyBSb3V0ZXJTZXJ2aWNlIHtcbiAgcHJpdmF0ZSByb3V0ZXJTdGF0ZVNuYXBzaG90OiBhbnk7XG4gIHByaXZhdGUgbGFzdFJvdXRlc1JlY29nbml6ZWQ6IGFueTtcbiAgcHJpdmF0ZSBkaXNwYXRjaFRyaWdnZXJlZEJ5Um91dGVyID0gZmFsc2U7XG4gIHByaXZhdGUgbmF2aWdhdGlvblRyaWdnZXJlZEJ5RGlzcGF0Y2ggPSBmYWxzZTtcbiAgcHJpdmF0ZSByb3V0ZXJTdGF0ZTogYW55O1xuXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgcm91dGVyU3RvcmU6IFJvdXRlclN0b3JlLCBwcml2YXRlIHJvdXRlclF1ZXJ5OiBSb3V0ZXJRdWVyeSwgcHJpdmF0ZSByb3V0ZXI6IFJvdXRlcikge31cblxuICBAYWN0aW9uKCdOYXZpZ2F0aW9uIENhbmNlbGxlZCcpXG4gIGRpc3BhdGNoUm91dGVyQ2FuY2VsKGV2ZW50OiBOYXZpZ2F0aW9uQ2FuY2VsKSB7XG4gICAgdGhpcy51cGRhdGUoKTtcbiAgfVxuXG4gIEBhY3Rpb24oJ05hdmlnYXRpb24gRXJyb3InKVxuICBkaXNwYXRjaFJvdXRlckVycm9yKGV2ZW50OiBOYXZpZ2F0aW9uRXJyb3IpIHtcbiAgICB0aGlzLnVwZGF0ZSgpO1xuICB9XG5cbiAgQGFjdGlvbignTmF2aWdhdGlvbicpXG4gIGRpc3BhdGNoUm91dGVyTmF2aWdhdGlvbigpIHtcbiAgICB0aGlzLnVwZGF0ZSgpO1xuICB9XG5cbiAgaW5pdCgpIHtcbiAgICB0aGlzLnNldFVwUm91dGVySG9vaygpO1xuICAgIHRoaXMuc2V0VXBTdG9yZUxpc3RlbmVyKCk7XG4gICAgdGhpcy5zZXRVcFN0YXRlUm9sbGJhY2tFdmVudHMoKTtcbiAgfVxuXG4gIHByaXZhdGUgdXBkYXRlKCkge1xuICAgIHRoaXMuZGlzcGF0Y2hUcmlnZ2VyZWRCeVJvdXRlciA9IHRydWU7XG4gICAgdGhpcy5yb3V0ZXJTdG9yZS51cGRhdGUoKHN0YXRlOiBhbnkpID0+IHtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIC4uLnN0YXRlLFxuICAgICAgICBzdGF0ZTogdGhpcy5yb3V0ZXJTdGF0ZVNuYXBzaG90LFxuICAgICAgICBuYXZpZ2F0aW9uSWQ6IHRoaXMubGFzdFJvdXRlc1JlY29nbml6ZWQgPyB0aGlzLmxhc3RSb3V0ZXNSZWNvZ25pemVkLmlkIDogbnVsbFxuICAgICAgfTtcbiAgICB9KTtcbiAgICB0aGlzLmRpc3BhdGNoVHJpZ2dlcmVkQnlSb3V0ZXIgPSBmYWxzZTtcbiAgICB0aGlzLm5hdmlnYXRpb25UcmlnZ2VyZWRCeURpc3BhdGNoID0gZmFsc2U7XG4gIH1cblxuICAvKipcbiAgICogSG9vayBpbnRvIHRoZSBhbmd1bGFyIHJvdXRlciBiZWZvcmUgZWFjaCBuYXZpZ2F0aW9uIGFjdGlvbiBpcyBwZXJmb3JtZWRcbiAgICogc2luY2UgdGhlIHJvdXRlIHRyZWUgY2FuIGJlIGxhcmdlLCB3ZSBzZXJpYWxpemUgaXQgaW50byBzb21ldGhpbmcgbW9yZSBtYW5hZ2VhYmxlXG4gICAqL1xuICBwcml2YXRlIHNldFVwUm91dGVySG9vaygpOiB2b2lkIHtcbiAgICAodGhpcy5yb3V0ZXIgYXMgYW55KS5ob29rcy5iZWZvcmVQcmVhY3RpdmF0aW9uID0gKHJvdXRlclN0YXRlU25hcHNob3Q6IFJvdXRlclN0YXRlU25hcHNob3QpID0+IHtcbiAgICAgIHRoaXMucm91dGVyU3RhdGVTbmFwc2hvdCA9IHtcbiAgICAgICAgcm9vdDogdGhpcy5zZXJpYWxpemVSb3V0ZShyb3V0ZXJTdGF0ZVNuYXBzaG90LnJvb3QpLFxuICAgICAgICB1cmw6IHJvdXRlclN0YXRlU25hcHNob3QudXJsXG4gICAgICB9O1xuICAgICAgaWYgKHRoaXMuc2hvdWxkRGlzcGF0Y2hSb3V0ZXJOYXZpZ2F0aW9uKCkpIHRoaXMuZGlzcGF0Y2hSb3V0ZXJOYXZpZ2F0aW9uKCk7XG4gICAgICByZXR1cm4gb2YodHJ1ZSk7XG4gICAgfTtcbiAgfVxuXG4gIHByaXZhdGUgc2V0VXBTdG9yZUxpc3RlbmVyKCk6IHZvaWQge1xuICAgIHRoaXMucm91dGVyUXVlcnlcbiAgICAgIC5zZWxlY3Qoc3RhdGUgPT4gc3RhdGUpXG4gICAgICAuc3Vic2NyaWJlKHMgPT4ge1xuICAgICAgICB0aGlzLnJvdXRlclN0YXRlID0gcztcbiAgICAgICAgdGhpcy5uYXZpZ2F0ZUlmTmVlZGVkKCk7XG4gICAgICB9KTtcbiAgfVxuXG4gIHByaXZhdGUgc2hvdWxkRGlzcGF0Y2hSb3V0ZXJOYXZpZ2F0aW9uKCk6IGJvb2xlYW4ge1xuICAgIGlmICghdGhpcy5yb3V0ZXJTdGF0ZSkgcmV0dXJuIHRydWU7XG4gICAgcmV0dXJuICF0aGlzLm5hdmlnYXRpb25UcmlnZ2VyZWRCeURpc3BhdGNoO1xuICB9XG5cbiAgcHJpdmF0ZSBuYXZpZ2F0ZUlmTmVlZGVkKCk6IHZvaWQge1xuICAgIGlmICghdGhpcy5yb3V0ZXJTdGF0ZSB8fCAhdGhpcy5yb3V0ZXJTdGF0ZS5zdGF0ZSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBpZiAodGhpcy5kaXNwYXRjaFRyaWdnZXJlZEJ5Um91dGVyKSByZXR1cm47XG5cbiAgICBpZiAodGhpcy5yb3V0ZXIudXJsICE9PSB0aGlzLnJvdXRlclN0YXRlLnN0YXRlLnVybCkge1xuICAgICAgdGhpcy5uYXZpZ2F0aW9uVHJpZ2dlcmVkQnlEaXNwYXRjaCA9IHRydWU7XG4gICAgICBzZXRTa2lwQWN0aW9uKCk7XG4gICAgICB0aGlzLnJvdXRlci5uYXZpZ2F0ZUJ5VXJsKHRoaXMucm91dGVyU3RhdGUuc3RhdGUudXJsKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIHNldFVwU3RhdGVSb2xsYmFja0V2ZW50cygpOiB2b2lkIHtcbiAgICB0aGlzLnJvdXRlci5ldmVudHMuc3Vic2NyaWJlKGUgPT4ge1xuICAgICAgaWYgKGUgaW5zdGFuY2VvZiBSb3V0ZXNSZWNvZ25pemVkKSB7XG4gICAgICAgIHRoaXMubGFzdFJvdXRlc1JlY29nbml6ZWQgPSBlO1xuICAgICAgfSBlbHNlIGlmIChlIGluc3RhbmNlb2YgTmF2aWdhdGlvbkNhbmNlbCkge1xuICAgICAgICB0aGlzLmRpc3BhdGNoUm91dGVyQ2FuY2VsKGUpO1xuICAgICAgfSBlbHNlIGlmIChlIGluc3RhbmNlb2YgTmF2aWdhdGlvbkVycm9yKSB7XG4gICAgICAgIHRoaXMuZGlzcGF0Y2hSb3V0ZXJFcnJvcihlKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfVxuXG4gIHByaXZhdGUgc2VyaWFsaXplUm91dGUocm91dGU6IEFjdGl2YXRlZFJvdXRlU25hcHNob3QpOiBQYXJ0aWFsPEFjdGl2YXRlZFJvdXRlU25hcHNob3Q+IHtcbiAgICBsZXQgc3RhdGU6IEFjdGl2YXRlZFJvdXRlU25hcHNob3QgPSByb3V0ZS5yb290O1xuICAgIHdoaWxlIChzdGF0ZS5maXJzdENoaWxkKSB7XG4gICAgICBzdGF0ZSA9IHN0YXRlLmZpcnN0Q2hpbGQ7XG4gICAgfVxuICAgIGNvbnN0IHsgcGFyYW1zLCBkYXRhLCBwYXJhbU1hcCwgcXVlcnlQYXJhbU1hcCwgcXVlcnlQYXJhbXMsIGZyYWdtZW50IH0gPSBzdGF0ZTtcblxuICAgIHJldHVybiB7XG4gICAgICB1cmw6IHJvdXRlLnVybCxcbiAgICAgIHBhcmFtcyxcbiAgICAgIHF1ZXJ5UGFyYW1zLFxuICAgICAgZnJhZ21lbnQsXG4gICAgICBkYXRhLFxuICAgICAgcGFyYW1NYXAsXG4gICAgICBxdWVyeVBhcmFtTWFwXG4gICAgfTtcbiAgfVxufVxuIl19